<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sportova Admin Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --success-color: #4cc9f0;
      --warning-color: #f9c74f;
      --danger-color: #f94144;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --sidebar-width: 250px;
      --header-height: 70px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fb;
      overflow-x: hidden;
      height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: var(--sidebar-width);
      background-color: var(--dark-color);
      color: white;
      padding: 1rem;
      z-index: 1000;
      transition: all 0.3s;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .sidebar.collapsed .sidebar-text {
      display: none;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 1rem 0;
      margin-bottom: 1rem;
      border-bottom: 1px solid #495057;
    }

    .sidebar-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      margin-right: 10px;
    }

    .sidebar-title {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 0;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
    }

    .sidebar-menu li {
      margin-bottom: 0.3rem;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #bdc3c7;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background-color: var(--primary-color);
      color: white;
    }

    .sidebar-menu i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid #495057;
    }

    /* Main Content Styles */
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 20px;
      transition: all 0.3s;
      height: 100vh;
      overflow-y: auto;
    }

    .main-content.expanded {
      margin-left: 70px;
    }

    .header {
      background-color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin-bottom: 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--dark-color);
    }

    .header-actions {
      display: flex;
      align-items: center;
    }

    .user-profile {
      display: flex;
      align-items: center;
      margin-left: 20px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }

    /* Dashboard Cards */
    .stats-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    .stats-card .number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .stats-card .label {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .stats-card i {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 15px;
    }

    /* Table Styles */
    .table-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
    }

    .table th {
      font-weight: 600;
      border-top: none;
      color: #495057;
      background-color: #f8f9fa;
    }

    .time-picker-container {
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 15px;
      background: #f8f9fa;
    }

    .clock-display .selected-time {
      background: linear-gradient(135deg, #4361ee, #3a0ca3);
      box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
    }

    .time-display {
      font-family: 'Courier New', monospace;
      letter-spacing: 2px;
    }

    .time-period {
      font-size: 1rem;
      opacity: 0.9;
    }

    .slots-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 10px;
      max-height: 200px;
      overflow-y: auto;
      padding: 10px;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      background: white;
    }

    .time-slot {
      padding: 8px 12px;
      border: 2px solid #e9ecef;
      border-radius: 6px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background: white;
    }

    .time-slot:hover {
      border-color: #4361ee;
      background: #f0f4ff;
    }

    .time-slot.selected {
      border-color: #4361ee;
      background: #4361ee;
      color: white;
    }

    .time-slot.available {
      border-color: #28a745;
    }

    .time-slot.unavailable {
      border-color: #dc3545;
      background: #f8d7da;
      color: #721c24;
      cursor: not-allowed;
    }

    .btn-check:checked+.btn-outline-primary {
      background-color: #4361ee;
      border-color: #4361ee;
      color: white;
    }

    /* Update these badge styles in your CSS */
    .badge-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      color: white !important;
      /* Force white text */
      border: none;
    }

    .badge-approved {
      background-color: #198754 !important;
      /* Green */
      color: white !important;
    }

    .badge-pending {
      background-color: #ffc107 !important;
      /* Yellow */
      color: #212529 !important;
      /* Dark text for better contrast on yellow */
    }

    .badge-rejected,
    .badge-cancelled {
      background-color: #dc3545 !important;
      /* Red */
      color: white !important;
    }

    /* Additional status badges for completeness */
    .badge-completed {
      background-color: #0d6efd !important;
      /* Blue */
      color: white !important;
    }

    .badge-confirmed {
      background-color: #20c997 !important;
      /* Teal */
      color: white !important;
    }

    /* Ensure all badges have proper contrast */
    .badge {
      color: white !important;
      font-weight: 600;
    }

    /* Form Styles */
    .form-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 25px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }

    /* Modal Styles */
    .modal-header {
      background-color: var(--light-color);
      border-bottom: 1px solid #eaeaea;
    }

    /* Toast Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }

    /* Toggle Button */
    .sidebar-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 10px;
    }

    /* Calendar Styles */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 20px;
    }

    .calendar-header {
      background-color: var(--primary-color);
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: 600;
    }

    .calendar-day {
      background-color: white;
      border: 1px solid #eaeaea;
      padding: 10px;
      min-height: 120px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .calendar-day:hover {
      background-color: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .calendar-day.today {
      background-color: #e3f2fd;
      border-color: var(--primary-color);
      border-width: 2px;
    }

    .calendar-day.has-booking {
      background-color: #f0f8ff;
      border-color: #b3d9ff;
    }

    .calendar-day.empty {
      background-color: #f8f9fa;
      border-color: #e9ecef;
      cursor: default;
    }

    .calendar-day.empty:hover {
      background-color: #f8f9fa;
      transform: none;
      box-shadow: none;
    }

    .calendar-event {
      font-size: 0.7rem;
      padding: 6px 8px;
      margin: 3px 0;
      border-radius: 6px;
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .calendar-event:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .calendar-event small,
    .week-booking small,
    .day-booking small {
      opacity: 0.8;
      font-weight: normal;
    }

    /* Drag and Drop Styles */
    .draggable-booking {
      cursor: move;
      transition: all 0.3s ease;
    }

    .draggable-booking.dragging {
      opacity: 0.6;
      transform: scale(0.95);
      transition: all 0.3s ease;
    }

    .calendar-day.drag-over,
    .calendar-week-slot.drag-over,
    .time-slot-content.drag-over {
      background-color: #e3f2fd !important;
      border: 2px dashed #2196f3 !important;
      transition: all 0.3s ease;
    }

    /* Week and Day Booking Styles */
    .week-booking,
    .day-booking {
      padding: 4px 8px;
      margin: 2px 0;
      border-radius: 4px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .week-booking:hover,
    .day-booking:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .date-number {
      font-size: 1.2rem;
      font-weight: bold;
    }

    /* Color Legend Styles */
    .color-legend {
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.8rem;
    }

    .legend-item {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      border-radius: 3px;
      display: inline-block;
      border: 1px solid rgba(0, 0, 0, 0.2);
    }

    /* Specific legend colors matching the booking styles */
    .legend-color.badminton-booking {
      background-color: #e3f2fd;
      border-left: 4px solid #2196f3;
    }

    .legend-color.tennis-booking {
      background-color: #e8f5e8;
      border-left: 4px solid #4caf50;
    }

    .legend-color.basketball-booking {
      background-color: #fff3e0;
      border-left: 4px solid #ff9800;
    }

    .legend-color.football-booking {
      background-color: #fce4ec;
      border-left: 4px solid #e91e63;
    }

    .legend-color.swimming-booking {
      background-color: #e0f2f1;
      border-left: 4px solid #009688;
    }

    .legend-color.gym-booking {
      background-color: #f3e5f5;
      border-left: 4px solid #9c27b0;
    }

    .legend-color.default-booking {
      background-color: #f5f5f5;
      border-left: 4px solid #757575;
    }

    .legend-color.status-approved {
      background-color: #d4edda;
      border-left: 4px solid #28a745;
    }

    .legend-color.status-pending {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
    }

    .legend-color.status-completed {
      background-color: #d1ecf1;
      border-left: 4px solid #17a2b8;
    }

    .legend-color.status-cancelled {
      background-color: #f8d7da;
      border-left: 4px solid #dc3545;
    }

    /* Active Filters Display */
    .alert-info {
      background-color: #e3f2fd;
      border-color: #4361ee;
      color: #4361ee;
    }

    .alert-info .btn-outline-danger {
      border-color: #dc3545;
      color: #dc3545;
    }

    .alert-info .btn-outline-danger:hover {
      background-color: #dc3545;
      color: white;
    }

    /* Enhanced Color Coding with Better Visibility */
    .calendar-event.badminton-booking {
      background: linear-gradient(135deg, #2196F3, #1976D2) !important;
      color: white !important;
      border-left: 4px solid #0D47A1 !important;
    }

    .calendar-event.tennis-booking {
      background: linear-gradient(135deg, #4CAF50, #388E3C) !important;
      color: white !important;
      border-left: 4px solid #1B5E20 !important;
    }

    .calendar-event.basketball-booking {
      background: linear-gradient(135deg, #FF9800, #F57C00) !important;
      color: white !important;
      border-left: 4px solid #E65100 !important;
    }

    .calendar-event.football-booking {
      background: linear-gradient(135deg, #E91E63, #C2185B) !important;
      color: white !important;
      border-left: 4px solid #880E4F !important;
    }

    .calendar-event.swimming-booking {
      background: linear-gradient(135deg, #009688, #00796B) !important;
      color: white !important;
      border-left: 4px solid #004D40 !important;
    }

    .calendar-event.gym-booking {
      background: linear-gradient(135deg, #9C27B0, #7B1FA2) !important;
      color: white !important;
      border-left: 4px solid #4A148C !important;
    }

    .calendar-event.default-booking {
      background: linear-gradient(135deg, #757575, #616161) !important;
      color: white !important;
      border-left: 4px solid #424242 !important;
    }

    /* Status-based colors */
    .calendar-event.status-confirmed,
    .calendar-event.status-approved {
      background: linear-gradient(135deg, #4CAF50, #388E3C) !important;
      color: white !important;
      border-left: 4px solid #1B5E20 !important;
    }

    .calendar-event.status-pending {
      background: linear-gradient(135deg, #FFC107, #FFA000) !important;
      color: black !important;
      border-left: 4px solid #FF6F00 !important;
    }

    .calendar-event.status-completed {
      background: linear-gradient(135deg, #2196F3, #1976D2) !important;
      color: white !important;
      border-left: 4px solid #0D47A1 !important;
    }

    .calendar-event.status-cancelled {
      background: linear-gradient(135deg, #F44336, #D32F2F) !important;
      color: white !important;
      border-left: 4px solid #B71C1C !important;
    }

    /* Facility-based colors */
    .calendar-event.facility-color-1 {
      background: linear-gradient(135deg, #2196F3, #1976D2) !important;
      color: white !important;
      border-left: 4px solid #0D47A1 !important;
    }

    .calendar-event.facility-color-2 {
      background: linear-gradient(135deg, #4CAF50, #388E3C) !important;
      color: white !important;
      border-left: 4px solid #1B5E20 !important;
    }

    .calendar-event.facility-color-3 {
      background: linear-gradient(135deg, #FF9800, #F57C00) !important;
      color: white !important;
      border-left: 4px solid #E65100 !important;
    }

    .calendar-event.facility-color-4 {
      background: linear-gradient(135deg, #E91E63, #C2185B) !important;
      color: white !important;
      border-left: 4px solid #880E4F !important;
    }

    .calendar-event.facility-color-5 {
      background: linear-gradient(135deg, #009688, #00796B) !important;
      color: white !important;
      border-left: 4px solid #004D40 !important;
    }

    .calendar-event.facility-color-6 {
      background: linear-gradient(135deg, #9C27B0, #7B1FA2) !important;
      color: white !important;
      border-left: 4px solid #4A148C !important;
    }

    /* Enhanced Week Booking Colors */
    .week-booking.badminton-booking {
      background: linear-gradient(135deg, #2196F3, #1976D2) !important;
      color: white !important;
      border-left: 4px solid #0D47A1 !important;
    }

    .week-booking.tennis-booking {
      background: linear-gradient(135deg, #4CAF50, #388E3C) !important;
      color: white !important;
      border-left: 4px solid #1B5E20 !important;
    }

    .week-booking.basketball-booking {
      background: linear-gradient(135deg, #FF9800, #F57C00) !important;
      color: white !important;
      border-left: 4px solid #E65100 !important;
    }

    .week-booking.football-booking {
      background: linear-gradient(135deg, #E91E63, #C2185B) !important;
      color: white !important;
      border-left: 4px solid #880E4F !important;
    }

    .week-booking.swimming-booking {
      background: linear-gradient(135deg, #009688, #00796B) !important;
      color: white !important;
      border-left: 4px solid #004D40 !important;
    }

    .week-booking.gym-booking {
      background: linear-gradient(135deg, #9C27B0, #7B1FA2) !important;
      color: white !important;
      border-left: 4px solid #4A148C !important;
    }

    .week-booking.default-booking {
      background: linear-gradient(135deg, #757575, #616161) !important;
      color: white !important;
      border-left: 4px solid #424242 !important;
    }

    /* Enhanced Day Booking Colors */
    .day-booking.badminton-booking {
      background: linear-gradient(135deg, #2196F3, #1976D2) !important;
      color: white !important;
      border-left: 4px solid #0D47A1 !important;
    }

    .day-booking.tennis-booking {
      background: linear-gradient(135deg, #4CAF50, #388E3C) !important;
      color: white !important;
      border-left: 4px solid #1B5E20 !important;
    }

    .day-booking.basketball-booking {
      background: linear-gradient(135deg, #FF9800, #F57C00) !important;
      color: white !important;
      border-left: 4px solid #E65100 !important;
    }

    .day-booking.football-booking {
      background: linear-gradient(135deg, #E91E63, #C2185B) !important;
      color: white !important;
      border-left: 4px solid #880E4F !important;
    }

    .day-booking.swimming-booking {
      background: linear-gradient(135deg, #009688, #00796B) !important;
      color: white !important;
      border-left: 4px solid #004D40 !important;
    }

    .day-booking.gym-booking {
      background: linear-gradient(135deg, #9C27B0, #7B1FA2) !important;
      color: white !important;
      border-left: 4px solid #4A148C !important;
    }

    .day-booking.default-booking {
      background: linear-gradient(135deg, #757575, #616161) !important;
      color: white !important;
      border-left: 4px solid #424242 !important;
    }

    /* Enhanced Calendar Event Styling */
    .event-title {
      font-weight: 700;
      font-size: 0.65rem;
      margin-bottom: 2px;
    }

    .event-time,
    .event-status,
    .event-user {
      font-size: 0.6rem;
      opacity: 0.9;
      font-weight: 500;
    }

    /* Make sure text is readable */
    .calendar-event,
    .week-booking,
    .day-booking {
      color: white !important;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    /* For pending status which has dark text */
    .calendar-event.status-pending,
    .week-booking.status-pending,
    .day-booking.status-pending {
      color: #000 !important;
      text-shadow: 0 1px 2px rgba(255, 255, 255, 0.5);
    }

    /* Enhanced Week View Styles */
    .calendar-week {
      display: grid;
      grid-template-columns: 80px repeat(7, 1fr);
      gap: 1px;
      background-color: #e9ecef;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .calendar-time-header {
      background-color: #4361ee;
      color: white;
      padding: 15px 10px;
      text-align: center;
      font-weight: bold;
      font-size: 0.9rem;
    }

    .calendar-day-header {
      background-color: #4361ee;
      color: white;
      padding: 15px 10px;
      text-align: center;
      font-weight: bold;
    }

    .calendar-day-header .date-number {
      font-size: 1.4rem;
      font-weight: bold;
      margin: 5px 0;
    }

    .calendar-time-slot {
      background-color: #f8f9fa;
      padding: 10px;
      text-align: center;
      font-weight: bold;
      font-size: 0.85rem;
      border-bottom: 1px solid #e9ecef;
      min-height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .calendar-week-slot {
      background-color: white;
      padding: 8px;
      min-height: 60px;
      border-bottom: 1px solid #e9ecef;
      position: relative;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .calendar-week-slot:hover {
      background-color: #f8f9fa;
    }

    .calendar-week-slot.has-booking {
      background-color: #f0f8ff;
    }

    .week-booking {
      padding: 6px 8px;
      margin: 2px 0;
      border-radius: 4px;
      font-size: 0.75rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.1);
      font-weight: 500;
      line-height: 1.2;
    }

    .week-booking:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
    }

    /* Enhanced Day View Styles */
    .calendar-day-view {
      display: grid;
      gap: 1px;
      background-color: #e9ecef;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      overflow: hidden;
      margin-bottom: 20px;
    }

    .day-view-header {
      grid-column: 1 / -1;
      background-color: #4361ee;
      color: white;
      padding: 20px;
    }

    .day-view-time-slots {
      display: flex;
      flex-direction: column;
    }

    .day-time-slot {
      display: flex;
      border-bottom: 1px solid #e9ecef;
      min-height: 100px;
    }

    .time-label {
      width: 100px;
      padding: 15px 10px;
      background-color: #f8f9fa;
      font-weight: bold;
      text-align: center;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.9rem;
    }

    .time-slot-content {
      flex: 1;
      padding: 15px;
      background-color: white;
      min-height: 100px;
    }

    .time-slot-content.has-booking {
      background-color: #f8f9fa;
    }

    .day-booking {
      padding: 12px;
      border-radius: 6px;
      font-size: 0.85rem;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(0, 0, 0, 0.1);
      margin-bottom: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .day-booking:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    .booking-facility {
      font-size: 0.9rem;
      margin-bottom: 4px;
    }

    .booking-user {
      margin-bottom: 4px;
    }

    .booking-time {
      font-size: 0.8rem;
    }

    .booking-notes {
      font-size: 0.75rem;
      border-top: 1px dashed #dee2e6;
      padding-top: 4px;
      margin-top: 4px;
    }

    /* Day number styling */
    .day-number {
      font-size: 1.1rem;
      font-weight: 600;
      color: #495057;
    }

    .calendar-day.today .day-number {
      color: var(--primary-color);
      font-size: 1.2rem;
    }

    /* Badge styling */
    .calendar-day .badge {
      font-size: 0.7rem;
      padding: 4px 6px;
    }

    /* Booking events container */
    .booking-events {
      max-height: 80px;
      overflow-y: auto;
      padding-right: 2px;
    }

    .booking-events::-webkit-scrollbar {
      width: 4px;
    }

    .booking-events::-webkit-scrollbar-track {
      background: #f1f1f1;
      border-radius: 2px;
    }

    .booking-events::-webkit-scrollbar-thumb {
      background: #c1c1c1;
      border-radius: 2px;
    }

    .booking-events::-webkit-scrollbar-thumb:hover {
      background: #a8a8a8;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
      }

      .sidebar .sidebar-text {
        display: none;
      }

      .main-content {
        margin-left: 70px;
      }

      .sidebar.collapsed {
        width: 0;
        overflow: hidden;
      }

      .main-content.expanded {
        margin-left: 0;
      }

      .calendar-week {
        grid-template-columns: 60px repeat(7, 1fr);
        font-size: 0.8rem;
      }

      .calendar-time-header,
      .calendar-day-header {
        padding: 10px 5px;
        font-size: 0.8rem;
      }

      .calendar-day-header .date-number {
        font-size: 1.1rem;
      }

      .time-label {
        width: 80px;
        font-size: 0.8rem;
      }

      .day-booking {
        padding: 8px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      <img src="img/logo.jpg" alt="Sportova Logo" class="sidebar-logo">
      <h5 class="sidebar-title sidebar-text">Sportova Admin</h5>
    </div>

    <ul class="sidebar-menu">
      <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> <span
            class="sidebar-text">Dashboard</span></a></li>
      <li><a href="#" data-page="facility-management"><i class="fas fa-building"></i> <span
            class="sidebar-text">Facility Management</span></a></li>
      <li><a href="#" data-page="booking-management"><i class="fas fa-calendar-alt"></i> <span
            class="sidebar-text">Booking Management</span></a></li>
      <li><a href="#" data-page="user-management"><i class="fas fa-users"></i> <span class="sidebar-text">User
            Management</span></a></li>
      <li><a href="#" data-page="coach-management"><i class="fas fa-user-tie"></i> <span class="sidebar-text">Coach
            Management</span></a></li>
      <li><a href="#" data-page="payment-finance"><i class="fas fa-money-bill-wave"></i> <span
            class="sidebar-text">Payment & Finance</span></a></li>
      <li><a href="#" data-page="calendar-scheduling"><i class="fas fa-calendar-day"></i> <span
            class="sidebar-text">Calendar & Scheduling</span></a></li>
      <li><a href="#" data-page="ai-insights"><i class="fas fa-brain"></i> <span class="sidebar-text">AI
            Insights</span></a></li>
      <li><a href="#" data-page="notifications"><i class="fas fa-bell"></i> <span
            class="sidebar-text">Notifications</span></a></li>
      <li><a href="#" data-page="promo-vouchers"><i class="fas fa-tags"></i> <span class="sidebar-text">Promo &
            Vouchers</span></a></li>
      <li><a href="#" data-page="events-tournaments"><i class="fas fa-trophy"></i> <span class="sidebar-text">Events &
            Tournaments</span></a></li>
      <li><a href="#" data-page="marketplace"><i class="fas fa-store"></i> <span
            class="sidebar-text">Marketplace</span></a></li>
      <li><a href="#" data-page="settings"><i class="fas fa-cog"></i> <span class="sidebar-text">Settings</span></a>
      </li>
      <li><a href="#" data-page="reports"><i class="fas fa-chart-bar"></i> <span class="sidebar-text">Reports</span></a>
      </li>
    </ul>

    <div class="sidebar-footer">
      <div class="user-profile mb-3">
        <img src="https://via.placeholder.com/40" alt="Admin" class="user-avatar" id="adminAvatar">
        <div class="sidebar-text">
          <div class="fw-bold" id="adminName">Admin</div>
          <small id="adminEmail">admin@sportova.com</small>
        </div>
      </div>
      <button class="btn btn-danger btn-sm w-100 mb-2" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> <span class="sidebar-text">Logout</span>
      </button>
      <a href="index.html" class="btn btn-outline-light btn-sm w-100">
        <i class="fas fa-home"></i> <span class="sidebar-text">Back to Homepage</span>
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="header">
      <h1 id="pageTitle">Dashboard</h1>
      <div class="header-actions">
        <div class="dropdown ms-3">
          <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-bell"></i>
            <span class="badge bg-danger">3</span>
          </button>
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <h6 class="dropdown-header">Notifications</h6>
            </li>
            <li><a class="dropdown-item" href="#">New booking request</a></li>
            <li><a class="dropdown-item" href="#">Payment received</a></li>
            <li><a class="dropdown-item" href="#">System update available</a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="#">View all notifications</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Page Content will be loaded here -->
    <div id="pageContent">
      <!-- Dashboard content will be loaded here by default -->
      <div class="row">
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-calendar-check"></i>
            <div class="number" id="totalBookings">0</div>
            <div class="label">Total Bookings</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-users"></i>
            <div class="number" id="totalCustomers">0</div>
            <div class="label">Total Customers</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-dollar-sign"></i>
            <div class="number" id="totalRevenue">RM0</div>
            <div class="label">Total Revenue</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-building"></i>
            <div class="number" id="totalFacilities">0</div>
            <div class="label">Total Facilities</div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-8">
          <div class="table-card">
            <h4>Recent Bookings</h4>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>User</th>
                    <th>Facility</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="recentBookings">
                  <!-- Recent bookings will be loaded here -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="table-card">
            <h4>Revenue Chart</h4>
            <div class="chart-container">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDjMwv9Bxff1bUE7CR_S-DPx3NV5kkinTU",
      authDomain: "nste-booking-system.firebaseapp.com",
      projectId: "nste-booking-system",
      storageBucket: "nste-booking-system.appspot.com",
      messagingSenderId: "574207536433",
      appId: "1:574207536433:web:0d2aeaacdc280cec019410"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const storage = firebase.storage();

    // Global variables
    let currentCalendarDate = new Date();
    let calendarView = 'month'; // 'day', 'week', 'month'
    let calendarFilter = 'all'; // 'all', 'facility', 'coach'
    let selectedFacilityFilter = '';
    let selectedCoachFilter = '';
    let currentUser = null;
    let isLoggingOut = false;
    let inactivityTimer;
    let adminFacilities = [];
    let allBookings = [];
    let allUsers = [];
    let allCoaches = [];
    let allPayments = [];
    let allPromos = [];
    let allEvents = [];
    let allProducts = [];
    let currentPage = 'dashboard'; // Track current page
    // Add these with other global variables
    window.statusFilter = 'all';
    window.colorMode = 'sport';

    // DOM elements
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const pageTitle = document.getElementById('pageTitle');
    const pageContent = document.getElementById('pageContent');
    const logoutBtn = document.getElementById('logoutBtn');
    const adminName = document.getElementById('adminName');
    const adminEmail = document.getElementById('adminEmail');
    const adminAvatar = document.getElementById('adminAvatar');

    // Authentication state listener
    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        adminName.textContent = user.displayName || "Admin";
        adminEmail.textContent = user.email || "No email";

        if (user.photoURL) {
          adminAvatar.src = user.photoURL;
        }

        // Load admin facilities and dashboard data
        loadAdminFacilities().then(() => {
          // Check if there's a saved page in localStorage
          const savedPage = localStorage.getItem('currentAdminPage');
          if (savedPage && savedPage !== 'dashboard') {
            // Navigate to the saved page
            navigateToPage(savedPage);
          } else {
            // Load dashboard by default
            loadDashboardData();
          }
        });

        // Reset inactivity timer
        resetInactivityTimer();
      } else {
        window.location.href = "login.html";
      }
    });

    // Navigate to a specific page
    function navigateToPage(page) {
      // Update active menu item
      document.querySelectorAll('.sidebar-menu a').forEach(a => {
        a.classList.remove('active');
        if (a.getAttribute('data-page') === page) {
          a.classList.add('active');
        }
      });

      // Update page title and content
      pageTitle.textContent = document.querySelector(`.sidebar-menu a[data-page="${page}"] .sidebar-text`).textContent;
      currentPage = page;
      localStorage.setItem('currentAdminPage', page);

      // Load page content
      loadPageContent(page);
    }

    // Load admin facilities - FIXED VERSION
    async function loadAdminFacilities() {
      try {
        const facilitiesSnapshot = await db.collection("facilities")
          .where("userId", "==", currentUser.uid) // Changed from adminId to userId
          .get();

        adminFacilities = [];
        facilitiesSnapshot.forEach(doc => {
          adminFacilities.push({ id: doc.id, ...doc.data() });
        });

        console.log(`Loaded ${adminFacilities.length} facilities for user ${currentUser.uid}`);
      } catch (error) {
        console.error("Error loading admin facilities:", error);
        showToast('Error loading facilities', 'danger');
      }
    }

    // Sidebar toggle functionality
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      mainContent.classList.toggle('expanded');

      // Change icon based on state
      if (sidebar.classList.contains('collapsed')) {
        sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
      } else {
        sidebarToggle.innerHTML = '<i class="fas fa-times"></i>';
      }
    });

    // Page navigation
    document.querySelectorAll('.sidebar-menu a').forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();

        // Get page name from data attribute
        const page = this.getAttribute('data-page');
        navigateToPage(page);
      });
    });

    // Logout function - FIXED VERSION
    logoutBtn.addEventListener('click', async () => {
      if (isLoggingOut) return;
      isLoggingOut = true;

      try {
        await auth.signOut();
        // Clear saved page from localStorage
        localStorage.removeItem('currentAdminPage');
        window.location.href = "login.html";
      } catch (error) {
        console.error("Logout error:", error);
        window.location.href = "login.html";
      }
    });

    // Inactivity timer
    function resetInactivityTimer() {
      clearTimeout(inactivityTimer);
      inactivityTimer = setTimeout(() => {
        if (currentUser && !isLoggingOut) {
          showToast('Session expired due to inactivity', 'warning');
          logoutBtn.click();
        }
      }, 30 * 60 * 1000); // 30 minutes
    }

    // Events that reset the inactivity timer
    ['mousemove', 'keypress', 'click', 'scroll'].forEach(event => {
      document.addEventListener(event, resetInactivityTimer);
    });

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');

      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;

      document.getElementById('toastContainer').appendChild(toast);

      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();

      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    // Load dashboard data - FIXED VERSION
    async function loadDashboardData() {
      try {
        // Get facility IDs for this admin
        const facilityIds = adminFacilities.map(f => f.id);

        if (facilityIds.length === 0) {
          document.getElementById('totalBookings').textContent = '0';
          document.getElementById('totalCustomers').textContent = '0';
          document.getElementById('totalRevenue').textContent = 'RM0';
          document.getElementById('totalFacilities').textContent = '0';
          document.getElementById('recentBookings').innerHTML = '<tr><td colspan="5" class="text-center">No facilities found</td></tr>';
          return;
        }

        // Fetch bookings for admin's facilities
        const bookingsSnapshot = await db.collection("bookings")
          .where("facilityId", "in", facilityIds)
          .get();

        const totalBookings = bookingsSnapshot.size;
        document.getElementById('totalBookings').textContent = totalBookings;

        // Calculate unique customers (users who booked admin's facilities)
        const customerIds = new Set();
        bookingsSnapshot.forEach(doc => {
          const booking = doc.data();
          if (booking.userId) {
            customerIds.add(booking.userId);
          }
        });
        document.getElementById('totalCustomers').textContent = customerIds.size;

        // Calculate revenue from admin's facilities
        let totalRevenue = 0;
        bookingsSnapshot.forEach(doc => {
          const booking = doc.data();
          if (booking.price) {
            totalRevenue += parseFloat(booking.price);
          }
        });
        document.getElementById('totalRevenue').textContent = `RM${totalRevenue.toFixed(2)}`;

        // Total facilities
        document.getElementById('totalFacilities').textContent = adminFacilities.length;

        // Load recent bookings
        const recentBookingsBody = document.getElementById('recentBookings');
        recentBookingsBody.innerHTML = '';

        if (bookingsSnapshot.empty) {
          recentBookingsBody.innerHTML = '<tr><td colspan="5" class="text-center">No bookings found</td></tr>';
        } else {
          // Get last 5 bookings
          const recentBookings = [];
          bookingsSnapshot.forEach(doc => {
            recentBookings.push({ id: doc.id, ...doc.data() });
          });

          // Sort by timestamp (newest first) and take first 5
          recentBookings.sort((a, b) => {
            const timeA = a.timestamp ? a.timestamp.toDate() : new Date(0);
            const timeB = b.timestamp ? b.timestamp.toDate() : new Date(0);
            return timeB - timeA;
          }).slice(0, 5).forEach(booking => {
            const tr = document.createElement('tr');
            const date = booking.date ? booking.date.toDate().toLocaleString() : 'N/A';
            const time = booking.slots || 'N/A';
            const status = booking.status || 'pending';

            tr.innerHTML = `
              <td>${booking.userEmail || 'Unknown User'}</td>
              <td>${booking.facilityName || 'Unknown Facility'}</td>
              <td>${date}</td>
              <td>${time}</td>
              <td><span class="badge badge-status badge-${status}">${status}</span></td>
            `;
            recentBookingsBody.appendChild(tr);
          });
        }

        // Initialize revenue chart
        initRevenueChart(bookingsSnapshot);

      } catch (error) {
        console.error("Error loading dashboard data:", error);
        showToast('Error loading dashboard data', 'danger');
      }
    }

    // Initialize revenue chart with fixed size
    function initRevenueChart(bookingsSnapshot) {
      const ctx = document.getElementById('revenueChart').getContext('2d');

      // Calculate monthly revenue
      const monthlyRevenue = {};
      bookingsSnapshot.forEach(doc => {
        const booking = doc.data();
        if (booking.timestamp) {
          const month = booking.timestamp.toDate().toLocaleString('default', { month: 'short' });
          const price = parseFloat(booking.price) || 0;

          if (monthlyRevenue[month]) {
            monthlyRevenue[month] += price;
          } else {
            monthlyRevenue[month] = price;
          }
        }
      });

      const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
      const revenueData = months.map(month => monthlyRevenue[month] || 0);

      // Create chart with fixed size
      new Chart(ctx, {
        type: 'line',
        data: {
          labels: months,
          datasets: [{
            label: 'Revenue (RM)',
            data: revenueData,
            borderColor: '#4361ee',
            backgroundColor: 'rgba(67, 97, 238, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: false
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              grid: {
                drawBorder: false
              }
            },
            x: {
              grid: {
                display: false
              }
            }
          }
        }
      });
    }

    // Load page content based on selection
    async function loadPageContent(page) {
      try {
        let content = '';

        switch (page) {
          case 'dashboard':
            content = await loadDashboardPage();
            break;
          case 'facility-management':
            content = await loadFacilityManagementPage();
            break;
          case 'booking-management':
            content = await loadBookingManagementPage();
            break;
          case 'user-management':
            content = await loadUserManagementPage();
            break;
          case 'coach-management':
            content = await loadCoachManagementPage();
            break;
          case 'payment-finance':
            content = await loadPaymentFinancePage();
            break;
          case 'calendar-scheduling':
            content = await loadCalendarSchedulingPage();
            break;
          case 'ai-insights':
            content = await loadAIInsightsPage();
            break;
          case 'notifications':
            content = await loadNotificationsPage();
            break;
          case 'promo-vouchers':
            content = await loadPromoVouchersPage();
            break;
          case 'events-tournaments':
            content = await loadEventsTournamentsPage();
            break;
          case 'marketplace':
            content = await loadMarketplacePage();
            break;
          case 'settings':
            content = await loadSettingsPage();
            break;
          case 'reports':
            content = await loadReportsPage();
            break;
          default:
            content = '<div class="alert alert-info">Page under development</div>';
        }

        pageContent.innerHTML = content;

        // Initialize any page-specific functionality
        initializePageFunctionality(page);

      } catch (error) {
        console.error(`Error loading ${page} page:`, error);
        pageContent.innerHTML = '<div class="alert alert-danger">Error loading page content</div>';
      }
    }

    // Page content loaders - Implementing all functionality
    async function loadDashboardPage() {
      // Return the dashboard HTML structure
      return `
    <div class="row">
      <div class="col-md-3">
        <div class="stats-card">
          <i class="fas fa-calendar-check"></i>
          <div class="number" id="totalBookings">0</div>
          <div class="label">Total Bookings</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <i class="fas fa-users"></i>
          <div class="number" id="totalCustomers">0</div>
          <div class="label">Total Customers</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <i class="fas fa-dollar-sign"></i>
          <div class="number" id="totalRevenue">RM0</div>
          <div class="label">Total Revenue</div>
        </div>
      </div>
      <div class="col-md-3">
        <div class="stats-card">
          <i class="fas fa-building"></i>
          <div class="number" id="totalFacilities">0</div>
          <div class="label">Total Facilities</div>
        </div>
      </div>
    </div>

    <div class="row mt-4">
      <div class="col-md-8">
        <div class="table-card">
          <h4>Recent Bookings</h4>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Facility</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="recentBookings">
              </tbody>
            </table>
          </div>
        </div>
      </div>
      <div class="col-md-4">
        <div class="table-card">
          <h4>Revenue Chart</h4>
          <div class="chart-container">
            <canvas id="revenueChart"></canvas>
          </div>
        </div>
      </div>
    </div>
  `;
    }

    async function loadFacilityManagementPage() {
      let facilitiesHTML = '';

      if (adminFacilities.length === 0) {
        facilitiesHTML = '<tr><td colspan="6" class="text-center py-4">No facilities found</td></tr>';
      } else {
        adminFacilities.forEach(facility => {
          facilitiesHTML += `
            <tr>
              <td>${facility.name || 'N/A'}</td>
              <td>${facility.type || 'N/A'}</td>
              <td>${facility.location || 'N/A'}</td>
              <td>RM${facility.price || '0'}</td>
              <td>${facility.status || 'Active'}</td>
              <td>
    <div class="btn-group" role="group">
        <button class="btn btn-sm btn-primary" onclick="editFacility('${facility.id}')" title="Edit Facility">
            <i class="fas fa-edit"></i>
        </button>
        <button class="btn btn-sm btn-info" onclick="viewFacilityDetails('${facility.id}')" title="View Details">
            <i class="fas fa-eye"></i>
        </button>
        <button class="btn btn-sm btn-danger" onclick="deleteFacility('${facility.id}')" title="Delete Facility">
            <i class="fas fa-trash"></i>
        </button>
    </div>
</td>
            </tr>
          `;
        });
      }

      return `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>Facility Management</h3>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addFacilityModal">
            <i class="fas fa-plus me-1"></i> Add New Facility
          </button>
        </div>
        
        <div class="table-card">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Facility Name</th>
                  <th>Type</th>
                  <th>Location</th>
                  <th>Price</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${facilitiesHTML}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Add Facility Modal -->
        <div class="modal fade" id="addFacilityModal" tabindex="-1">
          <div class="modal-dialog modal-lg">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add New Facility</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="addFacilityForm">
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label">Facility Name</label>
                        <input type="text" class="form-control" name="name" required>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label">Type</label>
                        <select class="form-select" name="type" required>
                          <option value="">Select Type</option>
                          <option value="Badminton Court">Badminton Court</option>
                          <option value="Basketball Court">Basketball Court</option>
                          <option value="Tennis Court">Tennis Court</option>
                          <option value="Swimming Pool">Swimming Pool</option>
                          <option value="Football Field">Football Field</option>
                          <option value="Gym">Gym</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label">Location</label>
                        <input type="text" class="form-control" name="location" required>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label">Price (RM)</label>
                        <input type="number" class="form-control" name="price" min="0" step="0.01" required>
                      </div>
                    </div>
                  </div>
                  
                  <div class="row">
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label">Capacity</label>
                        <input type="number" class="form-control" name="capacity" min="1" required>
                      </div>
                    </div>
                    <div class="col-md-6">
                      <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-select" name="status" required>
                          <option value="Active">Active</option>
                          <option value="Inactive">Inactive</option>
                          <option value="Maintenance">Under Maintenance</option>
                        </select>
                      </div>
                    </div>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" name="description" rows="3"></textarea>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Image URL</label>
                    <input type="url" class="form-control" name="imageUrl" placeholder="https://example.com/image.jpg">
                    <small class="form-text text-muted">Provide a direct link to the facility image</small>
                  </div>
                  
                  <div class="form-group">
                    <label class="form-label">Amenities</label>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="amenities" value="Parking" id="parking">
                      <label class="form-check-label" for="parking">Parking</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="amenities" value="Showers" id="showers">
                      <label class="form-check-label" for="showers">Showers</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="amenities" value="Changing Rooms" id="changingRooms">
                      <label class="form-check-label" for="changingRooms">Changing Rooms</label>
                    </div>
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" name="amenities" value="Equipment Rental" id="equipmentRental">
                      <label class="form-check-label" for="equipmentRental">Equipment Rental</label>
                    </div>
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveFacility()">Save Facility</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadBookingManagementPage() {
      // Fetch bookings for admin's facilities
      const facilityIds = adminFacilities.map(f => f.id);
      let bookings = [];

      if (facilityIds.length > 0) {
        const bookingsSnapshot = await db.collection("bookings")
          .where("facilityId", "in", facilityIds)
          .get();

        bookingsSnapshot.forEach(doc => {
          bookings.push({ id: doc.id, ...doc.data() });
        });
      }

      let bookingsHTML = '';

      if (bookings.length === 0) {
        bookingsHTML = '<tr><td colspan="7" class="text-center py-4">No bookings found</td></tr>';
      } else {
        bookings.forEach(booking => {
          const date = booking.date ? booking.date.toDate().toLocaleString() : 'N/A';
          const time = booking.slots || 'N/A';
          const status = booking.status || 'pending';

          bookingsHTML += `
            <tr>
              <td>${booking.userEmail || 'Unknown User'}</td>
              <td>${booking.facilityName || 'Unknown Facility'}</td>
              <td>${date}</td>
              <td>${time}</td>
              <td>RM${booking.price || '0'}</td>
              <td><span class="badge badge-status badge-${status}">${status}</span></td>
              <td>
                <button class="btn btn-sm btn-primary me-1" onclick="viewBooking('${booking.id}')">View</button>
                ${status === 'pending' ? `
                  <button class="btn btn-sm btn-success me-1" onclick="updateBookingStatus('${booking.id}', 'approved')">Approve</button>
                  <button class="btn btn-sm btn-danger" onclick="updateBookingStatus('${booking.id}', 'cancelled')">Cancel</button>
                ` : ''}
              </td>
            </tr>
          `;
        });
      }

      return `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>Booking Management</h3>
          <div class="d-flex">
            <div class="input-group me-2" style="width: 300px;">
              <input type="text" class="form-control" placeholder="Search bookings..." id="bookingSearch">
              <button class="btn btn-outline-primary" type="button" id="bookingSearchBtn">
                <i class="fas fa-search"></i>
              </button>
            </div>
            <button class="btn btn-primary" onclick="exportBookings()">
              <i class="fas fa-download me-1"></i> Export
            </button>
          </div>
        </div>
        
        <div class="table-card">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Facility</th>
                  <th>Date</th>
                  <th>Time</th>
                  <th>Amount</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="bookingsTableBody">
                ${bookingsHTML}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    async function loadUserManagementPage() {
      try {
        // Get facility IDs for this admin
        const facilityIds = adminFacilities.map(f => f.id);

        let users = [];

        if (facilityIds.length > 0) {
          // Fetch bookings for admin's facilities to get user IDs
          const bookingsSnapshot = await db.collection("bookings")
            .where("facilityId", "in", facilityIds)
            .get();

          // Extract unique user IDs from bookings
          const userIds = [...new Set(bookingsSnapshot.docs.map(doc => doc.data().userId))];

          if (userIds.length > 0) {
            // Fetch only users who have booked admin's facilities
            const usersSnapshot = await db.collection("users")
              .where(firebase.firestore.FieldPath.documentId(), 'in', userIds)
              .get();

            usersSnapshot.forEach(doc => {
              users.push({ id: doc.id, ...doc.data() });
            });

            // Enrich user data with booking information
            users = await enrichUserData(users, bookingsSnapshot);
          }
        }

        let usersHTML = '';

        if (users.length === 0) {
          usersHTML = `
        <tr>
          <td colspan="7" class="text-center py-4">
            <div class="text-muted">
              <i class="fas fa-users fa-2x mb-3"></i>
              <p>No users have booked your facilities yet</p>
              <small>Users will appear here once they make bookings</small>
            </div>
          </td>
        </tr>
      `;
        } else {
          users.forEach(user => {
            const lastBooking = user.lastBookingDate ?
              new Date(user.lastBookingDate).toLocaleDateString() : 'No bookings';
            const totalSpent = user.totalSpent ? `RM${user.totalSpent.toFixed(2)}` : 'RM0';

            usersHTML += `
          <tr>
            <td>
              <div class="d-flex align-items-center">
                <img src="${user.photoURL || 'https://via.placeholder.com/40'}" 
                     class="user-avatar me-3" alt="${user.name}">
                <div>
                  <div class="fw-semibold">${user.name || 'N/A'}</div>
                  <small class="text-muted">${user.email || 'N/A'}</small>
                </div>
              </div>
            </td>
            <td>${user.phone || 'N/A'}</td>
            <td>${user.membership || 'Regular'}</td>
            <td>${user.totalBookings || 0}</td>
            <td>${totalSpent}</td>
            <td>${lastBooking}</td>
            <td>
              <div class="btn-group" role="group">
              <button class="btn btn-sm btn-primary me-1" onclick="viewUser('${user.id}')" title="View Details">
              <i class="fas fa-eye"></i>
              </button>
              <button class="btn btn-sm btn-warning me-1" onclick="editUser('${user.id}')" title="Edit User">
              <i class="fas fa-edit"></i>
              </button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser('${user.id}')" title="Delete User">
              <i class="fas fa-trash"></i>
              </button>
              </div>
            </td>
          </tr>
        `;
          });
        }

        return `
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>User Management</h3>
        <div class="d-flex">
          <div class="input-group me-2" style="width: 300px;">
            <input type="text" class="form-control" placeholder="Search users..." id="userSearch">
            <button class="btn btn-outline-primary" type="button" id="userSearchBtn">
              <i class="fas fa-search"></i>
            </button>
          </div>
          <button class="btn btn-primary" onclick="exportUsers()">
            <i class="fas fa-download me-1"></i> Export
          </button>
        </div>
      </div>
      
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-users"></i>
            <div class="number">${users.length}</div>
            <div class="label">Total Customers</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-calendar-check"></i>
            <div class="number">${users.reduce((sum, user) => sum + (user.totalBookings || 0), 0)}</div>
            <div class="label">Total Bookings</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-dollar-sign"></i>
            <div class="number">RM${users.reduce((sum, user) => sum + (user.totalSpent || 0), 0).toFixed(2)}</div>
            <div class="label">Total Revenue</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-crown"></i>
            <div class="number">${users.filter(user => user.membership === 'Premium' || user.membership === 'VIP').length}</div>
            <div class="label">Premium Users</div>
          </div>
        </div>
      </div>
      
      <div class="table-card">
        <h4>Customers Who Booked Your Facilities</h4>
        <div class="table-responsive">
          <table class="table table-hover">
            <thead>
              <tr>
                <th>User</th>
                <th>Phone</th>
                <th>Membership</th>
                <th>Bookings</th>
                <th>Total Spent</th>
                <th>Last Booking</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody">
              ${usersHTML}
            </tbody>
          </table>
        </div>
      </div>
      
      <!-- Add User Modal -->
      <div class="modal fade" id="addUserModal" tabindex="-1">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Add New User</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <form id="addUserForm">
                <div class="form-group">
                  <label class="form-label">Full Name</label>
                  <input type="text" class="form-control" name="name" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Email</label>
                  <input type="email" class="form-control" name="email" required>
                </div>
                <div class="form-group">
                  <label class="form-label">Phone</label>
                  <input type="tel" class="form-control" name="phone">
                </div>
                <div class="form-group">
                  <label class="form-label">Membership</label>
                  <select class="form-select" name="membership">
                    <option value="Regular">Regular</option>
                    <option value="Premium">Premium</option>
                    <option value="VIP">VIP</option>
                  </select>
                </div>
                <div class="form-group">
                  <label class="form-label">Status</label>
                  <select class="form-select" name="status">
                    <option value="Active">Active</option>
                    <option value="Inactive">Inactive</option>
                  </select>
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
              <button type="button" class="btn btn-primary" onclick="saveUser()">Save User</button>
            </div>
          </div>
        </div>
      </div>
    `;
      } catch (error) {
        console.error("Error loading user management page:", error);
        return `
      <div class="alert alert-danger">
        <h4>Error Loading Users</h4>
        <p>There was an error loading user data. Please try again.</p>
        <button class="btn btn-primary mt-2" onclick="loadPageContent('user-management')">
          <i class="fas fa-redo me-1"></i> Retry
        </button>
      </div>
    `;
      }
    }

    // Helper function to enrich user data with booking statistics
    async function enrichUserData(users, bookingsSnapshot) {
      const userBookingsMap = {};

      // Group bookings by user
      bookingsSnapshot.forEach(doc => {
        const booking = doc.data();
        const userId = booking.userId;

        if (!userBookingsMap[userId]) {
          userBookingsMap[userId] = {
            bookings: [],
            totalSpent: 0
          };
        }

        userBookingsMap[userId].bookings.push(booking);
        if (booking.price) {
          userBookingsMap[userId].totalSpent += parseFloat(booking.price);
        }
      });

      // Enrich user data with booking statistics
      return users.map(user => {
        const userStats = userBookingsMap[user.id] || { bookings: [], totalSpent: 0 };
        const sortedBookings = userStats.bookings.sort((a, b) => {
          const timeA = a.timestamp ? a.timestamp.toDate() : new Date(0);
          const timeB = b.timestamp ? b.timestamp.toDate() : new Date(0);
          return timeB - timeA;
        });

        return {
          ...user,
          totalBookings: userStats.bookings.length,
          totalSpent: userStats.totalSpent,
          lastBookingDate: sortedBookings.length > 0 ?
            (sortedBookings[0].timestamp ? sortedBookings[0].timestamp.toDate() : null) : null
        };
      });
    }

    // View user details - FIXED VERSION with profile picture
    async function viewUser(userId) {
      try {
        // Fetch user details
        const userDoc = await db.collection('users').doc(userId).get();
        const user = userDoc.data();

        // Fetch user's bookings for admin's facilities
        const facilityIds = adminFacilities.map(f => f.id);
        let userBookings = [];

        if (facilityIds.length > 0) {
          const bookingsSnapshot = await db.collection('bookings')
            .where('userId', '==', userId)
            .where('facilityId', 'in', facilityIds)
            .get();

          bookingsSnapshot.forEach(doc => {
            userBookings.push({ id: doc.id, ...doc.data() });
          });
        }

        // Calculate user statistics
        const totalBookings = userBookings.length;
        const totalSpent = userBookings.reduce((sum, booking) => sum + parseFloat(booking.price || 0), 0);
        const lastBooking = userBookings.length > 0 ?
          userBookings.sort((a, b) => {
            const timeA = a.timestamp ? a.timestamp.toDate() : new Date(0);
            const timeB = b.timestamp ? b.timestamp.toDate() : new Date(0);
            return timeB - timeA;
          })[0] : null;

        // Create modal content with FIXED profile picture
        const modalContent = `
            <div class="modal fade" id="viewUserModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">User Details: ${user.name || 'N/A'}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="text-center mb-4">
                                        <!-- FIXED: Proper profile picture handling -->
                                        <img src="${user.photoURL || 'https://via.placeholder.com/150x150?text=No+Image'}" 
                                             alt="${user.name || 'User'}" 
                                             class="img-fluid rounded-circle mb-3" 
                                             style="width: 150px; height: 150px; object-fit: cover; border: 3px solid #4361ee;"
                                             onerror="this.src='https://via.placeholder.com/150x150?text=No+Image'">
                                        <h4>${user.name || 'N/A'}</h4>
                                        <p class="text-muted">${user.membership || 'Regular'} Member</p>
                                        <span class="badge ${user.status === 'Active' ? 'bg-success' : user.status === 'Suspended' ? 'bg-danger' : 'bg-secondary'}">
                                            ${user.status || 'Active'}
                                        </span>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                                </div>
                                                <div class="card-body">
                                                    <p><strong>Email:</strong> ${user.email || 'N/A'}</p>
                                                    <p><strong>Phone:</strong> ${user.phone || 'N/A'}</p>
                                                    <p><strong>Member Since:</strong> ${user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'N/A'}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-header bg-success text-white">
                                                    <h6 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Booking Statistics</h6>
                                                </div>
                                                <div class="card-body">
                                                    <p><strong>Total Bookings:</strong> ${totalBookings}</p>
                                                    <p><strong>Total Spent:</strong> RM${totalSpent.toFixed(2)}</p>
                                                    <p><strong>Last Booking:</strong> ${lastBooking ? lastBooking.date.toDate().toLocaleString() : 'No bookings'}</p>
                                                    <p><strong>Avg. per Booking:</strong> RM${totalBookings > 0 ? (totalSpent / totalBookings).toFixed(2) : '0'}</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${user.notes ? `
                                        <div class="card mb-3">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0"><i class="fas fa-sticky-note me-2"></i>Additional Notes</h6>
                                            </div>
                                            <div class="card-body">
                                                <p class="mb-0">${user.notes}</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            ${userBookings.length > 0 ? `
                                <div class="mt-4">
                                    <h5>Recent Bookings</h5>
                                    <div class="table-responsive">
                                        <table class="table table-sm table-hover">
                                            <thead>
                                                <tr>
                                                    <th>Facility</th>
                                                    <th>Date</th>
                                                    <th>Time</th>
                                                    <th>Amount</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${userBookings.slice(0, 5).map(booking => `
                                                    <tr>
                                                        <td>${booking.facilityName || 'N/A'}</td>
                                                        <td>${booking.date.toDate().toLocaleString() || 'N/A'}</td>
                                                        <td>${booking.slots || 'N/A'}</td>
                                                        <td>RM${parseFloat(booking.price || 0).toFixed(2)}</td>
                                                        <td>
                                                            <span class="badge badge-status badge-${booking.status || 'pending'}">
                                                                ${booking.status || 'Pending'}
                                                            </span>
                                                        </td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            ` : `
                                <div class="alert alert-info mt-4">
                                    <i class="fas fa-info-circle me-2"></i>
                                    This user hasn't made any bookings at your facilities yet.
                                </div>
                            `}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-warning" onclick="editUser('${userId}')">
                                <i class="fas fa-edit me-1"></i> Edit User
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Add modal to page and show it
        document.body.insertAdjacentHTML('beforeend', modalContent);
        const modal = new bootstrap.Modal(document.getElementById('viewUserModal'));
        modal.show();

        // Remove modal from DOM when hidden
        document.getElementById('viewUserModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });

      } catch (error) {
        console.error('Error viewing user:', error);
        showToast('Error loading user details', 'danger');
      }
    }

    // Comprehensive Export Functionality
    function exportToCSV(data, filename, headers) {
      if (!data || data.length === 0) {
        showToast('No data to export', 'warning');
        return;
      }

      try {
        // Prepare CSV content
        let csvContent = '';

        // Add headers
        if (headers && headers.length > 0) {
          csvContent += headers.join(',') + '\n';
        } else {
          // Auto-generate headers from first object
          const firstRow = data[0];
          const autoHeaders = Object.keys(firstRow);
          csvContent += autoHeaders.join(',') + '\n';
        }

        // Add data rows
        data.forEach(row => {
          const values = Object.values(row).map(value => {
            // Handle values that might contain commas or quotes
            if (value === null || value === undefined) return '';
            const stringValue = String(value);
            // Escape quotes and wrap in quotes if contains comma or quote
            if (stringValue.includes(',') || stringValue.includes('"') || stringValue.includes('\n')) {
              return '"' + stringValue.replace(/"/g, '""') + '"';
            }
            return stringValue;
          });
          csvContent += values.join(',') + '\n';
        });

        // Create and trigger download
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);

        link.setAttribute('href', url);
        link.setAttribute('download', filename);
        link.style.visibility = 'hidden';

        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);

        showToast(`Exported ${data.length} records successfully`, 'success');

      } catch (error) {
        console.error('Export error:', error);
        showToast('Error exporting data', 'danger');
      }
    }

    // Export Bookings
    async function exportBookings() {
      try {
        const facilityIds = adminFacilities.map(f => f.id);
        let bookings = [];

        if (facilityIds.length > 0) {
          const bookingsSnapshot = await db.collection("bookings")
            .where("facilityId", "in", facilityIds)
            .get();

          bookingsSnapshot.forEach(doc => {
            const booking = doc.data();
            bookings.push({
              'Booking ID': doc.id,
              'User Name': booking.userName || 'Unknown',
              'User Email': booking.userEmail || 'Unknown',
              'Facility Name': booking.facilityName || 'Unknown',
              'Date': booking.date || 'N/A',
              'Time Slot': booking.slot || 'N/A',
              'Price': `RM${booking.price || '0'}`,
              'Status': booking.status || 'pending',
              'Payment Method': booking.paymentMethod || 'Online',
              'Booking Date': booking.timestamp ? booking.timestamp.toDate().toLocaleString() : 'N/A',
              'Duration': booking.duration || '1 hour'
            });
          });
        }

        const headers = ['Booking ID', 'User Name', 'User Email', 'Facility Name', 'Date', 'Time Slot', 'Price', 'Status', 'Payment Method', 'Booking Date', 'Duration'];
        exportToCSV(bookings, `bookings_export_${new Date().toISOString().split('T')[0]}.csv`, headers);

      } catch (error) {
        console.error('Error exporting bookings:', error);
        showToast('Error exporting bookings data', 'danger');
      }
    }

    // Export Users
    async function exportUsers() {
      try {
        const facilityIds = adminFacilities.map(f => f.id);
        let users = [];

        if (facilityIds.length > 0) {
          // Get user IDs from bookings
          const bookingsSnapshot = await db.collection("bookings")
            .where("facilityId", "in", facilityIds)
            .get();

          const userIds = [...new Set(bookingsSnapshot.docs.map(doc => doc.data().userId))];

          if (userIds.length > 0) {
            const usersSnapshot = await db.collection("users")
              .where(firebase.firestore.FieldPath.documentId(), 'in', userIds)
              .get();

            // Enrich user data with booking statistics
            const userBookingsMap = {};
            bookingsSnapshot.forEach(doc => {
              const booking = doc.data();
              const userId = booking.userId;
              if (!userBookingsMap[userId]) {
                userBookingsMap[userId] = {
                  totalBookings: 0,
                  totalSpent: 0,
                  lastBooking: null
                };
              }
              userBookingsMap[userId].totalBookings++;
              if (booking.price) {
                userBookingsMap[userId].totalSpent += parseFloat(booking.price);
              }
              if (booking.timestamp) {
                const bookingDate = booking.timestamp.toDate();
                if (!userBookingsMap[userId].lastBooking || bookingDate > userBookingsMap[userId].lastBooking) {
                  userBookingsMap[userId].lastBooking = bookingDate;
                }
              }
            });

            usersSnapshot.forEach(doc => {
              const user = doc.data();
              const userStats = userBookingsMap[doc.id] || { totalBookings: 0, totalSpent: 0, lastBooking: null };

              users.push({
                'User ID': doc.id,
                'Name': user.name || 'N/A',
                'Email': user.email || 'N/A',
                'Phone': user.phone || 'N/A',
                'Membership': user.membership || 'Regular',
                'Status': user.status || 'Active',
                'Total Bookings': userStats.totalBookings,
                'Total Spent': `RM${userStats.totalSpent.toFixed(2)}`,
                'Last Booking': userStats.lastBooking ? userStats.lastBooking.toLocaleDateString() : 'No bookings',
                'Registration Date': user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'N/A'
              });
            });
          }
        }

        const headers = ['User ID', 'Name', 'Email', 'Phone', 'Membership', 'Status', 'Total Bookings', 'Total Spent', 'Last Booking', 'Registration Date'];
        exportToCSV(users, `users_export_${new Date().toISOString().split('T')[0]}.csv`, headers);

      } catch (error) {
        console.error('Error exporting users:', error);
        showToast('Error exporting users data', 'danger');
      }
    }

    // Export Payments
    async function exportPayments() {
      try {
        const facilityIds = adminFacilities.map(f => f.id);
        let payments = [];

        if (facilityIds.length > 0) {
          const bookingsSnapshot = await db.collection("bookings")
            .where("facilityId", "in", facilityIds)
            .where("status", "in", ["approved", "completed"])
            .get();

          bookingsSnapshot.forEach(doc => {
            const booking = doc.data();
            if (booking.price) {
              payments.push({
                'Payment ID': doc.id,
                'User Name': booking.userName || 'Unknown',
                'Facility Name': booking.facilityName || 'Unknown',
                'Date': booking.date || 'N/A',
                'Time': booking.slot || 'N/A',
                'Amount': `RM${parseFloat(booking.price).toFixed(2)}`,
                'Status': booking.status || 'approved',
                'Payment Method': booking.paymentMethod || 'Online',
                'Transaction Date': booking.timestamp ? booking.timestamp.toDate().toLocaleString() : 'N/A',
                'Duration': booking.duration || '1 hour'
              });
            }
          });
        }

        const headers = ['Payment ID', 'User Name', 'Facility Name', 'Date', 'Time', 'Amount', 'Status', 'Payment Method', 'Transaction Date', 'Duration'];
        exportToCSV(payments, `payments_export_${new Date().toISOString().split('T')[0]}.csv`, headers);

      } catch (error) {
        console.error('Error exporting payments:', error);
        showToast('Error exporting payments data', 'danger');
      }
    }

    // Export Facilities
    async function exportFacilities() {
      try {
        const facilitiesData = adminFacilities.map(facility => ({
          'Facility ID': facility.id,
          'Name': facility.name || 'N/A',
          'Type': facility.type || 'N/A',
          'Location': facility.location || 'N/A',
          'Price': `RM${facility.price || '0'}`,
          'Capacity': facility.capacity || 'N/A',
          'Status': facility.status || 'Active',
          'Description': facility.description || '',
          'Amenities': facility.amenities ? facility.amenities.join('; ') : '',
          'Created Date': facility.createdAt ? facility.createdAt.toDate().toLocaleDateString() : 'N/A'
        }));

        const headers = ['Facility ID', 'Name', 'Type', 'Location', 'Price', 'Capacity', 'Status', 'Description', 'Amenities', 'Created Date'];
        exportToCSV(facilitiesData, `facilities_export_${new Date().toISOString().split('T')[0]}.csv`, headers);

      } catch (error) {
        console.error('Error exporting facilities:', error);
        showToast('Error exporting facilities data', 'danger');
      }
    }

    // Export Report Data
    async function exportReportData() {
      try {
        const facilityIds = adminFacilities.map(f => f.id);
        let reportData = [];

        if (facilityIds.length > 0) {
          const bookingsSnapshot = await db.collection("bookings")
            .where("facilityId", "in", facilityIds)
            .get();

          // Generate monthly report
          const monthlyData = {};
          const facilityStats = {};
          const statusCount = { approved: 0, pending: 0, cancelled: 0 };

          bookingsSnapshot.forEach(doc => {
            const booking = doc.data();

            // Monthly data
            if (booking.timestamp) {
              const month = booking.timestamp.toDate().toLocaleString('default', { month: 'short', year: 'numeric' });
              if (!monthlyData[month]) {
                monthlyData[month] = { bookings: 0, revenue: 0 };
              }
              monthlyData[month].bookings++;
              if (booking.price) {
                monthlyData[month].revenue += parseFloat(booking.price);
              }
            }

            // Facility stats
            const facilityName = booking.facilityName || 'Unknown';
            if (!facilityStats[facilityName]) {
              facilityStats[facilityName] = { bookings: 0, revenue: 0 };
            }
            facilityStats[facilityName].bookings++;
            if (booking.price) {
              facilityStats[facilityName].revenue += parseFloat(booking.price);
            }

            // Status count
            const status = booking.status || 'pending';
            statusCount[status] = (statusCount[status] || 0) + 1;
          });

          // Convert to array format for CSV
          Object.keys(monthlyData).forEach(month => {
            reportData.push({
              'Report Type': 'Monthly Summary',
              'Period': month,
              'Total Bookings': monthlyData[month].bookings,
              'Total Revenue': `RM${monthlyData[month].revenue.toFixed(2)}`,
              'Average per Booking': `RM${(monthlyData[month].revenue / monthlyData[month].bookings).toFixed(2)}`
            });
          });

          Object.keys(facilityStats).forEach(facility => {
            reportData.push({
              'Report Type': 'Facility Performance',
              'Facility Name': facility,
              'Total Bookings': facilityStats[facility].bookings,
              'Total Revenue': `RM${facilityStats[facility].revenue.toFixed(2)}`,
              'Utilization Rate': `${((facilityStats[facility].bookings / (30 * adminFacilities.length)) * 100).toFixed(1)}%`
            });
          });

          Object.keys(statusCount).forEach(status => {
            reportData.push({
              'Report Type': 'Booking Status',
              'Status': status.charAt(0).toUpperCase() + status.slice(1),
              'Count': statusCount[status],
              'Percentage': `${((statusCount[status] / bookingsSnapshot.size) * 100).toFixed(1)}%`
            });
          });
        }

        const headers = ['Report Type', 'Period/Facility/Status', 'Total Bookings', 'Total Revenue', 'Additional Info'];
        exportToCSV(reportData, `comprehensive_report_${new Date().toISOString().split('T')[0]}.csv`, headers);

      } catch (error) {
        console.error('Error exporting report data:', error);
        showToast('Error exporting report data', 'danger');
      }
    }

    // Generate PDF Report (Placeholder - would need a PDF library)
    function generatePDFReport() {
      showToast('PDF report generation would require additional libraries like jsPDF', 'info');
      // This would require integrating a PDF library like jsPDF
      // For now, we'll just show a message
    }

    // Quick Export Dashboard Data
    async function exportDashboardData() {
      try {
        const facilityIds = adminFacilities.map(f => f.id);
        let dashboardData = [];

        if (facilityIds.length > 0) {
          const bookingsSnapshot = await db.collection("bookings")
            .where("facilityId", "in", facilityIds)
            .get();

          const totalBookings = bookingsSnapshot.size;
          const customerIds = new Set();
          let totalRevenue = 0;

          bookingsSnapshot.forEach(doc => {
            const booking = doc.data();
            if (booking.userId) customerIds.add(booking.userId);
            if (booking.price) totalRevenue += parseFloat(booking.price);
          });

          dashboardData.push({
            'Metric': 'Total Facilities',
            'Value': adminFacilities.length,
            'Date': new Date().toLocaleDateString()
          });
          dashboardData.push({
            'Metric': 'Total Bookings',
            'Value': totalBookings,
            'Date': new Date().toLocaleDateString()
          });
          dashboardData.push({
            'Metric': 'Total Customers',
            'Value': customerIds.size,
            'Date': new Date().toLocaleDateString()
          });
          dashboardData.push({
            'Metric': 'Total Revenue',
            'Value': `RM${totalRevenue.toFixed(2)}`,
            'Date': new Date().toLocaleDateString()
          });
          dashboardData.push({
            'Metric': 'Average Revenue per Booking',
            'Value': `RM${totalBookings > 0 ? (totalRevenue / totalBookings).toFixed(2) : '0'}`,
            'Date': new Date().toLocaleDateString()
          });
        }

        exportToCSV(dashboardData, `dashboard_snapshot_${new Date().toISOString().split('T')[0]}.csv`, ['Metric', 'Value', 'Date']);

      } catch (error) {
        console.error('Error exporting dashboard data:', error);
        showToast('Error exporting dashboard data', 'danger');
      }
    }

    async function loadCoachManagementPage() {
      try {
        // Fetch coaches from Firestore
        const coachesSnapshot = await db.collection("coaches").get();
        const coaches = [];

        coachesSnapshot.forEach(doc => {
          coaches.push({
            id: doc.id,
            ...doc.data(),
            // Ensure proper date formatting
            createdAt: doc.data().createdAt ? doc.data().createdAt.toDate() : null
          });
        });

        let coachesHTML = '';

        if (coaches.length === 0) {
          coachesHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="text-muted">
                            <i class="fas fa-user-tie fa-2x mb-3"></i>
                            <p>No coaches found</p>
                            <small>Add your first coach to get started</small>
                        </div>
                    </td>
                </tr>
            `;
        } else {
          coaches.forEach(coach => {
            const experience = coach.experience ? `${coach.experience} years` : 'N/A';
            const rate = coach.rate ? `RM${coach.rate}/hour` : 'N/A';
            const status = coach.status || 'Active';

            coachesHTML += `
                    <tr>
                        <td>
                            <div class="d-flex align-items-center">
                                <img src="${coach.photoURL || 'https://via.placeholder.com/40x40?text=Coach'}" 
                                     class="rounded-circle me-3" width="40" height="40" 
                                     alt="${coach.name}" 
                                     onerror="this.src='https://via.placeholder.com/40x40?text=Coach'">
                                <div>
                                    <div class="fw-semibold">${coach.name || 'N/A'}</div>
                                    <small class="text-muted">${coach.sport || 'N/A'}</small>
                                </div>
                            </div>
                        </td>
                        <td>${coach.sport || 'N/A'}</td>
                        <td>${experience}</td>
                        <td>${rate}</td>
                        <td>${coach.availability || 'Flexible'}</td>
                        <td>
                            <span class="badge ${status === 'Active' ? 'bg-success' : status === 'Inactive' ? 'bg-secondary' : 'bg-warning'}">
                                ${status}
                            </span>
                        </td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary me-1" onclick="viewCoach('${coach.id}')" title="View Details">
                                    <i class="fas fa-eye"></i>
                                </button>
                                <button class="btn btn-sm btn-warning me-1" onclick="editCoach('${coach.id}')" title="Edit Coach">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteCoach('${coach.id}')" title="Delete Coach">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
          });
        }

        return `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Coach Management</h3>
                <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addCoachModal">
                    <i class="fas fa-plus me-1"></i> Add New Coach
                </button>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-user-tie"></i>
                        <div class="number">${coaches.length}</div>
                        <div class="label">Total Coaches</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-basketball-ball"></i>
                        <div class="number">${new Set(coaches.map(c => c.sport)).size}</div>
                        <div class="label">Sports Covered</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-star"></i>
                        <div class="number">${coaches.filter(c => c.status === 'Active').length}</div>
                        <div class="label">Active Coaches</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-clock"></i>
                        <div class="number">${coaches.reduce((sum, coach) => sum + (coach.experience || 0), 0)}</div>
                        <div class="label">Total Experience</div>
                    </div>
                </div>
            </div>
            
            <div class="table-card">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Coach</th>
                                <th>Sport</th>
                                <th>Experience</th>
                                <th>Rate</th>
                                <th>Availability</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="coachesTableBody">
                            ${coachesHTML}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Add Coach Modal -->
            <div class="modal fade" id="addCoachModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Add New Coach</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="addCoachForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Profile Picture URL</label>
                                            <input type="url" class="form-control" name="photoURL" 
                                                   placeholder="https://example.com/coach.jpg">
                                            <small class="form-text text-muted">Optional: Direct link to coach's photo</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Full Name *</label>
                                            <input type="text" class="form-control" name="name" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Sport *</label>
                                            <select class="form-select" name="sport" required>
                                                <option value="">Select Sport</option>
                                                <option value="Badminton">Badminton</option>
                                                <option value="Tennis">Tennis</option>
                                                <option value="Basketball">Basketball</option>
                                                <option value="Football">Football</option>
                                                <option value="Swimming">Swimming</option>
                                                <option value="Gym">Gym & Fitness</option>
                                                <option value="Yoga">Yoga</option>
                                                <option value="Martial Arts">Martial Arts</option>
                                                <option value="Cricket">Cricket</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Experience (years) *</label>
                                            <input type="number" class="form-control" name="experience" min="0" max="50" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Hourly Rate (RM) *</label>
                                            <input type="number" class="form-control" name="rate" min="0" step="0.01" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" name="phone" placeholder="+60 12 345 6789">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Availability *</label>
                                            <select class="form-select" name="availability" required>
                                                <option value="Flexible">Flexible</option>
                                                <option value="Weekdays">Weekdays Only</option>
                                                <option value="Weekends">Weekends Only</option>
                                                <option value="Mornings">Mornings (8AM-12PM)</option>
                                                <option value="Afternoons">Afternoons (12PM-5PM)</option>
                                                <option value="Evenings">Evenings (5PM-10PM)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Status *</label>
                                            <select class="form-select" name="status" required>
                                                <option value="Active">Active</option>
                                                <option value="Inactive">Inactive</option>
                                                <option value="On Leave">On Leave</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-control" name="email" placeholder="coach@example.com">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label class="form-label">Bio/Qualifications</label>
                                    <textarea class="form-control" name="bio" rows="4" placeholder="Describe the coach's qualifications, achievements, and coaching style..."></textarea>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label class="form-label">Specialties</label>
                                    <input type="text" class="form-control" name="specialties" placeholder="e.g., Beginner Training, Advanced Techniques, Competition Prep">
                                    <small class="form-text text-muted">Separate multiple specialties with commas</small>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" name="availableForHire" id="availableForHire" checked>
                                    <label class="form-check-label" for="availableForHire">
                                        Available for hire
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="saveCoach()">Save Coach</button>
                        </div>
                    </div>
                </div>
            </div>
        `;
      } catch (error) {
        console.error("Error loading coach management page:", error);
        return `
            <div class="alert alert-danger">
                <h4>Error Loading Coaches</h4>
                <p>There was an error loading coach data. Please try again.</p>
                <button class="btn btn-primary mt-2" onclick="loadPageContent('coach-management')">
                    <i class="fas fa-redo me-1"></i> Retry
                </button>
            </div>
        `;
      }
    }

    async function loadPaymentFinancePage() {
      // Fetch payments for admin's facilities
      const facilityIds = adminFacilities.map(f => f.id);
      let payments = [];
      let totalRevenue = 0;

      if (facilityIds.length > 0) {
        const bookingsSnapshot = await db.collection("bookings")
          .where("facilityId", "in", facilityIds)
          .where("status", "==", "approved")
          .get();

        bookingsSnapshot.forEach(doc => {
          const booking = doc.data();
          if (booking.price) {
            totalRevenue += parseFloat(booking.price);
            payments.push({
              id: doc.id,
              ...booking,
              paymentDate: booking.timestamp ? booking.timestamp.toDate() : new Date()
            });
          }
        });
      }

      let paymentsHTML = '';

      if (payments.length === 0) {
        paymentsHTML = '<tr><td colspan="6" class="text-center py-4">No payments found</td></tr>';
      } else {
        payments.forEach(payment => {
          const date = payment.paymentDate ? payment.paymentDate.toLocaleDateString() : 'N/A';

          paymentsHTML += `
            <tr>
              <td>${payment.userName || 'Unknown User'}</td>
              <td>${payment.facilityName || 'Unknown Facility'}</td>
              <td>${date}</td>
              <td>RM${payment.price || '0'}</td>
              <td>${payment.paymentMethod || 'Online'}</td>
              <td><span class="badge badge-status badge-approved">Paid</span></td>
            </tr>
          `;
        });
      }

      return `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>Payment & Finance</h3>
          <div>
            <button class="btn btn-primary me-2" onclick="exportPayments()">
              <i class="fas fa-download me-1"></i> Export
            </button>
            <button class="btn btn-success" onclick="generateReport()">
              <i class="fas fa-chart-bar me-1"></i> Generate Report
            </button>
          </div>
        </div>
        
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-dollar-sign"></i>
              <div class="number">RM${totalRevenue.toFixed(2)}</div>
              <div class="label">Total Revenue</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-calendar-check"></i>
              <div class="number">${payments.length}</div>
              <div class="label">Total Transactions</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-chart-line"></i>
              <div class="number">RM${(totalRevenue / Math.max(payments.length, 1)).toFixed(2)}</div>
              <div class="label">Average Transaction</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-money-bill-wave"></i>
              <div class="number">RM0</div>
              <div class="label">Pending Payouts</div>
            </div>
          </div>
        </div>
        
        <div class="table-card">
          <h4>Payment History</h4>
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Facility</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Method</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                ${paymentsHTML}
              </tbody>
            </table>
          </div>
        </div>
      `;
    }

    async function loadCalendarSchedulingPage() {
      try {
        console.log('Loading calendar scheduling page...');

        // Fetch bookings for admin's facilities
        const facilityIds = adminFacilities.map(f => f.id);
        let bookings = [];

        if (facilityIds.length > 0) {
          console.log(`Fetching bookings for ${facilityIds.length} facilities`);

          const bookingsSnapshot = await db.collection("bookings")
            .where("facilityId", "in", facilityIds)
            .get();

          allBookings = []; // Reset allBookings
          bookingsSnapshot.forEach(doc => {
            const bookingData = doc.data();

            // Keep the original date format, we'll handle conversion in filtering
            let bookingDate = bookingData.date;

            // Ensure we have a proper date format
            if (bookingData.date && typeof bookingData.date.toDate === 'function') {
              // If date is a Firestore Timestamp, convert to string
              const dateFromTimestamp = bookingData.date.toDate();
              const month = (dateFromTimestamp.getMonth() + 1).toString().padStart(2, '0');
              const day = dateFromTimestamp.getDate().toString().padStart(2, '0');
              const year = dateFromTimestamp.getFullYear();
              bookingDate = `${month}/${day}/${year}`;
            } else if (!bookingData.date && bookingData.timestamp) {
              // Use timestamp as fallback
              const dateFromTimestamp = bookingData.timestamp.toDate();
              const month = (dateFromTimestamp.getMonth() + 1).toString().padStart(2, '0');
              const day = dateFromTimestamp.getDate().toString().padStart(2, '0');
              const year = dateFromTimestamp.getFullYear();
              bookingDate = `${month}/${day}/${year}`;
            }

            // If date is in YYYY-MM-DD format, convert to MM/DD/YYYY for consistency
            if (bookingDate && bookingDate.includes('-')) {
              const [year, month, day] = bookingDate.split('-');
              bookingDate = `${month}/${day}/${year}`;
            }

            allBookings.push({
              id: doc.id,
              ...bookingData,
              date: bookingDate, // Store in MM/DD/YYYY format
              timestamp: bookingData.timestamp || null
            });
          });

          console.log(`Loaded ${allBookings.length} bookings for calendar`);

          // Debug: Log first few bookings to verify data
          if (allBookings.length > 0) {
            console.log('Sample bookings:', allBookings.slice(0, 3).map(b => ({
              id: b.id,
              date: b.date,
              slot: b.slot,
              facilityName: b.facilityName,
              status: b.status,
              facilityId: b.facilityId
            })));
          }
        } else {
          console.log('No facilities found for this admin');
          allBookings = [];
        }

        // Generate calendar based on current view
        let calendarHTML = generateCalendarHeader();
        calendarHTML += generateCalendarViewControls();
        calendarHTML += generateCalendarFilterControls();

        // Add a debug info panel
        calendarHTML += `
            <div class="alert alert-info mb-4">
                <h6><i class="fas fa-info-circle me-2"></i>Calendar Information</h6>
                <div class="row">
                    <div class="col-md-4">
                        <small><strong>Total Bookings:</strong> ${allBookings.length}</small>
                    </div>
                    <div class="col-md-4">
                        <small><strong>Current Month:</strong> ${currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</small>
                    </div>
                    <div class="col-md-4">
                        <small><strong>View:</strong> ${calendarView}</small>
                    </div>
                </div>
            </div>
        `;

        switch (calendarView) {
          case 'day':
            calendarHTML += await generateDayView();
            break;
          case 'week':
            calendarHTML += await generateWeekView();
            break;
          case 'month':
          default:
            calendarHTML += await generateMonthView();
            break;
        }

        // Add debug button for testing
        calendarHTML += `
            <div class="row mt-4">
                <div class="col-12">
                    <button class="btn btn-outline-secondary btn-sm ms-2" onclick="refreshCalendar()">
                        <i class="fas fa-sync-alt me-1"></i> Refresh Calendar
                    </button>
                </div>
            </div>
        `;

        // Initialize drag and drop
        setTimeout(() => {
          initializeCalendarDragDrop();
        }, 100);

        return calendarHTML;

      } catch (error) {
        console.error('Error loading calendar page:', error);
        return `
            <div class="alert alert-danger">
                <h4>Error Loading Calendar</h4>
                <p>There was an error loading the calendar. Please try again.</p>
                <p><small>Error: ${error.message}</small></p>
                <button class="btn btn-primary mt-2" onclick="loadCalendarSchedulingPage()">
                    <i class="fas fa-redo me-1"></i> Retry
                </button>
            </div>
        `;
      }
    }
    // Calendar Header with Navigation
    function generateCalendarHeader() {
      return `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <button class="btn btn-outline-primary me-2" onclick="prevPeriod()">
                    <i class="fas fa-chevron-left me-1"></i> Previous
                </button>
                <button class="btn btn-outline-secondary me-2" onclick="goToToday()">
                    Today
                </button>
                <button class="btn btn-outline-primary" onclick="nextPeriod()">
                    Next <i class="fas fa-chevron-right ms-1"></i>
                </button>
            </div>
            <h4 class="mb-0 fw-bold" id="calendarTitle">${getCalendarTitle()}</h4>
        </div>
    `;
    }

    // Calendar View Controls
    function generateCalendarViewControls() {
      return `
        <div class="row mb-4">
            <div class="col-md-8">
                <div class="btn-group" role="group">
                    <input type="radio" class="btn-check" name="calendarView" id="viewDay" ${calendarView === 'day' ? 'checked' : ''} onclick="changeCalendarView('day')">
                    <label class="btn btn-outline-primary" for="viewDay">Day</label>
                    
                    <input type="radio" class="btn-check" name="calendarView" id="viewWeek" ${calendarView === 'week' ? 'checked' : ''} onclick="changeCalendarView('week')">
                    <label class="btn btn-outline-primary" for="viewWeek">Week</label>
                    
                    <input type="radio" class="btn-check" name="calendarView" id="viewMonth" ${calendarView === 'month' ? 'checked' : ''} onclick="changeCalendarView('month')">
                    <label class="btn btn-outline-primary" for="viewMonth">Month</label>
                </div>
            </div>
        </div>
    `;
    }

    // Calendar Filter Controls
    // Calendar Filter Controls - UPDATED with state persistence
    function generateCalendarFilterControls() {
      const facilitiesOptions = adminFacilities.map(f =>
        `<option value="${f.id}" ${selectedFacilityFilter === f.id ? 'selected' : ''}>${f.name} (${f.type})</option>`
      ).join('');

      // Get current filter values or defaults
      const currentStatusFilter = window.statusFilter || 'all';
      const currentColorMode = window.colorMode || 'sport';

      return `
        <div class="row mb-4">
            <div class="col-md-3">
                <label class="form-label">Filter by Facility</label>
                <select class="form-select" id="facilityFilter" onchange="changeFacilityFilter(this.value)">
                    <option value="all">All Facilities</option>
                    ${facilitiesOptions}
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Filter by Status</label>
                <select class="form-select" id="statusFilter" onchange="changeStatusFilter(this.value)">
                    <option value="all" ${currentStatusFilter === 'all' ? 'selected' : ''}>All Status</option>
                    <option value="approved" ${currentStatusFilter === 'approved' ? 'selected' : ''}>Approved</option>
                    <option value="pending" ${currentStatusFilter === 'pending' ? 'selected' : ''}>Pending</option>
                    <option value="completed" ${currentStatusFilter === 'completed' ? 'selected' : ''}>Completed</option>
                    <option value="cancelled" ${currentStatusFilter === 'cancelled' ? 'selected' : ''}>Cancelled</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Color Code By</label>
                <select class="form-select" id="colorCodeFilter" onchange="changeColorCode(this.value)">
                    <option value="sport" ${currentColorMode === 'sport' ? 'selected' : ''}>Sport Type</option>
                    <option value="status" ${currentColorMode === 'status' ? 'selected' : ''}>Booking Status</option>
                    <option value="facility" ${currentColorMode === 'facility' ? 'selected' : ''}>Facility</option>
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label">Legend</label>
                <div id="colorLegend" class="color-legend">
                    ${generateColorLegend()}
                </div>
            </div>
        </div>
        
        <!-- Active Filters Display -->
        ${getActiveFiltersDisplay()}
    `;
    }

    // Add active filters display
    function getActiveFiltersDisplay() {
      const activeFilters = [];

      if (selectedFacilityFilter && selectedFacilityFilter !== 'all') {
        const facility = adminFacilities.find(f => f.id === selectedFacilityFilter);
        if (facility) {
          activeFilters.push(`Facility: ${facility.name}`);
        }
      }

      if (window.statusFilter && window.statusFilter !== 'all') {
        activeFilters.push(`Status: ${window.statusFilter.charAt(0).toUpperCase() + window.statusFilter.slice(1)}`);
      }

      if (window.colorMode && window.colorMode !== 'sport') {
        activeFilters.push(`Color: ${window.colorMode.charAt(0).toUpperCase() + window.colorMode.slice(1)}`);
      }

      if (activeFilters.length === 0) {
        return '';
      }

      return `
        <div class="row mt-3">
            <div class="col-12">
                <div class="alert alert-info py-2">
                    <strong>Active Filters:</strong> ${activeFilters.join('  ')}
                    <button class="btn btn-sm btn-outline-danger ms-2" onclick="clearAllFilters()">
                        <i class="fas fa-times me-1"></i> Clear All
                    </button>
                </div>
            </div>
        </div>
    `;
    }
    // Generate Color Legend - UPDATED
    function generateColorLegend() {
      const colorMode = window.colorMode || 'sport';

      switch (colorMode) {
        case 'sport':
          return `
                <div class="legend-item"><span class="legend-color badminton-booking"></span> Badminton</div>
                <div class="legend-item"><span class="legend-color tennis-booking"></span> Tennis</div>
                <div class="legend-item"><span class="legend-color basketball-booking"></span> Basketball</div>
                <div class="legend-item"><span class="legend-color football-booking"></span> Football</div>
                <div class="legend-item"><span class="legend-color swimming-booking"></span> Swimming</div>
                <div class="legend-item"><span class="legend-color gym-booking"></span> Gym</div>
            `;
        case 'status':
          return `
                <div class="legend-item"><span class="legend-color status-approved"></span> Approved</div>
                <div class="legend-item"><span class="legend-color status-pending"></span> Pending</div>
                <div class="legend-item"><span class="legend-color status-completed"></span> Completed</div>
                <div class="legend-item"><span class="legend-color status-cancelled"></span> Cancelled</div>
            `;
        case 'facility':
          // Show legend for up to 4 facilities
          const facilitiesToShow = adminFacilities.slice(0, 4);
          return facilitiesToShow.map(facility => `
                <div class="legend-item"><span class="legend-color ${getFacilityColorClass(facility.id)}"></span> ${facility.name}</div>
            `).join('');
        default:
          return '';
      }
    }

    async function generateMonthView() {
      try {
        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startingDay = firstDay.getDay(); // 0 = Sunday, 1 = Monday, etc.

        console.log(`Generating month view for ${year}-${month + 1}, starting day: ${startingDay}, days in month: ${daysInMonth}`);

        let calendarHTML = '<div class="calendar">';
        const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];

        // Day headers
        daysOfWeek.forEach(day => {
          calendarHTML += `<div class="calendar-header">${day}</div>`;
        });

        // Empty cells for days before the first day of the month
        for (let i = 0; i < startingDay; i++) {
          calendarHTML += `<div class="calendar-day empty"></div>`;
        }

        // Days of the month
        const today = new Date();
        const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;

        let totalBookingsInMonth = 0;
        let daysWithBookings = 0;

        for (let day = 1; day <= daysInMonth; day++) {
          // Format date as YYYY-MM-DD for the calendar grid
          const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
          const dayBookings = getFilteredBookingsForDate(dateStr);
          const isToday = isCurrentMonth && today.getDate() === day;
          const hasBooking = dayBookings.length > 0;

          if (hasBooking) {
            totalBookingsInMonth += dayBookings.length;
            daysWithBookings++;
          }

          console.log(`Date: ${dateStr}, Bookings: ${dayBookings.length}`);

          calendarHTML += `
                <div class="calendar-day ${isToday ? 'today' : ''} ${hasBooking ? 'has-booking' : ''}" 
                     data-date="${dateStr}" 
                     ondragover="allowDrop(event)" 
                     ondrop="dropBooking(event, '${dateStr}')"
                     ondragleave="handleDragLeave(event)">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <span class="day-number ${isToday ? 'fw-bold text-primary' : ''}">${day}</span>
                        ${hasBooking ? `<span class="badge bg-primary">${dayBookings.length}</span>` : ''}
                    </div>
                    <div class="booking-events">
            `;

          // Display up to 3 bookings for this day
          if (dayBookings.length > 0) {
            dayBookings.slice(0, 3).forEach(booking => {
              const timeDisplay = booking.slot ? booking.slot.split('-')[0] : '';
              const status = booking.status || 'pending';
              const facilityName = booking.facilityName || 'Unknown Facility';
              const userName = booking.userName || 'Unknown User';

              // Truncate long facility names
              const displayFacilityName = facilityName.length > 12 ?
                facilityName.substring(0, 12) + '...' : facilityName;

              calendarHTML += `
                        <div class="calendar-event ${getBookingColorClass(booking)} draggable-booking" 
                             draggable="true" 
                             ondragstart="dragBooking(event, '${booking.id}')"
                             ondragend="handleDragEnd(event)"
                             data-booking-id="${booking.id}"
                             data-booking-facility="${booking.facilityId}"
                             data-booking-duration="${booking.duration || 1}"
                             onclick="showBookingDetails('${booking.id}', event)"
                             title="${facilityName} - ${userName} (${timeDisplay}) - ${status}">
                            <div class="d-flex justify-content-between align-items-start">
                                <small class="event-time">${timeDisplay}</small>
                                <small class="event-status">${status}</small>
                            </div>
                            <div class="event-title">${displayFacilityName}</div>
                            <small class="event-user">${userName.split('@')[0]}</small>
                        </div>
                    `;
            });

            // Show "+X more" if there are more than 3 bookings
            if (dayBookings.length > 3) {
              calendarHTML += `<small class="text-muted d-block mt-1">+${dayBookings.length - 3} more</small>`;
            }
          } else {
            // Empty state for days with no bookings
            calendarHTML += `<small class="text-muted">No bookings</small>`;
          }

          calendarHTML += `
                    </div>
                </div>
            `;
        }

        // Fill remaining cells to complete the calendar grid (6 rows  7 days = 42 cells total)
        const totalCells = 42; // 6 rows  7 days
        const filledCells = startingDay + daysInMonth;
        const remainingCells = totalCells - filledCells;

        for (let i = 0; i < remainingCells; i++) {
          calendarHTML += `<div class="calendar-day empty"></div>`;
        }

        calendarHTML += `</div>`;

        console.log(`Month view generated successfully. Total bookings in month: ${totalBookingsInMonth} across ${daysWithBookings} days`);
        return calendarHTML;

      } catch (error) {
        console.error('Error generating month view:', error);
        return `
            <div class="alert alert-danger">
                <h4>Error Generating Calendar</h4>
                <p>There was an error generating the month view. Please try refreshing.</p>
                <p><small>Error: ${error.message}</small></p>
            </div>
        `;
      }
    }

    // Refresh calendar function
    function refreshCalendar() {
      console.log('Refreshing calendar...');
      loadPageContent('calendar-scheduling');
    }

    // Enhanced date matching function for all views
    function normalizeDateForComparison(dateStr) {
      // Convert YYYY-MM-DD to MM/DD/YYYY for comparison with booking dates
      if (dateStr.includes('-')) {
        const [year, month, day] = dateStr.split('-');
        return `${month}/${day}/${year}`;
      }
      return dateStr;
    }

    // Enhanced getFilteredBookingsForDate function - FIXED VERSION
    function getFilteredBookingsForDate(dateStr) {
      console.log(`Filtering bookings for date: ${dateStr}`);

      // Normalize the target date for comparison
      const targetDateFormatted = normalizeDateForComparison(dateStr);

      console.log(`Looking for bookings with date: ${targetDateFormatted}`);

      let filteredBookings = allBookings.filter(booking => {
        if (!booking.date) {
          console.log('Booking has no date:', booking.id);
          return false;
        }

        // Handle different date formats
        let bookingDateFormatted = booking.date;

        // If booking.date is a Firestore Timestamp
        if (booking.date && typeof booking.date.toDate === 'function') {
          const dateFromTimestamp = booking.date.toDate();
          const month = (dateFromTimestamp.getMonth() + 1).toString().padStart(2, '0');
          const day = dateFromTimestamp.getDate().toString().padStart(2, '0');
          const year = dateFromTimestamp.getFullYear();
          bookingDateFormatted = `${month}/${day}/${year}`;
        }
        // If booking date is in YYYY-MM-DD format, convert to MM/DD/YYYY
        else if (typeof bookingDateFormatted === 'string' && bookingDateFormatted.includes('-')) {
          const [year, month, day] = bookingDateFormatted.split('-');
          bookingDateFormatted = `${month}/${day}/${year}`;
        }
        // If booking date is already in MM/DD/YYYY format, use as is
        else if (typeof bookingDateFormatted === 'string') {
          // Already in correct format
        }
        // If we have a timestamp field as fallback
        else if (booking.timestamp && typeof booking.timestamp.toDate === 'function') {
          const dateFromTimestamp = booking.timestamp.toDate();
          const month = (dateFromTimestamp.getMonth() + 1).toString().padStart(2, '0');
          const day = dateFromTimestamp.getDate().toString().padStart(2, '0');
          const year = dateFromTimestamp.getFullYear();
          bookingDateFormatted = `${month}/${day}/${year}`;
        }
        else {
          console.log('Unsupported date format for booking:', booking.id, booking.date);
          return false;
        }

        const matches = bookingDateFormatted === targetDateFormatted;

        if (matches) {
          console.log(` Booking ${booking.id} matches date:`, {
            originalDate: booking.date,
            formattedDate: bookingDateFormatted,
            targetDate: targetDateFormatted,
            facility: booking.facilityName,
            slot: booking.slot
          });
        }

        return matches;
      });

      // Apply facility filter
      if (selectedFacilityFilter && selectedFacilityFilter !== 'all') {
        const beforeCount = filteredBookings.length;
        filteredBookings = filteredBookings.filter(booking => booking.facilityId === selectedFacilityFilter);
        console.log(`Facility filter: ${beforeCount} -> ${filteredBookings.length} bookings`);
      }

      // Apply status filter
      if (window.statusFilter && window.statusFilter !== 'all') {
        const beforeCount = filteredBookings.length;
        filteredBookings = filteredBookings.filter(booking => booking.status === window.statusFilter);
        console.log(`Status filter: ${beforeCount} -> ${filteredBookings.length} bookings`);
      }

      console.log(`Final filtered bookings for ${dateStr}: ${filteredBookings.length}`);
      return filteredBookings;
    }
    // Convert 12-hour format to 24-hour format
    function convertTo24Hour(time12h) {
      if (!time12h) return null;

      // Remove spaces and convert to uppercase for consistent parsing
      const time = time12h.replace(/\s/g, '').toUpperCase();

      // Handle formats like "5-6PM", "7-8PM", "5-6 PM"
      if (time.includes('PM') || time.includes('AM')) {
        const [timePart, period] = time.split(/(?=[AP]M)/);
        const [startTime, endTime] = timePart.split('-');

        // Convert start time
        let [startHour, startMinute = '00'] = startTime.split(':');
        startHour = parseInt(startHour);
        if (period === 'PM' && startHour < 12) startHour += 12;
        if (period === 'AM' && startHour === 12) startHour = 0;

        // Convert end time  
        let [endHour, endMinute = '00'] = endTime.split(':');
        endHour = parseInt(endHour);
        if (period === 'PM' && endHour < 12) endHour += 12;
        if (period === 'AM' && endHour === 12) endHour = 0;

        return {
          start24: `${startHour.toString().padStart(2, '0')}:${startMinute}`,
          end24: `${endHour.toString().padStart(2, '0')}:${endMinute}`,
          slot24: `${startHour.toString().padStart(2, '0')}:${startMinute}-${endHour.toString().padStart(2, '0')}:${endMinute}`
        };
      }

      // If already in 24-hour format, return as is
      if (time.includes('-')) {
        const [start, end] = time.split('-');
        return {
          start24: start,
          end24: end,
          slot24: time
        };
      }

      return null;
    }

    // Enhanced getFilteredBookingsForTimeSlot function
    function getFilteredBookingsForTimeSlot(dateStr, timeSlot) {
      console.log(` Filtering bookings for time slot: ${dateStr} at ${timeSlot}`);

      // Get all bookings for the date first
      const dayBookings = getFilteredBookingsForDate(dateStr);

      // Then filter by time slot
      let filteredBookings = dayBookings.filter(booking => {
        if (!booking.slot) {
          console.log(`    Booking ${booking.id} has no slot`);
          return false;
        }

        // Convert booking slot to 24-hour format
        const convertedSlot = convertTo24Hour(booking.slot);
        if (!convertedSlot) {
          console.log(`    Could not convert slot: ${booking.slot}`);
          return false;
        }

        // Check if booking starts at this time
        const timeMatches = convertedSlot.start24 === timeSlot;

        if (timeMatches) {
          console.log(`    Booking ${booking.id} matches time slot:`, {
            originalSlot: booking.slot,
            convertedSlot: convertedSlot.slot24,
            targetTime: timeSlot
          });
        } else {
          console.log(`    Time mismatch - Booking: ${convertedSlot.start24}, Target: ${timeSlot}`);
        }

        return timeMatches;
      });

      console.log(` Final filtered bookings for ${dateStr} at ${timeSlot}: ${filteredBookings.length}`);
      return filteredBookings;
    }

    // Enhanced function to get all bookings for a time slot (including spanning bookings)
    function getBookingsForTimeSlot(dateStr, timeSlot) {
      console.log(` Getting ALL bookings for: ${dateStr} at ${timeSlot}`);

      const dayBookings = getFilteredBookingsForDate(dateStr);
      const slotBookings = [];

      dayBookings.forEach(booking => {
        if (!booking.slot) return;

        const convertedSlot = convertTo24Hour(booking.slot);
        if (!convertedSlot) return;

        const [targetHour, targetMinute] = timeSlot.split(':').map(Number);
        const [startHour, startMinute] = convertedSlot.start24.split(':').map(Number);
        const [endHour, endMinute] = convertedSlot.end24.split(':').map(Number);

        // Check if booking occurs during this time slot
        const targetTime = targetHour * 60 + targetMinute;
        const startTime = startHour * 60 + startMinute;
        const endTime = endHour * 60 + endMinute;

        const occursDuringSlot = targetTime >= startTime && targetTime < endTime;

        if (occursDuringSlot) {
          console.log(`    Booking ${booking.id} occurs during ${timeSlot}:`, {
            originalSlot: booking.slot,
            convertedSlot: convertedSlot.slot24,
            timeRange: `${startTime}-${endTime}`,
            targetTime: targetTime
          });
          slotBookings.push(booking);
        }
      });

      console.log(` Bookings occurring during ${timeSlot}: ${slotBookings.length}`);
      return slotBookings;
    }

    // Enhanced drag and drop handlers
    function handleDragLeave(event) {
      // Only remove class if not dragging over a child element
      if (!event.currentTarget.contains(event.relatedTarget)) {
        event.currentTarget.classList.remove('drag-over');
      }
    }

    function handleDragEnd(event) {
      // Remove dragging class from all elements
      document.querySelectorAll('.dragging').forEach(el => {
        el.classList.remove('dragging');
      });
    }

    // Enhanced initializeCalendarDragDrop function
    function initializeCalendarDragDrop() {
      console.log('Initializing calendar drag and drop...');

      // Add drag end listener to document
      document.addEventListener('dragend', handleDragEnd);

      // Add event listeners to all calendar elements
      const calendarDays = document.querySelectorAll('.calendar-day:not(.empty)');
      const weekSlots = document.querySelectorAll('.calendar-week-slot');
      const timeSlots = document.querySelectorAll('.time-slot-content');

      console.log(`Found ${calendarDays.length} calendar days, ${weekSlots.length} week slots, ${timeSlots.length} time slots`);

      // Add drag leave handlers for better UX
      [...calendarDays, ...weekSlots, ...timeSlots].forEach(element => {
        element.addEventListener('dragleave', handleDragLeave);
      });

      // Make booking events draggable
      const bookingEvents = document.querySelectorAll('.draggable-booking');
      console.log(`Made ${bookingEvents.length} booking events draggable`);
    }

    function handleDragEnd(event) {
      // Remove dragging and drag-over classes from all elements
      document.querySelectorAll('.dragging, .drag-over').forEach(el => {
        el.classList.remove('dragging', 'drag-over');
      });
    }

    // Add this to your initializePageFunctionality for calendar-scheduling
    function initializeCalendarDragDrop() {
      // Add drag end listener to document
      document.addEventListener('dragend', handleDragEnd);

      // Add dragover and dragleave handlers for better UX
      const calendarDays = document.querySelectorAll('.calendar-day, .calendar-week-slot, .time-slot-content');

      calendarDays.forEach(day => {
        day.addEventListener('dragleave', (e) => {
          // Only remove class if not dragging over a child element
          if (!day.contains(e.relatedTarget)) {
            day.classList.remove('drag-over');
          }
        });
      });
    }

    async function generateWeekView() {
      try {
        const startOfWeek = getStartOfWeek(currentCalendarDate);
        let calendarHTML = '<div class="calendar-week">';

        // Time slots header
        calendarHTML += '<div class="calendar-time-header">Time</div>';

        // Day headers
        for (let i = 0; i < 7; i++) {
          const currentDay = new Date(startOfWeek);
          currentDay.setDate(startOfWeek.getDate() + i);
          const dayName = currentDay.toLocaleDateString('en-US', { weekday: 'short' });
          const dateNum = currentDay.getDate();
          const month = currentDay.getMonth() + 1;
          const year = currentDay.getFullYear();
          const dateStr = `${year}-${String(month).padStart(2, '0')}-${String(dateNum).padStart(2, '0')}`;

          // Get bookings for this day to show count
          const dayBookings = getFilteredBookingsForDate(dateStr);

          calendarHTML += `
                <div class="calendar-day-header">
                    <div>${dayName}</div>
                    <div class="date-number">${dateNum}</div>
                    <small class="text-light opacity-75">${month}/${dateNum}</small>
                    ${dayBookings.length > 0 ? `<small class="badge bg-warning mt-1">${dayBookings.length}</small>` : ''}
                </div>
            `;
        }

        // Time slots (7 AM to 10 PM) - in 24-hour format
        for (let hour = 7; hour <= 22; hour++) {
          const timeLabel = `${hour}:00`; // 24-hour format
          const timeSlot24 = `${hour.toString().padStart(2, '0')}:00`;

          calendarHTML += `<div class="calendar-time-slot">${timeLabel}</div>`;

          for (let i = 0; i < 7; i++) {
            const currentDay = new Date(startOfWeek);
            currentDay.setDate(startOfWeek.getDate() + i);
            const dateStr = currentDay.toISOString().split('T')[0];

            // Get bookings that occur during this time slot
            const slotBookings = getBookingsForTimeSlot(dateStr, timeSlot24);

            console.log(` Week View - ${dateStr} ${timeSlot24}: ${slotBookings.length} bookings`);

            calendarHTML += `
                    <div class="calendar-week-slot ${slotBookings.length > 0 ? 'has-booking' : ''}"
                         ondragover="allowDrop(event)"
                         ondrop="dropBookingToSlot(event, '${dateStr}', '${timeSlot24}')"
                         ondragleave="handleDragLeave(event)">
                `;

            if (slotBookings.length > 0) {
              slotBookings.forEach(booking => {
                const convertedSlot = convertTo24Hour(booking.slot);

                // Truncate long names for better display
                const shortFacilityName = booking.facilityName.length > 12 ?
                  booking.facilityName.substring(0, 12) + '...' : booking.facilityName;
                const shortUserName = booking.userName.split('@')[0];

                calendarHTML += `
                            <div class="week-booking ${getBookingColorClass(booking)} mb-1"
                                 draggable="true"
                                 ondragstart="dragBooking(event, '${booking.id}')"
                                 ondragend="handleDragEnd(event)"
                                 onclick="showBookingDetails('${booking.id}', event)"
                                 title="${booking.facilityName} - ${booking.userName} (${booking.slot}) - ${booking.status}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <strong class="booking-facility">${shortFacilityName}</strong>
                                    <span class="badge badge-status badge-${booking.status}">${booking.status.charAt(0)}</span>
                                </div>
                                <small class="booking-user d-block">${shortUserName}</small>
                                <small class="booking-time text-muted d-block">${convertedSlot ? convertedSlot.slot24 : booking.slot}</small>
                            </div>
                        `;
              });
            } else {
              calendarHTML += `
                        <div class="text-center text-muted py-2">
                            <small>Available</small>
                        </div>
                    `;
            }

            calendarHTML += `</div>`;
          }
        }

        calendarHTML += '</div>';

        // Add week summary
        const weekBookings = getWeekBookings(startOfWeek);
        calendarHTML += `
            <div class="alert alert-info mt-3">
                <h6><i class="fas fa-calendar-week me-2"></i>Week Summary</h6>
                <div class="row">
                    <div class="col-md-6">
                        <small><strong>Total Bookings This Week:</strong> ${weekBookings.length}</small>
                    </div>
                    <div class="col-md-6">
                        <small><strong>Week Period:</strong> ${startOfWeek.toLocaleDateString()} - ${new Date(startOfWeek.getTime() + 6 * 24 * 60 * 60 * 1000).toLocaleDateString()}</small>
                    </div>
                </div>
                ${weekBookings.length > 0 ? `
                    <div class="mt-2">
                        <small><strong>Bookings by Day:</strong></small>
                        <div class="d-flex flex-wrap gap-2 mt-1">
                            ${Array.from({ length: 7 }).map((_, i) => {
          const day = new Date(startOfWeek);
          day.setDate(startOfWeek.getDate() + i);
          const dateStr = day.toISOString().split('T')[0];
          const dayBookings = getFilteredBookingsForDate(dateStr);
          return `<span class="badge bg-primary">${day.toLocaleDateString('en-US', { weekday: 'short' })}: ${dayBookings.length}</span>`;
        }).join('')}
                        </div>
                    </div>
                ` : ''}
            </div>
        `;

        return calendarHTML;

      } catch (error) {
        console.error('Error generating week view:', error);
        return `
            <div class="alert alert-danger">
                <h4>Error Generating Week View</h4>
                <p>There was an error generating the week view. Please try refreshing.</p>
                <p><small>Error: ${error.message}</small></p>
            </div>
        `;
      }
    }

    async function generateDayView() {
      try {
        const dateStr = currentCalendarDate.toISOString().split('T')[0];
        const dayBookings = getFilteredBookingsForDate(dateStr);

        console.log(`Generating day view for ${dateStr}, found ${dayBookings.length} bookings`);

        let calendarHTML = `
            <div class="calendar-day-view">
                <div class="day-view-header bg-primary text-white p-3 rounded-top">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-day me-2"></i>
                        ${currentCalendarDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
                    </h4>
                    <small>${dayBookings.length} booking(s) scheduled</small>
                </div>
                <div class="day-view-time-slots">
        `;

        // If no bookings, show empty state
        if (dayBookings.length === 0) {
          calendarHTML += `
                <div class="text-center py-5" style="grid-column: 1 / -1;">
                    <i class="fas fa-calendar-times fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">No Bookings Scheduled</h5>
                    <p class="text-muted">There are no bookings scheduled for this day.</p>
                </div>
            `;
        } else {
          // Group bookings by hour for better display
          const bookingsByHour = {};

          // Initialize hours from 7 AM to 10 PM in 24-hour format
          for (let hour = 7; hour <= 22; hour++) {
            const timeSlot = `${hour.toString().padStart(2, '0')}:00`;
            bookingsByHour[timeSlot] = [];
          }

          // Assign bookings to hours
          dayBookings.forEach(booking => {
            if (!booking.slot) return;

            const convertedSlot = convertTo24Hour(booking.slot);
            if (!convertedSlot) return;

            const [startHour, startMinute] = convertedSlot.start24.split(':').map(Number);
            const [endHour, endMinute] = convertedSlot.end24.split(':').map(Number);

            console.log(` Assigning booking ${booking.id}: ${convertedSlot.slot24} (${startHour}:${startMinute} to ${endHour}:${endMinute})`);

            // Add booking to all hours it spans
            for (let hour = startHour; hour < endHour; hour++) {
              const timeSlot = `${hour.toString().padStart(2, '0')}:00`;
              if (hour >= 7 && hour <= 22) {
                if (!bookingsByHour[timeSlot]) {
                  bookingsByHour[timeSlot] = [];
                }
                // Only add if not already in the array
                if (!bookingsByHour[timeSlot].find(b => b.id === booking.id)) {
                  bookingsByHour[timeSlot].push(booking);
                  console.log(`    Added to ${timeSlot}`);
                }
              }
            }
          });

          // Display time slots
          for (let hour = 7; hour <= 22; hour++) {
            const timeSlot = `${hour.toString().padStart(2, '0')}:00`;
            const hourBookings = bookingsByHour[timeSlot] || [];

            console.log(` Time slot ${timeSlot}: ${hourBookings.length} bookings`);

            calendarHTML += `
                    <div class="day-time-slot">
                        <div class="time-label bg-light fw-bold border-end">
                            ${hour}:00
                            ${hourBookings.length > 0 ? `<br><small class="badge bg-success">${hourBookings.length}</small>` : ''}
                        </div>
                        <div class="time-slot-content ${hourBookings.length > 0 ? 'has-booking' : ''}"
                             ondragover="allowDrop(event)"
                             ondrop="dropBookingToSlot(event, '${dateStr}', '${timeSlot}')"
                             ondragleave="handleDragLeave(event)">
                `;

            if (hourBookings.length > 0) {
              // Show unique bookings for this hour
              const uniqueBookings = Array.from(new Set(hourBookings.map(b => b.id)))
                .map(id => hourBookings.find(b => b.id === id));

              uniqueBookings.forEach(booking => {
                const convertedSlot = convertTo24Hour(booking.slot);
                const duration = booking.duration || 1;

                calendarHTML += `
                            <div class="day-booking ${getBookingColorClass(booking)} mb-2"
                                 draggable="true"
                                 ondragstart="dragBooking(event, '${booking.id}')"
                                 ondragend="handleDragEnd(event)"
                                 onclick="showBookingDetails('${booking.id}', event)"
                                 title="${booking.facilityName} - ${booking.userName} - ${booking.status}">
                                <div class="d-flex justify-content-between align-items-start">
                                    <strong class="booking-facility">${booking.facilityName}</strong>
                                    <span class="badge badge-status badge-${booking.status}">${booking.status}</span>
                                </div>
                                <div class="booking-user small">
                                    <i class="fas fa-user me-1"></i>${booking.userName}
                                </div>
                                <div class="booking-time small text-muted">
                                    <i class="fas fa-clock me-1"></i>
                                    ${convertedSlot ? convertedSlot.slot24 : booking.slot}
                                    ${duration > 1 ? `(${duration}h)` : ''}
                                </div>
                                ${booking.notes ? `
                                    <div class="booking-notes small text-muted mt-1">
                                        <i class="fas fa-sticky-note me-1"></i>
                                        ${booking.notes}
                                    </div>
                                ` : ''}
                            </div>
                        `;
              });
            } else {
              calendarHTML += `
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-calendar-plus fa-2x mb-2"></i>
                            <div>No bookings</div>
                            <small>Drag and drop to schedule</small>
                        </div>
                    `;
            }

            calendarHTML += `
                        </div>
                    </div>
                `;
          }
        }

        calendarHTML += `
                </div>
            </div>
        `;

        // Add day summary
        calendarHTML += `
            <div class="alert alert-success mt-3">
                <h6><i class="fas fa-calendar-day me-2"></i>Day Summary - ${currentCalendarDate.toLocaleDateString()}</h6>
                <div class="row">
                    <div class="col-md-3">
                        <small><strong>Total Bookings:</strong> ${dayBookings.length}</small>
                    </div>
                    <div class="col-md-3">
                        <small><strong>Confirmed:</strong> ${dayBookings.filter(b => b.status === 'confirmed' || b.status === 'approved').length}</small>
                    </div>
                    <div class="col-md-3">
                        <small><strong>Pending:</strong> ${dayBookings.filter(b => b.status === 'pending').length}</small>
                    </div>
                    <div class="col-md-3">
                        <small><strong>Facilities:</strong> ${new Set(dayBookings.map(b => b.facilityName)).size}</small>
                    </div>
                </div>
            </div>
        `;

        return calendarHTML;

      } catch (error) {
        console.error('Error generating day view:', error);
        return `
            <div class="alert alert-danger">
                <h4>Error Generating Day View</h4>
                <p>There was an error generating the day view. Please try refreshing.</p>
                <p><small>Error: ${error.message}</small></p>
            </div>
        `;
      }
    }
    // Calendar Navigation Functions
    function getCalendarTitle() {
      switch (calendarView) {
        case 'day':
          return currentCalendarDate.toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        case 'week':
          const startOfWeek = getStartOfWeek(currentCalendarDate);
          const endOfWeek = new Date(startOfWeek);
          endOfWeek.setDate(startOfWeek.getDate() + 6);
          return `${startOfWeek.toLocaleDateString()} - ${endOfWeek.toLocaleDateString()}`;
        case 'month':
        default:
          return currentCalendarDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
      }
    }

    function getStartOfWeek(date) {
      const start = new Date(date);
      const day = start.getDay();
      const diff = start.getDate() - day;
      return new Date(start.setDate(diff));
    }

    function changeCalendarView(view) {
      calendarView = view;
      loadPageContent('calendar-scheduling');
    }

    function changeFacilityFilter(facilityId) {
      selectedFacilityFilter = facilityId;
      loadPageContent('calendar-scheduling');
    }

    function changeStatusFilter(status) {
      // Implement status filtering logic
      loadPageContent('calendar-scheduling');
    }

    function changeColorCode(mode) {
      // Store the color mode in a global variable
      window.colorMode = mode;
      // Re-render the calendar with new color coding
      loadPageContent('calendar-scheduling');
    }
    // Clear All Filters Function
    function clearAllFilters() {
      selectedFacilityFilter = '';
      window.statusFilter = 'all';
      window.colorMode = 'sport';
      loadPageContent('calendar-scheduling');
    }
    // Generate facility-based color classes
    function getFacilityColorClass(facilityId) {
      const facilityIndex = adminFacilities.findIndex(f => f.id === facilityId);
      const colorIndex = (facilityIndex % 6) + 1; // Cycle through 6 colors
      return `facility-color-${colorIndex}`;
    }

    function prevPeriod() {
      switch (calendarView) {
        case 'day':
          currentCalendarDate.setDate(currentCalendarDate.getDate() - 1);
          break;
        case 'week':
          currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
          break;
        case 'month':
          currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
          break;
      }
      loadPageContent('calendar-scheduling');
    }

    function nextPeriod() {
      switch (calendarView) {
        case 'day':
          currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
          break;
        case 'week':
          currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
          break;
        case 'month':
          currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
          break;
      }
      loadPageContent('calendar-scheduling');
    }

    function goToToday() {
      currentCalendarDate = new Date();
      loadPageContent('calendar-scheduling');
    }

    // Get all bookings for a week
    function getWeekBookings(startOfWeek) {
      const weekBookings = [];
      const weekDates = [];

      // Generate all dates in the week
      for (let i = 0; i < 7; i++) {
        const currentDay = new Date(startOfWeek);
        currentDay.setDate(startOfWeek.getDate() + i);
        const dateStr = currentDay.toISOString().split('T')[0];
        weekDates.push(dateStr);

        const dayBookings = getFilteredBookingsForDate(dateStr);
        weekBookings.push(...dayBookings);
      }

      return weekBookings;
    }

    // Enhanced getStartOfWeek function
    function getStartOfWeek(date) {
      const start = new Date(date);
      const day = start.getDay();
      const diff = start.getDate() - day;
      return new Date(start.setDate(diff));
    }

    // Enhanced getBookingColorClass function with better color visibility
    function getBookingColorClass(booking) {
      // Get facility details to determine sport type
      const facility = adminFacilities.find(f => f.id === booking.facilityId);
      const sportType = facility?.type || 'Other';
      const status = booking.status || 'pending';

      // Map sport types to color classes with better visibility
      const sportColorMap = {
        'Badminton Court': 'badminton-booking',
        'Tennis Court': 'tennis-booking',
        'Basketball Court': 'basketball-booking',
        'Football Field': 'football-booking',
        'Swimming Pool': 'swimming-booking',
        'Gym': 'gym-booking',
        'Other': 'default-booking'
      };

      // Alternative: Color by status
      const statusColorMap = {
        'confirmed': 'status-confirmed',
        'approved': 'status-approved',
        'pending': 'status-pending',
        'completed': 'status-completed',
        'cancelled': 'status-cancelled'
      };

      // Get current color coding mode from global variable
      const colorMode = window.colorMode || 'sport';

      switch (colorMode) {
        case 'status':
          return statusColorMap[status] || 'status-pending';
        case 'facility':
          // Use a consistent color based on facility ID
          const facilityIndex = adminFacilities.findIndex(f => f.id === booking.facilityId);
          const colorIndex = (facilityIndex % 6) + 1;
          return `facility-color-${colorIndex}`;
        case 'sport':
        default:
          return sportColorMap[sportType] || 'default-booking';
      }
    }
    // Check Slot Availability Function
    async function checkSlotAvailability(bookingId, date, timeSlot) {
      try {
        const bookingDoc = await db.collection('bookings').doc(bookingId).get();
        const booking = bookingDoc.data();

        const existingBookings = await db.collection('bookings')
          .where('facilityId', '==', booking.facilityId)
          .where('date', '==', date)
          .where('status', 'in', ['approved', 'pending'])
          .get();

        const [newStart, newEnd] = timeSlot.split('-');

        for (const doc of existingBookings.docs) {
          if (doc.id === bookingId) continue;

          const existingBooking = doc.data();
          if (existingBooking.slot) {
            const [existingStart, existingEnd] = existingBooking.slot.split('-');

            // Check for time overlap
            if ((newStart >= existingStart && newStart < existingEnd) ||
              (newEnd > existingStart && newEnd <= existingEnd) ||
              (newStart <= existingStart && newEnd >= existingEnd)) {
              return false; // Conflict found
            }
          }
        }

        return true; // No conflict
      } catch (error) {
        console.error('Error checking slot availability:', error);
        return false;
      }
    }

    // Update the status filter function to actually filter
    function changeStatusFilter(status) {
      // Store the status filter in a global variable
      window.statusFilter = status;
      loadPageContent('calendar-scheduling');
    }

    // Enhanced drag and drop functions
    function allowDrop(event) {
      event.preventDefault();
      event.currentTarget.classList.add('drag-over');
    }

    function dragBooking(event, bookingId) {
      event.dataTransfer.setData('text/plain', bookingId);
      event.currentTarget.classList.add('dragging');

      // Store the original booking data for conflict checking
      const booking = allBookings.find(b => b.id === bookingId);
      if (booking) {
        event.dataTransfer.setData('application/json', JSON.stringify({
          facilityId: booking.facilityId,
          duration: booking.duration || 1,
          originalDate: booking.date,
          originalSlot: booking.slot
        }));
      }
    }

    async function dropBooking(event, newDate) {
      event.preventDefault();
      const bookingId = event.dataTransfer.getData('text/plain');
      const bookingData = JSON.parse(event.dataTransfer.getData('application/json'));

      // Remove drag-over styling
      event.currentTarget.classList.remove('drag-over');

      try {
        // Check for conflicts
        const conflict = await checkBookingConflict(bookingId, newDate, null);
        if (conflict) {
          showToast('Booking conflict detected! Cannot reschedule.', 'danger');
          return;
        }

        // Update booking date (keep original time slot)
        const bookingDoc = await db.collection('bookings').doc(bookingId).get();
        const booking = bookingDoc.data();

        await db.collection('bookings').doc(bookingId).update({
          date: newDate,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update local booking data
        updateLocalBooking(bookingId, {
          date: newDate
        });

        showToast('Booking date updated successfully', 'success');

        // Refresh the calendar view
        loadPageContent('calendar-scheduling');

      } catch (error) {
        console.error('Error updating booking date:', error);
        showToast('Error updating booking date', 'danger');
      }
    }
    // Calculate end time based on start time and duration
    function calculateEndTime(startTime, duration) {
      const [hours, minutes] = startTime.split(':').map(Number);
      const totalMinutes = hours * 60 + minutes + (duration * 60);

      const endHours = Math.floor(totalMinutes / 60);
      const endMinutes = totalMinutes % 60;

      return `${endHours.toString().padStart(2, '0')}:${endMinutes.toString().padStart(2, '0')}`;
    }
    async function dropBookingToSlot(event, newDate, newTime) {
      event.preventDefault();
      const bookingId = event.dataTransfer.getData('text/plain');
      const bookingData = JSON.parse(event.dataTransfer.getData('application/json'));

      // Remove drag-over styling
      event.currentTarget.classList.remove('drag-over');

      try {
        // Check for conflicts
        const conflict = await checkBookingConflict(bookingId, newDate, newTime);
        if (conflict) {
          showToast('Booking conflict detected! Cannot reschedule.', 'danger');
          return;
        }

        // Update booking date and time
        const bookingDoc = await db.collection('bookings').doc(bookingId).get();
        const booking = bookingDoc.data();
        const duration = booking.duration || 1;
        const endTime = calculateEndTime(newTime, duration);
        const newSlot = `${newTime}-${endTime}`;

        await db.collection('bookings').doc(bookingId).update({
          date: newDate,
          slot: newSlot,
          duration: duration,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update the booking in the local allBookings array
        updateLocalBooking(bookingId, {
          date: newDate,
          slot: newSlot,
          duration: duration
        });

        showToast('Booking rescheduled successfully', 'success');

        // Refresh the calendar view
        loadPageContent('calendar-scheduling');

      } catch (error) {
        console.error('Error rescheduling booking:', error);
        showToast('Error rescheduling booking', 'danger');
      }
    }
    // Update booking in local allBookings array
    function updateLocalBooking(bookingId, updates) {
      const bookingIndex = allBookings.findIndex(b => b.id === bookingId);
      if (bookingIndex !== -1) {
        allBookings[bookingIndex] = {
          ...allBookings[bookingIndex],
          ...updates
        };
        console.log('Updated local booking:', allBookings[bookingIndex]);
      }
    }

    // Enhanced conflict checker
    async function checkBookingConflict(bookingId, newDate, newTime) {
      try {
        const bookingDoc = await db.collection('bookings').doc(bookingId).get();
        if (!bookingDoc.exists) return true;

        const booking = bookingDoc.data();
        const facilityId = booking.facilityId;

        let query = db.collection('bookings')
          .where('facilityId', '==', facilityId)
          .where('date', '==', newDate)
          .where('status', 'in', ['approved', 'pending', 'confirmed']);

        const existingBookings = await query.get();

        if (newTime) {
          // Check for time slot conflicts
          const duration = booking.duration || 1;
          const newStartTime = newTime;
          const newEndTime = calculateEndTime(newStartTime, duration);

          for (const doc of existingBookings.docs) {
            if (doc.id === bookingId) continue; // Skip current booking

            const existingBooking = doc.data();
            if (existingBooking.slot) {
              const [existingStart, existingEnd] = existingBooking.slot.split('-');

              // Check for time overlap
              if ((newStartTime >= existingStart && newStartTime < existingEnd) ||
                (newEndTime > existingStart && newEndTime <= existingEnd) ||
                (newStartTime <= existingStart && newEndTime >= existingEnd)) {
                return true; // Conflict found
              }
            }
          }
        } else {
          // For month view drag (no specific time), check if there are any bookings on that date
          // Only consider it a conflict if there are bookings that would overlap
          const hasOverlappingBookings = existingBookings.docs.some(doc => {
            if (doc.id === bookingId) return false;
            const existingBooking = doc.data();

            // If the dragged booking has a specific time, we'd need to check overlap
            // For now, we'll be conservative and consider any booking on that date as a potential conflict
            return true;
          });

          return hasOverlappingBookings;
        }

        return false; // No conflict
      } catch (error) {
        console.error('Error checking booking conflict:', error);
        return true; // Assume conflict on error to be safe
      }
    }

    // Booking Details Modal - Make sure this exists
    function showBookingDetails(bookingId, event) {
      if (event) {
        event.stopPropagation();
        event.preventDefault();
      }
      viewBooking(bookingId);
    }
    // Refresh calendar data from Firestore
    async function refreshCalendarData() {
      try {
        const facilityIds = adminFacilities.map(f => f.id);

        if (facilityIds.length > 0) {
          const bookingsSnapshot = await db.collection("bookings")
            .where("facilityId", "in", facilityIds)
            .get();

          allBookings = [];
          bookingsSnapshot.forEach(doc => {
            const bookingData = doc.data();
            allBookings.push({
              id: doc.id,
              ...bookingData
            });
          });

          console.log('Refreshed calendar data:', allBookings.length, 'bookings');
        }
      } catch (error) {
        console.error('Error refreshing calendar data:', error);
      }
    }

    async function loadAIInsightsPage() {
  try {
    // Fetch real data from Firestore
    const facilityIds = adminFacilities.map(f => f.id);
    let bookings = [];
    let totalRevenue = 0;
    let peakHours = {};
    let popularFacilities = {};
    let monthlyRevenue = {};
    let facilityPerformance = {};
    let bookingTrends = {};
    let statusDistribution = {};

    if (facilityIds.length > 0) {
      const bookingsSnapshot = await db.collection("bookings")
        .where("facilityId", "in", facilityIds)
        .get();

      bookingsSnapshot.forEach(doc => {
        const booking = doc.data();
        bookings.push({ id: doc.id, ...booking });

        // Calculate total revenue
        if (booking.price) {
          totalRevenue += parseFloat(booking.price);
        }

        // Track peak hours
        if (booking.slot) {
          const timeSlot = booking.slot.split('-')[0];
          const hour = timeSlot.includes(':') ? timeSlot.split(':')[0] : timeSlot;
          peakHours[hour] = (peakHours[hour] || 0) + 1;
        }

        // Track popular facilities
        if (booking.facilityName) {
          popularFacilities[booking.facilityName] = (popularFacilities[booking.facilityName] || 0) + 1;
        }

        // Calculate monthly revenue
        if (booking.timestamp) {
          const month = booking.timestamp.toDate().toLocaleString('default', { month: 'short', year: 'numeric' });
          const price = parseFloat(booking.price) || 0;
          monthlyRevenue[month] = (monthlyRevenue[month] || 0) + price;
        }

        // Track facility performance
        if (booking.facilityName) {
          if (!facilityPerformance[booking.facilityName]) {
            facilityPerformance[booking.facilityName] = {
              bookings: 0,
              revenue: 0
            };
          }
          facilityPerformance[booking.facilityName].bookings++;
          facilityPerformance[booking.facilityName].revenue += parseFloat(booking.price) || 0;
        }

        // Track booking trends (last 30 days)
        if (booking.timestamp) {
          const bookingDate = booking.timestamp.toDate();
          const today = new Date();
          const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);

          if (bookingDate >= thirtyDaysAgo) {
            const day = bookingDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
            bookingTrends[day] = (bookingTrends[day] || 0) + 1;
          }
        }

        // Track status distribution
        const status = booking.status || 'pending';
        statusDistribution[status] = (statusDistribution[status] || 0) + 1;
      });
    }

    // Find peak hour
    let peakHour = 'N/A';
    let maxBookings = 0;
    for (const [hour, count] of Object.entries(peakHours)) {
      if (count > maxBookings) {
        maxBookings = count;
        peakHour = `${hour}:00`;
      }
    }

    // Find most popular facility
    let popularFacility = 'N/A';
    let maxFacilityBookings = 0;
    for (const [facility, count] of Object.entries(popularFacilities)) {
      if (count > maxFacilityBookings) {
        maxFacilityBookings = count;
        popularFacility = facility;
      }
    }

    // Calculate utilization rate
    const totalSlotsPerDay = adminFacilities.length * 14; // Assuming 14 slots per day (7 AM to 9 PM)
    const daysInMonth = 30; // Approximation
    const totalPossibleSlots = totalSlotsPerDay * daysInMonth;
    const utilizationRate = totalPossibleSlots > 0 ? (bookings.length / totalPossibleSlots * 100).toFixed(1) : 0;

    // Calculate average booking value
    const avgBookingValue = bookings.length > 0 ? (totalRevenue / bookings.length).toFixed(2) : 0;

    // Get top performing facilities
    const topFacilities = Object.entries(facilityPerformance)
      .sort(([, a], [, b]) => b.revenue - a.revenue)
      .slice(0, 3)
      .map(([name, data]) => ({ name, ...data }));

    // Generate recommendations based on real data
    const recommendations = generateAIRecommendations({
      peakHour,
      popularFacility,
      utilizationRate,
      avgBookingValue,
      topFacilities,
      totalBookings: bookings.length,
      totalRevenue,
      statusDistribution
    });

    // Store data for charts
    window.monthlyRevenueData = monthlyRevenue;
    window.bookingTrendsData = bookingTrends;
    window.facilityPerformanceData = facilityPerformance;
    window.statusDistributionData = statusDistribution;

    return `
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3>AI Insights & Analytics</h3>
        <button class="btn btn-primary" onclick="refreshInsights()">
          <i class="fas fa-sync-alt me-1"></i> Refresh Insights
        </button>
      </div>
      
      <div class="row">
        <div class="col-md-8">
          <div class="table-card">
            <h4>Revenue Trends</h4>
            <div class="chart-container" style="height: 300px;">
              <canvas id="revenueChart"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="stats-card mb-4">
            <i class="fas fa-chart-line"></i>
            <div class="number">${bookings.length}</div>
            <div class="label">Total Bookings</div>
          </div>
          <div class="stats-card mb-4">
            <i class="fas fa-dollar-sign"></i>
            <div class="number">RM${totalRevenue.toFixed(2)}</div>
            <div class="label">Total Revenue</div>
          </div>
          <div class="stats-card mb-4">
            <i class="fas fa-clock"></i>
            <div class="number">${peakHour}</div>
            <div class="label">Peak Hour</div>
          </div>
          <div class="stats-card">
            <i class="fas fa-star"></i>
            <div class="number">${popularFacility.length > 15 ? popularFacility.substring(0, 15) + '...' : popularFacility}</div>
            <div class="label">Most Popular Facility</div>
          </div>
        </div>
      </div>
      
      <div class="row mt-4">
        <div class="col-md-6">
          <div class="table-card">
            <h4>AI-Powered Recommendations</h4>
            <ul class="list-group list-group-flush">
              ${recommendations.map(rec => `
                <li class="list-group-item">
                  <i class="fas fa-robot text-primary me-2"></i>
                  ${rec}
                </li>
              `).join('')}
            </ul>
          </div>
          
          <div class="table-card mt-4">
            <h4>Top Performing Facilities</h4>
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Facility</th>
                    <th>Bookings</th>
                    <th>Revenue</th>
                  </tr>
                </thead>
                <tbody>
                  ${topFacilities.length > 0 ? topFacilities.map(facility => `
                    <tr>
                      <td>${facility.name}</td>
                      <td>${facility.bookings}</td>
                      <td>RM${facility.revenue.toFixed(2)}</td>
                    </tr>
                  `).join('') : `
                    <tr>
                      <td colspan="3" class="text-center text-muted">No facility data available</td>
                    </tr>
                  `}
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-6">
          <div class="table-card">
            <h4>Booking Trends</h4>
            <div class="chart-container" style="height: 300px;">
              <canvas id="trendsChart"></canvas>
            </div>
          </div>
          
          <div class="row mt-4">
            <div class="col-md-6">
              <div class="stats-card">
                <i class="fas fa-percentage"></i>
                <div class="number">${utilizationRate}%</div>
                <div class="label">Utilization Rate</div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="stats-card">
                <i class="fas fa-money-bill-wave"></i>
                <div class="number">RM${avgBookingValue}</div>
                <div class="label">Avg. Booking Value</div>
              </div>
            </div>
          </div>

          <div class="table-card mt-4">
            <h4>Booking Status Distribution</h4>
            <div class="chart-container" style="height: 200px;">
              <canvas id="statusChart"></canvas>
            </div>
          </div>
        </div>
      </div>
    `;
  } catch (error) {
    console.error("Error loading AI insights:", error);
    return `
      <div class="alert alert-danger">
        <h4>Error Loading Insights</h4>
        <p>There was an error loading AI insights data. Please try again.</p>
        <p><small>Error details: ${error.message}</small></p>
        <button class="btn btn-primary mt-2" onclick="loadPageContent('ai-insights')">
          <i class="fas fa-redo me-1"></i> Retry
        </button>
      </div>
    `;
  }
}
// Add this to your initializePageFunctionality function
function initializePageFunctionality(page) {
  switch (page) {
    case 'ai-insights':
      setTimeout(() => {
        initializeAICharts();
      }, 500);
      break;
    // ... other page initializations
  }
}

    // AI Recommendation Engine based on real data
function generateAIRecommendations(data) {
  const recommendations = [];

  // Peak hour recommendations
  if (data.peakHour && data.peakHour !== 'N/A') {
    recommendations.push(`Increase pricing by 10-15% during ${data.peakHour} peak hours to maximize revenue`);
  }

  // Popular facility recommendations
  if (data.popularFacility && data.popularFacility !== 'N/A') {
    recommendations.push(`Promote ${data.popularFacility.split(' ')[0]} more as it's your most booked facility`);
    recommendations.push(`Consider adding similar facilities to meet high demand for ${data.popularFacility.split(' ')[0]}`);
  }

  // Utilization rate recommendations
  if (parseFloat(data.utilizationRate) < 30) {
    recommendations.push('Launch off-peak discounts (20-30% off) to boost facility utilization');
    recommendations.push('Run targeted promotions during low-usage periods');
  } else if (parseFloat(data.utilizationRate) > 80) {
    recommendations.push('Consider expanding capacity or adding more time slots due to high demand');
  }

  // Revenue-based recommendations
  if (data.totalRevenue > 1000) {
    recommendations.push('Introduce premium membership packages for loyal customers');
  } else if (data.totalRevenue < 500) {
    recommendations.push('Focus on marketing campaigns to increase booking volume');
  }

  // Status-based recommendations
  if (data.statusDistribution) {
    const pendingCount = data.statusDistribution.pending || 0;
    const totalBookings = data.totalBookings || 1;

    if (pendingCount / totalBookings > 0.2) {
      recommendations.push('Speed up booking approvals - high number of pending bookings');
    }

    if (data.statusDistribution.cancelled && data.statusDistribution.cancelled / totalBookings > 0.1) {
      recommendations.push('Review cancellation reasons and consider flexible rescheduling options');
    }
  }

  // Seasonal recommendations
  const currentMonth = new Date().getMonth();
  if (currentMonth >= 10 || currentMonth <= 1) {
    recommendations.push('Promote indoor facilities and winter sports packages');
  } else if (currentMonth >= 5 && currentMonth <= 8) {
    recommendations.push('Focus on outdoor facilities and summer sports promotions');
  }

  // Average booking value recommendations
  if (parseFloat(data.avgBookingValue) < 50) {
    recommendations.push('Create bundled packages to increase average booking value');
  }

  // Ensure minimum recommendations
  if (recommendations.length < 4) {
    recommendations.push('Collect customer feedback to identify service improvement areas');
    recommendations.push('Monitor booking patterns to optimize pricing strategies');
    recommendations.push('Consider partnerships with local sports clubs or organizations');
  }

  return recommendations.slice(0, 6); // Return top 6 most relevant recommendations
}
    // Enhanced chart initialization for AI Insights
function initializeAICharts() {
  try {
    // Revenue Chart
    const revenueCtx = document.getElementById('revenueChart');
    if (revenueCtx) {
      const monthlyData = window.monthlyRevenueData || {};
      const months = Object.keys(monthlyData);
      const revenueData = Object.values(monthlyData);

      new Chart(revenueCtx, {
        type: 'bar',
        data: {
          labels: months,
          datasets: [{
            label: 'Monthly Revenue (RM)',
            data: revenueData,
            backgroundColor: '#4361ee',
            borderColor: '#3a0ca3',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Revenue (RM)'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Month'
              }
            }
          }
        }
      });
    }

    // Trends Chart
    const trendsCtx = document.getElementById('trendsChart');
    if (trendsCtx) {
      const trendsData = window.bookingTrendsData || {};
      const days = Object.keys(trendsData);
      const bookingsCount = Object.values(trendsData);

      new Chart(trendsCtx, {
        type: 'line',
        data: {
          labels: days,
          datasets: [{
            label: 'Daily Bookings',
            data: bookingsCount,
            borderColor: '#4cc9f0',
            backgroundColor: 'rgba(76, 201, 240, 0.1)',
            borderWidth: 3,
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Number of Bookings'
              }
            },
            x: {
              title: {
                display: true,
                text: 'Date'
              }
            }
          }
        }
      });
    }

    // Status Chart
    const statusCtx = document.getElementById('statusChart');
    if (statusCtx) {
      const statusData = window.statusDistributionData || {};
      const statuses = Object.keys(statusData);
      const statusCounts = Object.values(statusData);

      const statusColors = {
        'approved': '#28a745',
        'pending': '#ffc107',
        'completed': '#17a2b8',
        'cancelled': '#dc3545',
        'confirmed': '#20c997'
      };

      new Chart(statusCtx, {
        type: 'doughnut',
        data: {
          labels: statuses.map(s => s.charAt(0).toUpperCase() + s.slice(1)),
          datasets: [{
            data: statusCounts,
            backgroundColor: statuses.map(s => statusColors[s] || '#6c757d'),
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'bottom'
            }
          }
        }
      });
    }
  } catch (error) {
    console.error('Error initializing AI charts:', error);
  }
}

// Refresh insights function
function refreshInsights() {
  showToast('Refreshing AI insights with latest data', 'info');
  loadPageContent('ai-insights');
}

    // In the loadPromoVouchersPage function, replace the Firestore query:
    async function loadPromoVouchersPage() {
      try {
        // Fetch promos from Firestore - try multiple possible collection names
        let promosSnapshot;
        let promos = [];

        // Try different collection names
        try {
          promosSnapshot = await db.collection("promos").get();
        } catch (error) {
          console.log("Trying 'promotions' collection...");
          try {
            promosSnapshot = await db.collection("promotions").get();
          } catch (error2) {
            console.log("No promos collection found");
            promosSnapshot = { empty: true, forEach: () => { } };
          }
        }

        // If we have a snapshot, process the data
        if (promosSnapshot && !promosSnapshot.empty) {
          promosSnapshot.forEach(doc => {
            const promoData = doc.data();
            promos.push({
              id: doc.id,
              ...promoData,
              // Ensure proper date formatting
              validFrom: promoData.validFrom ? promoData.validFrom.toDate() : null,
              validTo: promoData.validTo ? promoData.validTo.toDate() : null
            });
          });
        }

        let promosHTML = '';

        if (promos.length === 0) {
          promosHTML = `
                <tr>
                    <td colspan="7" class="text-center py-4">
                        <div class="text-muted">
                            <i class="fas fa-tags fa-2x mb-3"></i>
                            <p>No promotions found</p>
                            <small>Create your first promotion to attract more customers</small>
                        </div>
                    </td>
                </tr>
            `;
        } else {
          promos.forEach(promo => {
            const validFrom = promo.validFrom ? promo.validFrom.toLocaleDateString() : 'N/A';
            const validTo = promo.validTo ? promo.validTo.toLocaleDateString() : 'N/A';
            const discountValue = promo.type === 'percentage' ?
              `${promo.discountValue || promo.discount || 0}%` :
              `RM${promo.discountValue || promo.discount || 0}`;

            // Check if promo is active
            const now = new Date();
            const isActive = promo.validFrom && promo.validTo &&
              now >= promo.validFrom && now <= promo.validTo &&
              promo.status !== 'inactive';

            promosHTML += `
                    <tr>
                        <td>
                            <div class="fw-semibold">${promo.code || 'N/A'}</div>
                            <small class="text-muted">${promo.description || 'No description'}</small>
                        </td>
                        <td>${promo.type ? promo.type.charAt(0).toUpperCase() + promo.type.slice(1) : 'N/A'}</td>
                        <td>${discountValue}</td>
                        <td>${validFrom}</td>
                        <td>${validTo}</td>
                        <td>
                            <span class="badge ${isActive ? 'bg-success' : 'bg-secondary'}">
                                ${isActive ? 'Active' : 'Inactive'}
                            </span>
                        </td>
                        <td>${promo.usageCount || 0}/${promo.maxUsage || ''}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <button class="btn btn-sm btn-primary me-1" onclick="editPromo('${promo.id}')" title="Edit Promo">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deletePromo('${promo.id}')" title="Delete Promo">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
          });
        }

        return `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h3>Promo & Vouchers Management</h3>
                <button class="btn btn-primary" onclick="showPromoModal()">
                    <i class="fas fa-plus me-1"></i> Add New Promo
                </button>
            </div>
            
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-tags"></i>
                        <div class="number">${promos.length}</div>
                        <div class="label">Total Promos</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-check-circle"></i>
                        <div class="number">${promos.filter(p => {
          const now = new Date();
          return p.validFrom && p.validTo && now >= p.validFrom && now <= p.validTo && p.status !== 'inactive';
        }).length}</div>
                        <div class="label">Active Promos</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-users"></i>
                        <div class="number">${promos.reduce((sum, promo) => sum + (promo.usageCount || 0), 0)}</div>
                        <div class="label">Total Usage</div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-gift"></i>
                        <div class="number">${new Set(promos.map(p => p.type)).size}</div>
                        <div class="label">Promo Types</div>
                    </div>
                </div>
            </div>
            
            <div class="table-card">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Promo Code & Description</th>
                                <th>Type</th>
                                <th>Discount</th>
                                <th>Valid From</th>
                                <th>Valid To</th>
                                <th>Status</th>
                                <th>Usage</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="promosTableBody">
                            ${promosHTML}
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Promo Modal will be dynamically inserted -->
        `;
      } catch (error) {
        console.error("Error loading promo vouchers page:", error);
        return `
            <div class="alert alert-danger">
                <h4>Error Loading Promotions</h4>
                <p>There was an error loading promo data. Please try again.</p>
                <button class="btn btn-primary mt-2" onclick="loadPageContent('promo-vouchers')">
                    <i class="fas fa-redo me-1"></i> Retry
                </button>
            </div>
        `;
      }
    }

    // Fixed showPromoModal function
    function showPromoModal(promoId = null, promoData = null) {
      const modalContent = `
        <div class="modal fade" id="promoModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="promoModalTitle">${promoId ? 'Edit Promotion' : 'Add New Promo'}</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="promoForm">
                            <input type="hidden" id="promoId" value="${promoId || ''}">
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Promo Code *</label>
                                        <input type="text" class="form-control" id="promoCode" 
                                               value="${promoData?.code || ''}" 
                                               placeholder="SUMMER2024" required>
                                        <small class="form-text text-muted">Unique code customers will use</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Promo Type *</label>
                                        <select class="form-select" id="promoType" required>
                                            <option value="">Select Type</option>
                                            <option value="percentage" ${promoData?.type === 'percentage' ? 'selected' : ''}>Percentage Discount</option>
                                            <option value="fixed" ${promoData?.type === 'fixed' ? 'selected' : ''}>Fixed Amount</option>
                                            <option value="free_shipping" ${promoData?.type === 'free_shipping' ? 'selected' : ''}>Free Shipping</option>
                                            <option value="free_item" ${promoData?.type === 'free_item' ? 'selected' : ''}>Free Item</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Discount Value *</label>
                                        <input type="number" class="form-control" id="promoDiscount" 
                                               value="${promoData?.discountValue || promoData?.discount || ''}" 
                                               min="0" step="0.01" required>
                                        <small class="form-text text-muted" id="discountHelp">
                                            For percentage: 10 = 10% off. For fixed: 20 = RM20 off
                                        </small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Minimum Purchase (RM)</label>
                                        <input type="number" class="form-control" id="promoMinPurchase" 
                                               value="${promoData?.minPurchase || ''}" 
                                               min="0" step="0.01" placeholder="No minimum">
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Valid From *</label>
                                        <input type="datetime-local" class="form-control" id="promoValidFrom" 
                                               value="${promoData?.validFrom ? promoData.validFrom.toISOString().slice(0, 16) : ''}" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Valid To *</label>
                                        <input type="datetime-local" class="form-control" id="promoValidTo" 
                                               value="${promoData?.validTo ? promoData.validTo.toISOString().slice(0, 16) : ''}" required>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Maximum Usage</label>
                                        <input type="number" class="form-control" id="promoMaxUsage" 
                                               value="${promoData?.maxUsage || ''}" 
                                               min="1" placeholder="Unlimited">
                                        <small class="form-text text-muted">Leave empty for unlimited usage</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Usage Per Customer</label>
                                        <input type="number" class="form-control" id="promoUsagePerCustomer" 
                                               value="${promoData?.usagePerCustomer || 1}" 
                                               min="1" value="1">
                                        <small class="form-text text-muted">How many times each customer can use this promo</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="promoDescription" rows="3" 
                                          placeholder="Describe this promotion...">${promoData?.description || ''}</textarea>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label class="form-label">Applicable Facilities</label>
                                <select class="form-select" id="promoFacilities" multiple>
                                    ${adminFacilities.map(facility =>
        `<option value="${facility.id}">${facility.name} (${facility.type})</option>`
      ).join('')}
                                </select>
                                <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple facilities. Leave empty for all facilities.</small>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="promoActive" ${promoData?.status !== 'inactive' ? 'checked' : ''}>
                                <label class="form-check-label" for="promoActive">
                                    Active Promotion
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        ${promoId ? `
                            <button type="button" class="btn btn-danger" onclick="deletePromo('${promoId}')">Delete Promo</button>
                        ` : ''}
                        <button type="button" class="btn btn-primary" onclick="savePromo()">Save Promo</button>
                    </div>
                </div>
            </div>
        </div>
    `;

      // Remove existing modal if any
      const existingModal = document.getElementById('promoModal');
      if (existingModal) {
        existingModal.remove();
      }

      // Add modal to page
      document.body.insertAdjacentHTML('beforeend', modalContent);

      // Set up facilities selection if editing
      if (promoData && promoData.facilities) {
        setTimeout(() => {
          const facilitiesSelect = document.getElementById('promoFacilities');
          if (facilitiesSelect) {
            Array.from(facilitiesSelect.options).forEach(option => {
              option.selected = promoData.facilities.includes(option.value);
            });
          }
        }, 100);
      }

      // Show modal
      const promoModal = new bootstrap.Modal(document.getElementById('promoModal'));
      promoModal.show();

      // Set default dates if creating new promo
      if (!promoId) {
        const today = new Date();
        const nextMonth = new Date(today);
        nextMonth.setDate(today.getDate() + 30);

        document.getElementById('promoValidFrom').value = today.toISOString().slice(0, 16);
        document.getElementById('promoValidTo').value = nextMonth.toISOString().slice(0, 16);
      }

      // Remove modal when hidden
      document.getElementById('promoModal').addEventListener('hidden.bs.modal', function () {
        this.remove();
      });
    }

    // Enhanced editPromo function with better error handling
    async function editPromo(promoId) {
      try {
        console.log('Editing promo ID:', promoId);

        if (!promoId) {
          showToast('Invalid promo ID', 'danger');
          return;
        }

        // Try multiple collection names with better error handling
        let promoDoc = null;
        let collectionName = null;

        // Try 'promos' collection first
        try {
          promoDoc = await db.collection("promos").doc(promoId).get();
          if (promoDoc.exists) {
            collectionName = "promos";
            console.log('Found promo in "promos" collection');
          }
        } catch (error) {
          console.log('"promos" collection not accessible:', error);
        }

        // If not found, try 'promotions' collection
        if (!promoDoc || !promoDoc.exists) {
          try {
            promoDoc = await db.collection("promotions").doc(promoId).get();
            if (promoDoc.exists) {
              collectionName = "promotions";
              console.log('Found promo in "promotions" collection');
            }
          } catch (error) {
            console.log('"promotions" collection not accessible:', error);
          }
        }

        // If still not found, show error
        if (!promoDoc || !promoDoc.exists) {
          console.error('Promo not found in any collection. ID:', promoId);
          showToast('Promo not found. It may have been deleted.', 'danger');
          return;
        }

        const promoData = promoDoc.data();
        console.log('Promo data loaded:', promoData);

        // Store collection name for later use
        promoData._collectionName = collectionName;

        showPromoModal(promoId, promoData);

      } catch (error) {
        console.error('Error in editPromo:', error);
        showToast('Error loading promo details: ' + error.message, 'danger');
      }
    }

    // Enhanced showPromoModal function with better data handling
    function showPromoModal(promoId = null, promoData = null) {
      try {
        console.log('Showing promo modal. ID:', promoId, 'Data:', promoData);

        // Format dates for input fields
        let validFromValue = '';
        let validToValue = '';

        if (promoData) {
          if (promoData.validFrom && promoData.validFrom.toDate) {
            validFromValue = promoData.validFrom.toDate().toISOString().slice(0, 16);
          } else if (promoData.validFrom instanceof Date) {
            validFromValue = promoData.validFrom.toISOString().slice(0, 16);
          }

          if (promoData.validTo && promoData.validTo.toDate) {
            validToValue = promoData.validTo.toDate().toISOString().slice(0, 16);
          } else if (promoData.validTo instanceof Date) {
            validToValue = promoData.validTo.toISOString().slice(0, 16);
          }
        }

        const modalContent = `
            <div class="modal fade" id="promoModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title" id="promoModalTitle">${promoId ? 'Edit Promotion' : 'Add New Promo'}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="promoForm">
                                <input type="hidden" id="promoId" value="${promoId || ''}">
                                <input type="hidden" id="promoCollection" value="${promoData?._collectionName || 'promos'}">
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Promo Code *</label>
                                            <input type="text" class="form-control" id="promoCode" 
                                                   value="${promoData?.code || ''}" 
                                                   placeholder="SUMMER2024" required>
                                            <small class="form-text text-muted">Unique code customers will use</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Promo Type *</label>
                                            <select class="form-select" id="promoType" required>
                                                <option value="">Select Type</option>
                                                <option value="percentage" ${promoData?.type === 'percentage' ? 'selected' : ''}>Percentage Discount</option>
                                                <option value="fixed" ${promoData?.type === 'fixed' ? 'selected' : ''}>Fixed Amount</option>
                                                <option value="free_shipping" ${promoData?.type === 'free_shipping' ? 'selected' : ''}>Free Shipping</option>
                                                <option value="free_item" ${promoData?.type === 'free_item' ? 'selected' : ''}>Free Item</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Discount Value *</label>
                                            <input type="number" class="form-control" id="promoDiscount" 
                                                   value="${promoData?.discountValue || promoData?.discount || ''}" 
                                                   min="0" step="0.01" required>
                                            <small class="form-text text-muted" id="discountHelp">
                                                For percentage: 10 = 10% off. For fixed: 20 = RM20 off
                                            </small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Minimum Purchase (RM)</label>
                                            <input type="number" class="form-control" id="promoMinPurchase" 
                                                   value="${promoData?.minPurchase || ''}" 
                                                   min="0" step="0.01" placeholder="No minimum">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Valid From *</label>
                                            <input type="datetime-local" class="form-control" id="promoValidFrom" 
                                                   value="${validFromValue}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Valid To *</label>
                                            <input type="datetime-local" class="form-control" id="promoValidTo" 
                                                   value="${validToValue}" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Maximum Usage</label>
                                            <input type="number" class="form-control" id="promoMaxUsage" 
                                                   value="${promoData?.maxUsage || ''}" 
                                                   min="1" placeholder="Unlimited">
                                            <small class="form-text text-muted">Leave empty for unlimited usage</small>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Usage Per Customer</label>
                                            <input type="number" class="form-control" id="promoUsagePerCustomer" 
                                                   value="${promoData?.usagePerCustomer || 1}" 
                                                   min="1">
                                            <small class="form-text text-muted">How many times each customer can use this promo</small>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" id="promoDescription" rows="3" 
                                              placeholder="Describe this promotion...">${promoData?.description || ''}</textarea>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label class="form-label">Applicable Facilities</label>
                                    <select class="form-select" id="promoFacilities" multiple>
                                        ${adminFacilities.map(facility =>
          `<option value="${facility.id}">${facility.name} (${facility.type})</option>`
        ).join('')}
                                    </select>
                                    <small class="form-text text-muted">Hold Ctrl/Cmd to select multiple facilities. Leave empty for all facilities.</small>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="promoActive" ${(promoData?.status !== 'inactive' && promoData?.status !== false) ? 'checked' : ''}>
                                    <label class="form-check-label" for="promoActive">
                                        Active Promotion
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            ${promoId ? `
                                <button type="button" class="btn btn-danger" onclick="deletePromo('${promoId}', '${promoData?._collectionName || 'promos'}')">Delete Promo</button>
                            ` : ''}
                            <button type="button" class="btn btn-primary" onclick="savePromo()">Save Promo</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('promoModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalContent);

        // Set up facilities selection if editing and facilities data exists
        if (promoData && promoData.facilities) {
          setTimeout(() => {
            const facilitiesSelect = document.getElementById('promoFacilities');
            if (facilitiesSelect && Array.isArray(promoData.facilities)) {
              Array.from(facilitiesSelect.options).forEach(option => {
                option.selected = promoData.facilities.includes(option.value);
              });
            }
          }, 100);
        }

        // Set default dates if creating new promo
        if (!promoId) {
          setTimeout(() => {
            const today = new Date();
            const nextMonth = new Date(today);
            nextMonth.setDate(today.getDate() + 30);

            document.getElementById('promoValidFrom').value = today.toISOString().slice(0, 16);
            document.getElementById('promoValidTo').value = nextMonth.toISOString().slice(0, 16);
          }, 100);
        }

        // Show modal
        const promoModal = new bootstrap.Modal(document.getElementById('promoModal'));
        promoModal.show();

        // Remove modal when hidden
        document.getElementById('promoModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });

      } catch (error) {
        console.error('Error showing promo modal:', error);
        showToast('Error opening promo form: ' + error.message, 'danger');
      }
    }

    // Enhanced savePromo function
    async function savePromo() {
      try {
        const promoId = document.getElementById('promoId').value;
        const collectionName = document.getElementById('promoCollection').value || 'promos';

        const promoData = {
          code: document.getElementById('promoCode').value.trim().toUpperCase(),
          type: document.getElementById('promoType').value,
          discountValue: parseFloat(document.getElementById('promoDiscount').value),
          minPurchase: document.getElementById('promoMinPurchase').value ?
            parseFloat(document.getElementById('promoMinPurchase').value) : null,
          maxUsage: document.getElementById('promoMaxUsage').value ?
            parseInt(document.getElementById('promoMaxUsage').value) : null,
          usagePerCustomer: parseInt(document.getElementById('promoUsagePerCustomer').value) || 1,
          description: document.getElementById('promoDescription').value.trim(),
          validFrom: new Date(document.getElementById('promoValidFrom').value),
          validTo: new Date(document.getElementById('promoValidTo').value),
          status: document.getElementById('promoActive').checked ? 'active' : 'inactive',
          facilities: Array.from(document.getElementById('promoFacilities').selectedOptions)
            .map(option => option.value),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Validation
        if (!promoData.code) {
          showToast('Please enter a promo code', 'warning');
          return;
        }

        if (promoData.validTo <= promoData.validFrom) {
          showToast('Valid To date must be after Valid From date', 'warning');
          return;
        }

        if (promoData.discountValue <= 0) {
          showToast('Discount value must be greater than 0', 'warning');
          return;
        }

        console.log('Saving promo data:', promoData);
        console.log('Collection:', collectionName, 'Promo ID:', promoId);

        if (promoId) {
          // Update existing promo
          await db.collection(collectionName).doc(promoId).update(promoData);
          showToast('Promo updated successfully', 'success');
        } else {
          // Create new promo
          promoData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
          promoData.usageCount = 0;
          const result = await db.collection(collectionName).add(promoData);
          console.log('New promo created with ID:', result.id);
          showToast('Promo created successfully', 'success');
        }

        // Close modal and reload
        const modal = bootstrap.Modal.getInstance(document.getElementById('promoModal'));
        if (modal) {
          modal.hide();
        }

        // Reload the promo page
        setTimeout(() => {
          loadPageContent('promo-vouchers');
        }, 500);

      } catch (error) {
        console.error('Error saving promo:', error);
        showToast('Error saving promo: ' + error.message, 'danger');
      }
    }

    // Enhanced deletePromo function
    async function deletePromo(promoId, collectionName = 'promos') {
      try {
        if (!promoId) {
          showToast('Invalid promo ID', 'danger');
          return;
        }

        if (!confirm('Are you sure you want to delete this promo? This action cannot be undone.')) {
          return;
        }

        console.log('Deleting promo:', promoId, 'from collection:', collectionName);

        await db.collection(collectionName).doc(promoId).delete();
        showToast('Promo deleted successfully', 'success');

        // Close modal and reload
        const modal = document.getElementById('promoModal');
        if (modal) {
          bootstrap.Modal.getInstance(modal).hide();
        }

        setTimeout(() => {
          loadPageContent('promo-vouchers');
        }, 500);

      } catch (error) {
        console.error('Error deleting promo:', error);
        showToast('Error deleting promo: ' + error.message, 'danger');
      }
    }


    // Make sure to update the window object with the new functions
    window.showPromoModal = showPromoModal;
    window.editPromo = editPromo;
    window.savePromo = savePromo;
    window.deletePromo = deletePromo;

    async function loadReportsPage() {
      // Fetch data for reports
      const facilityIds = adminFacilities.map(f => f.id);
      let bookings = [];
      let totalRevenue = 0;
      let monthlyRevenue = {};

      if (facilityIds.length > 0) {
        const bookingsSnapshot = await db.collection("bookings")
          .where("facilityId", "in", facilityIds)
          .get();

        bookingsSnapshot.forEach(doc => {
          const booking = doc.data();
          bookings.push(booking);

          if (booking.price) {
            totalRevenue += parseFloat(booking.price);

            // Calculate monthly revenue
            if (booking.timestamp) {
              const month = booking.timestamp.toDate().toLocaleString('default', { month: 'short', year: 'numeric' });
              monthlyRevenue[month] = (monthlyRevenue[month] || 0) + parseFloat(booking.price);
            }
          }
        });
      }

      const months = Object.keys(monthlyRevenue);
      const revenueData = Object.values(monthlyRevenue);

      return `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>Reports & Analytics</h3>
          <div>
            <button class="btn btn-primary me-2" onclick="generatePDFReport()">
              <i class="fas fa-file-pdf me-1"></i> PDF Report
            </button>
            <button class="btn btn-success" onclick="exportReportData()">
              <i class="fas fa-file-excel me-1"></i> Export Data
            </button>
          </div>
        </div>
        
        <div class="row mb-4">
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-calendar-check"></i>
              <div class="number">${bookings.length}</div>
              <div class="label">Total Bookings</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-dollar-sign"></i>
              <div class="number">RM${totalRevenue.toFixed(2)}</div>
              <div class="label">Total Revenue</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-users"></i>
              <div class="number">${new Set(bookings.map(b => b.userId)).size}</div>
              <div class="label">Unique Customers</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-percentage"></i>
              <div class="number">${adminFacilities.length > 0 ? (bookings.length / (adminFacilities.length * 30)).toFixed(1) : '0'}%</div>
              <div class="label">Utilization Rate</div>
            </div>
          </div>
        </div>
        
        <div class="row">
          <div class="col-md-8">
            <div class="table-card">
              <h4>Revenue Trend</h4>
              <div class="chart-container">
                <canvas id="reportsChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="table-card">
              <h4>Top Facilities</h4>
              <div class="chart-container">
                <canvas id="facilitiesChart"></canvas>
              </div>
            </div>
          </div>
        </div>
        
        <div class="row mt-4">
          <div class="col-md-6">
            <div class="table-card">
              <h4>Booking Status Distribution</h4>
              <div class="chart-container">
                <canvas id="statusChart"></canvas>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="table-card">
              <h4>Recent Activity</h4>
              <div class="table-responsive">
                <table class="table table-sm">
                  <thead>
                    <tr>
                      <th>User</th>
                      <th>Facility</th>
                      <th>Date</th>
                      <th>Amount</th>
                    </tr>
                  </thead>
                  <tbody>
                    ${bookings.slice(0, 5).map(booking => `
                      <tr>
                        <td>${booking.userName || 'Unknown'}</td>
                        <td>${booking.facilityName || 'Unknown'}</td>
                        <td>${booking.date || 'N/A'}</td>
                        <td>RM${booking.price || '0'}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadNotificationsPage() {
      return `
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3>Notifications</h3>
            <div>
                <button class="btn btn-primary me-2" onclick="createSampleNotifications()">
                    <i class="fas fa-plus me-1"></i> Create Sample
                </button>
                <button class="btn btn-success" onclick="markAllAsRead()">
                    <i class="fas fa-check-double me-1"></i> Mark All as Read
                </button>
            </div>
        </div>
        
        <!-- Notification Filters -->
        <div class="row mb-4">
            <div class="col-md-12">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-primary active" onclick="filterNotifications('all')">
                        All Notifications
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="filterNotifications('unread')">
                        Unread Only
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="filterNotifications('booking')">
                        Bookings
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="filterNotifications('payment')">
                        Payments
                    </button>
                    <button type="button" class="btn btn-outline-primary" onclick="filterNotifications('system')">
                        System
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Notifications Container -->
        <div class="table-card">
            <div id="notificationsContainer">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status"></div>
                    <p class="mt-2">Loading notifications...</p>
                </div>
            </div>
        </div>
        
        <!-- Notification Stats -->
        <div class="row mt-4">
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-bell"></i>
                    <div class="number" id="totalNotifications">0</div>
                    <div class="label">Total</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-envelope"></i>
                    <div class="number" id="unreadNotifications">0</div>
                    <div class="label">Unread</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-calendar-check"></i>
                    <div class="number" id="bookingNotifications">0</div>
                    <div class="label">Booking Alerts</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card">
                    <i class="fas fa-money-bill-wave"></i>
                    <div class="number" id="paymentNotifications">0</div>
                    <div class="label">Payment Alerts</div>
                </div>
            </div>
        </div>
    `;
    }
    // Real-time notifications listener
    let notificationsListener = null;

    function initializeNotifications() {
      // Remove existing listener if any
      if (notificationsListener) {
        notificationsListener();
      }

      // Get facility IDs for this admin
      const facilityIds = adminFacilities.map(f => f.id);

      if (facilityIds.length === 0) {
        document.getElementById('notificationsContainer').innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No facilities found. Notifications will appear here when you have facilities.
            </div>
        `;
        return;
      }

      // Set up real-time listener for notifications
      notificationsListener = db.collection("notifications")
        .where("facilityId", "in", facilityIds)
        .orderBy("createdAt", "desc")
        .limit(50)
        .onSnapshot(snapshot => {
          const notifications = [];
          snapshot.forEach(doc => {
            notifications.push({
              id: doc.id,
              ...doc.data()
            });
          });

          updateNotificationsUI(notifications);
          updateNotificationStats(notifications);
        }, error => {
          console.error("Error listening to notifications:", error);
          // If collection doesn't exist, show setup message
          if (error.code === 'failed-precondition') {
            document.getElementById('notificationsContainer').innerHTML = `
                    <div class="alert alert-warning">
                        <h5><i class="fas fa-exclamation-triangle me-2"></i>Notifications Setup Required</h5>
                        <p>The notifications collection doesn't exist yet. Click the button below to create sample notifications and set up the system.</p>
                        <button class="btn btn-primary mt-2" onclick="createSampleNotifications()">
                            <i class="fas fa-plus me-1"></i> Create Sample Notifications
                        </button>
                    </div>
                `;
          }
        });
    }

    // Update notifications UI
    function updateNotificationsUI(notifications) {
      const container = document.getElementById('notificationsContainer');

      if (notifications.length === 0) {
        container.innerHTML = `
            <div class="text-center py-5">
                <i class="fas fa-bell-slash fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">No Notifications</h5>
                <p class="text-muted">You're all caught up! New notifications will appear here.</p>
                <button class="btn btn-primary mt-2" onclick="createSampleNotifications()">
                    <i class="fas fa-plus me-1"></i> Create Sample Notifications
                </button>
            </div>
        `;
        return;
      }

      let notificationsHTML = '<div class="list-group">';

      notifications.forEach(notification => {
        const timeAgo = getTimeAgo(notification.createdAt?.toDate());
        const isUnread = !notification.read;

        notificationsHTML += `
            <div class="list-group-item list-group-item-action ${isUnread ? 'list-group-item-primary' : ''}" 
                 onclick="viewNotification('${notification.id}')">
                <div class="d-flex w-100 justify-content-between align-items-start">
                    <div class="flex-grow-1">
                        <div class="d-flex align-items-center mb-2">
                            <span class="badge bg-${getNotificationBadgeColor(notification.type)} me-2">
                                ${getNotificationTypeLabel(notification.type)}
                            </span>
                            ${isUnread ? '<span class="badge bg-danger me-2">NEW</span>' : ''}
                            <small class="text-muted">${timeAgo}</small>
                        </div>
                        <h6 class="mb-1">${notification.title}</h6>
                        <p class="mb-1">${notification.message}</p>
                        ${notification.bookingId ? `
                            <small class="text-muted">
                                <i class="fas fa-link me-1"></i>
                                Related to booking: ${notification.bookingId.substring(0, 8)}
                            </small>
                        ` : ''}
                    </div>
                    <div class="dropdown ms-3">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                type="button" 
                                data-bs-toggle="dropdown"
                                onclick="event.stopPropagation()">
                            <i class="fas fa-ellipsis-v"></i>
                        </button>
                        <ul class="dropdown-menu">
                            ${isUnread ? `
                                <li>
                                    <a class="dropdown-item" href="#" onclick="markAsRead('${notification.id}')">
                                        <i class="fas fa-check me-2"></i>Mark as Read
                                    </a>
                                </li>
                            ` : ''}
                            <li>
                                <a class="dropdown-item" href="#" onclick="deleteNotification('${notification.id}')">
                                    <i class="fas fa-trash me-2"></i>Delete
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        `;
      });

      notificationsHTML += '</div>';
      container.innerHTML = notificationsHTML;
    }

    // Update notification statistics
    function updateNotificationStats(notifications) {
      const total = notifications.length;
      const unread = notifications.filter(n => !n.read).length;
      const bookingAlerts = notifications.filter(n => n.type === 'booking').length;
      const paymentAlerts = notifications.filter(n => n.type === 'payment').length;

      document.getElementById('totalNotifications').textContent = total;
      document.getElementById('unreadNotifications').textContent = unread;
      document.getElementById('bookingNotifications').textContent = bookingAlerts;
      document.getElementById('paymentNotifications').textContent = paymentAlerts;

      // Update notification badge in header
      updateHeaderNotificationsDropdown(unread);
    }

    // Replace the static notifications dropdown in the header with this dynamic version
    function updateHeaderNotificationsDropdown() {
      const dropdownMenu = document.querySelector('.header-actions .dropdown-menu');
      if (!dropdownMenu) return;

      // Get recent unread notifications
      const facilityIds = adminFacilities.map(f => f.id);
      if (facilityIds.length === 0) return;

      db.collection("notifications")
        .where("facilityId", "in", facilityIds)
        .where("read", "==", false)
        .orderBy("createdAt", "desc")
        .limit(5)
        .get()
        .then(snapshot => {
          let dropdownHTML = `
                <li><h6 class="dropdown-header">Recent Notifications</h6></li>
            `;

          if (snapshot.empty) {
            dropdownHTML += `
                    <li><a class="dropdown-item text-muted" href="#">No new notifications</a></li>
                `;
          } else {
            snapshot.forEach(doc => {
              const notification = doc.data();
              const timeAgo = getTimeAgo(notification.createdAt?.toDate());

              dropdownHTML += `
                        <li>
                            <a class="dropdown-item" href="#" onclick="viewNotification('${doc.id}')">
                                <div class="d-flex w-100 justify-content-between">
                                    <strong>${notification.title}</strong>
                                    <small class="text-muted">${timeAgo}</small>
                                </div>
                                <small class="text-muted">${notification.message.substring(0, 50)}...</small>
                            </a>
                        </li>
                    `;
            });
          }

          dropdownHTML += `
                <li><hr class="dropdown-divider"></li>
                <li><a class="dropdown-item" href="#" onclick="navigateToPage('notifications')">View all notifications</a></li>
            `;

          dropdownMenu.innerHTML = dropdownHTML;
        })
        .catch(error => {
          console.error('Error loading header notifications:', error);
        });
    }

    // Helper functions for notifications
    function getTimeAgo(date) {
      if (!date) return 'Just now';

      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);

      if (diffInSeconds < 60) return 'Just now';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
      if (diffInSeconds < 604800) return `${Math.floor(diffInSeconds / 86400)}d ago`;

      return date.toLocaleDateString();
    }

    function getNotificationBadgeColor(type) {
      const colors = {
        'booking': 'primary',
        'payment': 'success',
        'system': 'warning',
        'alert': 'danger',
        'info': 'info'
      };
      return colors[type] || 'secondary';
    }

    function getNotificationTypeLabel(type) {
      const labels = {
        'booking': 'Booking',
        'payment': 'Payment',
        'system': 'System',
        'alert': 'Alert',
        'info': 'Info'
      };
      return labels[type] || 'Notification';
    }

    // Notification actions
    async function markAsRead(notificationId) {
      try {
        await db.collection("notifications").doc(notificationId).update({
          read: true,
          readAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showToast('Notification marked as read', 'success');
      } catch (error) {
        console.error('Error marking notification as read:', error);
        showToast('Error updating notification', 'danger');
      }
    }

    async function markAllAsRead() {
      try {
        const facilityIds = adminFacilities.map(f => f.id);
        const snapshot = await db.collection("notifications")
          .where("facilityId", "in", facilityIds)
          .where("read", "==", false)
          .get();

        const batch = db.batch();
        snapshot.forEach(doc => {
          batch.update(doc.ref, {
            read: true,
            readAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });

        await batch.commit();
        showToast('All notifications marked as read', 'success');
      } catch (error) {
        console.error('Error marking all notifications as read:', error);
        showToast('Error updating notifications', 'danger');
      }
    }

    async function deleteNotification(notificationId) {
      if (!confirm('Are you sure you want to delete this notification?')) {
        return;
      }

      try {
        await db.collection("notifications").doc(notificationId).delete();
        showToast('Notification deleted', 'success');
      } catch (error) {
        console.error('Error deleting notification:', error);
        showToast('Error deleting notification', 'danger');
      }
    }

    async function viewNotification(notificationId) {
      try {
        const doc = await db.collection("notifications").doc(notificationId).get();
        if (!doc.exists) {
          showToast('Notification not found', 'danger');
          return;
        }

        const notification = doc.data();

        // Mark as read when viewed
        if (!notification.read) {
          await markAsRead(notificationId);
        }

        // Show notification details
        const modalContent = `
            <div class="modal fade" id="notificationModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <span class="badge bg-${getNotificationBadgeColor(notification.type)} me-2">
                                    ${getNotificationTypeLabel(notification.type)}
                                </span>
                                Notification Details
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <h6>${notification.title}</h6>
                            <p class="mb-3">${notification.message}</p>
                            
                            <div class="row text-muted small">
                                <div class="col-6">
                                    <strong>Created:</strong><br>
                                    ${notification.createdAt?.toDate().toLocaleString() || 'N/A'}
                                </div>
                                ${notification.read ? `
                                    <div class="col-6">
                                        <strong>Read:</strong><br>
                                        ${notification.readAt?.toDate().toLocaleString() || 'N/A'}
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${notification.bookingId ? `
                                <div class="mt-3">
                                    <strong>Related Booking:</strong><br>
                                    ${notification.bookingId}
                                </div>
                            ` : ''}
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            ${notification.bookingId ? `
                                <button type="button" class="btn btn-primary" onclick="viewBooking('${notification.bookingId}')">
                                    <i class="fas fa-external-link-alt me-1"></i> View Booking
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('notificationModal');
        if (existingModal) {
          existingModal.remove();
        }

        document.body.insertAdjacentHTML('beforeend', modalContent);
        const modal = new bootstrap.Modal(document.getElementById('notificationModal'));
        modal.show();

        // Remove modal when hidden
        document.getElementById('notificationModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });

      } catch (error) {
        console.error('Error viewing notification:', error);
        showToast('Error loading notification details', 'danger');
      }
    }

    // Filter notifications
    function filterNotifications(filter) {
      // Update active filter button
      document.querySelectorAll('.btn-group .btn').forEach(btn => {
        btn.classList.remove('active');
      });
      event.target.classList.add('active');

      // This would filter the displayed notifications
      // In a real implementation, you might want to modify the Firestore query
      showToast(`Showing ${filter} notifications`, 'info');
    }

    // Create sample notifications (for testing)
    async function createSampleNotifications() {
      try {
        const facilityIds = adminFacilities.map(f => f.id);

        if (facilityIds.length === 0) {
          showToast('No facilities found. Please add facilities first.', 'warning');
          return;
        }

        const sampleNotifications = [
          {
            title: 'New Booking Request',
            message: 'John Doe has requested to book Badminton Court 1 for tomorrow at 6 PM.',
            type: 'booking',
            facilityId: facilityIds[0],
            bookingId: 'sample_booking_1',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          },
          {
            title: 'Payment Received',
            message: 'Payment of RM50 has been successfully processed for booking #12345.',
            type: 'payment',
            facilityId: facilityIds[0],
            bookingId: 'sample_booking_2',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          },
          {
            title: 'Facility Maintenance',
            message: 'Tennis Court 2 is scheduled for maintenance next week. Please inform affected customers.',
            type: 'system',
            facilityId: facilityIds[0],
            read: true,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          },
          {
            title: 'Booking Reminder',
            message: 'You have 3 pending booking requests that need approval.',
            type: 'alert',
            facilityId: facilityIds[0],
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          }
        ];

        const batch = db.batch();
        sampleNotifications.forEach(notification => {
          const docRef = db.collection("notifications").doc();
          batch.set(docRef, notification);
        });

        await batch.commit();
        showToast('Sample notifications created successfully', 'success');

      } catch (error) {
        console.error('Error creating sample notifications:', error);
        showToast('Error creating sample notifications', 'danger');
      }
    }

    // Function to create actual notifications (call this from other parts of your app)
    async function createNotification(notificationData) {
      try {
        const notification = {
          title: notificationData.title,
          message: notificationData.message,
          type: notificationData.type || 'info',
          facilityId: notificationData.facilityId,
          bookingId: notificationData.bookingId || null,
          read: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection("notifications").add(notification);

        // Show toast for important notifications
        if (notificationData.type === 'alert' || notificationData.type === 'booking') {
          showToast(`New notification: ${notificationData.title}`, 'info');
        }

      } catch (error) {
        console.error('Error creating notification:', error);
      }
    }

    // Update the initializePageFunctionality to handle notifications
    function initializePageFunctionality(page) {
      switch (page) {
        case 'booking-management':
          initializeBookingSearch();
          break;
        case 'user-management':
          initializeUserSearch();
          break;
        case 'dashboard':
          loadDashboardData();
          break;
        case 'calendar-scheduling':
          initializeCalendarDragDrop();
          break;
        case 'ai-insights':
          setTimeout(() => {
            initializeAICharts();
          }, 1000);
          break;
        case 'reports':
          initializeReportCharts();
          break;
        case 'notifications':
          // Initialize real-time notifications
          setTimeout(() => {
            initializeNotifications();
          }, 100);
          break;
        case 'promo-vouchers':
          setTimeout(() => {
            initializePromoManagement();
          }, 100);
          break;
      }
    }

    // Add cleanup when navigating away from notifications page
    const originalNavigateToPage = navigateToPage;
    navigateToPage = function (page) {
      // Clean up notifications listener if leaving notifications page
      if (currentPage === 'notifications' && page !== 'notifications' && notificationsListener) {
        notificationsListener();
        notificationsListener = null;
      }

      originalNavigateToPage.call(this, page);
    };

    // Make functions globally available
    window.markAsRead = markAsRead;
    window.markAllAsRead = markAllAsRead;
    window.deleteNotification = deleteNotification;
    window.viewNotification = viewNotification;
    window.filterNotifications = filterNotifications;
    window.createSampleNotifications = createSampleNotifications;
    window.createNotification = createNotification;
    async function loadEventsTournamentsPage() {
      // Fetch events
      const eventsSnapshot = await db.collection("events").get();
      const events = [];
      eventsSnapshot.forEach(doc => {
        events.push({ id: doc.id, ...doc.data() });
      });

      let eventsHTML = '';

      if (events.length === 0) {
        eventsHTML = '<tr><td colspan="5" class="text-center py-4">No events found</td></tr>';
      } else {
        events.forEach(event => {
          const date = event.date ? event.date.toDate().toLocaleDateString() : 'N/A';

          eventsHTML += `
            <tr>
              <td>${event.name || 'N/A'}</td>
              <td>${event.type || 'N/A'}</td>
              <td>${date}</td>
              <td>${event.participants || '0'}</td>
              <td>
                <button class="btn btn-sm btn-primary me-1" onclick="editEvent('${event.id}')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteEvent('${event.id}')">Delete</button>
              </td>
            </tr>
          `;
        });
      }

      return `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>Events & Tournaments</h3>
          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addEventModal">
            <i class="fas fa-plus me-1"></i> Add New Event
          </button>
        </div>
        
        <div class="table-card">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Event Name</th>
                  <th>Type</th>
                  <th>Date</th>
                  <th>Participants</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${eventsHTML}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Add Event Modal -->
        <div class="modal fade" id="addEventModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add New Event</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="addEventForm">
                  <div class="form-group">
                    <label class="form-label">Event Name</label>
                    <input type="text" class="form-control" name="name" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Type</label>
                    <select class="form-select" name="type" required>
                      <option value="Tournament">Tournament</option>
                      <option value="Workshop">Workshop</option>
                      <option value="Exhibition">Exhibition</option>
                      <option value="Competition">Competition</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" name="date" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" name="description" rows="3"></textarea>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Max Participants</label>
                    <input type="number" class="form-control" name="maxParticipants" min="1">
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveEvent()">Save Event</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadMarketplacePage() {
      // Fetch products
      const productsSnapshot = await db.collection("products").get();
      const products = [];
      productsSnapshot.forEach(doc => {
        products.push({ id: doc.id, ...doc.data() });
      });

      let productsHTML = '';

      if (products.length === 0) {
        productsHTML = '<tr><td colspan="6" class="text-center py-4">No products found</td></tr>';
      } else {
        products.forEach(product => {
          productsHTML += `
            <tr>
              <td>${product.name || 'N/A'}</td>
              <td>${product.category || 'N/A'}</td>
              <td>RM${product.price || '0'}</td>
              <td>${product.stock || '0'}</td>
              <td>${product.status || 'Active'}</td>
              <td>
                <button class="btn btn-sm btn-primary me-1" onclick="editProduct('${product.id}')">Edit</button>
                <button class="btn btn-sm btn-danger" onclick="deleteProduct('${product.id}')">Delete</button>
              </td>
            </tr>
          `;
        });
      }

      return `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>Marketplace</h3>
          <button class="btn btn-primary" onclick="showPromoModal()">
            <i class="fas fa-plus me-1"></i> Add New Product
          </button>
        </div>
        
        <div class="table-card">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Product Name</th>
                  <th>Category</th>
                  <th>Price</th>
                  <th>Stock</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                ${productsHTML}
              </tbody>
            </table>
          </div>
        </div>
        
        <!-- Add Product Modal -->
        <div class="modal fade" id="addProductModal" tabindex="-1">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title">Add New Product</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
              </div>
              <div class="modal-body">
                <form id="addProductForm">
                  <div class="form-group">
                    <label class="form-label">Product Name</label>
                    <input type="text" class="form-control" name="name" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Category</label>
                    <select class="form-select" name="category" required>
                      <option value="Sports Equipment">Sports Equipment</option>
                      <option value="Apparel">Apparel</option>
                      <option value="Accessories">Accessories</option>
                      <option value="Nutrition">Nutrition</option>
                    </select>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Price (RM)</label>
                    <input type="number" class="form-control" name="price" min="0" step="0.01" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Stock</label>
                    <input type="number" class="form-control" name="stock" min="0" required>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" name="description" rows="3"></textarea>
                  </div>
                  <div class="form-group">
                    <label class="form-label">Image URL</label>
                    <input type="url" class="form-control" name="imageUrl" placeholder="https://example.com/product.jpg">
                  </div>
                </form>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveProduct()">Save Product</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    async function loadSettingsPage() {
      return `
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3>Settings</h3>
          <button class="btn btn-primary" onclick="saveSettings()">
            <i class="fas fa-save me-1"></i> Save Settings
          </button>
        </div>
        
        <div class="row">
          <div class="col-md-6">
            <div class="form-card">
              <h5>General Settings</h5>
              <div class="form-group">
                <label class="form-label">Business Name</label>
                <input type="text" class="form-control" value="Sportova" id="businessName">
              </div>
              <div class="form-group">
                <label class="form-label">Email</label>
                <input type="email" class="form-control" value="admin@sportova.com" id="businessEmail">
              </div>
              <div class="form-group">
                <label class="form-label">Phone</label>
                <input type="tel" class="form-control" value="+1 234 567 8900" id="businessPhone">
              </div>
              <div class="form-group">
                <label class="form-label">Address</label>
                <textarea class="form-control" rows="3" id="businessAddress">123 Sports Street, City, Country</textarea>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="form-card">
              <h5>Notification Settings</h5>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="emailNotifications" checked>
                <label class="form-check-label" for="emailNotifications">Email Notifications</label>
              </div>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="smsNotifications">
                <label class="form-check-label" for="smsNotifications">SMS Notifications</label>
              </div>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="bookingAlerts" checked>
                <label class="form-check-label" for="bookingAlerts">New Booking Alerts</label>
              </div>
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="paymentAlerts" checked>
                <label class="form-check-label" for="paymentAlerts">Payment Alerts</label>
              </div>
            </div>
            
            <div class="form-card mt-4">
              <h5>Security</h5>
              <div class="form-group">
                <label class="form-label">Current Password</label>
                <input type="password" class="form-control" id="currentPassword">
              </div>
              <div class="form-group">
                <label class="form-label">New Password</label>
                <input type="password" class="form-control" id="newPassword">
              </div>
              <div class="form-group">
                <label class="form-label">Confirm New Password</label>
                <input type="password" class="form-control" id="confirmPassword">
              </div>
              <button class="btn btn-warning" onclick="changePassword()">Change Password</button>
            </div>
          </div>
        </div>
      `;
    }

    // Initialize page-specific functionality
    function initializePageFunctionality(page) {
      switch (page) {
        case 'booking-management':
          initializeBookingSearch();
          break;
        case 'user-management':
          initializeUserSearch();
          break;
        case 'dashboard':
          // Load dashboard data when dashboard page is initialized
          loadDashboardData();
          break;
        case 'calendar-scheduling':
          initializeCalendarDragDrop();
          break;
        case 'ai-insights':
          // Store data for charts before initializing
          setTimeout(() => {
            // This data would be calculated in loadAIInsightsPage and stored globally
            initializeAICharts();
          }, 1000);
          break;
        case 'reports':
          initializeReportCharts();
          break;
      }
    }

    // Initialize user search functionality
    function initializeUserSearch() {
      const searchInput = document.getElementById('userSearch');
      const searchBtn = document.getElementById('userSearchBtn');

      if (searchInput && searchBtn) {
        searchBtn.addEventListener('click', performUserSearch);
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            performUserSearch();
          }
        });
      }
    }

    function performUserSearch() {
      const searchTerm = document.getElementById('userSearch').value.toLowerCase();
      const tableBody = document.getElementById('usersTableBody');
      const rows = tableBody.getElementsByTagName('tr');
      let found = false;

      for (let row of rows) {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          row.style.display = '';
          found = true;
        } else {
          row.style.display = 'none';
        }
      }

      if (!found && searchTerm) {
        showToast('No users found for: ' + searchTerm, 'info');
      }
    }

    // Initialize booking search functionality
    function initializeBookingSearch() {
      const searchInput = document.getElementById('bookingSearch');
      const searchBtn = document.getElementById('bookingSearchBtn');

      if (searchInput && searchBtn) {
        searchBtn.addEventListener('click', performBookingSearch);
        searchInput.addEventListener('keypress', (e) => {
          if (e.key === 'Enter') {
            performBookingSearch();
          }
        });
      }
    }

    function performBookingSearch() {
      const searchTerm = document.getElementById('bookingSearch').value.toLowerCase();
      const tableBody = document.getElementById('bookingsTableBody');
      const rows = tableBody.getElementsByTagName('tr');
      let found = false;

      for (let row of rows) {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
          row.style.display = '';
          found = true;
        } else {
          row.style.display = 'none';
        }
      }

      if (!found && searchTerm) {
        showToast('No bookings found for: ' + searchTerm, 'info');
      }
    }

    // Initialize calendar drag and drop
    function initializeCalendarDragDrop() {
      const calendarDays = document.querySelectorAll('.calendar-day');

      calendarDays.forEach(day => {
        day.addEventListener('dragover', (e) => {
          e.preventDefault();
        });

        day.addEventListener('drop', (e) => {
          e.preventDefault();
          const bookingId = e.dataTransfer.getData('text/plain');
          const newDate = day.getAttribute('data-date');

          if (bookingId && newDate) {
            updateBookingDate(bookingId, newDate);
          }
        });
      });
    }

    function dragStart(e) {
      e.dataTransfer.setData('text/plain', e.target.getAttribute('data-booking-id'));
    }

    // Initialize report charts
    function initializeReportCharts() {
      // Implementation for report charts
      const reportsCtx = document.getElementById('reportsChart');
      if (reportsCtx) {
        new Chart(reportsCtx, {
          type: 'line',
          data: {
            labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
            datasets: [{
              label: 'Revenue',
              data: [3200, 2800, 3500, 4200, 3800, 4500],
              borderColor: '#4361ee',
              backgroundColor: 'rgba(67, 97, 238, 0.1)',
              fill: true
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }

      const facilitiesCtx = document.getElementById('facilitiesChart');
      if (facilitiesCtx) {
        new Chart(facilitiesCtx, {
          type: 'doughnut',
          data: {
            labels: ['Badminton', 'Tennis', 'Basketball', 'Swimming'],
            datasets: [{
              data: [40, 25, 20, 15],
              backgroundColor: ['#4361ee', '#4cc9f0', '#f9c74f', '#f94144']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }

      const statusCtx = document.getElementById('statusChart');
      if (statusCtx) {
        new Chart(statusCtx, {
          type: 'pie',
          data: {
            labels: ['Approved', 'Pending', 'Cancelled'],
            datasets: [{
              data: [70, 20, 10],
              backgroundColor: ['#4cc9f0', '#f9c74f', '#f94144']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false
          }
        });
      }
    }

    // Calendar functions
    function showDayBookings(date) {
      // Implementation to show bookings for a specific date
      const modalTitle = document.getElementById('dayBookingsModalTitle');
      const modalBody = document.getElementById('dayBookingsModalBody');

      modalTitle.textContent = `Bookings for ${date}`;

      // Fetch bookings for this date
      const facilityIds = adminFacilities.map(f => f.id);
      let dayBookings = [];

      if (facilityIds.length > 0) {
        // This would be fetched from Firestore in a real implementation
        dayBookings = allBookings.filter(b => b.date === date);
      }

      if (dayBookings.length === 0) {
        modalBody.innerHTML = '<p>No bookings for this date.</p>';
      } else {
        modalBody.innerHTML = `
          <div class="list-group">
            ${dayBookings.map(booking => `
              <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${booking.facilityName}</h6>
                  <small>${booking.slots}</small>
                </div>
                <p class="mb-1">Booked by: ${booking.userEmail}</p>
                <small>Status: <span class="badge badge-${booking.status}">${booking.status}</span></small>
              </div>
            `).join('')}
          </div>
        `;
      }

      const modal = new bootstrap.Modal(document.getElementById('dayBookingsModal'));
      modal.show();
    }

    function prevMonth() {
      // Implementation to navigate to previous month
      showToast('Navigating to previous month', 'info');
    }

    function nextMonth() {
      // Implementation to navigate to next month
      showToast('Navigating to next month', 'info');
    }

    // CRUD operations for various entities
    async function saveFacility() {
      const form = document.getElementById('addFacilityForm');
      const formData = new FormData(form);

      const facilityData = {
        name: formData.get('name'),
        type: formData.get('type'),
        location: formData.get('location'),
        price: parseFloat(formData.get('price')),
        capacity: parseInt(formData.get('capacity')),
        status: formData.get('status'),
        description: formData.get('description'),
        imageUrl: formData.get('imageUrl'),
        amenities: Array.from(formData.getAll('amenities')),
        userId: currentUser.uid, // Changed from adminId to userId
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection('facilities').add(facilityData);
        showToast('Facility added successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addFacilityModal')).hide();
        form.reset();

        // Reload facilities
        await loadAdminFacilities();
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'facility-management') {
          loadPageContent('facility-management');
        }
      } catch (error) {
        console.error('Error adding facility:', error);
        showToast('Error adding facility', 'danger');
      }
    }

    async function updateBookingStatus(bookingId, status) {
      try {
        await db.collection('bookings').doc(bookingId).update({
          status: status,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast(`Booking ${status} successfully`, 'success');

        // If cancelled, also update in calendar
        if (status === 'cancelled') {
          // Implementation to update calendar would go here
        }

        // Reload booking management page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'booking-management') {
          loadPageContent('booking-management');
        }
      } catch (error) {
        console.error('Error updating booking status:', error);
        showToast('Error updating booking status', 'danger');
      }
    }

    async function updateBookingDate(bookingId, newDate) {
      try {
        await db.collection('bookings').doc(bookingId).update({
          date: newDate,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('Booking date updated successfully', 'success');

        // Reload calendar page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'calendar-scheduling') {
          loadPageContent('calendar-scheduling');
        }
      } catch (error) {
        console.error('Error updating booking date:', error);
        showToast('Error updating booking date', 'danger');
      }
    }

    async function saveUser() {
      const form = document.getElementById('addUserForm');
      const formData = new FormData(form);

      const userData = {
        name: formData.get('name'),
        email: formData.get('email'),
        phone: formData.get('phone'),
        membership: formData.get('membership'),
        status: formData.get('status'),
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection('users').add(userData);
        showToast('User added successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addUserModal')).hide();
        form.reset();

        // Reload user management page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'user-management') {
          loadPageContent('user-management');
        }
      } catch (error) {
        console.error('Error adding user:', error);
        showToast('Error adding user', 'danger');
      }
    }

    // Save Coach Function
    async function saveCoach() {
      try {
        const form = document.getElementById('addCoachForm');
        const formData = new FormData(form);

        // Validate required fields
        const requiredFields = ['name', 'sport', 'experience', 'rate', 'availability', 'status'];
        for (let field of requiredFields) {
          if (!formData.get(field)) {
            showToast(`Please fill in the ${field} field`, 'warning');
            return;
          }
        }

        const coachData = {
          name: formData.get('name'),
          sport: formData.get('sport'),
          experience: parseInt(formData.get('experience')),
          rate: parseFloat(formData.get('rate')),
          availability: formData.get('availability'),
          status: formData.get('status'),
          phone: formData.get('phone') || null,
          email: formData.get('email') || null,
          bio: formData.get('bio') || null,
          specialties: formData.get('specialties') ? formData.get('specialties').split(',').map(s => s.trim()) : [],
          availableForHire: formData.get('availableForHire') === 'on',
          photoURL: formData.get('photoURL') || null,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Remove null values
        Object.keys(coachData).forEach(key => {
          if (coachData[key] === null || coachData[key] === '') {
            delete coachData[key];
          }
        });

        await db.collection('coaches').add(coachData);

        showToast('Coach added successfully', 'success');

        // Close modal and reset form
        bootstrap.Modal.getInstance(document.getElementById('addCoachModal')).hide();
        form.reset();

        // Reload coach management page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'coach-management') {
          loadPageContent('coach-management');
        }

      } catch (error) {
        console.error('Error adding coach:', error);
        showToast('Error adding coach', 'danger');
      }
    }

    // View Coach Details Function
    async function viewCoach(coachId) {
      try {
        // Fetch coach details
        const coachDoc = await db.collection('coaches').doc(coachId).get();

        if (!coachDoc.exists) {
          showToast('Coach not found', 'danger');
          return;
        }

        const coach = coachDoc.data();
        const createdAt = coach.createdAt ? coach.createdAt.toDate().toLocaleDateString() : 'N/A';

        // Create modal content
        const modalContent = `
            <div class="modal fade" id="viewCoachModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Coach Details: ${coach.name || 'N/A'}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-4 text-center">
                                    <img src="${coach.photoURL || 'https://via.placeholder.com/200x200?text=Coach'}" 
                                         alt="${coach.name}" 
                                         class="img-fluid rounded-circle mb-3" 
                                         style="width: 200px; height: 200px; object-fit: cover;"
                                         onerror="this.src='https://via.placeholder.com/200x200?text=Coach'">
                                    <h4>${coach.name || 'N/A'}</h4>
                                    <p class="text-muted">${coach.sport || 'N/A'} Coach</p>
                                    <span class="badge ${coach.status === 'Active' ? 'bg-success' : coach.status === 'Inactive' ? 'bg-secondary' : 'bg-warning'}">
                                        ${coach.status || 'Active'}
                                    </span>
                                </div>
                                <div class="col-md-8">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-header bg-primary text-white">
                                                    <h6 class="mb-0"><i class="fas fa-info-circle me-2"></i>Basic Information</h6>
                                                </div>
                                                <div class="card-body">
                                                    <p><strong>Experience:</strong> ${coach.experience || '0'} years</p>
                                                    <p><strong>Hourly Rate:</strong> RM${coach.rate || '0'}</p>
                                                    <p><strong>Availability:</strong> ${coach.availability || 'Flexible'}</p>
                                                    <p><strong>Phone:</strong> ${coach.phone || 'N/A'}</p>
                                                    <p><strong>Email:</strong> ${coach.email || 'N/A'}</p>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="card mb-3">
                                                <div class="card-header bg-success text-white">
                                                    <h6 class="mb-0"><i class="fas fa-star me-2"></i>Coach Status</h6>
                                                </div>
                                                <div class="card-body">
                                                    <p><strong>Status:</strong> ${coach.status || 'Active'}</p>
                                                    <p><strong>Available for Hire:</strong> ${coach.availableForHire ? 'Yes' : 'No'}</p>
                                                    ${coach.specialties && coach.specialties.length > 0 ? `
                                                        <p><strong>Specialties:</strong></p>
                                                        <div>
                                                            ${coach.specialties.map(specialty => `
                                                                <span class="badge bg-dark text-dark me-1 mb-1">${specialty}</span>
                                                            `).join('')}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    ${coach.bio ? `
                                        <div class="card mb-3">
                                            <div class="card-header bg-info text-white">
                                                <h6 class="mb-0"><i class="fas fa-file-alt me-2"></i>Bio & Qualifications</h6>
                                            </div>
                                            <div class="card-body">
                                                <p class="mb-0">${coach.bio}</p>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-warning" onclick="editCoach('${coachId}')">
                                <i class="fas fa-edit me-1"></i> Edit Coach
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('viewCoachModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalContent);

        // Show modal
        const viewModal = new bootstrap.Modal(document.getElementById('viewCoachModal'));
        viewModal.show();

        // Remove modal from DOM when hidden
        document.getElementById('viewCoachModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });

      } catch (error) {
        console.error('Error viewing coach:', error);
        showToast('Error loading coach details', 'danger');
      }
    }

    // Edit Coach Function
    async function editCoach(coachId) {
      try {
        // Fetch coach details
        const coachDoc = await db.collection('coaches').doc(coachId).get();

        if (!coachDoc.exists) {
          showToast('Coach not found', 'danger');
          return;
        }

        const coach = coachDoc.data();

        // Create edit modal
        const editModalHTML = `
            <div class="modal fade" id="editCoachModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Coach: ${coach.name || 'N/A'}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editCoachForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Profile Picture URL</label>
                                            <input type="url" class="form-control" id="editCoachPhotoURL" 
                                                   value="${coach.photoURL || ''}" 
                                                   placeholder="https://example.com/coach.jpg">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Full Name *</label>
                                            <input type="text" class="form-control" id="editCoachName" 
                                                   value="${coach.name || ''}" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Sport *</label>
                                            <select class="form-select" id="editCoachSport" required>
                                                <option value="">Select Sport</option>
                                                <option value="Badminton" ${coach.sport === 'Badminton' ? 'selected' : ''}>Badminton</option>
                                                <option value="Tennis" ${coach.sport === 'Tennis' ? 'selected' : ''}>Tennis</option>
                                                <option value="Basketball" ${coach.sport === 'Basketball' ? 'selected' : ''}>Basketball</option>
                                                <option value="Football" ${coach.sport === 'Football' ? 'selected' : ''}>Football</option>
                                                <option value="Swimming" ${coach.sport === 'Swimming' ? 'selected' : ''}>Swimming</option>
                                                <option value="Gym" ${coach.sport === 'Gym' ? 'selected' : ''}>Gym & Fitness</option>
                                                <option value="Yoga" ${coach.sport === 'Yoga' ? 'selected' : ''}>Yoga</option>
                                                <option value="Martial Arts" ${coach.sport === 'Martial Arts' ? 'selected' : ''}>Martial Arts</option>
                                                <option value="Cricket" ${coach.sport === 'Cricket' ? 'selected' : ''}>Cricket</option>
                                                <option value="Other" ${coach.sport === 'Other' ? 'selected' : ''}>Other</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Experience (years) *</label>
                                            <input type="number" class="form-control" id="editCoachExperience" 
                                                   value="${coach.experience || 0}" min="0" max="50" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Hourly Rate (RM) *</label>
                                            <input type="number" class="form-control" id="editCoachRate" 
                                                   value="${coach.rate || 0}" min="0" step="0.01" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Phone Number</label>
                                            <input type="tel" class="form-control" id="editCoachPhone" 
                                                   value="${coach.phone || ''}" placeholder="+60 12 345 6789">
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Availability *</label>
                                            <select class="form-select" id="editCoachAvailability" required>
                                                <option value="Flexible" ${coach.availability === 'Flexible' ? 'selected' : ''}>Flexible</option>
                                                <option value="Weekdays" ${coach.availability === 'Weekdays' ? 'selected' : ''}>Weekdays Only</option>
                                                <option value="Weekends" ${coach.availability === 'Weekends' ? 'selected' : ''}>Weekends Only</option>
                                                <option value="Mornings" ${coach.availability === 'Mornings' ? 'selected' : ''}>Mornings (8AM-12PM)</option>
                                                <option value="Afternoons" ${coach.availability === 'Afternoons' ? 'selected' : ''}>Afternoons (12PM-5PM)</option>
                                                <option value="Evenings" ${coach.availability === 'Evenings' ? 'selected' : ''}>Evenings (5PM-10PM)</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Status *</label>
                                            <select class="form-select" id="editCoachStatus" required>
                                                <option value="Active" ${coach.status === 'Active' ? 'selected' : ''}>Active</option>
                                                <option value="Inactive" ${coach.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                                <option value="On Leave" ${coach.status === 'On Leave' ? 'selected' : ''}>On Leave</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-control" id="editCoachEmail" 
                                           value="${coach.email || ''}" placeholder="coach@example.com">
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label class="form-label">Bio/Qualifications</label>
                                    <textarea class="form-control" id="editCoachBio" rows="4" 
                                              placeholder="Describe the coach's qualifications, achievements, and coaching style...">${coach.bio || ''}</textarea>
                                </div>
                                
                                <div class="form-group mb-3">
                                    <label class="form-label">Specialties</label>
                                    <input type="text" class="form-control" id="editCoachSpecialties" 
                                           value="${coach.specialties ? coach.specialties.join(', ') : ''}" 
                                           placeholder="e.g., Beginner Training, Advanced Techniques, Competition Prep">
                                    <small class="form-text text-muted">Separate multiple specialties with commas</small>
                                </div>
                                
                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="checkbox" id="editCoachAvailableForHire" 
                                           ${coach.availableForHire ? 'checked' : ''}>
                                    <label class="form-check-label" for="editCoachAvailableForHire">
                                        Available for hire
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="updateCoach('${coachId}')">Update Coach</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('editCoachModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', editModalHTML);

        // Show modal
        const editModal = new bootstrap.Modal(document.getElementById('editCoachModal'));
        editModal.show();

        // Remove modal from DOM when hidden
        document.getElementById('editCoachModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });

      } catch (error) {
        console.error('Error opening edit coach modal:', error);
        showToast('Error loading coach data', 'danger');
      }
    }

    // Update Coach Function
    async function updateCoach(coachId) {
      try {
        const coachData = {
          name: document.getElementById('editCoachName').value,
          sport: document.getElementById('editCoachSport').value,
          experience: parseInt(document.getElementById('editCoachExperience').value),
          rate: parseFloat(document.getElementById('editCoachRate').value),
          availability: document.getElementById('editCoachAvailability').value,
          status: document.getElementById('editCoachStatus').value,
          phone: document.getElementById('editCoachPhone').value || null,
          email: document.getElementById('editCoachEmail').value || null,
          bio: document.getElementById('editCoachBio').value || null,
          specialties: document.getElementById('editCoachSpecialties').value ?
            document.getElementById('editCoachSpecialties').value.split(',').map(s => s.trim()) : [],
          availableForHire: document.getElementById('editCoachAvailableForHire').checked,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Only update photoURL if provided
        const photoURL = document.getElementById('editCoachPhotoURL').value;
        if (photoURL) {
          coachData.photoURL = photoURL;
        }

        // Remove empty values
        Object.keys(coachData).forEach(key => {
          if (coachData[key] === null || coachData[key] === '') {
            delete coachData[key];
          }
        });

        await db.collection('coaches').doc(coachId).update(coachData);

        showToast('Coach updated successfully', 'success');

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('editCoachModal')).hide();

        // Refresh coach management page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'coach-management') {
          loadPageContent('coach-management');
        }

      } catch (error) {
        console.error('Error updating coach:', error);
        showToast('Error updating coach', 'danger');
      }
    }
    // Delete Coach Function
    async function deleteCoach(coachId) {
      try {
        // Fetch coach details for confirmation
        const coachDoc = await db.collection('coaches').doc(coachId).get();

        if (!coachDoc.exists) {
          showToast('Coach not found', 'danger');
          return;
        }

        const coach = coachDoc.data();
        const coachName = coach.name || 'Unknown Coach';

        if (!confirm(`Are you sure you want to delete coach "${coachName}"? This action cannot be undone.`)) {
          return;
        }

        // Delete the coach document
        await db.collection('coaches').doc(coachId).delete();

        showToast(`Coach "${coachName}" deleted successfully`, 'success');

        // Refresh coach management page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'coach-management') {
          loadPageContent('coach-management');
        }

      } catch (error) {
        console.error('Error deleting coach:', error);
        showToast('Error deleting coach', 'danger');
      }
    }

    async function saveEvent() {
      const form = document.getElementById('addEventForm');
      const formData = new FormData(form);

      const eventData = {
        name: formData.get('name'),
        type: formData.get('type'),
        date: new Date(formData.get('date')),
        description: formData.get('description'),
        maxParticipants: formData.get('maxParticipants') ? parseInt(formData.get('maxParticipants')) : null,
        participants: 0,
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection('events').add(eventData);
        showToast('Event added successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addEventModal')).hide();
        form.reset();

        // Reload events page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'events-tournaments') {
          loadPageContent('events-tournaments');
        }
      } catch (error) {
        console.error('Error adding event:', error);
        showToast('Error adding event', 'danger');
      }
    }

    async function saveProduct() {
      const form = document.getElementById('addProductForm');
      const formData = new FormData(form);

      const productData = {
        name: formData.get('name'),
        category: formData.get('category'),
        price: parseFloat(formData.get('price')),
        stock: parseInt(formData.get('stock')),
        description: formData.get('description'),
        imageUrl: formData.get('imageUrl'),
        status: 'Active',
        createdAt: firebase.firestore.FieldValue.serverTimestamp()
      };

      try {
        await db.collection('products').add(productData);
        showToast('Product added successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('addProductModal')).hide();
        form.reset();

        // Reload marketplace page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'marketplace') {
          loadPageContent('marketplace');
        }
      } catch (error) {
        console.error('Error adding product:', error);
        showToast('Error adding product', 'danger');
      }
    }

    // Placeholder functions for other operations
    function editFacility(id) {
      showToast('Edit facility: ' + id, 'info');
    }

    function deleteFacility(id) {
      if (confirm('Are you sure you want to delete this facility?')) {
        showToast('Deleting facility: ' + id, 'info');
      }
    }

    // Edit User Function
    async function editUser(userId) {
      try {
        // Fetch user details
        const userDoc = await db.collection('users').doc(userId).get();

        if (!userDoc.exists) {
          showToast('User not found', 'danger');
          return;
        }

        const user = userDoc.data();

        // Create edit modal
        const editModalHTML = `
            <div class="modal fade" id="editUserModal" tabindex="-1">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit User: ${user.name || 'N/A'}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editUserForm">
                                <div class="form-group mb-3">
                                    <label class="form-label">Profile Picture URL</label>
                                    <input type="url" class="form-control" id="editUserPhotoURL" 
                                           value="${user.photoURL || ''}" 
                                           placeholder="https://example.com/photo.jpg">
                                    <small class="form-text text-muted">Paste a direct link to the profile picture</small>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" id="editUserName" 
                                           value="${user.name || ''}" required>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="editUserEmail" 
                                           value="${user.email || ''}" required>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="editUserPhone" 
                                           value="${user.phone || ''}">
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">Membership</label>
                                    <select class="form-select" id="editUserMembership">
                                        <option value="Regular" ${user.membership === 'Regular' ? 'selected' : ''}>Regular</option>
                                        <option value="Premium" ${user.membership === 'Premium' ? 'selected' : ''}>Premium</option>
                                        <option value="VIP" ${user.membership === 'VIP' ? 'selected' : ''}>VIP</option>
                                    </select>
                                </div>
                                <div class="form-group mb-3">
                                    <label class="form-label">Status</label>
                                    <select class="form-select" id="editUserStatus">
                                        <option value="Active" ${user.status === 'Active' ? 'selected' : ''}>Active</option>
                                        <option value="Inactive" ${user.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                        <option value="Suspended" ${user.status === 'Suspended' ? 'selected' : ''}>Suspended</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Additional Notes</label>
                                    <textarea class="form-control" id="editUserNotes" rows="3" 
                                              placeholder="Any additional information about this user...">${user.notes || ''}</textarea>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="updateUser('${userId}')">Update User</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('editUserModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', editModalHTML);

        // Show modal
        const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));
        editModal.show();

        // Remove modal from DOM when hidden
        document.getElementById('editUserModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });

      } catch (error) {
        console.error('Error opening edit user modal:', error);
        showToast('Error loading user data', 'danger');
      }
    }

    // Update User Function
    async function updateUser(userId) {
      try {
        const userData = {
          name: document.getElementById('editUserName').value,
          email: document.getElementById('editUserEmail').value,
          phone: document.getElementById('editUserPhone').value,
          membership: document.getElementById('editUserMembership').value,
          status: document.getElementById('editUserStatus').value,
          notes: document.getElementById('editUserNotes').value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Only update photoURL if provided
        const photoURL = document.getElementById('editUserPhotoURL').value;
        if (photoURL) {
          userData.photoURL = photoURL;
        }

        await db.collection('users').doc(userId).update(userData);

        showToast('User updated successfully', 'success');

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('editUserModal')).hide();

        // Refresh user management page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'user-management') {
          loadPageContent('user-management');
        }

      } catch (error) {
        console.error('Error updating user:', error);
        showToast('Error updating user', 'danger');
      }
    }

    // Delete User Function
    async function deleteUser(userId) {
      try {
        // Fetch user details for confirmation message
        const userDoc = await db.collection('users').doc(userId).get();

        if (!userDoc.exists) {
          showToast('User not found', 'danger');
          return;
        }

        const user = userDoc.data();
        const userName = user.name || 'Unknown User';

        // Check if user has any bookings
        const facilityIds = adminFacilities.map(f => f.id);
        let hasBookings = false;

        if (facilityIds.length > 0) {
          const bookingsSnapshot = await db.collection("bookings")
            .where("userId", "==", userId)
            .where("facilityId", "in", facilityIds)
            .get();

          hasBookings = !bookingsSnapshot.empty;
        }

        let confirmationMessage = '';
        if (hasBookings) {
          confirmationMessage = `User "${userName}" has existing bookings. Are you sure you want to delete this user? This will also remove all their booking history. This action cannot be undone.`;
        } else {
          confirmationMessage = `Are you sure you want to delete user "${userName}"? This action cannot be undone.`;
        }

        if (!confirm(confirmationMessage)) {
          return;
        }

        // Delete the user document
        await db.collection('users').doc(userId).delete();

        showToast(`User "${userName}" deleted successfully`, 'success');

        // Refresh user management page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'user-management') {
          loadPageContent('user-management');
        }

      } catch (error) {
        console.error('Error deleting user:', error);
        showToast('Error deleting user', 'danger');
      }
    }

    function generateReport() {
      showToast('Generating financial report', 'info');
    }

    function refreshInsights() {
      showToast('Refreshing AI insights', 'info');
      if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'ai-insights') {
        loadPageContent('ai-insights');
      }
    }

    function markAllAsRead() {
      showToast('All notifications marked as read', 'success');
    }

    function editEvent(id) {
      showToast('Edit event: ' + id, 'info');
    }

    function deleteEvent(id) {
      if (confirm('Are you sure you want to delete this event?')) {
        showToast('Deleting event: ' + id, 'info');
      }
    }

    function editProduct(id) {
      showToast('Edit product: ' + id, 'info');
    }

    function deleteProduct(id) {
      if (confirm('Are you sure you want to delete this product?')) {
        showToast('Deleting product: ' + id, 'info');
      }
    }

    function saveSettings() {
      showToast('Settings saved successfully', 'success');
    }

    function changePassword() {
      showToast('Password changed successfully', 'success');
    }

    function generatePDFReport() {
      showToast('Generating PDF report', 'info');
    }

    // Edit Facility Function
    async function editFacility(id) {
      try {
        // Find the facility by ID
        const facility = adminFacilities.find(f => f.id === id);
        if (!facility) {
          showToast('Facility not found', 'danger');
          return;
        }

        // Create and show edit modal
        const editModalHTML = `
            <div class="modal fade" id="editFacilityModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Edit Facility</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="editFacilityForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Facility Name</label>
                                            <input type="text" class="form-control" name="name" value="${facility.name || ''}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Type</label>
                                            <select class="form-select" name="type" required>
                                                <option value="">Select Type</option>
                                                <option value="Badminton Court" ${facility.type === 'Badminton Court' ? 'selected' : ''}>Badminton Court</option>
                                                <option value="Basketball Court" ${facility.type === 'Basketball Court' ? 'selected' : ''}>Basketball Court</option>
                                                <option value="Tennis Court" ${facility.type === 'Tennis Court' ? 'selected' : ''}>Tennis Court</option>
                                                <option value="Swimming Pool" ${facility.type === 'Swimming Pool' ? 'selected' : ''}>Swimming Pool</option>
                                                <option value="Football Field" ${facility.type === 'Football Field' ? 'selected' : ''}>Football Field</option>
                                                <option value="Gym" ${facility.type === 'Gym' ? 'selected' : ''}>Gym</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Location</label>
                                            <input type="text" class="form-control" name="location" value="${facility.location || ''}" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Price (RM)</label>
                                            <input type="number" class="form-control" name="price" value="${facility.price || 0}" min="0" step="0.01" required>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Capacity</label>
                                            <input type="number" class="form-control" name="capacity" value="${facility.capacity || 1}" min="1" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label class="form-label">Status</label>
                                            <select class="form-select" name="status" required>
                                                <option value="Active" ${facility.status === 'Active' ? 'selected' : ''}>Active</option>
                                                <option value="Inactive" ${facility.status === 'Inactive' ? 'selected' : ''}>Inactive</option>
                                                <option value="Maintenance" ${facility.status === 'Maintenance' ? 'selected' : ''}>Under Maintenance</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Description</label>
                                    <textarea class="form-control" name="description" rows="3">${facility.description || ''}</textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Image URL</label>
                                    <input type="url" class="form-control" name="imageUrl" value="${facility.imageUrl || ''}" placeholder="https://example.com/image.jpg">
                                    <small class="form-text text-muted">Provide a direct link to the facility image</small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Amenities</label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="Parking" id="editParking" ${facility.amenities && facility.amenities.includes('Parking') ? 'checked' : ''}>
                                        <label class="form-check-label" for="editParking">Parking</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="Showers" id="editShowers" ${facility.amenities && facility.amenities.includes('Showers') ? 'checked' : ''}>
                                        <label class="form-check-label" for="editShowers">Showers</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="Changing Rooms" id="editChangingRooms" ${facility.amenities && facility.amenities.includes('Changing Rooms') ? 'checked' : ''}>
                                        <label class="form-check-label" for="editChangingRooms">Changing Rooms</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="amenities" value="Equipment Rental" id="editEquipmentRental" ${facility.amenities && facility.amenities.includes('Equipment Rental') ? 'checked' : ''}>
                                        <label class="form-check-label" for="editEquipmentRental">Equipment Rental</label>
                                    </div>
                                </div>
                                
                                <input type="hidden" name="facilityId" value="${id}">
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-primary" onclick="updateFacility('${id}')">Update Facility</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('editFacilityModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', editModalHTML);

        // Show modal
        const editModal = new bootstrap.Modal(document.getElementById('editFacilityModal'));
        editModal.show();

        // Remove modal from DOM when hidden
        document.getElementById('editFacilityModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });

      } catch (error) {
        console.error('Error opening edit facility modal:', error);
        showToast('Error loading facility data', 'danger');
      }
    }

    // Update Facility Function
    async function updateFacility(id) {
      try {
        const form = document.getElementById('editFacilityForm');
        const formData = new FormData(form);

        const facilityData = {
          name: formData.get('name'),
          type: formData.get('type'),
          location: formData.get('location'),
          price: parseFloat(formData.get('price')),
          capacity: parseInt(formData.get('capacity')),
          status: formData.get('status'),
          description: formData.get('description'),
          imageUrl: formData.get('imageUrl'),
          amenities: Array.from(formData.getAll('amenities')),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Remove empty fields
        Object.keys(facilityData).forEach(key => {
          if (facilityData[key] === undefined || facilityData[key] === null || facilityData[key] === '') {
            delete facilityData[key];
          }
        });

        await db.collection('facilities').doc(id).update(facilityData);

        showToast('Facility updated successfully', 'success');

        // Close modal
        bootstrap.Modal.getInstance(document.getElementById('editFacilityModal')).hide();

        // Reload facilities and refresh the page
        await loadAdminFacilities();
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'facility-management') {
          loadPageContent('facility-management');
        }

      } catch (error) {
        console.error('Error updating facility:', error);
        showToast('Error updating facility', 'danger');
      }
    }

    // Delete Facility Function (Enhanced)
    async function deleteFacility(id) {
      try {
        // Check if facility has any bookings
        const bookingsSnapshot = await db.collection("bookings")
          .where("facilityId", "==", id)
          .get();

        if (!bookingsSnapshot.empty) {
          if (!confirm('This facility has existing bookings. Are you sure you want to delete it? This action cannot be undone.')) {
            return;
          }
        } else {
          if (!confirm('Are you sure you want to delete this facility? This action cannot be undone.')) {
            return;
          }
        }

        // Delete the facility
        await db.collection('facilities').doc(id).delete();

        showToast('Facility deleted successfully', 'success');

        // Reload facilities and refresh the page
        await loadAdminFacilities();
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'facility-management') {
          loadPageContent('facility-management');
        }

      } catch (error) {
        console.error('Error deleting facility:', error);
        showToast('Error deleting facility', 'danger');
      }
    }

    // Also update the facility management page to include proper action buttons
    // Replace the existing action buttons in the facility management table with:
    function getFacilityManagementActions(facility) {
      return `
        <div class="btn-group" role="group">
            <button class="btn btn-sm btn-primary" onclick="editFacility('${facility.id}')" title="Edit Facility">
                <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm btn-info" onclick="viewFacilityDetails('${facility.id}')" title="View Details">
                <i class="fas fa-eye"></i>
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteFacility('${facility.id}')" title="Delete Facility">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    `;
    }

    // View Facility Details Function
    async function viewFacilityDetails(id) {
      try {
        const facility = adminFacilities.find(f => f.id === id);
        if (!facility) {
          showToast('Facility not found', 'danger');
          return;
        }

        // Get facility bookings for statistics
        const bookingsSnapshot = await db.collection("bookings")
          .where("facilityId", "==", id)
          .get();

        const totalBookings = bookingsSnapshot.size;
        let totalRevenue = 0;
        bookingsSnapshot.forEach(doc => {
          const booking = doc.data();
          if (booking.price) {
            totalRevenue += parseFloat(booking.price);
          }
        });

        const modalContent = `
            <div class="modal fade" id="viewFacilityModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Facility Details: ${facility.name}</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    ${facility.imageUrl ? `
                                        <img src="${facility.imageUrl}" alt="${facility.name}" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: cover;">
                                    ` : ''}
                                    <h6>Basic Information</h6>
                                    <p><strong>Name:</strong> ${facility.name || 'N/A'}</p>
                                    <p><strong>Type:</strong> ${facility.type || 'N/A'}</p>
                                    <p><strong>Location:</strong> ${facility.location || 'N/A'}</p>
                                    <p><strong>Price:</strong> RM${facility.price || '0'}</p>
                                    <p><strong>Capacity:</strong> ${facility.capacity || 'N/A'} people</p>
                                    <p><strong>Status:</strong> 
                                        <span class="badge ${facility.status === 'Active' ? 'bg-success' : facility.status === 'Maintenance' ? 'bg-warning' : 'bg-secondary'}">
                                            ${facility.status || 'N/A'}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <h6>Statistics</h6>
                                    <p><strong>Total Bookings:</strong> ${totalBookings}</p>
                                    <p><strong>Total Revenue:</strong> RM${totalRevenue.toFixed(2)}</p>
                                    <p><strong>Average Revenue per Booking:</strong> RM${totalBookings > 0 ? (totalRevenue / totalBookings).toFixed(2) : '0'}</p>
                                    
                                    <h6 class="mt-3">Amenities</h6>
                                    ${facility.amenities && facility.amenities.length > 0 ?
            facility.amenities.map(amenity => `
                                            <span class="badge bg-dark text-light me-1 mb-1">${amenity}</span>
                                        `).join('') :
            '<p class="text-muted">No amenities specified</p>'
          }
                                </div>
                            </div>
                            
                            ${facility.description ? `
                                <div class="mt-3">
                                    <h6>Description</h6>
                                    <p>${facility.description}</p>
                                </div>
                            ` : ''}
                            
                            <div class="mt-3">
                                <h6>Recent Bookings</h6>
                                ${totalBookings > 0 ? `
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>User</th>
                                                    <th>Date</th>
                                                    <th>Time</th>
                                                    <th>Status</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${bookingsSnapshot.docs.slice(0, 5).map(doc => {
            const booking = doc.data();
            return `
                                                        <tr>
                                                            <td>${booking.userEmail || 'Unknown User'}</td>
                                                            <td>${booking.date.toDate().toLocaleString() || 'N/A'}</td>
                                                            <td>${booking.slots || 'N/A'}</td>
                                                            <td><span class="badge badge-status badge-${booking.status || 'pending'}">${booking.status || 'Pending'}</span></td>
                                                        </tr>
                                                    `;
          }).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                ` : '<p class="text-muted">No bookings yet</p>'}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="button" class="btn btn-primary" onclick="editFacility('${id}')">Edit Facility</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('viewFacilityModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalContent);

        // Show modal
        const viewModal = new bootstrap.Modal(document.getElementById('viewFacilityModal'));
        viewModal.show();

        // Remove modal from DOM when hidden
        document.getElementById('viewFacilityModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });

      } catch (error) {
        console.error('Error viewing facility details:', error);
        showToast('Error loading facility details', 'danger');
      }
    }

    // Enhanced viewBooking function with better error handling
    async function viewBooking(bookingId) {
      try {
        console.log('Viewing booking:', bookingId);

        // First try to get from local allBookings array (faster)
        let booking = allBookings.find(b => b.id === bookingId);

        // If not found locally or needs fresh data, fetch from Firestore
        if (!booking) {
          console.log('Booking not found locally, fetching from Firestore...');
          const bookingDoc = await db.collection('bookings').doc(bookingId).get();
          if (!bookingDoc.exists) {
            showToast('Booking not found', 'danger');
            return;
          }
          booking = { id: bookingDoc.id, ...bookingDoc.data() };
        }

        // Format dates for display
        let bookingDate = 'N/A';
        let bookingTime = 'N/A';

        try {
          // Handle date formatting
          if (booking.date && typeof booking.date.toDate === 'function') {
            bookingDate = booking.date.toDate().toLocaleDateString();
          } else if (booking.date) {
            // If it's already a string, format it nicely
            const dateObj = new Date(booking.date);
            if (!isNaN(dateObj.getTime())) {
              bookingDate = dateObj.toLocaleDateString();
            } else {
              bookingDate = booking.date; // Use as is if can't parse
            }
          }

          // Handle time slot
          if (booking.slots) {
            bookingTime = booking.slots;
          }
        } catch (dateError) {
          console.error('Error formatting dates:', dateError);
        }

        // Get facility name
        const facility = adminFacilities.find(f => f.id === booking.facilityId);
        const facilityName = facility ? facility.name : 'Unknown Facility';

        // Create modal HTML
        const modalHTML = `
            <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Booking Details</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Booking Information</h6>
                                    <p><strong>Facility:</strong> ${facilityName}</p>
                                    <p><strong>Date:</strong> ${bookingDate}</p>
                                    <p><strong>Time:</strong> ${bookingTime}</p>
                                    <p><strong>Duration:</strong> ${booking.duration || 1} hour(s)</p>
                                    <p><strong>Status:</strong> 
                                        <span class="badge badge-status badge-${booking.status || 'pending'}">
                                            ${booking.status || 'Pending'}
                                        </span>
                                    </p>
                                </div>
                                <div class="col-md-6">
                                    <h6>User Information</h6>
                                    <p><strong>Name:</strong> ${booking.userName || 'N/A'}</p>
                                    <p><strong>Email:</strong> ${booking.userEmail || 'N/A'}</p>
                                    <p><strong>Phone:</strong> ${booking.userPhone || 'N/A'}</p>
                                </div>
                            </div>
                            
                            ${booking.notes ? `
                                <div class="row mt-3">
                                    <div class="col-12">
                                        <h6>Additional Notes</h6>
                                        <p>${booking.notes}</p>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="row mt-3">
                                <div class="col-12">
                                    <h6>Payment Information</h6>
                                    <p><strong>Amount:</strong> RM${parseFloat(booking.price || 0).toFixed(2)}</p>
                                    <p><strong>Payment Method:</strong> ${booking.paymentMethod || 'Online'}</p>
                                    <p><strong>Booking ID:</strong> ${bookingId}</p>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            ${booking.status === 'pending' ? `
                                <button type="button" class="btn btn-success" onclick="updateBookingStatus('${bookingId}', 'approved')">Approve</button>
                                <button type="button" class="btn btn-danger" onclick="updateBookingStatus('${bookingId}', 'cancelled')">Cancel</button>
                            ` : ''}
                            <button type="button" class="btn btn-primary" onclick="editBooking('${bookingId}')">Edit Booking</button>
                        </div>
                    </div>
                </div>
            </div>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('bookingDetailsModal');
        if (existingModal) {
          existingModal.remove();
        }

        // Add modal to page
        document.body.insertAdjacentHTML('beforeend', modalHTML);

        // Show modal
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
        bookingModal.show();

        // Remove modal when hidden
        document.getElementById('bookingDetailsModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });

      } catch (error) {
        console.error('Error viewing booking:', error);
        showToast('Error loading booking details: ' + error.message, 'danger');
      }
    }
    /// Print Booking Details Function
    async function printBookingDetails(bookingId) {
      try {
        // Fetch fresh booking data
        const bookingDoc = await db.collection('bookings').doc(bookingId).get();
        if (!bookingDoc.exists) {
          showToast('Booking not found', 'danger');
          return;
        }

        const booking = bookingDoc.data();

        // Fetch user and facility details
        let userDetails = {};
        let facilityDetails = {};

        if (booking.userId) {
          const userDoc = await db.collection('users').doc(booking.userId).get();
          if (userDoc.exists) userDetails = userDoc.data();
        }

        if (booking.facilityId) {
          const facilityDoc = await db.collection('facilities').doc(booking.facilityId).get();
          if (facilityDoc.exists) facilityDetails = facilityDoc.data();
        }

        // Format dates and times
        const bookingDate = booking.date || 'N/A';
        const timeSlot = booking.slot || 'N/A';
        const bookingDateTime = booking.timestamp ? booking.timestamp.toDate().toLocaleString() : 'N/A';
        const printDate = new Date().toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Sportova logo
        const sportovaLogo = 'img/logo.jpg';
        // Replace with your actual logo: 'https://yourdomain.com/logo.png'

        // Create print content
        const printContent = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <title>Booking Confirmation - Sportova</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        line-height: 1.6;
                        color: #333;
                        max-width: 800px;
                        margin: 0 auto;
                        padding: 20px;
                    }
                    .header {
                        text-align: center;
                        border-bottom: 3px solid #4361ee;
                        padding-bottom: 20px;
                        margin-bottom: 30px;
                    }
                    .logo {
                        max-width: 200px;
                        height: auto;
                        margin-bottom: 15px;
                    }
                    .company-name {
                        font-size: 28px;
                        font-weight: bold;
                        color: #4361ee;
                        margin-bottom: 5px;
                    }
                    .document-title {
                        text-align: center;
                        margin: 30px 0;
                    }
                    .info-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 20px;
                        margin-bottom: 30px;
                    }
                    .info-section {
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 8px;
                        border-left: 4px solid #4361ee;
                    }
                    .info-section h3 {
                        color: #4361ee;
                        margin-bottom: 15px;
                        font-size: 16px;
                    }
                    .info-item {
                        margin-bottom: 10px;
                        display: flex;
                        justify-content: space-between;
                    }
                    .summary-section {
                        background: #4361ee;
                        color: white;
                        padding: 20px;
                        border-radius: 8px;
                        margin: 20px 0;
                    }
                    .status-badge {
                        padding: 4px 12px;
                        border-radius: 15px;
                        font-size: 12px;
                        font-weight: bold;
                        text-transform: uppercase;
                    }
                    .status-approved { background: #d4edda; color: #155724; }
                    .status-pending { background: #fff3cd; color: #856404; }
                    .status-cancelled { background: #f8d7da; color: #721c24; }
                    .footer {
                        margin-top: 40px;
                        padding-top: 20px;
                        border-top: 1px solid #ddd;
                        text-align: center;
                        font-size: 12px;
                        color: #666;
                    }
                    @media print {
                        body { padding: 0; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <img src="${sportovaLogo}" alt="Sportova Logo" class="logo">
                    <div>Premium Sports Facility Management</div>
                </div>

                <div class="document-title">
                    <h1>BOOKING CONFIRMATION</h1>
                    <p>Reference: #${bookingId.substring(0, 8).toUpperCase()}</p>
                    <small>Generated on: ${printDate}</small>
                </div>

                <div class="info-grid">
                    <div class="info-section">
                        <h3>CUSTOMER INFORMATION</h3>
                        <div class="info-item">
                            <span>Name:</span>
                            <span>${booking.userName || userDetails.name || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span>Email:</span>
                            <span>${userDetails.email || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span>Phone:</span>
                            <span>${userDetails.phone || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span>Status:</span>
                            <span class="status-badge status-${booking.status || 'pending'}">${(booking.status || 'pending').toUpperCase()}</span>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>BOOKING DETAILS</h3>
                        <div class="info-item">
                            <span>Facility:</span>
                            <span>${booking.facilityName || facilityDetails.name || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span>Date:</span>
                            <span>${bookingDate}</span>
                        </div>
                        <div class="info-item">
                            <span>Time Slot:</span>
                            <span>${timeSlot}</span>
                        </div>
                        <div class="info-item">
                            <span>Duration:</span>
                            <span>${booking.duration || '1 hour'}</span>
                        </div>
                    </div>
                </div>

                <div class="summary-section">
                    <h3>PAYMENT SUMMARY</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: bold;">RM${parseFloat(booking.price || 0).toFixed(2)}</div>
                            <div>Total Amount</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: bold;">${booking.paymentMethod || 'Online'}</div>
                            <div>Payment Method</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: bold;">Paid</div>
                            <div>Payment Status</div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>ADDITIONAL INFORMATION</h3>
                    <div class="info-item">
                        <span>Booking Created:</span>
                        <span>${bookingDateTime}</span>
                    </div>
                    <div class="info-item">
                        <span>Facility Type:</span>
                        <span>${facilityDetails.type || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span>Location:</span>
                        <span>${facilityDetails.location || 'N/A'}</span>
                    </div>
                </div>

                <div class="footer">
                    <div style="margin-bottom: 15px;">
                        <strong>Sportova Sports Facilities</strong><br>
                        Email: support@sportova.com | Phone: +1 (555) 123-SPORT<br>
                        Website: www.sportova.com
                    </div>
                    <div>
                        Thank you for choosing Sportova! This is an computer-generated document.
                    </div>
                </div>
            </body>
            </html>
        `;

        // Open print window
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(printContent);
        printWindow.document.close();

        // Print after content loads
        printWindow.onload = function () {
          setTimeout(() => {
            printWindow.print();
          }, 500);
        };

      } catch (error) {
        console.error('Error printing booking details:', error);
        showToast('Error generating print document', 'danger');
      }
    }

    // Reschedule Booking Function with Clock Time Picker
    async function rescheduleBooking(bookingId) {
      try {
        const bookingDoc = await db.collection('bookings').doc(bookingId).get();
        if (!bookingDoc.exists) {
          showToast('Booking not found', 'danger');
          return;
        }

        const booking = bookingDoc.data();

        // Create reschedule modal with clock time picker
        const modalContent = `
            <div class="modal fade" id="rescheduleModal" tabindex="-1">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Reschedule Booking</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body">
                            <form id="rescheduleForm">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Current Date & Time</label>
                                            <input type="text" class="form-control" value="${booking.date} at ${booking.slot}" readonly>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label class="form-label">New Date</label>
                                            <input type="date" class="form-control" id="newBookingDate" min="${new Date().toISOString().split('T')[0]}" required>
                                        </div>
                                        
                                        <div class="form-group mb-3">
                                            <label class="form-label">Reason for Rescheduling</label>
                                            <textarea class="form-control" id="rescheduleReason" rows="3" placeholder="Optional reason for rescheduling..."></textarea>
                                        </div>
                                    </div>
                                    
                                    <div class="col-md-6">
                                        <div class="form-group mb-3">
                                            <label class="form-label">Select Time Slot</label>
                                            <div class="time-picker-container">
                                                <div class="clock-display text-center mb-3">
                                                    <div class="selected-time bg-primary text-white rounded p-3">
                                                        <div class="time-display fs-2 fw-bold" id="selectedTimeDisplay">--:--</div>
                                                        <div class="time-period" id="selectedPeriodDisplay">--</div>
                                                    </div>
                                                </div>
                                                
                                                <div class="time-selection">
                                                    <div class="row mb-3">
                                                        <div class="col-6">
                                                            <label class="form-label">Hour</label>
                                                            <select class="form-select" id="timeHour">
                                                                <option value="">Hour</option>
                                                                ${Array.from({ length: 12 }, (_, i) => {
          const hour = i + 1;
          return `<option value="${hour}">${hour}</option>`;
        }).join('')}
                                                            </select>
                                                        </div>
                                                        <div class="col-6">
                                                            <label class="form-label">Minute</label>
                                                            <select class="form-select" id="timeMinute">
                                                                <option value="">Minute</option>
                                                                <option value="00">00</option>
                                                                <option value="15">15</option>
                                                                <option value="30">30</option>
                                                                <option value="45">45</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row mb-3">
                                                        <div class="col-12">
                                                            <label class="form-label">Period</label>
                                                            <div class="btn-group w-100" role="group">
                                                                <input type="radio" class="btn-check" name="timePeriod" id="periodAM" value="AM" autocomplete="off">
                                                                <label class="btn btn-outline-primary" for="periodAM">AM</label>
                                                                
                                                                <input type="radio" class="btn-check" name="timePeriod" id="periodPM" value="PM" autocomplete="off">
                                                                <label class="btn btn-outline-primary" for="periodPM">PM</label>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    
                                                    <div class="row">
                                                        <div class="col-12">
                                                            <label class="form-label">Duration</label>
                                                            <select class="form-select" id="bookingDuration">
                                                                <option value="1">1 hour</option>
                                                                <option value="1.5">1.5 hours</option>
                                                                <option value="2">2 hours</option>
                                                                <option value="2.5">2.5 hours</option>
                                                                <option value="3">3 hours</option>
                                                            </select>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="available-slots mt-4" id="availableSlotsSection" style="display: none;">
                                    <h6>Available Time Slots for <span id="selectedDateDisplay"></span></h6>
                                    <div class="slots-container" id="availableSlotsContainer">
                                        <!-- Available slots will be populated here -->
                                    </div>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="button" class="btn btn-outline-info" onclick="checkAvailability('${bookingId}')">
                                <i class="fas fa-search me-1"></i> Check Availability
                            </button>
                            <button type="button" class="btn btn-primary" onclick="confirmReschedule('${bookingId}')" id="confirmRescheduleBtn" disabled>
                                Confirm Reschedule
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <style>
                .time-picker-container {
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    padding: 15px;
                    background: #f8f9fa;
                }
                
                .clock-display .selected-time {
                    background: linear-gradient(135deg, #4361ee, #3a0ca3);
                    box-shadow: 0 4px 15px rgba(67, 97, 238, 0.3);
                }
                
                .time-display {
                    font-family: 'Courier New', monospace;
                    letter-spacing: 2px;
                }
                
                .time-period {
                    font-size: 1rem;
                    opacity: 0.9;
                }
                
                .slots-container {
                    display: grid;
                    grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                    gap: 10px;
                    max-height: 200px;
                    overflow-y: auto;
                    padding: 10px;
                    border: 1px solid #e9ecef;
                    border-radius: 8px;
                    background: white;
                }
                
                .time-slot {
                    padding: 8px 12px;
                    border: 2px solid #e9ecef;
                    border-radius: 6px;
                    text-align: center;
                    cursor: pointer;
                    transition: all 0.3s ease;
                    background: white;
                }
                
                .time-slot:hover {
                    border-color: #4361ee;
                    background: #f0f4ff;
                }
                
                .time-slot.selected {
                    border-color: #4361ee;
                    background: #4361ee;
                    color: white;
                }
                
                .time-slot.available {
                    border-color: #28a745;
                }
                
                .time-slot.unavailable {
                    border-color: #dc3545;
                    background: #f8d7da;
                    color: #721c24;
                    cursor: not-allowed;
                }
                
                .btn-check:checked + .btn-outline-primary {
                    background-color: #4361ee;
                    border-color: #4361ee;
                    color: white;
                }
            </style>
        `;

        // Remove existing modal if any
        const existingModal = document.getElementById('rescheduleModal');
        if (existingModal) {
          existingModal.remove();
        }

        document.body.insertAdjacentHTML('beforeend', modalContent);
        const rescheduleModal = new bootstrap.Modal(document.getElementById('rescheduleModal'));
        rescheduleModal.show();

        // Initialize time picker functionality
        initializeTimePicker();

        // Remove modal when hidden
        document.getElementById('rescheduleModal').addEventListener('hidden.bs.modal', function () {
          this.remove();
        });

      } catch (error) {
        console.error('Error opening reschedule modal:', error);
        showToast('Error opening reschedule form', 'danger');
      }
    }

    // Initialize Time Picker Functionality
    function initializeTimePicker() {
      const hourSelect = document.getElementById('timeHour');
      const minuteSelect = document.getElementById('timeMinute');
      const periodRadios = document.querySelectorAll('input[name="timePeriod"]');
      const timeDisplay = document.getElementById('selectedTimeDisplay');
      const periodDisplay = document.getElementById('selectedPeriodDisplay');
      const confirmBtn = document.getElementById('confirmRescheduleBtn');

      function updateTimeDisplay() {
        const hour = hourSelect.value;
        const minute = minuteSelect.value;
        const period = document.querySelector('input[name="timePeriod"]:checked')?.value;

        if (hour && minute && period) {
          const formattedHour = hour.padStart(2, '0');
          timeDisplay.textContent = `${formattedHour}:${minute}`;
          periodDisplay.textContent = period;
          confirmBtn.disabled = false;
        } else {
          timeDisplay.textContent = '--:--';
          periodDisplay.textContent = '--';
          confirmBtn.disabled = true;
        }
      }

      hourSelect.addEventListener('change', updateTimeDisplay);
      minuteSelect.addEventListener('change', updateTimeDisplay);
      periodRadios.forEach(radio => {
        radio.addEventListener('change', updateTimeDisplay);
      });

      // Auto-select current time or a default time
      const now = new Date();
      const currentHour = now.getHours() % 12 || 12;
      const currentMinute = Math.floor(now.getMinutes() / 15) * 15;
      const currentPeriod = now.getHours() >= 12 ? 'PM' : 'AM';

      hourSelect.value = currentHour.toString();
      minuteSelect.value = currentMinute.toString().padStart(2, '0');
      document.getElementById(`period${currentPeriod}`).checked = true;

      updateTimeDisplay();
    }

    // Check Availability Function
    async function checkAvailability(bookingId) {
      try {
        const date = document.getElementById('newBookingDate').value;
        const hour = document.getElementById('timeHour').value;
        const minute = document.getElementById('timeMinute').value;
        const period = document.querySelector('input[name="timePeriod"]:checked')?.value;
        const duration = document.getElementById('bookingDuration').value;

        if (!date || !hour || !minute || !period) {
          showToast('Please select date and time first', 'warning');
          return;
        }

        // Convert to 24-hour format for calculations
        let hour24 = parseInt(hour);
        if (period === 'PM' && hour24 !== 12) hour24 += 12;
        if (period === 'AM' && hour24 === 12) hour24 = 0;

        const startTime = `${hour24.toString().padStart(2, '0')}:${minute}`;

        // Show loading state
        const slotsContainer = document.getElementById('availableSlotsContainer');
        slotsContainer.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-primary" role="status"></div><p class="mt-2">Checking availability...</p></div>';

        document.getElementById('availableSlotsSection').style.display = 'block';
        document.getElementById('selectedDateDisplay').textContent = new Date(date).toLocaleDateString();

        // Simulate API call to check availability (replace with actual Firestore query)
        const availableSlots = await getAvailableSlots(date, bookingId);

        // Generate time slots around the selected time
        const timeSlots = generateTimeSlots(startTime, duration, availableSlots);

        // Display available slots
        displayAvailableSlots(timeSlots);

      } catch (error) {
        console.error('Error checking availability:', error);
        showToast('Error checking availability', 'danger');
      }
    }

    // Generate Time Slots Function
    function generateTimeSlots(selectedTime, duration, availableSlots) {
      const slots = [];
      const [startHour, startMinute] = selectedTime.split(':').map(Number);

      // Generate slots 2 hours before and after selected time
      for (let hourOffset = -2; hourOffset <= 2; hourOffset++) {
        for (let minuteOffset of [0, 15, 30, 45]) {
          let slotHour = startHour + hourOffset;
          let slotMinute = startMinute + minuteOffset;

          // Handle minute overflow
          if (slotMinute >= 60) {
            slotHour += 1;
            slotMinute -= 60;
          }
          if (slotMinute < 0) {
            slotHour -= 1;
            slotMinute += 60;
          }

          // Ensure valid time range (7 AM to 10 PM)
          if (slotHour >= 7 && slotHour <= 22) {
            const period = slotHour >= 12 ? 'PM' : 'AM';
            const displayHour = slotHour % 12 || 12;
            const timeString = `${displayHour}:${slotMinute.toString().padStart(2, '0')} ${period}`;
            const time24 = `${slotHour.toString().padStart(2, '0')}:${slotMinute.toString().padStart(2, '0')}`;

            const isAvailable = availableSlots.includes(time24);
            const isSelected = time24 === selectedTime;

            slots.push({
              display: timeString,
              value: time24,
              available: isAvailable,
              selected: isSelected
            });
          }
        }
      }

      return slots;
    }

    // Display Available Slots
    function displayAvailableSlots(slots) {
      const container = document.getElementById('availableSlotsContainer');

      if (slots.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">No available slots found</div>';
        return;
      }

      container.innerHTML = slots.map(slot => `
        <div class="time-slot ${slot.available ? 'available' : 'unavailable'} ${slot.selected ? 'selected' : ''}" 
             onclick="${slot.available ? `selectTimeSlot('${slot.value}')` : ''}">
            ${slot.display}
            ${slot.selected ? '<br><small>Selected</small>' : ''}
        </div>
    `).join('');
    }

    // Select Time Slot Function
    function selectTimeSlot(time24) {
      // Convert 24-hour time to 12-hour format for display
      const [hour, minute] = time24.split(':').map(Number);
      const period = hour >= 12 ? 'PM' : 'AM';
      const displayHour = hour % 12 || 12;

      // Update the time picker inputs
      document.getElementById('timeHour').value = displayHour.toString();
      document.getElementById('timeMinute').value = minute.toString().padStart(2, '0');
      document.getElementById(`period${period}`).checked = true;

      // Update the display
      updateTimeDisplay();

      // Update slot selection UI
      const slots = document.querySelectorAll('.time-slot');
      slots.forEach(slot => {
        slot.classList.remove('selected');
        if (slot.textContent.includes(`${displayHour}:${minute.toString().padStart(2, '0')} ${period}`)) {
          slot.classList.add('selected');
        }
      });

      showToast('Time slot selected', 'success');
    }

    // Get Available Slots (Mock function - replace with actual Firestore query)
    async function getAvailableSlots(date, bookingId) {
      // This would typically query Firestore for existing bookings on that date
      // and return available time slots

      // Mock data - in real implementation, query Firestore like:
      // const existingBookings = await db.collection('bookings')
      //     .where('date', '==', date)
      //     .where('facilityId', '==', facilityId)
      //     .where('status', 'in', ['approved', 'pending'])
      //     .get();

      // For demo purposes, return some random available slots
      const allSlots = [
        '08:00', '09:00', '10:00', '11:00', '12:00',
        '13:00', '14:00', '15:00', '16:00', '17:00',
        '18:00', '19:00', '20:00'
      ];

      // Randomly make some slots unavailable for demo
      const availableSlots = allSlots.filter(() => Math.random() > 0.3);

      return availableSlots;
    }

    // Updated Confirm Reschedule Function
    async function confirmReschedule(bookingId) {
      try {
        const date = document.getElementById('newBookingDate').value;
        const hour = document.getElementById('timeHour').value;
        const minute = document.getElementById('timeMinute').value;
        const period = document.querySelector('input[name="timePeriod"]:checked')?.value;
        const duration = document.getElementById('bookingDuration').value;
        const reason = document.getElementById('rescheduleReason').value;

        if (!date || !hour || !minute || !period) {
          showToast('Please select date and time', 'warning');
          return;
        }

        // Convert to 24-hour format for storage
        let hour24 = parseInt(hour);
        if (period === 'PM' && hour24 !== 12) hour24 += 12;
        if (period === 'AM' && hour24 === 12) hour24 = 0;

        const startTime = `${hour24.toString().padStart(2, '0')}:${minute}`;
        const endTime = calculateEndTime(startTime, duration);
        const timeSlot = `${startTime}-${endTime}`;

        // Check availability one more time
        const isAvailable = await checkSlotAvailability(bookingId, date, timeSlot);

        if (!isAvailable) {
          showToast('Selected time slot is no longer available', 'warning');
          return;
        }

        await db.collection('bookings').doc(bookingId).update({
          date: date,
          slot: timeSlot,
          duration: parseFloat(duration),
          rescheduleReason: reason,
          rescheduledAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('Booking rescheduled successfully', 'success');
        bootstrap.Modal.getInstance(document.getElementById('rescheduleModal')).hide();

        // Refresh the booking management page
        if (document.querySelector('.sidebar-menu a.active').getAttribute('data-page') === 'booking-management') {
          loadPageContent('booking-management');
        }

      } catch (error) {
        console.error('Error rescheduling booking:', error);
        showToast('Error rescheduling booking', 'danger');
      }
    }

    // Calculate End Time Function
    function calculateEndTime(startTime, duration) {
      const [startHour, startMinute] = startTime.split(':').map(Number);
      const durationHours = Math.floor(duration);
      const durationMinutes = (duration - durationHours) * 60;

      let endHour = startHour + durationHours;
      let endMinute = startMinute + durationMinutes;

      if (endMinute >= 60) {
        endHour += 1;
        endMinute -= 60;
      }

      return `${endHour.toString().padStart(2, '0')}:${endMinute.toString().padStart(2, '0')}`;
    }

    

    // Update the window object with new functions
    window.rescheduleBooking = rescheduleBooking;
    window.checkAvailability = checkAvailability;
    window.selectTimeSlot = selectTimeSlot;
    window.confirmReschedule = confirmReschedule;
    window.printBookingDetails = printBookingDetails;

    // Update the window object to include the new functions
    window.editFacility = editFacility;
    window.updateFacility = updateFacility;
    window.deleteFacility = deleteFacility;
    window.viewFacilityDetails = viewFacilityDetails;

    // Make functions globally available
    window.saveFacility = saveFacility;
    window.updateBookingStatus = updateBookingStatus;
    window.updateBookingDate = updateBookingDate;
    window.saveUser = saveUser;
    window.saveCoach = saveCoach;
    window.viewCoach = viewCoach;
    window.updateCoach = updateCoach;
    window.savePromo = savePromo;
    window.saveEvent = saveEvent;
    window.saveProduct = saveProduct;
    window.viewBooking = viewBooking;
    window.editUser = editUser;
    window.deleteUser = deleteUser;
    window.editCoach = editCoach;
    window.deleteCoach = deleteCoach;
    window.generateReport = generateReport;
    window.refreshInsights = refreshInsights;
    window.editPromo = editPromo;
    window.deletePromo = deletePromo;
    window.savePromo = savePromo;
    window.showPromoModal = showPromoModal;
    window.markAllAsRead = markAllAsRead;
    window.editEvent = editEvent;
    window.deleteEvent = deleteEvent;
    window.editProduct = editProduct;
    window.deleteProduct = deleteProduct;
    window.saveSettings = saveSettings;
    window.changePassword = changePassword;
    window.showDayBookings = showDayBookings;
    window.dragStart = dragStart;
    window.viewUser = viewUser;
    // Update the window object to include all export functions
    window.exportBookings = exportBookings;
    window.exportUsers = exportUsers;
    window.exportPayments = exportPayments;
    window.exportFacilities = exportFacilities;
    window.exportReportData = exportReportData;
    window.generatePDFReport = generatePDFReport;
    window.exportDashboardData = exportDashboardData;
    window.exportToCSV = exportToCSV;
    // Add these to the window object at the bottom of the file
    window.changeCalendarView = changeCalendarView;
    window.changeFacilityFilter = changeFacilityFilter;
    window.changeStatusFilter = changeStatusFilter;
    window.prevPeriod = prevPeriod;
    window.nextPeriod = nextPeriod;
    window.goToToday = goToToday;
    window.allowDrop = allowDrop;
    window.dragBooking = dragBooking;
    window.dropBooking = dropBooking;
    window.dropBookingToSlot = dropBookingToSlot;
    window.checkBookingConflict = checkBookingConflict;
    window.showBookingDetails = showBookingDetails;
    window.changeColorCode = changeColorCode;
    window.getFacilityColorClass = getFacilityColorClass;
    window.generateColorLegend = generateColorLegend;
    // Add to the window object at the bottom
    window.changeStatusFilter = changeStatusFilter;
    window.clearAllFilters = clearAllFilters;
    window.checkSlotAvailability = checkSlotAvailability;
  </script>
</body>

</html>