<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management | sportova</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --secondary: #3f37c9;
      --success: #4cc9f0;
      --light-bg: #f8f9fa;
      --dark-bg: #212529;
      --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      --transition: all 0.3s ease;
    }
    
    body {
      background-color: #f5f7fb;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #495057;
    }
    
    .main-content {
      margin-left: 20px;
      padding: 20px;
      transition: var(--transition);
    }
    
    .card {
      border: none;
      border-radius: 10px;
      box-shadow: var(--card-shadow);
      margin-bottom: 20px;
      transition: var(--transition);
    }
    
    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
    }
    
    .card-header {
      background-color: white;
      border-bottom: 1px solid #eaeaea;
      font-weight: 600;
      padding: 15px 20px;
      border-radius: 10px 10px 0 0 !important;
    }
    
    .stats-card {
      text-align: center;
      padding: 15px;
    }
    
    .stats-card .number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }
    
    .stats-card .label {
      font-size: 0.9rem;
      color: #6c757d;
    }
    
    .stats-card i {
      font-size: 2.5rem;
      color: var(--primary);
      margin-bottom: 15px;
    }
    
    .table th {
      font-weight: 600;
      border-top: none;
      color: #495057;
      background-color: #f8f9fa;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    
    .badge-role {
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }
    
    .badge-admin { background-color: #f032e6; color: white; }
    .badge-sub-admin { background-color: #4361ee; color: white; }
    .badge-operator { background-color: #42ba96; color: white; }
    .badge-coach { background-color: #ffc107; color: black; }
    .badge-player { background-color: #6610f2; color: white; }
    .badge-user { background-color: #6c757d; color: white; }
    
    .btn-primary {
      background-color: var(--primary);
      border-color: var(--primary);
    }
    
    .btn-primary:hover {
      background-color: var(--secondary);
      border-color: var(--secondary);
    }
    
    .action-btn {
      width: 32px;
      height: 32px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      margin-right: 5px;
    }
    
    .filter-bar {
      background: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      box-shadow: var(--card-shadow);
    }
    
    .modal-header {
      background-color: var(--light-bg);
      border-bottom: 1px solid #eaeaea;
    }
    
    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }
    
    .activity-item {
      border-left: 3px solid var(--primary);
      padding-left: 15px;
      margin-bottom: 15px;
    }
    
    @media (max-width: 992px) {
      
      .main-content {
        margin-left: 80px;
      }
    }
    
    @media (max-width: 768px) {
      
      .main-content {
        margin-left: 0;
      }
      
      .stats-card .number {
        font-size: 1.5rem;
      }
    }
  </style>
</head>
<body>
    <!-- Main Content -->
    <div class="main-content">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
          <h3 class="mb-1">User Management</h3>
          <p class="text-muted">Manage all system users and their permissions</p>
        </div>
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createUserModal">
          <i class="fas fa-plus-circle me-2"></i>Create User
        </button>
      </div>

      <!-- Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-2 col-6">
          <div class="card stats-card">
            <i class="fas fa-users"></i>
            <div class="number" id="totalUsers">0</div>
            <div class="label">Total Users</div>
          </div>
        </div>
        <div class="col-md-2 col-6">
          <div class="card stats-card">
            <i class="fas fa-user-check"></i>
            <div class="number" id="activeUsers">0</div>
            <div class="label">Active Users</div>
          </div>
        </div>
        <div class="col-md-2 col-6">
          <div class="card stats-card">
            <i class="fas fa-user-tie"></i>
            <div class="number" id="coachCount">0</div>
            <div class="label">Coaches</div>
          </div>
        </div>
        <div class="col-md-2 col-6">
          <div class="card stats-card">
            <i class="fas fa-user-alt"></i>
            <div class="number" id="playerCount">0</div>
            <div class="label">Players</div>
          </div>
        </div>
        <div class="col-md-2 col-6">
          <div class="card stats-card">
            <i class="fas fa-user-shield"></i>
            <div class="number" id="adminCount">0</div>
            <div class="label">Admins</div>
          </div>
        </div>
        <div class="col-md-2 col-6">
          <div class="card stats-card">
            <i class="fas fa-user-slash"></i>
            <div class="number" id="suspendedCount">0</div>
            <div class="label">Suspended</div>
          </div>
        </div>
      </div>

      <!-- Filter Bar -->
      <div class="filter-bar">
        <div class="row">
          <div class="col-md-3 mb-2">
            <input type="text" class="form-control" placeholder="Search users..." id="searchInput">
          </div>
          <div class="col-md-2 mb-2">
            <select class="form-select" id="roleFilter">
              <option value="">All Roles</option>
              <option value="admin">Admin</option>
              <option value="coach">Coach</option>
              <option value="user">User</option>
            </select>
          </div>
          <div class="col-md-2 mb-2">
            <select class="form-select" id="sportFilter">
              <option value="">All Sports</option>
              <option value="Tennis">Tennis</option>
              <option value="Squash">Squash</option>
              <option value="Badminton">Badminton</option>
              <option value="Padel">Padel</option>
            </select>
          </div>
          <div class="col-md-2 mb-2">
            <select class="form-select" id="statusFilter">
              <option value="">All Status</option>
              <option value="active">Active</option>
              <option value="suspended">Suspended</option>
            </select>
          </div>
          <div class="col-md-3 mb-2 text-md-end">
            <button class="btn btn-outline-secondary" id="exportBtn">
              <i class="fas fa-download me-2"></i>Export
            </button>
          </div>
        </div>
      </div>

      <!-- Users Table -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <span><i class="fas fa-list-alt me-2"></i>All Users</span>
          <div class="form-check form-switch">
            <input class="form-check-input" type="checkbox" id="autoRefreshToggle" checked>
            <label class="form-check-label" for="autoRefreshToggle">Auto Refresh</label>
          </div>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover align-middle">
              <thead>
                <tr>
                  <th>User</th>
                  <th>Contact</th>
                  <th>Role</th>
                  <th>Sport & Skill</th>
                  <th>Status</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody id="usersTable"></tbody>
            </table>
          </div>
          
          <!-- Pagination -->
          <nav>
            <ul class="pagination justify-content-center">
              <li class="page-item disabled">
                <a class="page-link" href="#">Previous</a>
              </li>
              <li class="page-item active"><a class="page-link" href="#">1</a></li>
              <li class="page-item"><a class="page-link" href="#">2</a></li>
              <li class="page-item"><a class="page-link" href="#">3</a></li>
              <li class="page-item">
                <a class="page-link" href="#">Next</a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>

  <!-- Create User Modal -->
  <div class="modal fade" id="createUserModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <form id="createUserForm">
          <div class="modal-header">
            <h5 class="modal-title"><i class="fas fa-user-plus me-2"></i>Create New User</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Full Name</label>
                <input type="text" id="newName" class="form-control" placeholder="Enter full name" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Email Address</label>
                <input type="email" id="newEmail" class="form-control" placeholder="Enter email" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Phone Number</label>
                <input type="text" id="newPhone" class="form-control" placeholder="Enter phone number">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Location</label>
                <input type="text" id="newLocation" class="form-control" placeholder="Enter location">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Primary Sport</label>
                <select id="newSport" class="form-select">
                  <option value="">Select a sport</option>
                  <option value="Tennis">Tennis</option>
                  <option value="Squash">Squash</option>
                  <option value="Badminton">Badminton</option>
                  <option value="Padel">Padel</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Skill Level</label>
                <select id="newSkill" class="form-select">
                  <option value="">Select skill level</option>
                  <option value="Beginner">Beginner</option>
                  <option value="Intermediate">Intermediate</option>
                  <option value="Advanced">Advanced</option>
                  <option value="Professional">Professional</option>
                </select>
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">User Role</label>
                <select id="newRole" class="form-select" required>
                  <option value="user">User</option>
                  <option value="coach">Coach</option>
                  <option value="admin">Admin</option>
                </select>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
            <button type="submit" class="btn btn-primary">Create User</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Activity Modal -->
  <div class="modal fade" id="activityModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title"><i class="fas fa-history me-2"></i>User Activity & Booking History</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="activityContent">
          <div class="d-flex align-items-center mb-4">
            <img id="activityUserImg" src="https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_640.png" class="user-avatar me-3">
            <div>
              <h5 id="activityUserName">User Name</h5>
              <p id="activityUserEmail" class="text-muted mb-0">user@example.com</p>
            </div>
          </div>
          
          <ul class="nav nav-tabs" id="activityTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="bookings-tab" data-bs-toggle="tab" data-bs-target="#bookings" type="button" role="tab">Bookings</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="activity-tab" data-bs-toggle="tab" data-bs-target="#activity" type="button" role="tab">Activity Log</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="details-tab" data-bs-toggle="tab" data-bs-target="#details" type="button" role="tab">User Details</button>
            </li>
          </ul>
          
          <div class="tab-content p-3" id="activityTabContent">
            <div class="tab-pane fade show active" id="bookings" role="tabpanel">
              <p>Loading bookings...</p>
            </div>
            <div class="tab-pane fade" id="activity" role="tabpanel">
              <p class="text-muted">No recent activity found.</p>
            </div>
            <div class="tab-pane fade" id="details" role="tabpanel">
              <div class="row">
                <div class="col-md-6">
                  <p><strong>Joined:</strong> <span id="userJoinDate">N/A</span></p>
                  <p><strong>Last Login:</strong> <span id="userLastLogin">N/A</span></p>
                  <p><strong>Phone:</strong> <span id="userPhone">N/A</span></p>
                </div>
                <div class="col-md-6">
                  <p><strong>Location:</strong> <span id="userLocation">N/A</span></p>
                  <p><strong>Sport:</strong> <span id="userSport">N/A</span></p>
                  <p><strong>Skill Level:</strong> <span id="userSkill">N/A</span></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyDjMwv9Bxff1bUE7CR_S-DPx3NV5kkinTU",
      authDomain: "nste-booking-system.firebaseapp.com",
      projectId: "nste-booking-system",
      storageBucket: "nste-booking-system.appspot.com",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Global variables
    let allUsers = [];
    let currentActivityUser = null;
    let filteredUsers = [];

    // Load Users
    async function loadUsers() {
      try {
        const table = document.getElementById("usersTable");
        table.innerHTML = "<tr><td colspan='6' class='text-center py-4'><div class='spinner-border text-primary' role='status'></div><p class='mt-2'>Loading users...</p></td></tr>";
        
        const snapshot = await db.collection("users").get();
        allUsers = [];
        const userCounts = {
          total: 0,
          active: 0,
          coaches: 0,
          players: 0,
          admins: 0,
          suspended: 0
        };

        snapshot.forEach(doc => {
          const user = { id: doc.id, ...doc.data() };
          allUsers.push(user);
          
          // Update counts
          userCounts.total++;
          if (!user.suspended) userCounts.active++;
          if (user.role === 'coach') userCounts.coaches++;
          if (user.role === 'user') userCounts.players++;
          if (user.role === 'admin' || user.role === 'sub-admin') userCounts.admins++;
          if (user.suspended) userCounts.suspended++;
        });

        // Update stats cards
        document.getElementById('totalUsers').textContent = userCounts.total;
        document.getElementById('activeUsers').textContent = userCounts.active;
        document.getElementById('coachCount').textContent = userCounts.coaches;
        document.getElementById('playerCount').textContent = userCounts.players;
        document.getElementById('adminCount').textContent = userCounts.admins;
        document.getElementById('suspendedCount').textContent = userCounts.suspended;

        filteredUsers = [...allUsers];
        renderUsers(filteredUsers);
      } catch (error) {
        console.error("Error loading users:", error);
        document.getElementById("usersTable").innerHTML = "<tr><td colspan='6' class='text-center text-danger py-4'>Error loading users. Please try again.</td></tr>";
      }
    }

    // Render users to table
    function renderUsers(users) {
      const table = document.getElementById("usersTable");
      
      if (users.length === 0) {
        table.innerHTML = "<tr><td colspan='6' class='text-center py-4'>No users found.</td></tr>";
        return;
      }
      
      table.innerHTML = "";
      
      users.forEach(user => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>
            <div class="d-flex align-items-center">
              <img src="${user.photoURL || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_640.png'}" class="user-avatar me-3">
              <div>
                <div class="fw-semibold">${user.name || "N/A"}</div>
                <small class="text-muted">ID: ${user.id.substring(0, 8)}</small>
              </div>
            </div>
          </td>
          <td>
            <div>${user.email || "N/A"}</div>
            <small class="text-muted">${user.phone || "No phone"}</small>
          </td>
          <td>
            <span class="badge badge-role badge-${user.role}">${user.role}</span>
            <div class="mt-1">
              <select class="form-select form-select-sm" onchange="updateRole('${user.id}', this.value)">
                <option value="admin" ${user.role === "admin" ? "selected" : ""}>Admin</option>
                <option value="coach" ${user.role === "coach" ? "selected" : ""}>Coach</option>
                <option value="user" ${user.role === "user" ? "selected" : ""}>User</option>
              </select>
            </div>
          </td>
          <td>
            <div>${user.primarySport || "N/A"}</div>
            <small class="text-muted">${user.skillLevel || "No skill level"}</small>
          </td>
          <td>
            <span class="badge ${user.suspended ? 'bg-danger' : 'bg-success'}">
              ${user.suspended ? 'Suspended' : 'Active'}
            </span>
          </td>
          <td>
            <button class="btn btn-sm btn-info action-btn" onclick="viewActivity('${user.id}')" title="View Activity">
              <i class="fas fa-history"></i>
            </button>
            <button class="btn btn-sm btn-warning action-btn" onclick="editUser('${user.id}')" title="Edit User">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn btn-sm ${user.suspended ? 'btn-success' : 'btn-danger'} action-btn" 
                    onclick="${user.suspended ? 'reinstateUser' : 'suspendUser'}('${user.id}')" 
                    title="${user.suspended ? 'Reinstate User' : 'Suspend User'}">
              <i class="fas ${user.suspended ? 'fa-user-check' : 'fa-user-slash'}"></i>
            </button>
          </td>
        `;
        table.appendChild(tr);
      });
    }

    // Update Role
    async function updateRole(uid, role) {
      try {
        await db.collection("users").doc(uid).update({ role });
        
        // Show notification
        showNotification(`User role updated to ${role}`, 'success');
        
        // Reload users to reflect changes
        loadUsers();
      } catch (error) {
        console.error("Error updating role:", error);
        showNotification('Failed to update role', 'error');
      }
    }

    // Suspend User
    async function suspendUser(uid) {
      if (confirm("Are you sure you want to suspend this user?")) {
        try {
          await db.collection("users").doc(uid).update({ suspended: true });
          showNotification('User suspended successfully', 'success');
          loadUsers();
        } catch (error) {
          console.error("Error suspending user:", error);
          showNotification('Failed to suspend user', 'error');
        }
      }
    }

    // Reinstate User
    async function reinstateUser(uid) {
      try {
        await db.collection("users").doc(uid).update({ suspended: false });
        showNotification('User reinstated successfully', 'success');
        loadUsers();
      } catch (error) {
        console.error("Error reinstating user:", error);
        showNotification('Failed to reinstate user', 'error');
      }
    }

    // View Activity & Booking History
    async function viewActivity(uid) {
      try {
        const user = allUsers.find(u => u.id === uid);
        if (!user) return;
        
        currentActivityUser = user;
        
        // Update user info in modal
        document.getElementById('activityUserImg').src = user.photoURL || 'https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_640.png';
        document.getElementById('activityUserName').textContent = user.name || "N/A";
        document.getElementById('activityUserEmail').textContent = user.email || "N/A";
        document.getElementById('userJoinDate').textContent = user.createdAt ? user.createdAt.toDate().toLocaleDateString() : "N/A";
        document.getElementById('userLastLogin').textContent = user.lastLogin ? user.lastLogin.toDate().toLocaleString() : "N/A";
        document.getElementById('userPhone').textContent = user.phone || "N/A";
        document.getElementById('userLocation').textContent = user.location || "N/A";
        document.getElementById('userSport').textContent = user.primarySport || "N/A";
        document.getElementById('userSkill').textContent = user.skillLevel || "N/A";
        
        const bookingsTab = document.querySelector('#bookings');
        bookingsTab.innerHTML = "<p>Loading bookings...</p>";
        
        const bookingsSnap = await db.collection("bookings").where("userId", "==", uid).get();

        if (bookingsSnap.empty) {
          bookingsTab.innerHTML = "<p class='text-muted'>No bookings found for this user.</p>";
        } else {
          let html = `<div class="list-group">`;
          bookingsSnap.forEach(doc => {
            const b = doc.data();
            html += `
              <div class="list-group-item">
                <div class="d-flex w-100 justify-content-between">
                  <h6 class="mb-1">${b.facilityName} (${b.type})</h6>
                  <small class="text-${b.status === 'confirmed' ? 'success' : 'warning'}">${b.status}</small>
                </div>
                <p class="mb-1">Date: ${b.date}, Slot: ${b.slot}</p>
                <small class="text-muted">Price: $${b.price || '0'}, Total: $${b.totalAmount || '0'}</small>
                ${b.coach ? `<small class="d-block text-muted">Coach: ${b.coach.name || "N/A"}</small>` : ''}
                ${b.snacks && b.snacks.length > 0 ? 
                  `<small class="d-block text-muted">Snacks: ${b.snacks.map(s => s.name + " x" + s.quantity).join(", ")}</small>` : ''}
              </div>
            `;
          });
          html += "</div>";
          bookingsTab.innerHTML = html;
        }
        
        new bootstrap.Modal(document.getElementById("activityModal")).show();
      } catch (error) {
        console.error("Error loading user activity:", error);
        document.querySelector('#bookings').innerHTML = "<p class='text-danger'>Error loading bookings</p>";
      }
    }

    // Create User
    document.getElementById("createUserForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      
      try {
        const newUser = {
          name: document.getElementById("newName").value,
          email: document.getElementById("newEmail").value,
          phone: document.getElementById("newPhone").value,
          location: document.getElementById("newLocation").value,
          primarySport: document.getElementById("newSport").value,
          skillLevel: document.getElementById("newSkill").value,
          role: document.getElementById("newRole").value,
          createdAt: new Date(),
          photoURL: "https://cdn.pixabay.com/photo/2015/10/05/22/37/blank-profile-picture-973460_640.png"
        };
        
        await db.collection("users").add(newUser);
        showNotification("User created successfully!", 'success');
        
        document.getElementById("createUserForm").reset();
        bootstrap.Modal.getInstance(document.getElementById("createUserModal")).hide();
        loadUsers();
      } catch (error) {
        console.error("Error creating user:", error);
        showNotification('Failed to create user', 'error');
      }
    });

    // Search and filter functionality
    document.getElementById('searchInput').addEventListener('input', filterUsers);
    document.getElementById('roleFilter').addEventListener('change', filterUsers);
    document.getElementById('sportFilter').addEventListener('change', filterUsers);
    document.getElementById('statusFilter').addEventListener('change', filterUsers);

    function filterUsers() {
      const searchText = document.getElementById('searchInput').value.toLowerCase();
      const roleFilter = document.getElementById('roleFilter').value;
      const sportFilter = document.getElementById('sportFilter').value;
      const statusFilter = document.getElementById('statusFilter').value;
      
      filteredUsers = allUsers.filter(user => {
        const matchesSearch = user.name?.toLowerCase().includes(searchText) || 
                             user.email?.toLowerCase().includes(searchText);
        const matchesRole = !roleFilter || user.role === roleFilter;
        const matchesSport = !sportFilter || user.primarySport === sportFilter;
        const matchesStatus = !statusFilter || 
                             (statusFilter === 'active' && !user.suspended) ||
                             (statusFilter === 'suspended' && user.suspended);
        
        return matchesSearch && matchesRole && matchesSport && matchesStatus;
      });
      
      renderUsers(filteredUsers);
    }

    // Export functionality
    document.getElementById('exportBtn').addEventListener('click', exportUsers);

    function exportUsers() {
      // Prepare data for export
      const data = filteredUsers.map(user => ({
        'User ID': user.id.substring(0, 8),
        'Name': user.name || 'N/A',
        'Email': user.email || 'N/A',
        'Phone': user.phone || 'N/A',
        'Role': user.role || 'N/A',
        'Sport': user.primarySport || 'N/A',
        'Skill Level': user.skillLevel || 'N/A',
        'Location': user.location || 'N/A',
        'Status': user.suspended ? 'Suspended' : 'Active',
        'Created At': user.createdAt ? user.createdAt.toDate().toLocaleDateString() : 'N/A',
        'Last Login': user.lastLogin ? user.lastLogin.toDate().toLocaleString() : 'N/A'
      }));

      // Create worksheet
      const ws = XLSX.utils.json_to_sheet(data);
      
      // Create workbook
      const wb = XLSX.utils.book_new();
      XLSX.utils.book_append_sheet(wb, ws, "Users");
      
      // Generate file name with timestamp
      const fileName = `users_export_${new Date().toISOString().slice(0, 10)}.xlsx`;
      
      // Export to Excel
      XLSX.writeFile(wb, fileName);
      
      showNotification('Users exported successfully', 'success');
    }

    // Show notification
    function showNotification(message, type = 'info') {
      // Create notification element
      const notification = document.createElement('div');
      notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
      notification.style.cssText = 'top: 20px; right: 20px; z-index: 1050; min-width: 300px;';
      notification.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      `;
      
      // Add to page
      document.body.appendChild(notification);
      
      // Auto remove after 3 seconds
      setTimeout(() => {
        if (notification.parentNode) {
          notification.remove();
        }
      }, 3000);
    }

    // Initialize
    loadUsers();
    
    // Auto refresh if toggle is enabled
    setInterval(() => {
      if (document.getElementById('autoRefreshToggle').checked) {
        loadUsers();
      }
    }, 30000); // Refresh every 30 seconds
  </script>
</body>

</html>
