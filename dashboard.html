<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AI-Powered Facility Dashboard</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --accent-color: #4cc9f0;
      --light-bg: #f8f9fa;
      --dark-bg: #212529;
      --success-color: #38b000;
      --warning-color: #ffaa00;
      --danger-color: #ef233c;
      --ai-color: #7209b7;
    }

    body {
      background-color: #f8fafc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 1rem;
    }

    .dashboard-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid #e9ecef;
    }

    .card {
      border: none;
      border-radius: 12px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
      overflow: hidden;
      background-color: white;
      height: 100%;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    .stat-card {
      padding: 1.5rem;
      position: relative;
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: linear-gradient(to bottom, var(--primary-color), var(--accent-color));
    }

    .stat-icon {
      font-size: 1.75rem;
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 1rem;
      color: white;
    }

    .stat-icon.users {
      background: linear-gradient(135deg, #4361ee, #4cc9f0);
    }

    .stat-icon.active {
      background: linear-gradient(135deg, #38b000, #80ed99);
    }

    .stat-icon.revenue {
      background: linear-gradient(135deg, #7209b7, #b5179e);
    }

    .stat-icon.ai {
      background: linear-gradient(135deg, #7209b7, #3a0ca3);
    }

    .stat-value {
      font-size: 1.75rem;
      font-weight: 700;
      margin: 0.5rem 0;
      color: var(--dark-bg);
    }

    .stat-label {
      color: #6c757d;
      font-size: 0.9rem;
      font-weight: 500;
    }

    .chart-container {
      position: relative;
      height: 300px;
      margin: 1rem 0;
    }

    .section-title {
      font-size: 1.25rem;
      font-weight: 600;
      margin-bottom: 1.25rem;
      color: var(--dark-bg);
      display: flex;
      align-items: center;
    }

    .section-title i {
      margin-right: 0.5rem;
      color: var(--primary-color);
    }

    .badge {
      font-weight: 500;
      padding: 0.35em 0.65em;
      border-radius: 8px;
    }

    .badge-confirmed {
      background-color: rgba(56, 176, 0, 0.1);
      color: var(--success-color);
    }

    .badge-pending {
      background-color: rgba(255, 170, 0, 0.1);
      color: var(--warning-color);
    }

    .badge-cancelled {
      background-color: rgba(239, 35, 60, 0.1);
      color: var(--danger-color);
    }

    .badge-ai {
      background-color: rgba(114, 9, 183, 0.1);
      color: var(--ai-color);
    }

    .search-bar {
      max-width: 300px;
      position: relative;
    }

    .search-bar i {
      position: absolute;
      left: 12px;
      top: 50%;
      transform: translateY(-50%);
      color: #adb5bd;
    }

    .search-bar input {
      padding-left: 40px;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .modal-header {
      background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
      border-bottom: none;
    }

    .btn-primary {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-primary:hover {
      background-color: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    .btn-outline-primary {
      color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-outline-primary:hover {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .btn-ai {
      background-color: var(--ai-color);
      border-color: var(--ai-color);
      color: white;
    }

    .btn-ai:hover {
      background-color: #5a08a5;
      border-color: #5a08a5;
      color: white;
    }

    .pagination .page-item.active .page-link {
      background-color: var(--primary-color);
      border-color: var(--primary-color);
    }

    .pagination .page-link {
      color: var(--primary-color);
    }

    .ai-prediction {
      background-color: rgba(114, 9, 183, 0.05);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 1rem;
      border-left: 3px solid var(--ai-color);
    }

    .ai-prediction-title {
      color: var(--ai-color);
      font-weight: 600;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
    }

    .ai-prediction-title i {
      margin-right: 0.5rem;
    }

    .sentiment-positive {
      color: var(--success-color);
    }

    .sentiment-neutral {
      color: var(--warning-color);
    }

    .sentiment-negative {
      color: var(--danger-color);
    }

    .anomaly-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      margin-right: 6px;
    }

    .anomaly-high {
      background-color: var(--danger-color);
    }

    .anomaly-medium {
      background-color: var(--warning-color);
    }

    .anomaly-low {
      background-color: var(--success-color);
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    .gradient-bg {
      background: linear-gradient(135deg, #4361ee, #3a0ca3);
      color: white;
    }

    .ai-highlight {
      background: linear-gradient(90deg, rgba(114, 9, 183, 0.1) 0%, rgba(255, 255, 255, 0) 100%);
      border-left: 3px solid var(--ai-color);
      padding: 1rem;
      border-radius: 0 8px 8px 0;
      margin-bottom: 1rem;
    }

    .chart-card {
      border-left: 4px solid var(--primary-color);
    }

    .insights-card {
      border-left: 4px solid var(--ai-color);
    }

    @media (max-width: 768px) {
      .stat-value {
        font-size: 1.5rem;
      }

      .section-title {
        font-size: 1.1rem;
      }

      .dashboard-header {
        flex-direction: column;
        align-items: flex-start;
      }

      .search-bar {
        max-width: 100%;
        width: 100%;
        margin-top: 1rem;
      }
    }
  </style>
</head>

<body>
  <div class="container-fluid">
    <!-- Dashboard Header -->
    <div class="dashboard-header glass-effect p-3">
      <div>
        <h2 class="mb-0"><i class="bi bi-robot me-2"></i>AI Facility Dashboard</h2>
        <p class="text-muted mb-0">Smart insights and predictive analytics for facility management</p>
      </div>
      <div class="text-end">
        <div class="text-muted small">Last updated: <span id="lastUpdated">Loading...</span></div>
      </div>
    </div>

    <div class="row g-4">
      <!-- Total Bookings Card -->
      <div class="col-md-3">
        <div class="card stat-card glass-effect">
          <div class="stat-icon users">
            <i class="bi bi-calendar-check"></i>
          </div>
          <h4 class="stat-value" id="totalBookings">0</h4>
          <p class="stat-label">Total Bookings</p>
          <div class="mt-2 text-success small">
            <i class="bi bi-arrow-up"></i> <span id="bookingGrowth">0%</span> from last month
          </div>
        </div>
      </div>

      <!-- Utilization Rate Card -->
      <div class="col-md-3">
        <div class="card stat-card glass-effect">
          <div class="stat-icon active">
            <i class="bi bi-speedometer2"></i>
          </div>
          <h4 class="stat-value" id="utilizationRate">0%</h4>
          <p class="stat-label">Facility Utilization</p>
          <div class="mt-2 text-success small">
            <i class="bi bi-arrow-up"></i> <span id="utilizationGrowth">0%</span> from last month
          </div>
        </div>
      </div>

      <!-- Revenue Card -->
      <div class="col-md-3">
        <div class="card stat-card glass-effect">
          <div class="stat-icon revenue">
            <i class="bi bi-currency-dollar"></i>
          </div>
          <h4 class="stat-value" id="totalRevenue">RM0</h4>
          <p class="stat-label">Total Revenue</p>
          <div class="mt-2 text-success small">
            <i class="bi bi-arrow-up"></i> <span id="revenueGrowth">0%</span> from last month
          </div>
        </div>
      </div>

      <!-- AI Predictions Card -->
      <div class="col-md-3">
        <div class="card stat-card glass-effect">
          <div class="stat-icon ai">
            <i class="bi bi-robot"></i>
          </div>
          <h4 class="stat-value" id="aiPredictions">0</h4>
          <p class="stat-label">AI Insights</p>
          <div class="mt-2 text-primary small">
            <i class="bi bi-lightbulb"></i> <span id="aiActionable">0</span> actionable
          </div>
        </div>
      </div>

      <!-- Bookings Chart Section -->
      <div class="col-lg-8">
        <div class="card p-4 chart-card glass-effect">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="section-title">
              <i class="bi bi-graph-up"></i> Monthly Bookings with AI Forecast
            </h5>
            <button class="btn btn-sm btn-ai" id="refreshForecastBtn">
              <i class="bi bi-arrow-repeat"></i> Refresh Forecast
            </button>
          </div>
          <div class="chart-container">
            <canvas id="bookingsChart"></canvas>
          </div>
          <div class="d-flex justify-content-between mt-2">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="showForecast" checked>
              <label class="form-check-label small" for="showForecast">Show AI forecast</label>
            </div>
            <div>
              <select class="form-select form-select-sm" id="timeRangeSelect" style="width: 120px;">
                <option value="6">Last 6 months</option>
                <option value="12">Last year</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- AI Insights Section -->
      <div class="col-lg-4">
        <div class="card p-4 insights-card glass-effect">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="section-title">
              <i class="bi bi-robot"></i> AI Insights
            </h5>
            <button class="btn btn-sm btn-outline-primary" id="generateInsightsBtn">
              <i class="bi bi-magic"></i> Generate
            </button>
          </div>

          <div id="aiInsightsContainer">
            <div class="ai-prediction">
              <div class="ai-prediction-title">
                <i class="bi bi-hourglass-split"></i> Peak Hours Prediction
              </div>
              <p id="peakHoursInsight">Analyzing booking patterns to predict peak hours...</p>
            </div>

            <div class="ai-prediction">
              <div class="ai-prediction-title">
                <i class="bi bi-exclamation-triangle"></i> Anomaly Detection
              </div>
              <p id="anomalyInsight">Scanning for unusual booking patterns...</p>
            </div>

            <div class="ai-prediction">
              <div class="ai-prediction-title">
                <i class="bi bi-chat-square-text"></i> Feedback Sentiment
              </div>
              <p id="sentimentInsight">Analyzing customer feedback sentiment...</p>
            </div>

            <div class="ai-prediction">
              <div class="ai-prediction-title">
                <i class="bi bi-lightbulb"></i> Optimization Suggestion
              </div>
              <p id="optimizationInsight">Generating facility optimization ideas...</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Charts Section -->
      <div class="col-lg-6">
        <div class="card p-4 chart-card glass-effect">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="section-title">
              <i class="bi bi-pie-chart"></i> Booking Status Distribution
            </h5>
            <div class="small">
              <span class="text-muted">This month</span>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="bookingStatusChart"></canvas>
          </div>
        </div>
      </div>

      <div class="col-lg-6">
        <div class="card p-4 chart-card glass-effect">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="section-title">
              <i class="bi bi-cash-stack"></i> Revenue Sources
            </h5>
            <div class="small">
              <span class="text-muted">This month</span>
            </div>
          </div>
          <div class="chart-container">
            <canvas id="revenueSourcesChart"></canvas>
          </div>
        </div>
      </div>

      <!-- AI Highlights Section -->
      <div class="col-12">
        <div class="card p-4 insights-card glass-effect">
          <h5 class="section-title">
            <i class="bi bi-stars"></i> AI Highlights
          </h5>

          <div class="row">
            <div class="col-md-4">
              <div class="ai-highlight">
                <h6><i class="bi bi-graph-up"></i> Performance Trend</h6>
                <p id="performanceTrend" class="mb-0">Analyzing monthly performance trends...</p>
              </div>
            </div>

            <div class="col-md-4">
              <div class="ai-highlight">
                <h6><i class="bi bi-people"></i> Customer Insights</h6>
                <p id="customerInsights" class="mb-0">Evaluating customer behavior patterns...</p>
              </div>
            </div>

            <div class="col-md-4">
              <div class="ai-highlight">
                <h6><i class="bi bi-lightbulb"></i> Smart Suggestions</h6>
                <p id="smartSuggestions" class="mb-0">Generating actionable recommendations...</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Analysis Modal -->
  <div class="modal fade" id="aiAnalysisModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
      <div class="modal-content glass-effect">
        <div class="modal-header gradient-bg">
          <h5 class="modal-title text-white"><i class="bi bi-robot me-2"></i>Advanced AI Analysis</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="aiAnalysisContent">
          <div class="d-flex justify-content-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button type="button" class="btn btn-ai" id="runAdvancedAnalysisBtn">
            <i class="bi bi-robot"></i> Run Analysis
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Scripts -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-functions-compat.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDjMwv9Bxff1bUE7CR_S-DPx3NV5kkinTU",
      authDomain: "nste-booking-system.firebaseapp.com",
      projectId: "nste-booking-system",
      storageBucket: "nste-booking-system.appspot.com",
      messagingSenderId: "574207536433",
      appId: "1:574207536433:web:0d2aeaacdc280cec019410"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const functions = firebase.functions();

    // Global variables
    let usersData = [];
    let bookingsData = [];
    let facilitiesData = [];
    let coachesData = [];
    let addonsData = [];
    let feedbackData = [];
    let bookingsChart = null;
    let statusChart = null;
    let revenueChart = null;
    let aiAnalysisModal = null;
    let aiInsights = [];
    let forecastData = [];

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', () => {
      aiAnalysisModal = new bootstrap.Modal(document.getElementById('aiAnalysisModal'));
      setupEventListeners();

      // Set last updated time
      document.getElementById('lastUpdated').textContent = new Date().toLocaleString();

      // Load data silently without showing error popups
      loadDashboardData().catch(error => {
        console.error("Error loading dashboard data:", error);
        // Update UI to show loading failed
        document.getElementById('totalBookings').textContent = "N/A";
        document.getElementById('utilizationRate').textContent = "N/A";
        document.getElementById('totalRevenue').textContent = "RMN/A";
        document.getElementById('bookingGrowth').textContent = "N/A";
        document.getElementById('utilizationGrowth').textContent = "N/A";
        document.getElementById('revenueGrowth').textContent = "N/A";
      });
    });

    function setupEventListeners() {
      // Time range select
      document.getElementById('timeRangeSelect').addEventListener('change', () => {
        renderBookingsChart();
      });

      // Forecast toggle
      document.getElementById('showForecast').addEventListener('change', () => {
        renderBookingsChart();
      });

      // Refresh forecast button
      document.getElementById('refreshForecastBtn').addEventListener('click', () => {
        generateBookingForecast().catch(error => {
          console.error("Error generating forecast:", error);
          alert("Failed to generate forecast. Please try again.");
        });
      });

      // Generate insights button
      document.getElementById('generateInsightsBtn').addEventListener('click', () => {
        generateAIInsights().catch(error => {
          console.error("Error generating insights:", error);
          alert("Failed to generate insights. Please try again.");
        });
      });

      // Run advanced analysis button
      document.getElementById('runAdvancedAnalysisBtn').addEventListener('click', () => {
        runAdvancedAnalysis().catch(error => {
          console.error("Error running analysis:", error);
        });
      });
    }

    async function loadDashboardData() {
      try {
        // Load all data from Firestore
        const [
          usersSnapshot,
          bookingsSnapshot,
          facilitiesSnapshot,
          postsSnapshot
        ] = await Promise.all([
          db.collection("users").get(),
          db.collection("bookings").orderBy("timestamp", "desc").get(),
          db.collection("facilities").get(),
          db.collection("posts").orderBy("timestamp", "desc").limit(50).get() // Limit to 50 recent posts
        ]);

        // Process core data
        usersData = processSnapshot(usersSnapshot);
        bookingsData = processBookings(bookingsSnapshot);
        facilitiesData = processSnapshot(facilitiesSnapshot);

        // Process posts and their comments
        feedbackData = await processPostsWithComments(postsSnapshot);

        // Update dashboard
        updateDashboardStats();
        renderBookingsChart();
        renderStatusChart();
        renderRevenueChart();

        // Generate initial AI insights
        generateBookingForecast();
        generateAIInsights();
      } catch (error) {
        console.error("Error loading dashboard data:", error);
        throw error;
      }
    }

    // Helper functions
    function processSnapshot(snapshot) {
      return snapshot.docs.map(doc => ({
        id: doc.id,
        ...doc.data(),
        timestamp: doc.data().timestamp?.toDate?.() || new Date()
      }));
    }

    function processBookings(snapshot) {
      return snapshot.docs.map(doc => {
        const data = doc.data();
        return {
          id: doc.id,
          ...data,
          date: data.date?.toDate?.() || new Date(),
          timestamp: data.timestamp?.toDate?.() || new Date()
        };
      });
    }

    async function processPostsWithComments(postsSnapshot) {
      const posts = [];

      // Process posts in batches to avoid too many simultaneous requests
      for (let i = 0; i < postsSnapshot.docs.length; i += 5) {
        const batch = postsSnapshot.docs.slice(i, i + 5);
        const processedBatch = await Promise.all(batch.map(async doc => {
          const postData = doc.data();
          const post = {
            id: doc.id,
            ...postData,
            timestamp: postData.timestamp?.toDate?.() || new Date(),
            comments: []
          };

          // Get comments subcollection
          const commentsSnapshot = await db.collection("posts").doc(doc.id).collection("comments").get();
          post.comments = commentsSnapshot.docs.map(commentDoc => ({
            id: commentDoc.id,
            ...commentDoc.data(),
            timestamp: commentDoc.data().timestamp?.toDate?.() || new Date()
          }));

          return post;
        }));

        posts.push(...processedBatch);
      }

      return posts;
    }

    function updateDashboardStats() {
      try {
        // Total bookings
        document.getElementById("totalBookings").textContent = bookingsData.length;

        // Utilization rate (calculate based on facility capacity and bookings)
        const totalCapacity = facilitiesData.reduce((sum, facility) => sum + (facility.maxBookings || 1), 0);
        const totalBookedSlots = bookingsData
          .filter(booking => booking.status === 'confirmed')
          .length;

        const utilizationRate = totalCapacity > 0 ?
          Math.round((totalBookedSlots / (totalCapacity * 30)) * 100) : 0; // Assuming 30 days in month
        document.getElementById("utilizationRate").textContent = `${utilizationRate}%`;

        // Total revenue (only confirmed bookings)
        const totalRevenue = bookingsData
          .filter(booking => booking.status === 'confirmed')
          .reduce((sum, booking) => sum + (booking.totalAmount || 0), 0);
        document.getElementById("totalRevenue").textContent = `RM${totalRevenue.toFixed(2)}`;

        // Calculate growth percentages
        calculateGrowthPercentages();
      } catch (error) {
        console.error("Error updating dashboard stats:", error);
        throw error;
      }
    }

    function calculateGrowthPercentages() {
      try {
        // Calculate booking growth
        const now = new Date();
        const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);
        const prevMonthStart = new Date(now.getFullYear(), now.getMonth() - 1, 1);
        const prevMonthEnd = new Date(now.getFullYear(), now.getMonth(), 0);

        const currentMonthBookings = bookingsData.filter(booking =>
          booking.date >= currentMonthStart
        ).length;

        const prevMonthBookings = bookingsData.filter(booking =>
          booking.date >= prevMonthStart && booking.date <= prevMonthEnd
        ).length;

        const bookingGrowth = prevMonthBookings > 0 ?
          ((currentMonthBookings - prevMonthBookings) / prevMonthBookings * 100).toFixed(1) : 100;
        document.getElementById("bookingGrowth").textContent = `${bookingGrowth}%`;

        // Calculate utilization growth
        const currentMonthCapacity = facilitiesData.reduce((sum, facility) => sum + (facility.maxBookings || 1), 0) * 30;
        const currentMonthBooked = bookingsData
          .filter(booking => booking.date >= currentMonthStart)
          .length;
        const currentUtilization = currentMonthCapacity > 0 ?
          (currentMonthBooked / currentMonthCapacity) * 100 : 0;

        const prevMonthBooked = bookingsData
          .filter(booking => booking.date >= prevMonthStart && booking.date <= prevMonthEnd)
          .length;
        const prevUtilization = currentMonthCapacity > 0 ?
          (prevMonthBooked / currentMonthCapacity) * 100 : 0;

        const utilizationGrowth = prevUtilization > 0 ?
          ((currentUtilization - prevUtilization) / prevUtilization * 100).toFixed(1) : 100;
        document.getElementById("utilizationGrowth").textContent = `${utilizationGrowth}%`;

        // Calculate revenue growth
        const currentMonthRevenue = bookingsData
          .filter(booking => booking.date >= currentMonthStart && booking.status === 'confirmed')
          .reduce((sum, booking) => sum + (booking.totalAmount || 0), 0);

        const prevMonthRevenue = bookingsData
          .filter(booking => booking.date >= prevMonthStart && booking.date <= prevMonthEnd && booking.status === 'confirmed')
          .reduce((sum, booking) => sum + (booking.totalAmount || 0), 0);

        const revenueGrowth = prevMonthRevenue > 0 ?
          ((currentMonthRevenue - prevMonthRevenue) / prevMonthRevenue * 100).toFixed(1) : 100;
        document.getElementById("revenueGrowth").textContent = `${revenueGrowth}%`;
      } catch (error) {
        console.error("Error calculating growth percentages:", error);
        throw error;
      }
    }

    function renderBookingsChart() {
      try {
        const ctx = document.getElementById('bookingsChart');
        const timeRange = parseInt(document.getElementById('timeRangeSelect').value);

        // Group bookings by month
        const now = new Date();
        const startDate = new Date();
        startDate.setMonth(now.getMonth() - timeRange + 1);

        const monthLabels = [];
        const monthCounts = [];

        for (let i = timeRange - 1; i >= 0; i--) {
          const date = new Date();
          date.setMonth(now.getMonth() - i);

          const monthName = date.toLocaleDateString('en-US', { month: 'short' });
          monthLabels.push(monthName);

          const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
          const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);

          const count = bookingsData.filter(booking =>
            booking.date >= monthStart && booking.date <= monthEnd
          ).length;

          monthCounts.push(count);
        }

        if (bookingsChart) {
          bookingsChart.destroy();
        }

        const datasets = [{
          label: 'Actual Bookings',
          data: monthCounts,
          backgroundColor: 'rgba(67, 97, 238, 0.2)',
          borderColor: 'rgba(67, 97, 238, 1)',
          borderWidth: 2,
          tension: 0.3,
          fill: true
        }];

        // Add forecast data if available and toggle is on
        if (forecastData.length > 0 && document.getElementById('showForecast').checked) {
          datasets.push({
            label: 'AI Forecast',
            data: forecastData,
            borderColor: 'rgba(114, 9, 183, 1)',
            borderWidth: 2,
            borderDash: [5, 5],
            tension: 0.3,
            fill: false,
            pointBackgroundColor: 'rgba(114, 9, 183, 1)'
          });
        }

        bookingsChart = new Chart(ctx, {
          type: 'line',
          data: {
            labels: monthLabels,
            datasets: datasets
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'top',
              },
              tooltip: {
                mode: 'index',
                intersect: false,
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                grid: {
                  drawBorder: false
                },
                title: {
                  display: true,
                  text: 'Number of Bookings'
                }
              },
              x: {
                grid: {
                  display: false
                },
                title: {
                  display: true,
                  text: 'Month'
                }
              }
            }
          }
        });
      } catch (error) {
        console.error("Error rendering bookings chart:", error);
      }
    }

    async function generateBookingForecast() {
      try {
        // Show loading state
        document.getElementById('refreshForecastBtn').innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Generating...';

        // Prepare data for forecasting
        const now = new Date();
        const pastMonths = 12; // Use last 12 months for forecasting
        const forecastMonths = 3; // Forecast next 3 months

        const monthlyData = [];

        for (let i = pastMonths - 1; i >= 0; i--) {
          const date = new Date();
          date.setMonth(now.getMonth() - i);

          const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
          const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);

          const count = bookingsData.filter(booking =>
            booking.date >= monthStart && booking.date <= monthEnd
          ).length;

          monthlyData.push(count);
        }

        // Simulate forecast since we don't have the Firebase function
        // In a real app, you would call your Firebase function here
        const forecast = simulateForecast(monthlyData, forecastMonths);

        // Process forecast results
        forecastData = monthlyData.slice(-6).concat(forecast.predictions);

        // Update the chart
        renderBookingsChart();

        // Update AI predictions count
        document.getElementById('aiPredictions').textContent =
          parseInt(document.getElementById('aiPredictions').textContent || '0') + 1;

        // Show success message
        const forecastContainer = document.getElementById('aiInsightsContainer');
        const forecastInsight = document.createElement('div');
        forecastInsight.className = 'ai-prediction';
        forecastInsight.innerHTML = `
          <div class="ai-prediction-title">
            <i class="bi bi-graph-up"></i> Booking Forecast
          </div>
          <p>AI predicts ${Math.round(forecast.predictions[0])} bookings next month (${forecast.confidence}% confidence).</p>
        `;
        forecastContainer.prepend(forecastInsight);

      } catch (error) {
        console.error("Error generating forecast:", error);
        alert("Failed to generate forecast. Please try again.");
      } finally {
        document.getElementById('refreshForecastBtn').innerHTML =
          '<i class="bi bi-arrow-repeat"></i> Refresh Forecast';
      }
    }

    function simulateForecast(historicalData, periods) {
      // Simple linear regression to simulate forecast
      const n = historicalData.length;
      let sumX = 0, sumY = 0, sumXY = 0, sumXX = 0;

      for (let i = 0; i < n; i++) {
        sumX += i;
        sumY += historicalData[i];
        sumXY += i * historicalData[i];
        sumXX += i * i;
      }

      const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
      const intercept = (sumY - slope * sumX) / n;

      const predictions = [];
      for (let i = 0; i < periods; i++) {
        predictions.push(Math.max(0, Math.round(intercept + slope * (n + i))));
      }

      // Calculate confidence based on data variance
      let sumSqDiff = 0;
      for (let i = 0; i < n; i++) {
        const predicted = intercept + slope * i;
        sumSqDiff += Math.pow(historicalData[i] - predicted, 2);
      }
      const variance = sumSqDiff / n;
      const confidence = Math.max(50, 100 - Math.round(variance));

      return {
        predictions,
        confidence
      };
    }

    async function generateAIInsights() {
      try {
        // Show loading state
        document.getElementById('generateInsightsBtn').innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';

        // Generate peak hours insight
        generatePeakHoursInsight();

        // Analyze feedback sentiment
        analyzeFeedbackSentiment();

        // Generate anomaly detection insight
        detectBookingAnomalies();

        // Generate optimization suggestions
        generateOptimizationSuggestions();

        // Update AI predictions count
        document.getElementById('aiPredictions').textContent =
          parseInt(document.getElementById('aiPredictions').textContent || '0') + 3;
        document.getElementById('aiActionable').textContent =
          parseInt(document.getElementById('aiActionable').textContent || '0') + 1;

      } catch (error) {
        console.error("Error generating insights:", error);
        alert("Failed to generate insights. Please try again.");
      } finally {
        document.getElementById('generateInsightsBtn').innerHTML =
          '<i class="bi bi-magic"></i> Generate';
      }
    }

    function analyzeFeedbackSentiment() {
      try {
        // Enhanced keyword lists
        const positiveKeywords = ['great', 'excellent', 'awesome', 'love', 'good', 'happy',
          'wonderful', 'fantastic', 'perfect', 'best', 'beautiful'];
        const negativeKeywords = ['bad', 'poor', 'terrible', 'disappointed', 'unhappy',
          'horrible', 'awful', 'worst', 'hate', 'dislike'];

        let analysisResults = {
          positive: 0,
          neutral: 0,
          negative: 0,
          totalItems: 0,
          mostLikedPost: null,
          mostCommentedPost: null
        };

        // Analyze each post and its comments
        feedbackData.forEach(post => {
          // Analyze post caption
          if (post.caption) {
            const sentiment = getSentiment(post.caption, positiveKeywords, negativeKeywords);
            analysisResults[sentiment]++;
            analysisResults.totalItems++;
          }

          // Analyze comments
          post.comments.forEach(comment => {
            if (comment.text) {
              const sentiment = getSentiment(comment.text, positiveKeywords, negativeKeywords);
              analysisResults[sentiment]++;
              analysisResults.totalItems++;
            }
          });

          // Track engagement metrics
          if (!analysisResults.mostLikedPost ||
            (post.likes?.length || 0) > (analysisResults.mostLikedPost.likes?.length || 0)) {
            analysisResults.mostLikedPost = post;
          }

          if (!analysisResults.mostCommentedPost ||
            post.comments.length > analysisResults.mostCommentedPost.comments.length) {
            analysisResults.mostCommentedPost = post;
          }
        });

        // Determine overall sentiment
        const sentiment = determineOverallSentiment(analysisResults);
        const sentimentClass = `sentiment-${sentiment}`;

        // Update UI
        updateSentimentUI(analysisResults, sentiment, sentimentClass);

      } catch (error) {
        console.error("Error analyzing feedback sentiment:", error);
        document.getElementById('sentimentInsight').innerHTML = `
      <div class="alert alert-warning">
        Could not analyze community sentiment. Error: ${error.message}
      </div>
    `;
      }
    }

    // Helper functions for sentiment analysis
    function getSentiment(text, positiveKeywords, negativeKeywords) {
      const lowerText = text.toLowerCase();
      const hasPositive = positiveKeywords.some(kw => lowerText.includes(kw));
      const hasNegative = negativeKeywords.some(kw => lowerText.includes(kw));

      if (hasPositive && !hasNegative) return 'positive';
      if (hasNegative && !hasPositive) return 'negative';
      return 'neutral';
    }

    function determineOverallSentiment(results) {
      if (results.totalItems === 0) return 'neutral';

      const positiveRatio = results.positive / results.totalItems;
      const negativeRatio = results.negative / results.totalItems;

      if (positiveRatio > 0.6) return 'positive';
      if (negativeRatio > 0.3) return 'negative';
      return 'neutral';
    }

    function updateSentimentUI(results, sentiment, sentimentClass) {
      const sentimentElement = document.getElementById('sentimentInsight');
      const highlightsElement = document.getElementById('customerInsights');

      // Base sentiment analysis
      let html = `
    <div class="ai-prediction-title">
      <i class="bi ${sentiment === 'positive' ? 'bi-emoji-smile' :
          sentiment === 'negative' ? 'bi-emoji-frown' : 'bi-emoji-neutral'}"></i>
      Community Sentiment Analysis
    </div>
    <p>
      Overall sentiment is <span class="${sentimentClass}">${sentiment}</span> based on 
      ${results.totalItems} posts and comments.
    </p>
    <div class="row mt-2">
      <div class="col-md-4">
        <div class="bg-light p-2 rounded">
          <i class="bi bi-hand-thumbs-up text-success"></i> 
          <strong>${results.positive}</strong> positive
        </div>
      </div>
      <div class="col-md-4">
        <div class="bg-light p-2 rounded">
          <i class="bi bi-dash-circle text-warning"></i> 
          <strong>${results.neutral}</strong> neutral
        </div>
      </div>
      <div class="col-md-4">
        <div class="bg-light p-2 rounded">
          <i class="bi bi-hand-thumbs-down text-danger"></i> 
          <strong>${results.negative}</strong> negative
        </div>
      </div>
    </div>
  `;

      // Add engagement highlights if available
      if (results.mostLikedPost || results.mostCommentedPost) {
        html += `<div class="mt-3"><strong>Engagement Highlights:</strong></div><ul class="list-unstyled">`;

        if (results.mostLikedPost) {
          html += `
        <li class="mb-1">
          <i class="bi bi-heart-fill text-danger"></i> Most liked post: 
          "${truncateText(results.mostLikedPost.caption, 40)}"
          (${results.mostLikedPost.likes?.length || 0} likes)
        </li>
      `;
        }

        if (results.mostCommentedPost) {
          html += `
        <li class="mb-1">
          <i class="bi bi-chat-square-text-fill text-primary"></i> Most commented post: 
          "${truncateText(results.mostCommentedPost.caption, 40)}"
          (${results.mostCommentedPost.comments.length} comments)
        </li>
      `;
        }

        html += `</ul>`;
      }

      // Add recommendations if negative sentiment
      if (sentiment === 'negative') {
        html += `
      <div class="mt-3 alert alert-warning">
        <i class="bi bi-exclamation-triangle-fill"></i>
        <strong>Recommendation:</strong> Consider addressing negative feedback in community posts.
      </div>
    `;
      }

      sentimentElement.innerHTML = html;

      // Update customer insights highlight
      let highlightsText = `Community sentiment is ${sentiment}. `;
      if (results.mostLikedPost) {
        highlightsText += `Most popular post has ${results.mostLikedPost.likes?.length || 0} likes.`;
      }
      highlightsElement.textContent = highlightsText;
    }

    function truncateText(text, maxLength) {
      if (!text) return 'No caption';
      return text.length > maxLength ? `${text.substring(0, maxLength)}...` : text;
    }

    function generatePeakHoursInsight() {
      try {
        // Group bookings by hour of day
        const hours = Array(24).fill(0);
        bookingsData.forEach(booking => {
          if (booking.slot) {
            // Extract hour from slot (e.g., "6-7 AM" -> 6)
            const hourMatch = booking.slot.match(/(\d+)/);
            if (hourMatch) {
              let hour = parseInt(hourMatch[1]);
              // Convert to 24-hour format if PM
              if (booking.slot.includes('PM') && hour < 12) hour += 12;
              hours[hour]++;
            }
          }
        });

        // Find peak hours
        const maxBookings = Math.max(...hours);
        const peakHours = hours.map((count, hour) => ({ hour, count }))
          .filter(h => h.count > maxBookings * 0.7) // At least 70% of max
          .sort((a, b) => b.count - a.count);

        // Format peak hours string
        let peakHoursStr = '';
        if (peakHours.length > 0) {
          peakHoursStr = peakHours.map(h => {
            const period = h.hour < 12 ? 'AM' : 'PM';
            const displayHour = h.hour % 12 || 12;
            return `${displayHour}${period}`;
          }).join(', ');
        } else {
          peakHoursStr = 'No clear peak hours detected';
        }

        // Update UI
        document.getElementById('peakHoursInsight').innerHTML = `
          The busiest hours are <strong>${peakHoursStr}</strong> with up to ${maxBookings} bookings.
          <div class="mt-2">
            <span class="badge badge-ai">Recommendation</span>
            Consider offering discounts for off-peak hours to balance demand.
          </div>
        `;

        // Update performance trend
        document.getElementById('performanceTrend').textContent =
          `Peak hours identified at ${peakHoursStr}. Consider dynamic pricing during these periods.`;
      } catch (error) {
        console.error("Error generating peak hours insight:", error);
        document.getElementById('peakHoursInsight').textContent =
          "Could not analyze peak hours due to data issues.";
      }
    }

    function detectBookingAnomalies() {
      try {
        // Simple anomaly detection - compare current month to historical averages
        const now = new Date();
        const currentMonthStart = new Date(now.getFullYear(), now.getMonth(), 1);

        // Get current month bookings
        const currentMonthBookings = bookingsData.filter(booking =>
          booking.date >= currentMonthStart
        ).length;

        // Calculate historical average (last 6 months excluding current)
        const historicalMonths = 6;
        let historicalSum = 0;
        let monthCount = 0;

        for (let i = 1; i <= historicalMonths; i++) {
          const date = new Date();
          date.setMonth(now.getMonth() - i);

          const monthStart = new Date(date.getFullYear(), date.getMonth(), 1);
          const monthEnd = new Date(date.getFullYear(), date.getMonth() + 1, 0);

          const count = bookingsData.filter(booking =>
            booking.date >= monthStart && booking.date <= monthEnd
          ).length;

          historicalSum += count;
          monthCount++;
        }

        const historicalAvg = historicalSum / monthCount;
        const deviation = (currentMonthBookings - historicalAvg) / historicalAvg;

        // Determine anomaly level
        let anomalyLevel = 'low';
        let anomalyClass = 'anomaly-low';
        let message = 'Booking patterns are normal this month.';

        if (Math.abs(deviation) > 0.3) {
          anomalyLevel = 'high';
          anomalyClass = 'anomaly-high';
          message = `Significant ${deviation > 0 ? 'increase' : 'decrease'} in bookings detected (${Math.abs(deviation * 100).toFixed(0)}% ${deviation > 0 ? 'above' : 'below'} average).`;
        } else if (Math.abs(deviation) > 0.15) {
          anomalyLevel = 'medium';
          anomalyClass = 'anomaly-medium';
          message = `Moderate ${deviation > 0 ? 'increase' : 'decrease'} in bookings detected (${Math.abs(deviation * 100).toFixed(0)}% ${deviation > 0 ? 'above' : 'below'} average).`;
        }

        // Update UI
        document.getElementById('anomalyInsight').innerHTML = `
          <span class="${anomalyClass} anomaly-indicator"></span>
          ${message}
          ${anomalyLevel !== 'low' ? `
            <div class="mt-2">
              <span class="badge badge-ai">Action</span>
              ${deviation > 0 ? 'Investigate marketing effectiveness.' : 'Review pricing and promotions.'}
            </div>
          ` : ''}
        `;
      } catch (error) {
        console.error("Error detecting anomalies:", error);
        document.getElementById('anomalyInsight').textContent =
          "Could not analyze booking anomalies due to data issues.";
      }
    }

    function generateOptimizationSuggestions() {
      try {
        // Simple optimization suggestions based on utilization and revenue
        const currentMonthStart = new Date();
        currentMonthStart.setDate(1);

        // Calculate facility usage
        const facilityUsage = facilitiesData.map(facility => {
          const bookingsForFacility = bookingsData.filter(booking =>
            booking.facilityId === facility.id &&
            booking.status === 'confirmed' &&
            booking.date >= currentMonthStart
          );

          const totalBookedSlots = bookingsForFacility.length;

          // Assuming each facility can be booked once per day
          const totalCapacity = (facility.maxBookings || 1) * 30;
          const usagePercentage = totalCapacity > 0 ?
            (totalBookedSlots / totalCapacity) * 100 : 0;

          return {
            id: facility.id,
            name: facility.name,
            percentage: usagePercentage
          };
        });

        // Find underutilized and overutilized facilities
        const underutilized = facilityUsage.filter(f => f.percentage < 40).sort((a, b) => a.percentage - b.percentage);
        const overutilized = facilityUsage.filter(f => f.percentage > 80).sort((a, b) => b.percentage - a.percentage);

        // Calculate revenue per facility
        const revenuePerFacility = facilitiesData.map(facility => {
          const revenue = bookingsData
            .filter(booking =>
              booking.facilityId === facility.id &&
              booking.status === 'confirmed' &&
              booking.date >= currentMonthStart
            )
            .reduce((sum, booking) => sum + (booking.totalAmount || 0), 0);

          return {
            id: facility.id,
            name: facility.name,
            revenue: revenue
          };
        }).sort((a, b) => b.revenue - a.revenue);

        // Generate suggestions
        let suggestions = [];

        if (underutilized.length > 0) {
          suggestions.push(`Promote ${underutilized[0].name} (only ${underutilized[0].percentage.toFixed(0)}% utilized)`);
        }

        if (overutilized.length > 0) {
          suggestions.push(`Consider expanding ${overutilized[0].name} capacity (${overutilized[0].percentage.toFixed(0)}% utilized)`);
        }

        if (revenuePerFacility.length > 0) {
          const topPerformer = revenuePerFacility[0];
          const lowPerformer = revenuePerFacility[revenuePerFacility.length - 1];

          if (topPerformer.revenue > 0) {
            suggestions.push(`Highlight ${topPerformer.name} (top revenue generator at RM${topPerformer.revenue.toFixed(0)})`);
          }

          if (lowPerformer.revenue < topPerformer.revenue * 0.3 && lowPerformer.revenue > 0) {
            suggestions.push(`Review pricing for ${lowPerformer.name} (low revenue at RM${lowPerformer.revenue.toFixed(0)})`);
          }
        }

        // Default suggestion if no specific ones
        if (suggestions.length === 0) {
          suggestions.push("Facility utilization is well balanced. Consider adding new amenities to attract more customers.");
        }

        // Update UI
        document.getElementById('optimizationInsight').innerHTML = `
          ${suggestions.map(s => `<div class="mb-1">• ${s}</div>`).join('')}
          <div class="mt-2">
            <span class="badge badge-ai">Recommendation</span>
            Focus on ${suggestions[0].toLowerCase()}
          </div>
        `;

        // Update smart suggestions
        document.getElementById('smartSuggestions').textContent = suggestions[0];
      } catch (error) {
        console.error("Error generating optimization suggestions:", error);
        document.getElementById('optimizationInsight').textContent =
          "Could not generate optimization suggestions due to data issues.";
      }
    }

    async function runAdvancedAnalysis() {
      try {
        // Show loading state
        document.getElementById('runAdvancedAnalysisBtn').innerHTML =
          '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Analyzing...';

        // Prepare data for advanced analysis
        const analysisData = {
          bookings: bookingsData.slice(0, 100).map(b => ({
            date: b.date.toISOString().split('T')[0],
            facility: facilitiesData.find(f => f.id === b.facilityId)?.name || 'Unknown',
            status: b.status,
            revenue: b.totalAmount || 0
          })),
          facilities: facilitiesData.map(f => ({
            name: f.name,
            capacity: f.maxBookings || 0
          }))
        };

        // Simulate advanced analysis since we don't have the Firebase function
        // In a real app, you would call your Firebase function here
        const result = simulateAdvancedAnalysis(analysisData);

        // Display results
        document.getElementById('aiAnalysisContent').innerHTML = `
          <h5><i class="bi bi-graph-up"></i> Advanced Booking Analysis</h5>
          <p>${result.summary}</p>
          
          <h5 class="mt-4"><i class="bi bi-lightbulb"></i> Key Insights</h5>
          <ul>
            ${result.insights.map(i => `<li>${i}</li>`).join('')}
          </ul>
          
          <h5 class="mt-4"><i class="bi bi-check-circle"></i> Recommendations</h5>
          <div class="list-group">
            ${result.recommendations.map(r => `
              <div class="list-group-item">
                <div class="d-flex align-items-center">
                  <i class="bi bi-${r.priority === 'high' ? 'exclamation-triangle-fill text-danger' :
            r.priority === 'medium' ? 'info-circle-fill text-primary' : 'check-circle-fill text-success'} me-2"></i>
                  ${r.action}
                </div>
              </div>
            `).join('')}
          </div>
        `;

        // Update AI predictions count
        document.getElementById('aiPredictions').textContent =
          parseInt(document.getElementById('aiPredictions').textContent || '0') + 1;
        document.getElementById('aiActionable').textContent =
          parseInt(document.getElementById('aiActionable').textContent || '0') +
          result.recommendations.filter(r => r.priority === 'high').length;

      } catch (error) {
        console.error("Error running advanced analysis:", error);
        document.getElementById('aiAnalysisContent').innerHTML = `
          <div class="alert alert-danger">
            Failed to run advanced analysis. Please try again later.
          </div>
        `;
      } finally {
        document.getElementById('runAdvancedAnalysisBtn').innerHTML =
          '<i class="bi bi-robot"></i> Run Analysis';
      }
    }

    function simulateAdvancedAnalysis(data) {
      // Simulate analysis results based on the data
      const totalBookings = data.bookings.length;
      const confirmedBookings = data.bookings.filter(b => b.status === 'confirmed').length;
      const confirmationRate = Math.round((confirmedBookings / totalBookings) * 100);

      const totalRevenue = data.bookings.reduce((sum, b) => sum + b.revenue, 0);
      const avgRevenuePerBooking = totalBookings > 0 ? totalRevenue / totalBookings : 0;

      const facilities = data.facilities.map(f => {
        const facilityBookings = data.bookings.filter(b => b.facility === f.name);
        const revenue = facilityBookings.reduce((sum, b) => sum + b.revenue, 0);
        return {
          name: f.name,
          bookings: facilityBookings.length,
          revenue: revenue,
          utilization: Math.round((facilityBookings.length / (f.capacity * 30)) * 100)
        };
      });

      const topFacility = [...facilities].sort((a, b) => b.revenue - a.revenue)[0];
      const lowFacility = [...facilities].sort((a, b) => a.revenue - b.revenue)[0];

      return {
        summary: `Analyzed ${totalBookings} bookings across ${data.facilities.length} facilities with ${confirmationRate}% confirmation rate and average revenue of RM${avgRevenuePerBooking.toFixed(2)} per booking.`,
        insights: [
          `Top performing facility is ${topFacility.name} with RM${topFacility.revenue.toFixed(2)} revenue`,
          `Lowest performing facility is ${lowFacility.name} with RM${lowFacility.revenue.toFixed(2)} revenue`,
          `${confirmationRate < 80 ? 'Low' : 'High'} booking confirmation rate of ${confirmationRate}%`,
          `Average facility utilization is ${Math.round(facilities.reduce((sum, f) => sum + f.utilization, 0) / facilities.length)}%`
        ],
        recommendations: [
          {
            action: `Promote ${lowFacility.name} with special offers to increase utilization`,
            priority: 'high'
          },
          {
            action: `Implement reminder system to improve confirmation rate`,
            priority: confirmedBookings < 80 ? 'high' : 'medium'
          },
          {
            action: `Consider dynamic pricing for ${topFacility.name} during peak hours`,
            priority: 'medium'
          },
          {
            action: `Add more amenities to underutilized facilities`,
            priority: 'low'
          }
        ]
      };
    }

    function renderStatusChart() {
      try {
        const ctx = document.getElementById('bookingStatusChart');

        // Count bookings by status
        const statusCounts = {
          confirmed: bookingsData.filter(b => b.status === 'confirmed').length,
          pending: bookingsData.filter(b => b.status === 'pending').length,
          cancelled: bookingsData.filter(b => b.status === 'cancelled').length
        };

        if (statusChart) {
          statusChart.destroy();
        }

        statusChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: ['Confirmed', 'Pending', 'Cancelled'],
            datasets: [{
              data: [statusCounts.confirmed, statusCounts.pending, statusCounts.cancelled],
              backgroundColor: [
                'rgba(56, 176, 0, 0.7)',
                'rgba(255, 170, 0, 0.7)',
                'rgba(239, 35, 60, 0.7)'
              ],
              borderColor: [
                'rgba(56, 176, 0, 1)',
                'rgba(255, 170, 0, 1)',
                'rgba(239, 35, 60, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
              },
              title: {
                display: true,
                text: 'Booking Status Distribution'
              }
            }
          }
        });
      } catch (error) {
        console.error("Error rendering status chart:", error);
      }
    }

    function renderRevenueChart() {
      try {
        const ctx = document.getElementById('revenueSourcesChart');

        // Calculate revenue by source - simplified since we don't have addons/coaches data
        const revenueSources = {
          facility: bookingsData
            .filter(booking => booking.status === 'confirmed')
            .reduce((sum, booking) => sum + (booking.price || 0), 0),
          discounts: bookingsData
            .filter(booking => booking.status === 'confirmed')
            .reduce((sum, booking) => sum + (booking.discount || 0), 0)
        };

        if (revenueChart) {
          revenueChart.destroy();
        }

        revenueChart = new Chart(ctx, {
          type: 'pie',
          data: {
            labels: ['Facility Rental', 'Discounts Applied'],
            datasets: [{
              data: [revenueSources.facility, revenueSources.discounts],
              backgroundColor: [
                'rgba(67, 97, 238, 0.7)',
                'rgba(76, 201, 240, 0.7)'
              ],
              borderColor: [
                'rgba(67, 97, 238, 1)',
                'rgba(76, 201, 240, 1)'
              ],
              borderWidth: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right',
              },
              title: {
                display: true,
                text: 'Revenue Sources'
              }
            }
          }
        });
      } catch (error) {
        console.error("Error rendering revenue chart:", error);
      }
    }
  </script>
</body>

</html>
