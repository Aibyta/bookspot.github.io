<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sportova User Portal</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <style>
    :root {
      --primary-color: #4361ee;
      --secondary-color: #3f37c9;
      --success-color: #4cc9f0;
      --warning-color: #f9c74f;
      --danger-color: #f94144;
      --light-color: #f8f9fa;
      --dark-color: #212529;
      --sidebar-width: 250px;
      --header-height: 70px;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fb;
      overflow-x: hidden;
      height: 100vh;
    }

    /* Sidebar Styles */
    .sidebar {
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      width: var(--sidebar-width);
      background-color: var(--dark-color);
      color: white;
      padding: 1rem;
      z-index: 1000;
      transition: all 0.3s;
      box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
      overflow-y: auto;
      display: flex;
      flex-direction: column;
    }

    .sidebar.collapsed {
      width: 70px;
    }

    .sidebar.collapsed .sidebar-text {
      display: none;
    }

    .sidebar-header {
      display: flex;
      align-items: center;
      padding: 1rem 0;
      margin-bottom: 1rem;
      border-bottom: 1px solid #495057;
    }

    .sidebar-logo {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      margin-right: 10px;
    }

    .sidebar-title {
      font-weight: 700;
      font-size: 1.2rem;
      margin-bottom: 0;
    }

    .sidebar-menu {
      list-style: none;
      padding: 0;
      margin: 0;
      flex-grow: 1;
    }

    .sidebar-menu li {
      margin-bottom: 0.3rem;
    }

    .sidebar-menu a {
      display: flex;
      align-items: center;
      padding: 12px 15px;
      color: #bdc3c7;
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .sidebar-menu a:hover,
    .sidebar-menu a.active {
      background-color: var(--primary-color);
      color: white;
    }

    .sidebar-menu i {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 1rem;
      border-top: 1px solid #495057;
    }

    /* Main Content Styles */
    .main-content {
      margin-left: var(--sidebar-width);
      padding: 20px;
      transition: all 0.3s;
      height: 100vh;
      overflow-y: auto;
    }

    .main-content.expanded {
      margin-left: 70px;
    }

    .header {
      background-color: white;
      padding: 15px 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 {
      margin-bottom: 0;
      font-size: 1.8rem;
      font-weight: 700;
      color: var(--dark-color);
    }

    .header-actions {
      display: flex;
      align-items: center;
    }

    .user-profile {
      display: flex;
      align-items: center;
      margin-left: 20px;
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 10px;
    }

    /* Dashboard Cards */
    .stats-card {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .stats-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 15px rgba(0, 0, 0, 0.1);
    }

    .stats-card .number {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary-color);
      margin-bottom: 5px;
    }

    .stats-card .label {
      font-size: 0.9rem;
      color: #6c757d;
    }

    .stats-card i {
      font-size: 2.5rem;
      color: var(--primary-color);
      margin-bottom: 15px;
    }

    /* Table Styles */
    .table-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 20px;
      margin-bottom: 20px;
    }

    .table th {
      font-weight: 600;
      border-top: none;
      color: #495057;
      background-color: #f8f9fa;
    }

    /* Form Styles */
    .form-card {
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      padding: 25px;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 1.5rem;
    }

    .form-label {
      font-weight: 600;
      margin-bottom: 0.5rem;
    }

    .form-control:focus,
    .form-select:focus {
      border-color: var(--primary-color);
      box-shadow: 0 0 0 0.25rem rgba(67, 97, 238, 0.25);
    }

    /* Toast Styles */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1055;
    }

    /* Toggle Button */
    .sidebar-toggle {
      background: none;
      border: none;
      color: white;
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 10px;
    }

    /* Calendar Styles */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 5px;
      margin-top: 20px;
    }

    .calendar-header {
      background-color: var(--primary-color);
      color: white;
      padding: 10px;
      text-align: center;
      font-weight: 600;
    }

    .calendar-day {
      background-color: white;
      border: 1px solid #eaeaea;
      padding: 10px;
      min-height: 120px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .calendar-day:hover {
      background-color: #f8f9fa;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .calendar-day.today {
      background-color: #e3f2fd;
      border-color: var(--primary-color);
      border-width: 2px;
    }

    .calendar-day.has-booking {
      background-color: #f0f8ff;
      border-color: #b3d9ff;
    }

    .calendar-day.empty {
      background-color: #f8f9fa;
      border-color: #e9ecef;
      cursor: default;
    }

    .calendar-day.empty:hover {
      background-color: #f8f9fa;
      transform: none;
      box-shadow: none;
    }

    .calendar-event {
      font-size: 0.7rem;
      padding: 6px 8px;
      margin: 3px 0;
      border-radius: 6px;
      display: block;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 1px solid rgba(255, 255, 255, 0.3);
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .calendar-event:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    /* Badge styling */
    .badge-status {
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
      color: white !important;
      border: none;
    }

    .badge-approved {
      background-color: #198754 !important;
      color: white !important;
    }

    .badge-pending {
      background-color: #ffc107 !important;
      color: #212529 !important;
    }

    .badge-rejected,
    .badge-cancelled {
      background-color: #dc3545 !important;
      color: white !important;
    }

    .badge-completed {
      background-color: #0d6efd !important;
      color: white !important;
    }

    .badge-confirmed {
      background-color: #20c997 !important;
      color: white !important;
    }

    /* Promo Badge */
    .promo-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #ff6b6b;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    /* Responsive */
    @media (max-width: 768px) {
      .sidebar {
        width: 70px;
      }

      .sidebar .sidebar-text {
        display: none;
      }

      .main-content {
        margin-left: 70px;
      }

      .sidebar.collapsed {
        width: 0;
        overflow: hidden;
      }

      .main-content.expanded {
        margin-left: 0;
      }
    }

    /* Facility Cards */
    .facility-card {
      transition: transform 0.2s;
      border-radius: 10px;
      overflow: hidden;
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      height: 100%;
      position: relative;
    }

    .facility-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .facility-image {
      height: 200px;
      object-fit: cover;
    }

    /* Event Cards */
    .event-card {
      transition: all 0.3s;
      cursor: pointer;
    }

    .event-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    .event-image {
      height: 150px;
      object-fit: cover;
    }

    /* Friend Cards */
    .friend-card {
      border: none;
      border-radius: 10px;
      padding: 1.5rem;
      margin-bottom: 1.5rem;
      background: #fff;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: all 0.3s ease;
    }

    .friend-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    .friend-avatar {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .skill-level {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
    }

    .beginner {
      background-color: #d4edda;
      color: #155724;
    }

    .intermediate {
      background-color: #cce5ff;
      color: #004085;
    }

    .advanced {
      background-color: #fff3cd;
      color: #856404;
    }

    /* Product Cards */
    .product-card {
      background: white;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      transition: all 0.3s;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    /* Post Cards */
    .post-card {
      background: white;
      color: #222;
      border-radius: 1rem;
      padding: 1.5rem;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      margin-bottom: 2rem;
      animation: fadeSlide .5s ease;
    }

    .media {
      width: 100%;
      max-height: 400px;
      object-fit: cover;
      border-radius: .75rem;
    }

    @keyframes fadeSlide {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    /* Booking Steps */
    .booking-step {
      display: none;
    }

    .booking-step.active {
      display: block;
    }

    .step-indicator {
      display: flex;
      justify-content: space-between;
      margin-bottom: 2rem;
      position: relative;
    }

    .step-indicator::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 0;
      right: 0;
      height: 2px;
      background-color: #e9ecef;
      z-index: 1;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      position: relative;
      z-index: 2;
    }

    .step-number {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #e9ecef;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-bottom: 0.5rem;
      transition: all 0.3s;
    }

    .step.active .step-number {
      background-color: var(--primary-color);
      color: white;
    }

    .step.completed .step-number {
      background-color: #198754;
      color: white;
    }

    .step-label {
      font-size: 0.85rem;
      font-weight: 500;
    }

    /* Time Slot Styling */
    .time-slot {
      padding: 10px 15px;
      border: 1px solid #dee2e6;
      border-radius: 8px;
      margin: 5px;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
      flex: 1 0 30%;
      max-width: 30%;
    }

    .time-slot.available {
      background-color: #d1edff;
      border-color: #0d6efd;
    }

    .time-slot.available:hover {
      background-color: #b8daff;
    }

    .time-slot.unavailable {
      background-color: #f8d7da;
      border-color: #dc3545;
      color: #721c24;
      cursor: not-allowed;
    }

    .time-slot.selected {
      background-color: #0d6efd;
      color: white;
      border-color: #0a58ca;
    }

    /* Coach Card */
    .coach-card {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .coach-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .coach-card.selected {
      border-color: #0d6efd;
      background-color: #f0f8ff;
    }

    /* Snack Card */
    .snack-card {
      border: 1px solid #dee2e6;
      border-radius: 8px;
      padding: 15px;
      margin-bottom: 15px;
      transition: all 0.3s;
    }

    .snack-card:hover {
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    /* Summary Card */
    .summary-card {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .summary-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }

    .summary-total {
      font-weight: bold;
      font-size: 1.2rem;
      border-top: 1px solid #dee2e6;
      padding-top: 10px;
      margin-top: 10px;
    }

    /* Monthly Calendar */
    .month-calendar {
      background: white;
      border-radius: 10px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
    }

    .calendar-header-month {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 1px;
      background-color: #e9ecef;
      border: 1px solid #e9ecef;
    }

    .calendar-day-month {
      background: white;
      padding: 10px;
      min-height: 100px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .calendar-day-month:hover {
      background-color: #f8f9fa;
    }

    .calendar-day-month.today {
      background-color: #e3f2fd;
    }

    .calendar-day-month.selected {
      background-color: #0d6efd;
      color: white;
    }

    .calendar-day-month.disabled {
      background-color: #f8f9fa;
      color: #6c757d;
      cursor: not-allowed;
    }

    .day-number {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .calendar-events {
      font-size: 0.7rem;
    }

    .calendar-event-small {
      background-color: #4cc9f0;
      color: white;
      padding: 2px 5px;
      border-radius: 3px;
      margin-bottom: 2px;
      font-size: 0.6rem;
    }

    /* Chat Styles */
    .chat-container {
      background-color: #f8f9fa;
      border-radius: 10px;
      padding: 15px;
    }

    .message-text {
      word-wrap: break-word;
    }

    .message-time {
      font-size: 0.75rem;
    }

    .friend-card {
      border: none;
      border-radius: 10px;
      padding: 1rem;
      margin-bottom: 1rem;
      background: #fff;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      transition: all 0.3s ease;
    }

    .friend-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
    }

    /* Enhanced Chat Styles */
    .chat-modal-content {
      height: 80vh;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 1rem 1.5rem;
      border-bottom: 1px solid #e9ecef;
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: white;
      border-radius: 10px 10px 0 0;
    }

    .chat-user-avatar {
      width: 45px;
      height: 45px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
    }

    .chat-user-info h6 {
      font-weight: 600;
    }

    .chat-actions {
      display: flex;
      align-items: center;
    }

    .chat-body {
      flex: 1;
      overflow: hidden;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      position: relative;
    }

    .chat-body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" opacity="0.03"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
      pointer-events: none;
    }

    .chat-messages {
      height: 100%;
      overflow-y: auto;
      padding: 1.5rem;
      display: flex;
      flex-direction: column;
    }

    .chat-footer {
      padding: 1rem 1.5rem;
      border-top: 1px solid #e9ecef;
      background: white;
      border-radius: 0 0 10px 10px;
    }

    .chat-input-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .message-input-wrapper {
      flex: 1;
      position: relative;
    }

    .message-input {
      border-radius: 25px;
      padding: 12px 50px 12px 20px;
      border: 1px solid #e0e0e0;
      font-size: 0.9rem;
    }

    .emoji-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      color: #6c757d;
    }

    .chat-action-btn,
    .send-btn {
      border-radius: 50%;
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #e0e0e0;
    }

    .send-btn {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: white;
    }

    .send-btn:hover {
      background: var(--secondary-color);
      border-color: var(--secondary-color);
    }

    /* Message Bubbles */
    .message-container {
      margin-bottom: 1rem;
      display: flex;
      animation: messageSlideIn 0.3s ease-out;
    }

    @keyframes messageSlideIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .message-container.sent {
      justify-content: flex-end;
    }

    .message-container.received {
      justify-content: flex-start;
    }

    .message-bubble {
      max-width: 70%;
      padding: 12px 16px;
      border-radius: 18px;
      position: relative;
      word-wrap: break-word;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .message-bubble.sent {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border-bottom-right-radius: 4px;
    }

    .message-bubble.received {
      background: white;
      color: #333;
      border-bottom-left-radius: 4px;
    }

    .message-text {
      margin-bottom: 4px;
      line-height: 1.4;
    }

    .message-time {
      font-size: 0.75rem;
      opacity: 0.8;
      text-align: right;
    }

    .message-bubble.received .message-time {
      text-align: left;
      color: #666;
    }

    .message-status {
      font-size: 0.7rem;
      margin-left: 5px;
    }

    /* Typing Indicator */
    .typing-indicator {
      padding: 8px 0;
      display: flex;
      align-items: center;
    }

    .typing-dots {
      display: inline-flex;
      margin-left: 8px;
    }

    .typing-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background-color: #6c757d;
      margin: 0 2px;
      animation: typingAnimation 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) {
      animation-delay: -0.32s;
    }

    .typing-dot:nth-child(2) {
      animation-delay: -0.16s;
    }

    @keyframes typingAnimation {

      0%,
      80%,
      100% {
        transform: scale(0.8);
        opacity: 0.5;
      }

      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Chat Date Separator */
    .chat-date-separator {
      text-align: center;
      margin: 1rem 0;
      position: relative;
    }

    .chat-date-separator::before {
      content: '';
      position: absolute;
      top: 50%;
      left: 0;
      right: 0;
      height: 1px;
      background: rgba(255, 255, 255, 0.2);
    }

    .chat-date-separator span {
      background: rgba(255, 255, 255, 0.1);
      padding: 4px 12px;
      border-radius: 12px;
      color: white;
      font-size: 0.8rem;
      position: relative;
      backdrop-filter: blur(10px);
    }

    /* Scrollbar Styling */
    .chat-messages::-webkit-scrollbar {
      width: 6px;
    }

    .chat-messages::-webkit-scrollbar-track {
      background: transparent;
    }

    .chat-messages::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 3px;
    }

    .chat-messages::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    /* Message Reactions */
    .message-reactions {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .reaction {
      background: rgba(255, 255, 255, 0.2);
      padding: 2px 6px;
      border-radius: 12px;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
    }

    .reaction:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.1);
    }

    /* Online Status Indicator */
    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #28a745;
      position: absolute;
      bottom: 2px;
      right: 2px;
      border: 2px solid white;
    }

    .status-offline {
      background: #6c757d;
    }

    /* Marketplace Styles */
    .sold-badge {
      position: absolute;
      top: 10px;
      right: 10px;
      background-color: #dc3545;
      color: white;
      padding: 5px 10px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: bold;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    }

    .product-card {
      position: relative;
      transition: transform 0.2s;
      border-radius: 10px;
      overflow: hidden;
      border: none;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
      height: 100%;
    }

    .product-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
    }

    /* Community Post Styles */
    .post-actions {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }

    .post-action-btn {
      background: none;
      border: none;
      color: #6c757d;
      cursor: pointer;
      transition: color 0.2s;
    }

    .post-action-btn:hover {
      color: var(--primary-color);
    }

    .post-action-btn.active {
      color: var(--primary-color);
    }

    .comments-section {
      margin-top: 15px;
      border-top: 1px solid #e9ecef;
      padding-top: 15px;
    }

    .comment {
      padding: 10px 0;
      border-bottom: 1px solid #f8f9fa;
    }

    .comment:last-child {
      border-bottom: none;
    }

    .comment-user {
      font-weight: 600;
      margin-right: 5px;
    }

    .comment-actions {
      display: flex;
      gap: 10px;
      margin-top: 5px;
    }

    .comment-action-btn {
      background: none;
      border: none;
      color: #6c757d;
      font-size: 0.8rem;
      cursor: pointer;
    }

    .comment-action-btn:hover {
      color: var(--primary-color);
    }

    .emoji-picker {
      position: absolute;
      bottom: 50px;
      right: 10px;
      background: white;
      border-radius: 10px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      padding: 10px;
      z-index: 1000;
      display: none;
    }

    .emoji-picker.show {
      display: block;
    }

    .emoji-option {
      display: inline-block;
      padding: 5px;
      cursor: pointer;
      font-size: 1.2rem;
    }

    .emoji-option:hover {
      background-color: #f8f9fa;
      border-radius: 5px;
    }

    .contact-details {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 10px;
      margin-top: 10px;
      font-size: 0.9rem;
    }

    .contact-label {
      font-weight: 600;
      color: #495057;
    }

    /* WhatsApp Button Styles */
    .whatsapp-btn {
      background-color: #25D366 !important;
      border-color: #25D366 !important;
      color: white !important;
      transition: all 0.3s ease;
    }

    .whatsapp-btn:hover {
      background-color: #128C7E !important;
      border-color: #128C7E !important;
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(37, 211, 102, 0.3);
    }

    /* Contact Details Enhancement */
    .contact-details {
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 12px;
      margin-top: 10px;
      font-size: 0.9rem;
      border-left: 4px solid #25D366;
    }

    .contact-label {
      font-weight: 600;
      color: #495057;
      margin-bottom: 5px;
    }

    .contact-actions {
      margin-top: 10px;
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
  </style>
</head>

<body>
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header">
      <button class="sidebar-toggle" id="sidebarToggle">
        <i class="fas fa-bars"></i>
      </button>
      <img src="img/logo.jpg" alt="Sportova Logo" class="sidebar-logo">
      <h5 class="sidebar-title sidebar-text">Sportova User</h5>
    </div>

    <ul class="sidebar-menu">
      <li><a href="#" class="active" data-page="dashboard"><i class="fas fa-tachometer-alt"></i> <span
            class="sidebar-text">Dashboard</span></a></li>
      <li><a href="#" data-page="book-facility"><i class="fas fa-calendar-plus"></i> <span class="sidebar-text">Book a
            Court</span></a></li>
      <li><a href="#" data-page="find-friends"><i class="fas fa-users"></i> <span class="sidebar-text">Find
            Friends</span></a></li>
      <li><a href="#" data-page="my-bookings"><i class="fas fa-calendar-check"></i> <span class="sidebar-text">My
            Bookings</span></a></li>
      <li><a href="#" data-page="marketplace"><i class="fas fa-store"></i> <span
            class="sidebar-text">Marketplace</span></a></li>
      <li><a href="#" data-page="community"><i class="fas fa-comments"></i> <span
            class="sidebar-text">Community</span></a></li>
      <li><a href="#" data-page="profile"><i class="fas fa-user"></i> <span class="sidebar-text">My Profile</span></a>
      </li>
    </ul>

    <div class="sidebar-footer">
      <div class="user-profile mb-3">
        <img src="https://via.placeholder.com/40" alt="User" class="user-avatar" id="userAvatar">
        <div class="sidebar-text">
          <div class="fw-bold" id="userName">User</div>
          <small id="userEmail">user@sportova.com</small>
        </div>
      </div>
      <button class="btn btn-danger btn-sm w-100 mb-2" id="logoutBtn">
        <i class="fas fa-sign-out-alt"></i> <span class="sidebar-text">Logout</span>
      </button>
      <a href="index.html" class="btn btn-outline-light btn-sm w-100">
        <i class="fas fa-home"></i> <span class="sidebar-text">Back to Homepage</span>
      </a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content" id="mainContent">
    <div class="header">
      <h1 id="pageTitle">Dashboard</h1>
      <div class="header-actions">
        <div class="dropdown ms-3">
          <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
            <i class="fas fa-bell"></i>
            <span class="badge bg-danger">3</span>
          </button>
          <!-- Update the dropdown menu in the header section -->
          <ul class="dropdown-menu dropdown-menu-end">
            <li>
              <h6 class="dropdown-header">Notifications</h6>
            </li>
            <li><a class="dropdown-item" href="#" id="markAllReadBtn">Mark all as read</a></li>
            <li>
              <hr class="dropdown-divider">
            </li>
            <!-- Notifications will be loaded here dynamically -->
            <li>
              <hr class="dropdown-divider">
            </li>
            <li><a class="dropdown-item" href="#" id="viewAllNotifications">View all notifications</a></li>
          </ul>
        </div>
      </div>
    </div>

    <!-- Page Content will be loaded here -->
    <div id="pageContent">
      <!-- Dashboard content will be loaded here by default -->
      <div class="row">
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-calendar-check"></i>
            <div class="number" id="totalBookings">0</div>
            <div class="label">My Bookings</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-users"></i>
            <div class="number" id="totalFriends">0</div>
            <div class="label">Friends</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-trophy"></i>
            <div class="number" id="loyaltyPoints">0</div>
            <div class="label">Loyalty Points</div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="stats-card">
            <i class="fas fa-calendar-day"></i>
            <div class="number" id="upcomingEvents">0</div>
            <div class="label">Upcoming Events</div>
          </div>
        </div>
      </div>

      <div class="row mt-4">
        <div class="col-md-8">
          <div class="table-card">
            <h4>Recent Bookings</h4>
            <div class="table-responsive">
              <table class="table table-hover">
                <thead>
                  <tr>
                    <th>Facility</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="recentBookings">
                  <!-- Bookings will be loaded dynamically -->
                </tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="table-card">
            <h4>Upcoming Events</h4>
            <div class="list-group" id="upcomingEventsList">
              <!-- Events will be loaded dynamically -->
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Container -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- Enhanced Chat Modal -->
  <div class="modal fade" id="chatModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
      <div class="modal-content chat-modal-content">
        <div class="chat-header">
          <div class="d-flex align-items-center">
            <img src="" alt="" class="chat-user-avatar" id="chatUserAvatar">
            <div class="chat-user-info">
              <h6 class="mb-0" id="chatUserName">User</h6>
              <small class="text-muted" id="chatUserStatus">Online</small>
            </div>
          </div>
          <div class="chat-actions">
            <button class="btn btn-sm btn-outline-secondary me-2" id="callBtn">
              <i class="fas fa-phone"></i>
            </button>
            <button class="btn btn-sm btn-outline-secondary me-2" id="videoCallBtn">
              <i class="fas fa-video"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger" data-bs-dismiss="modal">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>

        <div class="chat-body">
          <div class="chat-messages" id="chatMessages">
            <!-- Messages will be loaded here -->
          </div>
        </div>

        <div class="chat-footer">
          <div class="chat-input-container">
            <button class="btn btn-sm btn-outline-secondary chat-action-btn" id="attachBtn">
              <i class="fas fa-paperclip"></i>
            </button>
            <div class="message-input-wrapper">
              <input type="text" class="form-control message-input" id="messageInput" placeholder="Type a message...">
              <button class="btn btn-sm btn-outline-secondary emoji-btn" id="emojiBtn">
                <i class="fas fa-smile"></i>
              </button>
              <div class="emoji-picker" id="emojiPicker">
                <div class="emoji-option" data-emoji="üòÄ">üòÄ</div>
                <div class="emoji-option" data-emoji="üòÇ">üòÇ</div>
                <div class="emoji-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
                <div class="emoji-option" data-emoji="üëç">üëç</div>
                <div class="emoji-option" data-emoji="üëè">üëè</div>
                <div class="emoji-option" data-emoji="üéâ">üéâ</div>
                <div class="emoji-option" data-emoji="üî•">üî•</div>
                <div class="emoji-option" data-emoji="‚≠ê">‚≠ê</div>
              </div>
            </div>
            <button class="btn btn-primary send-btn" id="sendMessageBtn">
              <i class="fas fa-paper-plane"></i>
            </button>
          </div>
          <div class="typing-indicator" id="typingIndicator" style="display: none;">
            <small class="text-muted">
              <i class="fas fa-pencil-alt me-1"></i>
              <span id="typingUserName">User</span> is typing...
            </small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDjMwv9Bxff1bUE7CR_S-DPx3NV5kkinTU",
      authDomain: "nste-booking-system.firebaseapp.com",
      projectId: "nste-booking-system",
      storageBucket: "nste-booking-system.appspot.com",
      messagingSenderId: "574207536433",
      appId: "1:574207536433:web:0d2aeaacdc280cec019410"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    // DOM elements
    const sidebar = document.getElementById('sidebar');
    const mainContent = document.getElementById('mainContent');
    const sidebarToggle = document.getElementById('sidebarToggle');
    const pageTitle = document.getElementById('pageTitle');
    const pageContent = document.getElementById('pageContent');
    const logoutBtn = document.getElementById('logoutBtn');
    const userName = document.getElementById('userName');
    const userEmail = document.getElementById('userEmail');
    const userAvatar = document.getElementById('userAvatar');

    // Global variables
    let userDataLoaded = false;
    let currentPage = localStorage.getItem('currentPage') || 'dashboard';
    let currentUser = null;

    // Booking process variables
    let selectedFacility = null;
    let selectedDate = null;
    let selectedTimeSlot = null;
    let selectedCoach = null;
    let selectedSnacks = [];
    let availableCoaches = [];
    let availableSnacks = [];
    let userLoyaltyPoints = 0;
    let currentMonth = new Date().getMonth();
    let currentYear = new Date().getFullYear();

    // Authentication state observer
    auth.onAuthStateChanged((user) => {
      if (user) {
        currentUser = user;
        userName.textContent = user.displayName || 'User';
        userEmail.textContent = user.email;

        // Load user data from Firestore
        loadUserData(user.uid).then(() => {
          userDataLoaded = true;
          // Initialize the current page
          loadPageContent(currentPage);
        });

        // Set up beforeunload event for logout confirmation
        window.addEventListener('beforeunload', handleBeforeUnload);
        // Initialize notification system
        loadNotifications();
        setupNotificationListener();

        // Add event listener for mark all as read
        document.getElementById('markAllReadBtn')?.addEventListener('click', async (e) => {
          e.preventDefault();
          await markAllNotificationsAsRead(currentUser.uid);
          await loadNotifications();
        });

      } else {
        // Redirect to login page if not authenticated
        window.location.href = 'login.html';
      }
    });

    // Load user data from Firestore
    async function loadUserData(userId) {
      try {
        const userDoc = await db.collection('users').doc(userId).get();
        if (userDoc.exists) {
          const userData = userDoc.data();

          // Store user data for later use
          window.userProfileData = userData;
          userLoyaltyPoints = userData.loyaltyPoints || 0;

          // Update avatar with photoUrl from users collection
          if (userData.photoURL) {
            userAvatar.src = userData.photoURL;
          } else {
            // Use a default avatar based on user's name
            userAvatar.src = generateDefaultAvatar(userData.name || user.email);
          }

          // Always update dashboard stats when loading user data
          await updateDashboardStats(userId);
        } else {
          // Create user document if it doesn't exist
          await initializeUserDocument(userId);
        }
      } catch (error) {
        console.error('Error loading user data:', error);
        showToast('Error loading user data', 'danger');
      }
    }

    // Initialize user document if it doesn't exist
    async function initializeUserDocument(userId) {
      try {
        const userData = {
          name: currentUser.displayName || 'User',
          email: currentUser.email,
          photoUrl: currentUser.photoURL || '',
          phone: '',
          location: '',
          primarySport: 'tennis',
          skillLevel: 'intermediate',
          bio: '',
          loyaltyPoints: 0,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('users').doc(userId).set(userData);
        window.userProfileData = userData;

        // Update avatar
        if (currentUser.photoURL) {
          userAvatar.src = currentUser.photoURL;
        } else {
          userAvatar.src = generateDefaultAvatar(currentUser.displayName || currentUser.email);
        }

      } catch (error) {
        console.error('Error initializing user document:', error);
      }
    }

    // Generate default avatar based on name (make sure this function exists)
    function generateDefaultAvatar(name) {
      const colors = ['#4361ee', '#3f37c9', '#4cc9f0', '#f9c74f', '#f94144'];
      const color = colors[name.length % colors.length];
      const initials = name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);

      return `https://via.placeholder.com/60/${color.replace('#', '')}/ffffff?text=${initials}`;
    }

    // Handle page refresh/close
    function handleBeforeUnload(e) {
      // You can add confirmation here if needed
      sessionStorage.clear();
      localStorage.removeItem('firebase:authUser:AIzaSyDjMwv9Bxff1bUE7CR_S-DPx3NV5kkinTU:[DEFAULT]');
    }

    // Calculate user bookings from bookings collection
    async function calculateUserBookings(userId) {
      try {
        const bookingsSnapshot = await db.collection('bookings')
          .where('userId', '==', userId)
          .get();

        return bookingsSnapshot.size;
      } catch (error) {
        console.error('Error calculating bookings:', error);
        return 0;
      }
    }

    // Calculate user friends (all other users in the system)
    async function calculateUserFriends(userId) {
      try {
        const usersSnapshot = await db.collection('users').get();
        return Math.max(0, usersSnapshot.size - 1); // Exclude current user
      } catch (error) {
        console.error('Error calculating friends:', error);
        return 0;
      }
    }

    // Calculate upcoming events
    async function calculateUpcomingEvents() {
      try {
        const today = new Date();
        const eventsSnapshot = await db.collection('events').get();
        let upcomingCount = 0;

        eventsSnapshot.forEach(doc => {
          const event = doc.data();
          if (event.date && event.date.toDate() >= today) {
            upcomingCount++;
          }
        });

        return upcomingCount;
      } catch (error) {
        console.error('Error calculating upcoming events:', error);
        return 0;
      }
    }

    // Load recent bookings from Firestore
    async function loadRecentBookings(userId) {
      try {
        const bookingsSnapshot = await db.collection('bookings')
          .where('userId', '==', userId)
          .orderBy('createdAt', 'desc')
          .limit(5)
          .get();

        const bookingsTable = document.getElementById('recentBookings');
        if (!bookingsTable) {
          console.log('Recent bookings table not found in DOM');
          return;
        }

        bookingsTable.innerHTML = '';

        if (bookingsSnapshot.empty) {
          bookingsTable.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No bookings yet. Book your first court!</td></tr>';
          return;
        }

        const bookingsData = [];

        bookingsSnapshot.forEach(doc => {
          const booking = doc.data();
          bookingsData.push({ id: doc.id, ...booking });
        });

        // Sort by date if available
        bookingsData.sort((a, b) => {
          const dateA = a.date ? a.date.toDate() : new Date(0);
          const dateB = b.date ? b.date.toDate() : new Date(0);
          return dateB - dateA;
        });

        // Render bookings
        bookingsData.forEach(booking => {
          const row = document.createElement('tr');

          // Format date
          let formattedDate = 'Date not set';
          if (booking.date) {
            const bookingDate = booking.date.toDate();
            formattedDate = bookingDate.toLocaleDateString();
          } else if (booking.createdAt) {
            const createdDate = booking.createdAt.toDate();
            formattedDate = createdDate.toLocaleDateString();
          }

          // Create status badge
          let statusClass = 'badge-pending';
          let statusText = 'pending';

          if (booking.status === 'confirmed' || booking.status === 'Confirmed') {
            statusClass = 'badge-confirmed';
            statusText = 'confirmed';
          } else if (booking.status === 'completed' || booking.status === 'Completed') {
            statusClass = 'badge-completed';
            statusText = 'completed';
          } else if (booking.status === 'cancelled' || booking.status === 'Cancelled') {
            statusClass = 'badge-cancelled';
            statusText = 'cancelled';
          } else if (booking.status === 'Active') {
            statusClass = 'badge-confirmed';
            statusText = 'active';
          }

          row.innerHTML = `
            <td>${booking.facilityName || booking.name || 'Facility'}</td>
            <td>${formattedDate}</td>
            <td>${booking.time || (booking.slots && booking.slots.length > 0 ? booking.slots[0] : 'Time not set')}</td>
            <td><span class="badge badge-status ${statusClass}">${statusText}</span></td>
          `;

          bookingsTable.appendChild(row);
        });
      } catch (error) {
        console.error('Error loading bookings:', error);
        const bookingsTable = document.getElementById('recentBookings');
        if (bookingsTable) {
          bookingsTable.innerHTML = '<tr><td colspan="4" class="text-center text-danger">Error loading bookings</td></tr>';
        }
      }
    }

    // Load upcoming events from Firestore
    async function loadUpcomingEvents() {
      try {
        const today = new Date();
        const eventsSnapshot = await db.collection('events')
          .where('date', '>=', today)
          .orderBy('date')
          .limit(3)
          .get();

        const eventsList = document.getElementById('upcomingEventsList');
        if (!eventsList) return; // Exit if element doesn't exist

        eventsList.innerHTML = '';

        if (eventsSnapshot.empty) {
          eventsList.innerHTML = '<div class="text-center p-3">No upcoming events</div>';
          return;
        }

        eventsSnapshot.forEach(doc => {
          const event = doc.data();
          const eventDate = event.date.toDate();
          const daysUntil = Math.ceil((eventDate - today) / (1000 * 60 * 60 * 24));

          const eventItem = document.createElement('a');
          eventItem.href = '#';
          eventItem.className = 'list-group-item list-group-item-action';

          eventItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1">${event.name}</h5>
              <small>${daysUntil} ${daysUntil === 1 ? 'day' : 'days'}</small>
            </div>
            <p class="mb-1">${event.description}</p>
            <small>${eventDate.toLocaleDateString()} ‚Ä¢ ${event.time}</small>
          `;

          eventsList.appendChild(eventItem);
        });
      } catch (error) {
        console.error('Error loading events:', error);
        // Don't show toast here as it might be called when not on dashboard
      }
    }

    // Sidebar toggle functionality
    sidebarToggle.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
      mainContent.classList.toggle('expanded');

      // Change icon based on state
      if (sidebar.classList.contains('collapsed')) {
        sidebarToggle.innerHTML = '<i class="fas fa-bars"></i>';
      } else {
        sidebarToggle.innerHTML = '<i class="fas fa-times"></i>';
      }
    });

    // Page navigation
    document.querySelectorAll('.sidebar-menu a').forEach(link => {
      link.addEventListener('click', function (e) {
        e.preventDefault();

        // Update active menu item
        document.querySelectorAll('.sidebar-menu a').forEach(a => {
          a.classList.remove('active');
        });
        this.classList.add('active');

        // Get page name from data attribute
        const page = this.getAttribute('data-page');
        currentPage = page;

        // Store current page in localStorage
        localStorage.setItem('currentPage', page);

        // Update page title and content
        updatePageTitle(page);

        // Load page content
        loadPageContent(page);

        // If dashboard, reload the data specifically
        if (page === 'dashboard') {
          if (currentUser) {
            updateDashboardStats(currentUser.uid);
          }
        }
      });
    });

    // Load the correct page on initial load
    document.addEventListener('DOMContentLoaded', function () {
      const savedPage = localStorage.getItem('currentPage') || 'dashboard';
      updatePageTitle(savedPage);
    });

    // Logout function
    logoutBtn.addEventListener('click', () => {
      if (confirm('Are you sure you want to logout?')) {
        auth.signOut().then(() => {
          showToast('Logged out successfully', 'success');
          setTimeout(() => {
            window.location.href = 'login.html';
          }, 1000);
        }).catch((error) => {
          console.error('Logout error:', error);
          showToast('Error logging out', 'danger');
        });
      }
    });

    // Toast notification function
    function showToast(message, type = 'info') {
      const toast = document.createElement('div');
      toast.className = `toast align-items-center text-white bg-${type} border-0`;
      toast.setAttribute('role', 'alert');
      toast.setAttribute('aria-live', 'assertive');
      toast.setAttribute('aria-atomic', 'true');

      toast.innerHTML = `
        <div class="d-flex">
          <div class="toast-body">
            <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'warning' ? 'exclamation-triangle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
            ${message}
          </div>
          <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
        </div>
      `;

      document.getElementById('toastContainer').appendChild(toast);

      const bsToast = new bootstrap.Toast(toast);
      bsToast.show();

      toast.addEventListener('hidden.bs.toast', () => {
        toast.remove();
      });
    }

    // Update dashboard stats
    async function updateDashboardStats(userId) {
      try {
        // Calculate values from collections
        const bookingsCount = await calculateUserBookings(userId);
        const friendsCount = await calculateUserFriends(userId);
        const upcomingEventsCount = await calculateUpcomingEvents();
        const userData = window.userProfileData || {};

        // Update dashboard elements if they exist
        const totalBookingsEl = document.getElementById('totalBookings');
        const totalFriendsEl = document.getElementById('totalFriends');
        const loyaltyPointsEl = document.getElementById('loyaltyPoints');
        const upcomingEventsEl = document.getElementById('upcomingEvents');

        if (totalBookingsEl) totalBookingsEl.textContent = bookingsCount;
        if (totalFriendsEl) totalFriendsEl.textContent = friendsCount;
        if (loyaltyPointsEl) loyaltyPointsEl.textContent = userData.loyaltyPoints || 0;
        if (upcomingEventsEl) upcomingEventsEl.textContent = upcomingEventsCount;

        // Load recent bookings
        await loadRecentBookings(userId);

        // Load upcoming events
        await loadUpcomingEvents();
      } catch (error) {
        console.error('Error updating dashboard stats:', error);
        showToast('Error loading dashboard data', 'danger');
      }
    }

    // Load page content based on selection
    function loadPageContent(page) {
      let content = '';

      switch (page) {
        case 'dashboard':
          content = loadDashboardPage();
          break;
        case 'book-facility':
          content = loadBookFacilityPage();
          break;
        case 'find-friends':
          content = loadFindFriendsPage();
          break;
        case 'my-bookings':
          content = loadMyBookingsPage();
          break;
        case 'marketplace':
          content = loadMarketplacePage();
          break;
        case 'community':
          content = loadCommunityPage();
          break;
        case 'profile':
          content = loadProfilePage();
          break;
        default:
          content = '<div class="alert alert-info">Page under development</div>';
      }

      pageContent.innerHTML = content;

      // Update page title immediately
      updatePageTitle(page);

      // Initialize any page-specific functionality
      initializePageFunctionality(page);
    }

    // Add this function to update page title
    function updatePageTitle(page) {
      const pageTitles = {
        'dashboard': 'Dashboard',
        'book-facility': 'Book a Court',
        'find-friends': 'Find Friends',
        'my-bookings': 'My Bookings',
        'marketplace': 'Marketplace',
        'community': 'Community',
        'profile': 'My Profile'
      };

      pageTitle.textContent = pageTitles[page] || 'Dashboard';

      // Also update the active menu item
      document.querySelectorAll('.sidebar-menu a').forEach(a => {
        a.classList.remove('active');
        if (a.getAttribute('data-page') === page) {
          a.classList.add('active');
        }
      });
    }

    // Load dashboard data specifically for dashboard page
    async function loadDashboardData() {
      if (!currentUser) return;

      try {
        await updateDashboardStats(currentUser.uid);
      } catch (error) {
        console.error('Error loading dashboard data:', error);
        showToast('Error loading dashboard data', 'danger');
      }
    }

    // Page content loaders
    function loadDashboardPage() {
      return `
        <div class="row">
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-calendar-check"></i>
              <div class="number" id="totalBookings">0</div>
              <div class="label">My Bookings</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-users"></i>
              <div class="number" id="totalFriends">0</div>
              <div class="label">Friends</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-trophy"></i>
              <div class="number" id="loyaltyPoints">0</div>
              <div class="label">Loyalty Points</div>
            </div>
          </div>
          <div class="col-md-3">
            <div class="stats-card">
              <i class="fas fa-calendar-day"></i>
              <div class="number" id="upcomingEvents">0</div>
              <div class="label">Upcoming Events</div>
            </div>
          </div>
        </div>

        <div class="row mt-4">
          <div class="col-md-8">
            <div class="table-card">
              <h4>Recent Bookings</h4>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Facility</th>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Status</th>
                    </tr>
                  </thead>
                  <tbody id="recentBookings">
                    <!-- Bookings will be loaded dynamically -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="table-card">
              <h4>Upcoming Events</h4>
              <div class="list-group" id="upcomingEventsList">
                <!-- Events will be loaded dynamically -->
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function loadBookFacilityPage() {
      return `
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="form-card">
              <h4>Search Facilities</h4>
              <div class="row">
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Sport Type</label>
                    <select class="form-select" id="sportType">
                      <option value="tennis" selected>Tennis</option>
                      <option value="badminton">Badminton</option>
                      <option value="basketball">Basketball</option>
                      <option value="volleyball">Volleyball</option>
                      <option value="football">Football</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" id="bookingDate">
                  </div>
                </div>
                <div class="col-md-3">
                  <div class="form-group">
                    <label class="form-label">Time</label>
                    <select class="form-select" id="bookingTime">
                      <option value="morning">Morning (8AM-12PM)</option>
                      <option value="afternoon">Afternoon (12PM-5PM)</option>
                      <option value="evening">Evening (5PM-10PM)</option>
                    </select>
                  </div>
                </div>
                <div class="col-md-3 d-flex align-items-end">
                  <button class="btn btn-primary w-100" id="searchFacilitiesBtn">
                    <i class="fas fa-search"></i> Search
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row" id="facilitiesList">
          <!-- Facilities will be loaded dynamically -->
        </div>

        <!-- Booking Steps -->
        <div id="bookingSteps" style="display: none;">
          <div class="step-indicator">
            <div class="step active" id="step1">
              <div class="step-number">1</div>
              <div class="step-label">Select Date</div>
            </div>
            <div class="step" id="step2">
              <div class="step-number">2</div>
              <div class="step-label">Select Time</div>
            </div>
            <div class="step" id="step3">
              <div class="step-number">3</div>
              <div class="step-label">Coach</div>
            </div>
            <div class="step" id="step4">
              <div class="step-number">4</div>
              <div class="step-label">Snacks</div>
            </div>
            <div class="step" id="step5">
              <div class="step-number">5</div>
              <div class="step-label">Payment</div>
            </div>
          </div>

          <!-- Step 1: Select Date -->
          <div class="booking-step active" id="step1-content">
            <div class="form-card">
              <h4>Select a Date</h4>
              <div id="bookingCalendar"></div>
              <div class="mt-3 d-flex justify-content-end">
                <button class="btn btn-primary" id="nextToStep2">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 2: Select Time -->
          <div class="booking-step" id="step2-content">
            <div class="form-card">
              <h4>Select a Time Slot</h4>
              <div id="timeSlots" class="d-flex flex-wrap"></div>
              <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-secondary" id="backToStep1">Back</button>
                <button class="btn btn-primary" id="nextToStep3">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 3: Coach Selection -->
          <div class="booking-step" id="step3-content">
            <div class="form-card">
              <h4>Do you need a coach?</h4>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="coachNeeded" id="coachYes" value="yes">
                <label class="form-check-label" for="coachYes">
                  Yes, I need a coach
                </label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="coachNeeded" id="coachNo" value="no" checked>
                <label class="form-check-label" for="coachNo">
                  No, I don't need a coach
                </label>
              </div>
              
              <div id="coachSelection" style="display: none;">
                <h5 class="mt-4">Available Coaches</h5>
                <div id="coachesList"></div>
              </div>
              
              <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-secondary" id="backToStep2">Back</button>
                <button class="btn btn-primary" id="nextToStep4">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 4: Snacks Selection -->
          <div class="booking-step" id="step4-content">
            <div class="form-card">
              <h4>Do you want to order snacks?</h4>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="snacksNeeded" id="snacksYes" value="yes">
                <label class="form-check-label" for="snacksYes">
                  Yes, I want snacks
                </label>
              </div>
              <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="snacksNeeded" id="snacksNo" value="no" checked>
                <label class="form-check-label" for="snacksNo">
                  No, I don't want snacks
                </label>
              </div>
              
              <div id="snacksSelection" style="display: none;">
                <h5 class="mt-4">Available Snacks</h5>
                <div id="snacksList"></div>
              </div>
              
              <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-secondary" id="backToStep3">Back</button>
                <button class="btn btn-primary" id="nextToStep5">Next</button>
              </div>
            </div>
          </div>

          <!-- Step 5: Payment -->
          <div class="booking-step" id="step5-content">
            <div class="form-card">
              <h4>Booking Summary & Payment</h4>
              
              <div class="summary-card mb-4">
                <h5>Booking Details</h5>
                <div class="summary-item">
                  <span>Facility:</span>
                  <span id="summaryFacility">-</span>
                </div>
                <div class="summary-item">
                  <span>Date:</span>
                  <span id="summaryDate">-</span>
                </div>
                <div class="summary-item">
                  <span>Time:</span>
                  <span id="summaryTime">-</span>
                </div>
                <div class="summary-item">
                  <span>Court Fee:</span>
                  <span id="summaryCourtFee">RM 0</span>
                </div>
                <div class="summary-item">
                  <span>Coach:</span>
                  <span id="summaryCoach">-</span>
                </div>
                <div class="summary-item">
                  <span>Snacks:</span>
                  <span id="summarySnacks">-</span>
                </div>
                <div class="summary-item">
                  <span>Promo Discount:</span>
                  <span id="summaryDiscount">RM 0</span>
                </div>
                <div class="summary-item">
                  <span>Loyalty Points Discount:</span>
                  <span id="summaryLoyaltyDiscount">RM 0</span>
                </div>
                <div class="summary-item">
                  <span>Subtotal:</span>
                  <span id="summarySubtotal">RM 0</span>
                </div>
                
                <div class="form-check mt-3">
                  <input class="form-check-input" type="checkbox" id="useLoyaltyPoints">
                  <label class="form-check-label" for="useLoyaltyPoints">
                    Use Loyalty Points (You have <span id="availablePoints">0</span> points)
                  </label>
                </div>
                
                <div class="summary-item summary-total">
                  <span>Total Amount:</span>
                  <span id="summaryTotal">RM 0</span>
                </div>
              </div>
              
              <div class="mt-3 d-flex justify-content-between">
                <button class="btn btn-secondary" id="backToStep4">Back</button>
                <button class="btn btn-success" id="submitBooking">Submit Booking</button>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function loadFindFriendsPage() {
      return `
        <div class="row mb-4">
          <div class="col-md-12">
            <div class="form-card">
              <h4>Find Friends</h4>
              <div class="row">
                <div class="col-md-6">
                  <div class="input-group">
                    <input type="text" class="form-control" id="friendSearch" placeholder="Search by name, skill level, or sport...">
                    <button class="btn btn-primary" type="button" id="searchFriendsBtn">
                      <i class="fas fa-search"></i> Search
                    </button>
                  </div>
                </div>
                <div class="col-md-6">
                  <div class="form-group">
                    <select class="form-select" id="friendFilter">
                      <option value="all">All Users</option>
                      <option value="sameSport">Same Sport</option>
                      <option value="sameLevel">Same Skill Level</option>
                      <option value="sameLocation">Same Location</option>
                    </select>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <div class="row">
          <div class="col-md-8">
            <div class="table-card">
              <h5>All Users</h5>
              <div id="allUsersList">
                <!-- All users will be loaded here -->
              </div>
            </div>
          </div>
          
          <div class="col-md-4">
            <div class="table-card">
              <h5>Suggested Friends</h5>
              <div id="suggestedFriends">
                <!-- Suggested friends will be loaded here -->
              </div>
            </div>
            
            <div class="table-card mt-4">
              <h5>Active Chats</h5>
              <div id="activeChats">
                <!-- Active chats will be loaded here -->
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function loadMyBookingsPage() {
      return `
        <div class="row">
          <div class="col-md-12">
            <div class="table-card">
              <h4>My Bookings</h4>
              <div class="table-responsive">
                <table class="table table-hover">
                  <thead>
                    <tr>
                      <th>Facility</th>
                      <th>Date</th>
                      <th>Time</th>
                      <th>Status</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="allBookings">
                    <!-- All bookings will be loaded here -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    function loadMarketplacePage() {
      return `
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="form-card">
          <h4>Sell Your Equipment</h4>
          <div class="row">
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label">Item Name</label>
                <input type="text" class="form-control" id="itemName" placeholder="e.g. Tennis Racket">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label">Price (RM)</label>
                <input type="number" class="form-control" id="itemPrice" placeholder="e.g. 150">
              </div>
            </div>
            <div class="col-md-4">
              <div class="form-group">
                <label class="form-label">Condition</label>
                <select class="form-select" id="itemCondition">
                  <option value="new">New</option>
                  <option value="excellent">Excellent</option>
                  <option value="good">Good</option>
                  <option value="fair">Fair</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Image URL</label>
                <input type="url" class="form-control" id="itemImageUrl" placeholder="https://example.com/image.jpg">
                <small class="form-text text-muted">Paste the URL of your item's image</small>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="itemCategory">
                  <option value="tennis">Tennis</option>
                  <option value="badminton">Badminton</option>
                  <option value="basketball">Basketball</option>
                  <option value="football">Football</option>
                  <option value="fitness">Fitness</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Your Contact Number</label>
                <input type="tel" class="form-control" id="contactNumber" placeholder="+6012-345-6789">
                <small class="form-text text-muted">This will be shown to potential buyers</small>
              </div>
            </div>
            <div class="col-md-12">
              <div class="form-group">
                <label class="form-label">Description</label>
                <textarea class="form-control" id="itemDescription" rows="3" placeholder="Describe your item"></textarea>
              </div>
            </div>
            <div class="col-md-12">
              <button class="btn btn-primary" id="listItemBtn">
                <i class="fas fa-plus"></i> List Item
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mb-4">
      <div class="col-md-12">
        <div class="form-card">
          <h4>Filter Items</h4>
          <div class="row">
            <div class="col-md-3">
              <div class="form-group">
                <label class="form-label">Category</label>
                <select class="form-select" id="filterCategory">
                  <option value="all">All Categories</option>
                  <option value="tennis">Tennis</option>
                  <option value="badminton">Badminton</option>
                  <option value="basketball">Basketball</option>
                  <option value="football">Football</option>
                  <option value="fitness">Fitness</option>
                  <option value="other">Other</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label class="form-label">Condition</label>
                <select class="form-select" id="filterCondition">
                  <option value="all">All Conditions</option>
                  <option value="new">New</option>
                  <option value="excellent">Excellent</option>
                  <option value="good">Good</option>
                  <option value="fair">Fair</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label class="form-label">Price Range</label>
                <select class="form-select" id="filterPrice">
                  <option value="all">All Prices</option>
                  <option value="0-50">RM 0 - 50</option>
                  <option value="51-100">RM 51 - 100</option>
                  <option value="101-200">RM 101 - 200</option>
                  <option value="201-500">RM 201 - 500</option>
                  <option value="501+">RM 501+</option>
                </select>
              </div>
            </div>
            <div class="col-md-3">
              <div class="form-group">
                <label class="form-label">Status</label>
                <select class="form-select" id="filterStatus">
                  <option value="available">Available</option>
                  <option value="sold">Sold</option>
                  <option value="all">All</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row" id="marketplaceItems">
      <!-- Marketplace items will be loaded dynamically -->
    </div>
  `;
    }

    // Updated Community Page Loader
    function loadCommunityPage() {
      return `
    <div class="row mb-4">
      <div class="col-md-12">
        <div class="form-card">
          <h4>Create a Post</h4>
          <div class="form-group">
            <textarea class="form-control" id="postContent" rows="3" placeholder="What's on your mind?"></textarea>
          </div>
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Photo URL (Optional)</label>
                <input type="url" class="form-control" id="photoUrl" placeholder="https://example.com/photo.jpg">
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label class="form-label">Video URL (Optional)</label>
                <input type="url" class="form-control" id="videoUrl" placeholder="https://example.com/video.mp4">
              </div>
            </div>
          </div>
          <div class="d-flex justify-content-end mt-3">
            <button class="btn btn-primary" id="createPostBtn">Post</button>
          </div>
        </div>
      </div>
    </div>

    <div class="row">
      <div class="col-md-8" id="communityPosts">
        <!-- Community posts will be loaded dynamically -->
      </div>
      <div class="col-md-4">
        <div class="table-card">
          <h5>Community Stats</h5>
          <ul class="list-group">
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Active Members
              <span class="badge bg-primary rounded-pill" id="activeMembers">0</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Posts This Week
              <span class="badge bg-primary rounded-pill" id="postsThisWeek">0</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center">
              Events Created
              <span class="badge bg-primary rounded-pill" id="eventsCreated">0</span>
            </li>
          </ul>
        </div>

        <div class="table-card mt-4">
          <h5>Top Players</h5>
          <div class="list-group" id="topPlayers">
            <!-- Top players will be loaded dynamically -->
          </div>
        </div>
      </div>
    </div>
  `;
    }


    function loadProfilePage() {
      return `
        <div class="row">
          <div class="col-md-4">
            <div class="form-card text-center">
              <img src="https://via.placeholder.com/150" class="rounded-circle mb-3" alt="Profile" style="width: 150px; height: 150px; object-fit: cover;" id="profileImage">
              <h4 id="profileName">${currentUser ? currentUser.displayName || 'User' : 'User'}</h4>
              <p class="text-muted" id="profileSport">Tennis Enthusiast</p>
              <div class="d-grid gap-2">
                <button class="btn btn-outline-primary" id="editProfileBtn">Edit Profile</button>
                <button class="btn btn-outline-secondary" id="changePasswordBtn">Change Password</button>
              </div>
            </div>

            <div class="form-card mt-4">
              <h5>Statistics</h5>
              <ul class="list-group list-group-flush">
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Total Bookings
                  <span class="badge bg-primary rounded-pill" id="profileTotalBookings">0</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Friends
                  <span class="badge bg-primary rounded-pill" id="profileTotalFriends">0</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Events Attended
                  <span class="badge bg-primary rounded-pill" id="profileEventsAttended">0</span>
                </li>
                <li class="list-group-item d-flex justify-content-between align-items-center">
                  Loyalty Points
                  <span class="badge bg-primary rounded-pill" id="profileLoyaltyPoints">0</span>
                </li>
              </ul>
            </div>
          </div>
          <div class="col-md-8">
            <div class="form-card">
              <h5>Personal Information</h5>
              <form id="profileForm">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Full Name</label>
                      <input type="text" class="form-control" id="profileFullName" value="${currentUser ? currentUser.displayName || '' : ''}">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Email</label>
                      <input type="email" class="form-control" id="profileEmail" value="${currentUser ? currentUser.email || '' : ''}" readonly>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Phone</label>
                      <input type="tel" class="form-control" id="profilePhone" placeholder="+6012-345-6789">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Location</label>
                      <input type="text" class="form-control" id="profileLocation" placeholder="Kuala Lumpur">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Primary Sport</label>
                      <select class="form-select" id="profilePrimarySport">
                        <option value="tennis" selected>Tennis</option>
                        <option value="badminton">Badminton</option>
                        <option value="basketball">Basketball</option>
                        <option value="football">Football</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Skill Level</label>
                      <select class="form-select" id="profileSkillLevel">
                        <option value="beginner">Beginner</option>
                        <option value="intermediate" selected>Intermediate</option>
                        <option value="advanced">Advanced</option>
                      </select>
                    </div>
                  </div>
                  <div class="col-12">
                    <div class="form-group">
                      <label class="form-label">Bio</label>
                      <textarea class="form-control" id="profileBio" rows="3" placeholder="Tell us about yourself"></textarea>
                    </div>
                  </div>
                  <div class="col-12">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      `;
    }

    // Initialize page functionality
    function initializePageFunctionality(page) {
      switch (page) {
        case 'dashboard':
          // Ensure dashboard data is loaded
          if (currentUser && userDataLoaded) {
            setTimeout(() => {
              loadDashboardData();
            }, 100);
          }
          break;
        case 'book-facility':
          initializeBookFacilityPage();
          break;
        case 'events':
          initializeEventsPage();
          break;
        case 'find-friends':
          initializeFindFriendsPage();
          break;
        case 'my-bookings':
          initializeMyBookingsPage();
          break;
        case 'marketplace':
          initializeMarketplacePage();
          break;
        case 'community':
          initializeCommunityPage();
          break;
        case 'profile':
          initializeProfilePage();
          break;
      }
    }

    // Initialize My Bookings Page
    async function initializeMyBookingsPage() {
      await loadAllBookings();
    }

    // Load all bookings for the current user
    async function loadAllBookings() {
      try {
        const bookingsSnapshot = await db.collection('bookings')
          .where('userId', '==', currentUser.uid)
          .orderBy('createdAt', 'desc')
          .get();

        const bookingsTable = document.getElementById('allBookings');
        if (!bookingsTable) return;

        bookingsTable.innerHTML = '';

        if (bookingsSnapshot.empty) {
          bookingsTable.innerHTML = '<tr><td colspan="5" class="text-center text-muted">No bookings found</td></tr>';
          return;
        }

        const bookingsData = [];

        bookingsSnapshot.forEach(doc => {
          const booking = doc.data();
          bookingsData.push({ id: doc.id, ...booking });
        });

        // Sort by date if available
        bookingsData.sort((a, b) => {
          const dateA = a.date ? a.date.toDate() : new Date(0);
          const dateB = b.date ? b.date.toDate() : new Date(0);
          return dateB - dateA;
        });

        // Render bookings
        bookingsData.forEach(booking => {
          const row = document.createElement('tr');

          // Format date
          let formattedDate = 'Date not set';
          if (booking.date) {
            const bookingDate = booking.date.toDate();
            formattedDate = bookingDate.toLocaleDateString();
          } else if (booking.createdAt) {
            const createdDate = booking.createdAt.toDate();
            formattedDate = createdDate.toLocaleDateString();
          }

          // Create status badge
          let statusClass = 'badge-pending';
          let statusText = 'pending';

          if (booking.status === 'approved' || booking.status === 'Approved') {
            statusClass = 'badge-confirmed';
            statusText = 'approved';
          } else if (booking.status === 'completed' || booking.status === 'Completed') {
            statusClass = 'badge-completed';
            statusText = 'completed';
          } else if (booking.status === 'cancelled' || booking.status === 'Cancelled') {
            statusClass = 'badge-cancelled';
            statusText = 'cancelled';
          } else if (booking.status === 'Active') {
            statusClass = 'badge-confirmed';
            statusText = 'active';
          }

          row.innerHTML = `
            <td>${booking.facilityName || booking.name || 'Facility'}</td>
            <td>${formattedDate}</td>
            <td>${booking.time || (booking.slots && booking.slots.length > 0 ? booking.slots[0] : 'Time not set')}</td>
            <td><span class="badge badge-status ${statusClass}">${statusText}</span></td>
            <td>
              <button class="btn btn-sm btn-outline-primary view-booking-btn" data-id="${booking.id}">
                <i class="fas fa-eye"></i> View
              </button>
              ${statusText === 'pending' || statusText === 'approved' ? `
                <button class="btn btn-sm btn-outline-danger cancel-booking-btn" data-id="${booking.id}">
                  <i class="fas fa-times"></i> Cancel
                </button>
              ` : ''}
            </td>
          `;

          bookingsTable.appendChild(row);
        });

        // Add event listeners to booking buttons
        document.querySelectorAll('.view-booking-btn').forEach(btn => {
          btn.addEventListener('click', function () {
            const bookingId = this.getAttribute('data-id');
            viewBookingDetails(bookingId);
          });
        });

        document.querySelectorAll('.cancel-booking-btn').forEach(btn => {
          btn.addEventListener('click', function () {
            const bookingId = this.getAttribute('data-id');
            cancelBooking(bookingId);
          });
        });

      } catch (error) {
        console.error('Error loading bookings:', error);
        const bookingsTable = document.getElementById('allBookings');
        if (bookingsTable) {
          bookingsTable.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Error loading bookings</td></tr>';
        }
      }
    }

    // View booking details
    async function viewBookingDetails(bookingId) {
      try {
        const bookingDoc = await db.collection('bookings').doc(bookingId).get();

        if (!bookingDoc.exists) {
          showToast('Booking not found', 'danger');
          return;
        }

        const booking = bookingDoc.data();

        // Format date for display
        let formattedDate = 'Date not set';
        if (booking.date) {
          const bookingDate = booking.date.toDate();
          formattedDate = bookingDate.toLocaleDateString();
        }

        // Create modal for booking details
        const modalHtml = `
      <div class="modal fade" id="bookingDetailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Booking Details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
              <div class="row">
                <div class="col-md-6">
                  <h6>Facility Information</h6>
                  <p><strong>Name:</strong> ${booking.facilityName || booking.name || 'N/A'}</p>
                  <p><strong>Location:</strong> ${booking.location || 'N/A'}</p>
                  <p><strong>Sport Type:</strong> ${booking.sportType || 'N/A'}</p>
                </div>
                <div class="col-md-6">
                  <h6>Booking Details</h6>
                  <p><strong>Date:</strong> ${formattedDate}</p>
                  <p><strong>Time:</strong> ${booking.time || 'N/A'}</p>
                  <p><strong>Duration:</strong> ${booking.duration || '1 hour'}</p>
                  <p><strong>Status:</strong> <span class="badge ${getStatusBadgeClass(booking.status)}">${booking.status || 'pending'}</span></p>
                </div>
              </div>
              
              ${booking.coach ? `
              <div class="row mt-3">
                <div class="col-12">
                  <h6>Coach Information</h6>
                  <p><strong>Coach:</strong> ${booking.coach.name || 'N/A'}</p>
                  <p><strong>Rate:</strong> RM${booking.coach.rate || '0'}/hour</p>
                </div>
              </div>
              ` : ''}
              
              ${booking.snacks && booking.snacks.length > 0 ? `
              <div class="row mt-3">
                <div class="col-12">
                  <h6>Snacks Ordered</h6>
                  <ul>
                    ${booking.snacks.map(snack => `<li>${snack.name} - RM${snack.price}</li>`).join('')}
                  </ul>
                </div>
              </div>
              ` : ''}
              
              <div class="row mt-3">
                <div class="col-12">
                  <h6>Payment Information</h6>
                  <p><strong>Total Amount:</strong> RM${booking.amount || '0'}</p>
                  ${booking.loyaltyPointsUsed ? `<p><strong>Loyalty Points Used:</strong> ${booking.loyaltyPointsUsed}</p>` : ''}
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
              <button type="button" class="btn btn-primary" onclick="printBookingDetails('${bookingId}')">
                <i class="fas fa-print me-1"></i> Print
              </button>
            </div>
          </div>
        </div>
      </div>
    `;

        // Add modal to DOM
        const modalContainer = document.createElement('div');
        modalContainer.innerHTML = modalHtml;
        document.body.appendChild(modalContainer);

        // Show modal
        const modal = new bootstrap.Modal(document.getElementById('bookingDetailsModal'));
        modal.show();

        // Remove modal from DOM after it's hidden
        document.getElementById('bookingDetailsModal').addEventListener('hidden.bs.modal', function () {
          modalContainer.remove();
        });

      } catch (error) {
        console.error('Error viewing booking details:', error);
        showToast('Error loading booking details', 'danger');
      }
    }
    /// Print Booking Details Function
    async function printBookingDetails(bookingId) {
      try {
        // Fetch fresh booking data
        const bookingDoc = await db.collection('bookings').doc(bookingId).get();
        if (!bookingDoc.exists) {
          showToast('Booking not found', 'danger');
          return;
        }

        const booking = bookingDoc.data();

        // Fetch user and facility details
        let userDetails = {};
        let facilityDetails = {};

        if (booking.userId) {
          const userDoc = await db.collection('users').doc(booking.userId).get();
          if (userDoc.exists) userDetails = userDoc.data();
        }

        if (booking.facilityId) {
          const facilityDoc = await db.collection('facilities').doc(booking.facilityId).get();
          if (facilityDoc.exists) facilityDetails = facilityDoc.data();
        }

        // Format dates and times
        const bookingDate = booking.date || 'N/A';
        const timeSlot = booking.slot || 'N/A';
        const bookingDateTime = booking.timestamp ? booking.timestamp.toDate().toLocaleString() : 'N/A';
        const printDate = new Date().toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        // Sportova logo
        const sportovaLogo = 'img/logo.jpg';
        // Replace with your actual logo: 'https://yourdomain.com/logo.png'

        // Create print content
        const printContent = `
            <!DOCTYPE html>
            <html lang="en">
            <head>
                <title>Booking Confirmation - Sportova</title>
                <style>
                    body {
                        font-family: Arial, sans-serif;
                        line-height: 1.6;
                        color: #333;
                        max-width: 800px;
                        margin: 0 auto;
                        padding: 20px;
                    }
                    .header {
                        text-align: center;
                        border-bottom: 3px solid #4361ee;
                        padding-bottom: 20px;
                        margin-bottom: 30px;
                    }
                    .logo {
                        max-width: 200px;
                        height: auto;
                        margin-bottom: 15px;
                    }
                    .company-name {
                        font-size: 28px;
                        font-weight: bold;
                        color: #4361ee;
                        margin-bottom: 5px;
                    }
                    .document-title {
                        text-align: center;
                        margin: 30px 0;
                    }
                    .info-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 20px;
                        margin-bottom: 30px;
                    }
                    .info-section {
                        background: #f8f9fa;
                        padding: 20px;
                        border-radius: 8px;
                        border-left: 4px solid #4361ee;
                    }
                    .info-section h3 {
                        color: #4361ee;
                        margin-bottom: 15px;
                        font-size: 16px;
                    }
                    .info-item {
                        margin-bottom: 10px;
                        display: flex;
                        justify-content: space-between;
                    }
                    .summary-section {
                        background: #4361ee;
                        color: white;
                        padding: 20px;
                        border-radius: 8px;
                        margin: 20px 0;
                    }
                    .status-badge {
                        padding: 4px 12px;
                        border-radius: 15px;
                        font-size: 12px;
                        font-weight: bold;
                        text-transform: uppercase;
                    }
                    .status-approved { background: #d4edda; color: #155724; }
                    .status-pending { background: #fff3cd; color: #856404; }
                    .status-cancelled { background: #f8d7da; color: #721c24; }
                    .footer {
                        margin-top: 40px;
                        padding-top: 20px;
                        border-top: 1px solid #ddd;
                        text-align: center;
                        font-size: 12px;
                        color: #666;
                    }
                    @media print {
                        body { padding: 0; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <img src="${sportovaLogo}" alt="Sportova Logo" class="logo">
                    <div>Premium Sports Facility Management</div>
                </div>

                <div class="document-title">
                    <h1>BOOKING CONFIRMATION</h1>
                    <p>Reference: #${bookingId.substring(0, 8).toUpperCase()}</p>
                    <small>Generated on: ${printDate}</small>
                </div>

                <div class="info-grid">
                    <div class="info-section">
                        <h3>CUSTOMER INFORMATION</h3>
                        <div class="info-item">
                            <span>Name:</span>
                            <span>${booking.userName || userDetails.name || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span>Email:</span>
                            <span>${userDetails.email || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span>Phone:</span>
                            <span>${userDetails.phone || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span>Status:</span>
                            <span class="status-badge status-${booking.status || 'pending'}">${(booking.status || 'pending').toUpperCase()}</span>
                        </div>
                    </div>

                    <div class="info-section">
                        <h3>BOOKING DETAILS</h3>
                        <div class="info-item">
                            <span>Facility:</span>
                            <span>${booking.facilityName || facilityDetails.name || 'N/A'}</span>
                        </div>
                        <div class="info-item">
                            <span>Date:</span>
                            <span>${booking.date.toDate().toLocaleString()}</span>
                        </div>
                        <div class="info-item">
                            <span>Time Slot:</span>
                            <span>${booking.slots}</span>
                        </div>
                        <div class="info-item">
                            <span>Duration:</span>
                            <span>${booking.duration || '1 hour'}</span>
                        </div>
                    </div>
                </div>

                <div class="summary-section">
                    <h3>PAYMENT SUMMARY</h3>
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; text-align: center;">
                        <div>
                            <div style="font-size: 20px; font-weight: bold;">RM${parseFloat(booking.price || 0).toFixed(2)}</div>
                            <div>Total Amount</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: bold;">${booking.paymentMethod || 'Online'}</div>
                            <div>Payment Method</div>
                        </div>
                        <div>
                            <div style="font-size: 20px; font-weight: bold;">Paid</div>
                            <div>Payment Status</div>
                        </div>
                    </div>
                </div>

                <div class="info-section">
                    <h3>ADDITIONAL INFORMATION</h3>
                    <div class="info-item">
                        <span>Booking Created:</span>
                        <span>${booking.createdAt.toDate().toLocaleString()}</span>
                    </div>
                    <div class="info-item">
                        <span>Facility Type:</span>
                        <span>${facilityDetails.type || 'N/A'}</span>
                    </div>
                    <div class="info-item">
                        <span>Location:</span>
                        <span>${facilityDetails.location || 'N/A'}</span>
                    </div>
                </div>

                <div class="footer">
                    <div style="margin-bottom: 15px;">
                        <strong>Sportova Sports Facilities</strong><br>
                        Email: support@sportova.com | Phone: +1 (555) 123-SPORT<br>
                        Website: www.sportova.com
                    </div>
                    <div>
                        Thank you for choosing Sportova! This is an computer-generated document.
                    </div>
                </div>
            </body>
            </html>
        `;

        // Open print window
        const printWindow = window.open('', '_blank', 'width=800,height=600');
        printWindow.document.write(printContent);
        printWindow.document.close();

        // Print after content loads
        printWindow.onload = function () {
          setTimeout(() => {
            printWindow.print();
          }, 500);
        };

      } catch (error) {
        console.error('Error printing booking details:', error);
        showToast('Error generating print document', 'danger');
      }
    }

    // Helper function for status badge classes
    function getStatusBadgeClass(status) {
      const statusClasses = {
        'pending': 'bg-warning',
        'confirmed': 'bg-success',
        'completed': 'bg-info',
        'cancelled': 'bg-danger',
        'active': 'bg-primary'
      };
      return statusClasses[status?.toLowerCase()] || 'bg-secondary';
    }

    // Cancel a booking
    async function cancelBooking(bookingId) {
      if (!confirm('Are you sure you want to cancel this booking?')) return;

      try {
        await db.collection('bookings').doc(bookingId).update({
          status: 'cancelled',
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('Booking cancelled successfully', 'success');

        // Reload bookings
        await loadAllBookings();

      } catch (error) {
        console.error('Error cancelling booking:', error);
        showToast('Error cancelling booking', 'danger');
      }
    }

    // Initialize Profile Page
    async function initializeProfilePage() {
      // Load profile data from Firestore
      const userData = window.userProfileData || {};

      // Update profile image with photoUrl from users collection
      const profileImage = document.getElementById('profileImage');
      if (userData.photoURL) {
        profileImage.src = userData.photoURL;
      } else if (currentUser.photoURL) {
        profileImage.src = currentUser.photoURL;
      } else {
        profileImage.src = generateDefaultAvatar(userData.name || currentUser.displayName || currentUser.email);
      }

      // Update profile form fields
      document.getElementById('profileFullName').value = userData.name || currentUser.displayName || '';
      document.getElementById('profilePhone').value = userData.phone || '';
      document.getElementById('profileLocation').value = userData.location || '';
      document.getElementById('profilePrimarySport').value = userData.primarySport || 'tennis';
      document.getElementById('profileSkillLevel').value = userData.skillLevel || 'intermediate';
      document.getElementById('profileBio').value = userData.bio || '';

      // Update profile statistics
      document.getElementById('profileTotalBookings').textContent = await calculateUserBookings(currentUser.uid);
      document.getElementById('profileTotalFriends').textContent = await calculateUserFriends(currentUser.uid);
      document.getElementById('profileLoyaltyPoints').textContent = userData.loyaltyPoints || 0;

      // Set up profile form submission
      document.getElementById('profileForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        await updateProfile();
      });
    }

    // Update user profile
    async function updateProfile() {
      try {
        const profileData = {
          name: document.getElementById('profileFullName').value,
          phone: document.getElementById('profilePhone').value,
          location: document.getElementById('profileLocation').value,
          primarySport: document.getElementById('profilePrimarySport').value,
          skillLevel: document.getElementById('profileSkillLevel').value,
          bio: document.getElementById('profileBio').value,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('users').doc(currentUser.uid).update(profileData);

        // Update user display name in Firebase Auth
        await currentUser.updateProfile({
          displayName: profileData.name
        });

        // Update local user data
        window.userProfileData = { ...window.userProfileData, ...profileData };

        showToast('Profile updated successfully', 'success');

      } catch (error) {
        console.error('Error updating profile:', error);
        showToast('Error updating profile', 'danger');
      }
    }

    // Initialize Book Facility Page
    async function initializeBookFacilityPage() {
      // Load facilities from Firestore
      try {
        const facilitiesSnapshot = await db.collection('facilities').get();
        const facilitiesList = document.getElementById('facilitiesList');
        facilitiesList.innerHTML = '';

        if (facilitiesSnapshot.empty) {
          facilitiesList.innerHTML = '<div class="col-12 text-center">No facilities found</div>';
          return;
        }

        facilitiesSnapshot.forEach(doc => {
          const facility = doc.data();
          const col = document.createElement('div');
          col.className = 'col-md-4 mb-4';

          // Format amenities
          const amenitiesHtml = facility.amenities ?
            facility.amenities.map(amenity => `<span class="badge bg-secondary me-1">${amenity}</span>`).join('') :
            '';

          // Add promo badge if promo exists
          const promoBadge = facility.promo ? `<div class="promo-badge">${facility.promo}</div>` : '';

          col.innerHTML = `
            <div class="facility-card card h-100">
              ${promoBadge}
              <img src="${facility.imageUrl || 'https://via.placeholder.com/300x200'}" 
                   class="card-img-top facility-image" alt="${facility.name}"
                   style="height: 200px; object-fit: cover;">
              <div class="card-body d-flex flex-column">
                <h5 class="card-title">${facility.name}</h5>
                <p class="card-text flex-grow-1">${facility.description}</p>
                <div class="mb-2">
                  <small class="text-muted"><i class="fas fa-map-marker-alt"></i> ${facility.location}</small>
                </div>
                <div class="mb-2">
                  ${amenitiesHtml}
                </div>
                <div class="mt-auto">
                  <div class="d-flex justify-content-between align-items-center">
                    <span class="badge bg-primary">RM${facility.price}/hour</span>
                    <button class="btn btn-sm btn-outline-primary book-facility-btn" data-id="${doc.id}">
                      Book Now
                    </button>
                  </div>
                </div>
              </div>
            </div>
          `;

          facilitiesList.appendChild(col);
        });

        // Add event listeners to book buttons
        document.querySelectorAll('.book-facility-btn').forEach(btn => {
          btn.addEventListener('click', function () {
            const facilityId = this.getAttribute('data-id');
            startBookingProcess(facilityId);
          });
        });
      } catch (error) {
        console.error('Error loading facilities:', error);
        showToast('Error loading facilities', 'danger');
      }

      // Search facilities functionality
      document.getElementById('searchFacilitiesBtn').addEventListener('click', () => {
        showToast('Searching for available facilities...', 'info');
      });
    }

    // Start the booking process
    async function startBookingProcess(facilityId) {
      try {
        const facilityDoc = await db.collection('facilities').doc(facilityId).get();
        if (!facilityDoc.exists) {
          showToast('Facility not found', 'danger');
          return;
        }

        selectedFacility = {
          id: facilityId,
          ...facilityDoc.data()
        };

        // Show booking steps and hide facilities list
        document.getElementById('facilitiesList').style.display = 'none';
        document.getElementById('bookingSteps').style.display = 'block';

        // Initialize step 1: Calendar
        initializeMonthlyCalendar();

        // Load available coaches for this facility
        await loadAvailableCoachesForFacility(facilityId);

        // Load available snacks
        await loadAvailableSnacks();

        // Update loyalty points display
        document.getElementById('availablePoints').textContent = userLoyaltyPoints;

      } catch (error) {
        console.error('Error starting booking process:', error);
        showToast('Error starting booking process', 'danger');
      }
    }

    // Initialize monthly calendar for date selection
    function initializeMonthlyCalendar() {
      const calendarEl = document.getElementById('bookingCalendar');
      calendarEl.innerHTML = '';

      // Create monthly calendar container
      const monthCalendar = document.createElement('div');
      monthCalendar.className = 'month-calendar';

      // Create calendar header with month navigation
      const calendarHeader = document.createElement('div');
      calendarHeader.className = 'calendar-header-month';

      const monthNames = ["January", "February", "March", "April", "May", "June",
        "July", "August", "September", "October", "November", "December"];

      const prevButton = document.createElement('button');
      prevButton.className = 'btn btn-outline-primary';
      prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
      prevButton.addEventListener('click', () => {
        currentMonth--;
        if (currentMonth < 0) {
          currentMonth = 11;
          currentYear--;
        }
        initializeMonthlyCalendar();
      });

      const nextButton = document.createElement('button');
      nextButton.className = 'btn btn-outline-primary';
      nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
      nextButton.addEventListener('click', () => {
        currentMonth++;
        if (currentMonth > 11) {
          currentMonth = 0;
          currentYear++;
        }
        initializeMonthlyCalendar();
      });

      const monthTitle = document.createElement('h5');
      monthTitle.textContent = `${monthNames[currentMonth]} ${currentYear}`;
      monthTitle.className = 'mb-0';

      calendarHeader.appendChild(prevButton);
      calendarHeader.appendChild(monthTitle);
      calendarHeader.appendChild(nextButton);

      monthCalendar.appendChild(calendarHeader);

      // Create calendar grid
      const calendarGrid = document.createElement('div');
      calendarGrid.className = 'calendar-grid';

      // Add day headers
      const dayHeaders = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
      dayHeaders.forEach(day => {
        const dayHeader = document.createElement('div');
        dayHeader.className = 'calendar-header';
        dayHeader.textContent = day;
        calendarGrid.appendChild(dayHeader);
      });

      // Get first day of month and number of days
      const firstDay = new Date(currentYear, currentMonth, 1);
      const lastDay = new Date(currentYear, currentMonth + 1, 0);
      const daysInMonth = lastDay.getDate();
      const startingDay = firstDay.getDay();

      // Add empty cells for days before the first day of the month
      for (let i = 0; i < startingDay; i++) {
        const emptyCell = document.createElement('div');
        emptyCell.className = 'calendar-day-month disabled';
        calendarGrid.appendChild(emptyCell);
      }

      // Add days of the month
      const today = new Date();
      for (let day = 1; day <= daysInMonth; day++) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day-month';

        const currentDate = new Date(currentYear, currentMonth, day);

        // Check if date is in the past
        if (currentDate < today) {
          dayCell.classList.add('disabled');
        } else {
          dayCell.addEventListener('click', () => selectDate(currentDate, dayCell));
        }

        // Highlight today
        if (currentDate.toDateString() === today.toDateString()) {
          dayCell.classList.add('today');
        }

        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = day;

        dayCell.appendChild(dayNumber);

        // Add events/availability indicator (you can customize this)
        const eventsContainer = document.createElement('div');
        eventsContainer.className = 'calendar-events';

        // Add sample availability indicator (green dot for available days)
        if (Math.random() > 0.3) { // Random availability for demo
          const availableIndicator = document.createElement('div');
          availableIndicator.className = 'calendar-event-small';
          availableIndicator.textContent = 'Available';
          eventsContainer.appendChild(availableIndicator);
        }

        dayCell.appendChild(eventsContainer);
        calendarGrid.appendChild(dayCell);
      }

      monthCalendar.appendChild(calendarGrid);
      calendarEl.appendChild(monthCalendar);
    }

    // Select a date for booking
    function selectDate(date, element) {
      selectedDate = date;

      // Remove selected class from all days
      document.querySelectorAll('.calendar-day-month').forEach(day => {
        day.classList.remove('selected');
      });

      // Add selected class to clicked day
      element.classList.add('selected');

      // Enable next button
      document.getElementById('nextToStep2').disabled = false;
    }

    // Load available coaches for specific facility
    async function loadAvailableCoachesForFacility(facilityId) {
      try {
        const coachesSnapshot = await db.collection('coaches')
          .where('facilityId', '==', facilityId)
          .where('availableForHire', '==', true)
          .get();

        availableCoaches = [];
        coachesSnapshot.forEach(doc => {
          availableCoaches.push({
            id: doc.id,
            ...doc.data()
          });
        });

        // Populate coaches list
        const coachesListEl = document.getElementById('coachesList');
        coachesListEl.innerHTML = '';

        if (availableCoaches.length === 0) {
          coachesListEl.innerHTML = '<p>No coaches available for this facility.</p>';
          return;
        }

        availableCoaches.forEach(coach => {
          const coachCard = document.createElement('div');
          coachCard.className = 'coach-card';
          coachCard.innerHTML = `
            <div class="form-check">
              <input class="form-check-input" type="radio" name="coachSelection" id="coach-${coach.id}" value="${coach.id}">
              <label class="form-check-label w-100" for="coach-${coach.id}">
                <div class="d-flex align-items-center">
                  <img src="${coach.photoURL || 'https://via.placeholder.com/60'}" 
                       class="rounded-circle me-3" width="60" height="60" alt="${coach.name}">
                  <div>
                    <h6 class="mb-1">${coach.name}</h6>
                    <p class="mb-1">Experience: ${coach.experience} years</p>
                    <p class="mb-1">Rate: RM${coach.rate}/hour</p>
                    <p class="mb-0">${coach.specialties ? coach.specialties.join(', ') : ''}</p>
                  </div>
                </div>
              </label>
            </div>
          `;
          coachesListEl.appendChild(coachCard);
        });

        // Add event listeners to coach selection
        document.querySelectorAll('input[name="coachSelection"]').forEach(radio => {
          radio.addEventListener('change', function () {
            if (this.checked) {
              selectedCoach = availableCoaches.find(coach => coach.id === this.value);
            }
          });
        });

      } catch (error) {
        console.error('Error loading coaches:', error);
        showToast('Error loading coaches', 'danger');
      }
    }

    // Load available snacks
    async function loadAvailableSnacks() {
      try {
        // In a real app, you would fetch from a snacks collection
        // For now, we'll use mock data
        availableSnacks = [
          { id: '1', name: 'Energy Bar', price: 5 },
          { id: '2', name: 'Protein Shake', price: 8 },
          { id: '3', name: 'Banana', price: 2 },
          { id: '4', name: 'Sports Drink', price: 4 },
          { id: '5', name: 'Trail Mix', price: 6 }
        ];

        // Populate snacks list
        const snacksListEl = document.getElementById('snacksList');
        snacksListEl.innerHTML = '';

        availableSnacks.forEach(snack => {
          const snackCard = document.createElement('div');
          snackCard.className = 'snack-card';
          snackCard.innerHTML = `
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="snack-${snack.id}" value="${snack.id}">
              <label class="form-check-label w-100" for="snack-${snack.id}">
                <div class="d-flex justify-content-between align-items-center">
                  <span>${snack.name}</span>
                  <span>RM${snack.price}</span>
                </div>
              </label>
            </div>
          `;
          snacksListEl.appendChild(snackCard);
        });

        // Add event listeners to snack selection
        document.querySelectorAll('input[type="checkbox"][id^="snack-"]').forEach(checkbox => {
          checkbox.addEventListener('change', function () {
            const snackId = this.value;
            const snack = availableSnacks.find(s => s.id === snackId);

            if (this.checked) {
              selectedSnacks.push(snack);
            } else {
              selectedSnacks = selectedSnacks.filter(s => s.id !== snackId);
            }
          });
        });

      } catch (error) {
        console.error('Error loading snacks:', error);
        showToast('Error loading snacks', 'danger');
      }
    }

    // Initialize step navigation
    document.addEventListener('click', function (e) {
      // Step 1 to Step 2
      if (e.target && e.target.id === 'nextToStep2') {
        if (!selectedDate) {
          showToast('Please select a date', 'warning');
          return;
        }

        goToStep(2);
        initializeTimeSlots();
      }

      // Step 2 to Step 1
      if (e.target && e.target.id === 'backToStep1') {
        goToStep(1);
      }

      // Step 2 to Step 3
      if (e.target && e.target.id === 'nextToStep3') {
        if (!selectedTimeSlot) {
          showToast('Please select a time slot', 'warning');
          return;
        }

        goToStep(3);
      }

      // Step 3 to Step 2
      if (e.target && e.target.id === 'backToStep2') {
        goToStep(2);
      }

      // Step 3 to Step 4
      if (e.target && e.target.id === 'nextToStep4') {
        goToStep(4);
      }

      // Step 4 to Step 3
      if (e.target && e.target.id === 'backToStep3') {
        goToStep(3);
      }

      // Step 4 to Step 5
      if (e.target && e.target.id === 'nextToStep5') {
        goToStep(5);
        updateBookingSummary();
      }

      // Step 5 to Step 4
      if (e.target && e.target.id === 'backToStep4') {
        goToStep(4);
      }

      // Submit booking
      if (e.target && e.target.id === 'submitBooking') {
        submitBooking();
      }
    });

    // Toggle coach selection based on radio button
    document.addEventListener('change', function (e) {
      if (e.target && e.target.name === 'coachNeeded') {
        const coachSelectionEl = document.getElementById('coachSelection');
        if (e.target.value === 'yes') {
          coachSelectionEl.style.display = 'block';
        } else {
          coachSelectionEl.style.display = 'none';
          selectedCoach = null;
        }
      }

      if (e.target && e.target.name === 'snacksNeeded') {
        const snacksSelectionEl = document.getElementById('snacksSelection');
        if (e.target.value === 'yes') {
          snacksSelectionEl.style.display = 'block';
        } else {
          snacksSelectionEl.style.display = 'none';
          selectedSnacks = [];
        }
      }

      // Update summary when loyalty points checkbox changes
      if (e.target && e.target.id === 'useLoyaltyPoints') {
        updateBookingSummary();
      }
    });

    // Navigate to a specific step
    function goToStep(stepNumber) {
      // Hide all steps
      document.querySelectorAll('.booking-step').forEach(step => {
        step.classList.remove('active');
      });

      // Show selected step
      document.getElementById(`step${stepNumber}-content`).classList.add('active');

      // Update step indicators
      document.querySelectorAll('.step').forEach(step => {
        step.classList.remove('active', 'completed');
      });

      for (let i = 1; i <= stepNumber; i++) {
        if (i < stepNumber) {
          document.getElementById(`step${i}`).classList.add('completed');
        } else {
          document.getElementById(`step${i}`).classList.add('active');
        }
      }
    }

    // Initialize time slots based on facility availability
    async function initializeTimeSlots() {
      const timeSlotsEl = document.getElementById('timeSlots');
      timeSlotsEl.innerHTML = '';

      // Get available slots from facility
      const availableSlots = selectedFacility.slots || ['7-8PM', '5-6 PM'];

      // Check which slots are already booked
      const bookedSlots = await getBookedSlots();

      // Create time slot elements
      availableSlots.forEach(slot => {
        const slotEl = document.createElement('div');
        slotEl.className = 'time-slot';
        slotEl.textContent = slot;

        // Check if slot is available
        const isBooked = bookedSlots.some(booked => booked.time === slot);

        if (isBooked) {
          slotEl.classList.add('unavailable');
        } else {
          slotEl.classList.add('available');
          slotEl.addEventListener('click', () => selectTimeSlot(slot, slotEl));
        }

        timeSlotsEl.appendChild(slotEl);
      });
    }

    // Get already booked slots for the selected date
    async function getBookedSlots() {
      try {
        const bookingsSnapshot = await db.collection('bookings')
          .where('facilityId', '==', selectedFacility.id)
          .where('date', '==', selectedDate)
          .where('status', 'in', ['pending', 'confirmed', 'active'])
          .get();

        const bookedSlots = [];
        bookingsSnapshot.forEach(doc => {
          const booking = doc.data();
          bookedSlots.push({
            time: booking.time,
            id: doc.id
          });
        });

        return bookedSlots;
      } catch (error) {
        console.error('Error getting booked slots:', error);
        return [];
      }
    }

    // Select a time slot
    function selectTimeSlot(slot, element) {
      selectedTimeSlot = slot;

      // Remove selected class from all slots
      document.querySelectorAll('.time-slot').forEach(slotEl => {
        slotEl.classList.remove('selected');
      });

      // Add selected class to clicked slot
      element.classList.add('selected');
    }

    // Update booking summary
    function updateBookingSummary() {
      // Calculate costs
      const courtFee = selectedFacility.price || 0;
      const coachFee = selectedCoach ? selectedCoach.rate : 0;
      const snacksFee = selectedSnacks.reduce((total, snack) => total + snack.price, 0);

      // Calculate promo discount (10% for NEWUSER10)
      let discount = 0;
      if (selectedFacility.promo === 'NEWUSER10') {
        discount = courtFee * 0.1;
      }

      // Calculate subtotal before loyalty points
      const subtotalBeforeLoyalty = courtFee + coachFee + snacksFee - discount;

      // Calculate loyalty points discount (1 point = RM0.10)
      let loyaltyDiscount = 0;
      const useLoyaltyPoints = document.getElementById('useLoyaltyPoints').checked;
      if (useLoyaltyPoints) {
        loyaltyDiscount = Math.min(userLoyaltyPoints * 0.1, subtotalBeforeLoyalty);
      }

      // Calculate final total
      const total = subtotalBeforeLoyalty - loyaltyDiscount;

      // Update summary display
      document.getElementById('summaryFacility').textContent = selectedFacility.name;
      document.getElementById('summaryDate').textContent = selectedDate.toLocaleDateString();
      document.getElementById('summaryTime').textContent = selectedTimeSlot;
      document.getElementById('summaryCourtFee').textContent = `RM ${courtFee}`;
      document.getElementById('summaryCoach').textContent = selectedCoach ? `${selectedCoach.name} (RM${coachFee})` : 'No coach';
      document.getElementById('summarySnacks').textContent = selectedSnacks.length > 0 ?
        `${selectedSnacks.length} items (RM${snacksFee})` : 'No snacks';
      document.getElementById('summaryDiscount').textContent = `- RM ${discount.toFixed(2)}`;
      document.getElementById('summaryLoyaltyDiscount').textContent = `- RM ${loyaltyDiscount.toFixed(2)}`;
      document.getElementById('summarySubtotal').textContent = `RM ${subtotalBeforeLoyalty.toFixed(2)}`;
      document.getElementById('summaryTotal').textContent = `RM ${total.toFixed(2)}`;
    }

    // Reset booking process
    function resetBookingProcess() {
      selectedFacility = null;
      selectedDate = null;
      selectedTimeSlot = null;
      selectedCoach = null;
      selectedSnacks = [];
      currentMonth = new Date().getMonth();
      currentYear = new Date().getFullYear();
      goToStep(1);
    }

    // Initialize Find Friends Page
    async function initializeFindFriendsPage() {
      await loadAllUsers();
      await loadSuggestedFriends();
      await loadActiveChats();

      // Search functionality
      document.getElementById('searchFriendsBtn').addEventListener('click', handleFriendSearch);
      document.getElementById('friendSearch').addEventListener('input', handleFriendSearch);
      document.getElementById('friendFilter').addEventListener('change', handleFriendSearch);

      // Chat modal event listeners
      document.getElementById('sendMessageBtn').addEventListener('click', sendMessage);
      document.getElementById('messageInput').addEventListener('keypress', function (e) {
        if (e.key === 'Enter') {
          sendMessage();
        }
      });

      // Add event listener for chat buttons
      document.addEventListener('click', function (e) {
        if (e.target && e.target.classList.contains('start-chat-btn')) {
          const userId = e.target.getAttribute('data-user-id');
          const userName = e.target.getAttribute('data-user-name');
          startNewChat(userId, userName);
        }
      });

      // Emoji picker functionality
      document.getElementById('emojiBtn').addEventListener('click', function () {
        const emojiPicker = document.getElementById('emojiPicker');
        emojiPicker.classList.toggle('show');
      });

      // Close emoji picker when clicking outside
      document.addEventListener('click', function (e) {
        if (!e.target.closest('#emojiPicker') && !e.target.closest('#emojiBtn')) {
          document.getElementById('emojiPicker').classList.remove('show');
        }
      });

      // Add emoji to message input
      document.querySelectorAll('.emoji-option').forEach(emoji => {
        emoji.addEventListener('click', function () {
          const emojiChar = this.getAttribute('data-emoji');
          const messageInput = document.getElementById('messageInput');
          messageInput.value += emojiChar;
          document.getElementById('emojiPicker').classList.remove('show');
          messageInput.focus();
        });
      });
    }

    // Load all users except current user and admins
    async function loadAllUsers(searchTerm = '', filter = 'all') {
      try {
        const usersSnapshot = await db.collection('users').get();
        const allUsersList = document.getElementById('allUsersList');
        allUsersList.innerHTML = '';

        if (usersSnapshot.empty) {
          allUsersList.innerHTML = '<div class="text-center p-3">No users found</div>';
          return;
        }

        const currentUserData = window.userProfileData || {};
        const users = [];

        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          // Skip current user and admins
          if (doc.id !== currentUser.uid && userData.role !== 'admin') {
            users.push({
              id: doc.id,
              ...userData
            });
          }
        });

        // Apply filters and search
        let filteredUsers = users.filter(user => {
          // Search filter
          const matchesSearch = !searchTerm ||
            user.name?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            user.primarySport?.toLowerCase().includes(searchTerm.toLowerCase()) ||
            user.skillLevel?.toLowerCase().includes(searchTerm.toLowerCase());

          // Additional filters
          let matchesFilter = true;
          if (filter === 'sameSport' && currentUserData.primarySport) {
            matchesFilter = user.primarySport === currentUserData.primarySport;
          } else if (filter === 'sameLevel' && currentUserData.skillLevel) {
            matchesFilter = user.skillLevel === currentUserData.skillLevel;
          } else if (filter === 'sameLocation' && currentUserData.location) {
            matchesFilter = user.location === currentUserData.location;
          }

          return matchesSearch && matchesFilter;
        });

        if (filteredUsers.length === 0) {
          allUsersList.innerHTML = '<div class="text-center p-3">No users match your criteria</div>';
          return;
        }

        // Render users
        filteredUsers.forEach(user => {
          const userCard = createUserCard(user, false);
          allUsersList.appendChild(userCard);
        });

      } catch (error) {
        console.error('Error loading users:', error);
        showToast('Error loading users', 'danger');
      }
    }

    // Load suggested friends based on similarities
    async function loadSuggestedFriends() {
      try {
        const usersSnapshot = await db.collection('users').get();
        const suggestedFriendsEl = document.getElementById('suggestedFriends');
        suggestedFriendsEl.innerHTML = '';

        if (usersSnapshot.empty) {
          suggestedFriendsEl.innerHTML = '<div class="text-center p-3">No suggestions available</div>';
          return;
        }

        const currentUserData = window.userProfileData || {};
        const users = [];

        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          // Skip current user and admins
          if (doc.id !== currentUser.uid && userData.role !== 'admin') {
            users.push({
              id: doc.id,
              ...userData,
              similarityScore: calculateSimilarityScore(currentUserData, userData)
            });
          }
        });

        // Sort by similarity score and take top 5
        const suggestedUsers = users
          .sort((a, b) => b.similarityScore - a.similarityScore)
          .slice(0, 5);

        if (suggestedUsers.length === 0) {
          suggestedFriendsEl.innerHTML = '<div class="text-center p-3">No suggestions available</div>';
          return;
        }

        // Render suggested friends
        suggestedUsers.forEach(user => {
          const userCard = createUserCard(user, true);
          suggestedFriendsEl.appendChild(userCard);
        });

      } catch (error) {
        console.error('Error loading suggested friends:', error);
      }
    }

    // Calculate similarity score between current user and another user
    function calculateSimilarityScore(currentUser, otherUser) {
      let score = 0;

      // Same sport (highest weight)
      if (currentUser.primarySport && otherUser.primarySport &&
        currentUser.primarySport === otherUser.primarySport) {
        score += 40;
      }

      // Same skill level
      if (currentUser.skillLevel && otherUser.skillLevel &&
        currentUser.skillLevel === otherUser.skillLevel) {
        score += 30;
      }

      // Same location
      if (currentUser.location && otherUser.location &&
        currentUser.location === otherUser.location) {
        score += 20;
      }

      // Similar age (within 5 years)
      if (currentUser.age && otherUser.age) {
        const ageDiff = Math.abs(currentUser.age - otherUser.age);
        if (ageDiff <= 5) {
          score += 10;
        }
      }

      return score;
    }

    // Create user card component
    function createUserCard(user, isSuggested = false) {
      const userCard = document.createElement('div');
      userCard.className = 'friend-card';

      const skillLevelClass = user.skillLevel ?
        `skill-level ${user.skillLevel.toLowerCase()}` : 'skill-level beginner';

      const skillLevelText = user.skillLevel ?
        user.skillLevel.charAt(0).toUpperCase() + user.skillLevel.slice(1) : 'Beginner';

      // Use a placeholder image instead of trying to generate one
      const avatarUrl = user.photoURL || 'https://via.placeholder.com/60';

      userCard.innerHTML = `
    <div class="d-flex align-items-center">
      <img src="${avatarUrl}" 
           class="friend-avatar me-3" alt="${user.name}" 
           style="width: 60px; height: 60px; object-fit: cover; border-radius: 50%;"
           onerror="this.src='https://via.placeholder.com/60'">
      <div class="flex-grow-1">
        <h6 class="mb-1">${user.name || 'User'}</h6>
        <p class="mb-1 text-muted">
          <i class="fas fa-map-marker-alt me-1"></i>
          ${user.location || 'Location not set'}
        </p>
        <p class="mb-1">
          <span class="${skillLevelClass}">${skillLevelText}</span>
          ${user.primarySport ? `<span class="badge bg-secondary ms-1">${user.primarySport}</span>` : ''}
        </p>
        ${isSuggested ? `<small class="text-success"><i class="fas fa-star me-1"></i>Suggested</small>` : ''}
      </div>
      <div>
        <button class="btn btn-sm btn-outline-primary start-chat-btn" data-user-id="${user.id}" data-user-name="${user.name || 'User'}">
          <i class="fas fa-comment"></i> Chat
        </button>
      </div>
    </div>
  `;

      return userCard;
    }

    // Handle friend search and filtering
    function handleFriendSearch() {
      const searchTerm = document.getElementById('friendSearch').value;
      const filter = document.getElementById('friendFilter').value;
      loadAllUsers(searchTerm, filter);
    }

    // Load active chats for current user
    async function loadActiveChats() {
      try {
        const activeChatsEl = document.getElementById('activeChats');
        activeChatsEl.innerHTML = '';

        // Get all chats where current user is a participant
        const chatsSnapshot = await db.collection('chats')
          .where('participants', 'array-contains', currentUser.uid)
          .orderBy('lastMessageAt', 'desc')
          .limit(5)
          .get();

        if (chatsSnapshot.empty) {
          activeChatsEl.innerHTML = '<div class="text-center p-3">No active chats</div>';
          return;
        }

        // Get user data for each chat participant
        const chatPromises = chatsSnapshot.docs.map(async (doc) => {
          const chatData = doc.data();
          const otherParticipantId = chatData.participants.find(id => id !== currentUser.uid);

          if (otherParticipantId) {
            const userDoc = await db.collection('users').doc(otherParticipantId).get();
            return {
              chatId: doc.id,
              otherUser: userDoc.exists ? userDoc.data() : { name: 'Unknown User' },
              lastMessage: chatData.lastMessage,
              lastMessageAt: chatData.lastMessageAt
            };
          }
          return null;
        });

        const chats = (await Promise.all(chatPromises)).filter(chat => chat !== null);

        // Render active chats
        chats.forEach(chat => {
          const chatItem = document.createElement('div');
          chatItem.className = 'list-group-item list-group-item-action';
          chatItem.style.cursor = 'pointer';

          const lastMessageTime = chat.lastMessageAt ?
            formatMessageTime(chat.lastMessageAt.toDate()) : 'No messages';

          // In loadActiveChats() function, replace the avatar line with:
          chatItem.innerHTML = `
  <div class="d-flex align-items-center">
    <img src="${chat.otherUser.photoURL || 'https://via.placeholder.com/40'}" 
         class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;" 
         onerror="this.src='https://via.placeholder.com/40'">
    <div class="flex-grow-1">
      <h6 class="mb-1">${chat.otherUser.name || 'User'}</h6>
      <p class="mb-1 text-muted small">${chat.lastMessage || 'Start a conversation'}</p>
      <small class="text-muted">${lastMessageTime}</small>
    </div>
  </div>
`;

          chatItem.addEventListener('click', () => openChat(chat.chatId, chat.otherUser));
          activeChatsEl.appendChild(chatItem);
        });

      } catch (error) {
        console.error('Error loading active chats:', error);
      }
    }

    // Format message time
    function formatMessageTime(timestamp) {
      const now = new Date();
      const messageTime = new Date(timestamp);
      const diffInHours = (now - messageTime) / (1000 * 60 * 60);

      if (diffInHours < 1) {
        return 'Just now';
      } else if (diffInHours < 24) {
        return `${Math.floor(diffInHours)}h ago`;
      } else {
        return messageTime.toLocaleDateString();
      }
    }

    // Open chat with a user
    async function openChat(chatId, otherUser) {
      const chatModal = new bootstrap.Modal(document.getElementById('chatModal'));
      const chatUserName = document.getElementById('chatUserName');
      const chatUserAvatar = document.getElementById('chatUserAvatar');
      const chatUserStatus = document.getElementById('chatUserStatus');

      // Store current chat info
      window.currentChat = {
        chatId,
        otherUser,
        otherUserId: otherUser.id
      };

      // Update chat header
      chatUserName.textContent = otherUser.name || 'User';
      chatUserAvatar.src = otherUser.photoURL || generateDefaultAvatar(otherUser.name || 'User');
      chatUserStatus.textContent = 'Online'; // You can implement real status updates

      // Load messages
      await loadChatMessages(chatId);

      // Set up real-time listener for new messages
      setupChatListener(chatId);

      // Set up typing indicator listener
      setupTypingListener(chatId);

      chatModal.show();

      // Focus on message input
      setTimeout(() => {
        document.getElementById('messageInput').focus();
      }, 300);
    }

    // Start a new chat with a user
    async function startNewChat(otherUserId, otherUserName) {
      try {
        // Check if chat already exists
        const existingChatSnapshot = await db.collection('chats')
          .where('participants', 'array-contains', currentUser.uid)
          .get();

        let existingChat = null;
        existingChatSnapshot.forEach(doc => {
          const chatData = doc.data();
          if (chatData.participants.includes(otherUserId)) {
            existingChat = { id: doc.id, ...chatData };
          }
        });

        if (existingChat) {
          // Open existing chat
          openChat(existingChat.id, { id: otherUserId, name: otherUserName });
        } else {
          // Create new chat
          const chatData = {
            participants: [currentUser.uid, otherUserId],
            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastMessage: '',
            lastMessageAt: firebase.firestore.FieldValue.serverTimestamp()
          };

          const chatRef = await db.collection('chats').add(chatData);
          openChat(chatRef.id, { id: otherUserId, name: otherUserName });
        }
      } catch (error) {
        console.error('Error starting chat:', error);
        showToast('Error starting chat', 'danger');
      }
    }

    // Enhanced message loading with date separators
    async function loadChatMessages(chatId) {
      try {
        const messagesSnapshot = await db.collection('chats')
          .doc(chatId)
          .collection('messages')
          .orderBy('timestamp', 'asc')
          .get();

        const chatMessages = document.getElementById('chatMessages');
        chatMessages.innerHTML = '';

        if (messagesSnapshot.empty) {
          chatMessages.innerHTML = `
            <div class="text-center text-white" style="padding: 2rem;">
              <i class="fas fa-comments fa-3x mb-3 opacity-50"></i>
              <p>No messages yet</p>
              <small class="opacity-75">Start the conversation!</small>
            </div>
          `;
          return;
        }

        let lastDate = null;

        messagesSnapshot.forEach(doc => {
          const message = doc.data();
          const messageDate = message.timestamp?.toDate().toDateString();

          // Add date separator if date changed
          if (messageDate !== lastDate) {
            addDateSeparator(message.timestamp?.toDate());
            lastDate = messageDate;
          }

          addMessageToChat(message, doc.id);
        });

        // Scroll to bottom
        scrollToBottom();
      } catch (error) {
        console.error('Error loading messages:', error);
      }
    }

    // Add date separator
    function addDateSeparator(date) {
      const chatMessages = document.getElementById('chatMessages');
      const separator = document.createElement('div');
      separator.className = 'chat-date-separator';

      const today = new Date();
      const yesterday = new Date(today);
      yesterday.setDate(yesterday.getDate() - 1);

      let dateText;
      if (date.toDateString() === today.toDateString()) {
        dateText = 'Today';
      } else if (date.toDateString() === yesterday.toDateString()) {
        dateText = 'Yesterday';
      } else {
        dateText = date.toLocaleDateString('en-US', {
          weekday: 'long',
          year: 'numeric',
          month: 'long',
          day: 'numeric'
        });
      }

      separator.innerHTML = `<span>${dateText}</span>`;
      chatMessages.appendChild(separator);
    }

    // Typing indicator functionality
    function setupTypingListener(chatId) {
      const typingRef = db.collection('chats').doc(chatId);

      // Listen for typing indicators
      typingRef.onSnapshot((doc) => {
        const data = doc.data();
        if (data && data.typing && data.typing.userId !== currentUser.uid) {
          showTypingIndicator(data.typing.userName);
        } else {
          hideTypingIndicator();
        }
      });
    }

    function showTypingIndicator(userName) {
      const typingIndicator = document.getElementById('typingIndicator');
      const typingUserName = document.getElementById('typingUserName');

      typingUserName.textContent = userName;
      typingIndicator.style.display = 'block';

      // Add animated dots
      const dots = document.createElement('span');
      dots.className = 'typing-dots';
      dots.innerHTML = `
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
        <span class="typing-dot"></span>
      `;

      typingIndicator.querySelector('small').appendChild(dots);
    }

    function hideTypingIndicator() {
      const typingIndicator = document.getElementById('typingIndicator');
      typingIndicator.style.display = 'none';
    }

    // Enhanced send message with typing indicator
    let typingTimer;
    const TYPING_TIMEOUT = 3000;

    // Set up real-time listener for chat messages
    function setupChatListener(chatId) {
      // Remove existing listener if any
      if (window.chatListener) {
        window.chatListener();
      }

      window.chatListener = db.collection('chats')
        .doc(chatId)
        .collection('messages')
        .orderBy('timestamp', 'asc')
        .onSnapshot((snapshot) => {
          snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') {
              const message = change.doc.data();
              addMessageToChat(message, change.doc.id);

              // Scroll to bottom
              const chatMessages = document.getElementById('chatMessages');
              chatMessages.scrollTop = chatMessages.scrollHeight;
            }
          });
        });
    }

    // Enhanced message display
    function addMessageToChat(message, messageId) {
      const chatMessages = document.getElementById('chatMessages');

      // Remove empty state if present
      const emptyState = chatMessages.querySelector('.text-center');
      if (emptyState) {
        emptyState.remove();
      }

      const messageContainer = document.createElement('div');
      messageContainer.className = `message-container ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;

      const messageBubble = document.createElement('div');
      messageBubble.className = `message-bubble ${message.senderId === currentUser.uid ? 'sent' : 'received'}`;

      const messageTime = formatMessageTime(message.timestamp?.toDate());
      const statusIcon = message.senderId === currentUser.uid ?
        '<i class="fas fa-check message-status"></i>' : '';

      messageBubble.innerHTML = `
        <div class="message-text">${message.text}</div>
        <div class="message-time">
          ${messageTime}
          ${statusIcon}
        </div>
        ${message.reactions ? `
          <div class="message-reactions">
            ${Object.entries(message.reactions).map(([emoji, users]) =>
        `<span class="reaction" title="${users.join(', ')}">${emoji} ${users.length}</span>`
      ).join('')}
          </div>
        ` : ''}
      `;

      messageContainer.appendChild(messageBubble);
      chatMessages.appendChild(messageContainer);

      // Auto-scroll to bottom for new messages
      if (message.senderId === currentUser.uid || !chatMessages.scrollTop) {
        scrollToBottom();
      }
    }

    // Scroll to bottom of chat
    function scrollToBottom() {
      const chatMessages = document.getElementById('chatMessages');
      chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // Enhanced sendMessage function with notifications
    async function sendMessage() {
      const messageInput = document.getElementById('messageInput');
      const messageText = messageInput.value.trim();

      if (!messageText || !window.currentChat) return;

      try {
        // Clear typing indicator
        await updateTypingIndicator(false);

        const messageData = {
          text: messageText,
          senderId: currentUser.uid,
          senderName: currentUser.displayName || 'User',
          timestamp: firebase.firestore.FieldValue.serverTimestamp(),
          read: false
        };

        // Add message to subcollection
        await db.collection('chats')
          .doc(window.currentChat.chatId)
          .collection('messages')
          .add(messageData);

        // Update chat last message and timestamp
        await db.collection('chats')
          .doc(window.currentChat.chatId)
          .update({
            lastMessage: messageText,
            lastMessageAt: firebase.firestore.FieldValue.serverTimestamp(),
            lastMessageSender: currentUser.uid
          });

        // Create notification for the recipient
        const otherUserId = window.currentChat.otherUser.id;
        await createNotification(
          otherUserId,
          'new_message',
          'New Message',
          `You have a new message from ${currentUser.displayName || 'User'}`,
          {
            chatId: window.currentChat.chatId,
            senderId: currentUser.uid,
            senderName: currentUser.displayName || 'User',
            message: messageText.substring(0, 100) // First 100 chars
          }
        );

        // Clear input
        messageInput.value = '';

      } catch (error) {
        console.error('Error sending message:', error);
        showToast('Error sending message', 'danger');
      }
    }
    // Enhanced message time formatting
    function formatMessageTime(timestamp) {
      if (!timestamp) return '';

      const now = new Date();
      const messageTime = new Date(timestamp);
      const diffInMinutes = (now - messageTime) / (1000 * 60);

      if (diffInMinutes < 1) {
        return 'Just now';
      } else if (diffInMinutes < 60) {
        return `${Math.floor(diffInMinutes)}m ago`;
      } else if (diffInMinutes < 1440) {
        return messageTime.toLocaleTimeString('en-US', {
          hour: 'numeric',
          minute: '2-digit',
          hour12: true
        });
      } else {
        return messageTime.toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric'
        });
      }
    }

    // Add event listeners for chat actions
    document.getElementById('callBtn').addEventListener('click', function () {
      showToast('Voice call feature coming soon!', 'info');
    });

    document.getElementById('videoCallBtn').addEventListener('click', function () {
      showToast('Video call feature coming soon!', 'info');
    });

    document.getElementById('attachBtn').addEventListener('click', function () {
      showToast('File attachment feature coming soon!', 'info');
    });

    // Typing indicator management
    async function updateTypingIndicator(isTyping) {
      if (!window.currentChat) return;

      try {
        await db.collection('chats')
          .doc(window.currentChat.chatId)
          .update({
            typing: isTyping ? {
              userId: currentUser.uid,
              userName: currentUser.displayName || 'User',
              timestamp: firebase.firestore.FieldValue.serverTimestamp()
            } : null
          });
      } catch (error) {
        console.error('Error updating typing indicator:', error);
      }
    }

    // Add typing detection
    document.getElementById('messageInput').addEventListener('input', function () {
      if (!window.currentChat) return;

      // Clear existing timer
      clearTimeout(typingTimer);

      // Start typing indicator
      updateTypingIndicator(true);

      // Set timer to stop typing indicator
      typingTimer = setTimeout(() => {
        updateTypingIndicator(false);
      }, TYPING_TIMEOUT);
    });

    // Initialize Marketplace Page
    async function initializeMarketplacePage() {
      try {
        await loadMarketplaceItems();

        // Set up event listeners
        document.getElementById('listItemBtn').addEventListener('click', listNewItem);
        document.getElementById('filterCategory').addEventListener('change', filterItems);
        document.getElementById('filterCondition').addEventListener('change', filterItems);
        document.getElementById('filterPrice').addEventListener('change', filterItems);
        document.getElementById('filterStatus').addEventListener('change', filterItems);

      } catch (error) {
        console.error('Error initializing marketplace:', error);
        showToast('Error initializing marketplace', 'danger');
      }
    }

    // Load marketplace items from Firestore
    async function loadMarketplaceItems(filters = {}) {
      try {
        console.log('Loading marketplace items with filters:', filters);

        let itemsQuery = db.collection('marketplace');

        // Apply filters
        if (filters.category && filters.category !== 'all') {
          itemsQuery = itemsQuery.where('category', '==', filters.category);
        }

        if (filters.condition && filters.condition !== 'all') {
          itemsQuery = itemsQuery.where('condition', '==', filters.condition);
        }

        if (filters.status && filters.status !== 'all') {
          itemsQuery = itemsQuery.where('status', '==', filters.status);
        } else {
          // Default to available items
          itemsQuery = itemsQuery.where('status', '==', 'available');
        }

        const itemsSnapshot = await itemsQuery.orderBy('createdAt', 'desc').get();
        const marketplaceItems = document.getElementById('marketplaceItems');

        if (!marketplaceItems) {
          console.error('Marketplace items container not found');
          return;
        }

        marketplaceItems.innerHTML = '';

        if (itemsSnapshot.empty) {
          console.log('No marketplace items found');
          marketplaceItems.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No items found. Be the first to list an item!
          </div>
        </div>
      `;
          return;
        }

        const itemsData = [];

        itemsSnapshot.forEach(doc => {
          const item = doc.data();
          itemsData.push({
            id: doc.id,
            ...item,
            // Ensure all required fields have default values
            name: item.name || 'Unnamed Item',
            price: item.price || 0,
            condition: item.condition || 'good',
            category: item.category || 'other',
            description: item.description || 'No description provided',
            sellerName: item.sellerName || 'Unknown Seller',
            sellerContact: item.sellerContact || 'Not provided',
            status: item.status || 'available'
          });
        });

        // Apply price filter
        let filteredItems = itemsData;
        if (filters.price && filters.price !== 'all') {
          filteredItems = itemsData.filter(item => {
            const price = item.price || 0;
            switch (filters.price) {
              case '0-50': return price <= 50;
              case '51-100': return price >= 51 && price <= 100;
              case '101-200': return price >= 101 && price <= 200;
              case '201-500': return price >= 201 && price <= 500;
              case '501+': return price >= 501;
              default: return true;
            }
          });
        }

        if (filteredItems.length === 0) {
          marketplaceItems.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-warning">
            <i class="fas fa-search me-2"></i>
            No items match your filters.
          </div>
        </div>
      `;
          return;
        }

        // Render items
        renderMarketplaceItems(filteredItems);

      } catch (error) {
        console.error('Error loading marketplace items:', error);
        const marketplaceItems = document.getElementById('marketplaceItems');
        if (marketplaceItems) {
          marketplaceItems.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            Error loading marketplace items: ${error.message}
          </div>
        </div>
      `;
        }
        showToast('Error loading marketplace items', 'danger');
      }
    }

    // In the renderMarketplaceItems function, update the contact section:
    function renderMarketplaceItems(items) {
      const marketplaceItems = document.getElementById('marketplaceItems');
      marketplaceItems.innerHTML = '';

      items.forEach(item => {
        const col = document.createElement('div');
        col.className = 'col-md-4 mb-4';

        const isOwner = item.sellerId === currentUser.uid;
        const isSold = item.status === 'sold';

        col.innerHTML = `
      <div class="product-card card h-100 ${isSold ? 'opacity-75' : ''}">
        ${isSold ? '<div class="sold-badge">SOLD</div>' : ''}
        <img src="${item.imageUrl || 'https://via.placeholder.com/300x200?text=No+Image'}" 
             class="card-img-top" alt="${item.name}"
             style="height: 200px; object-fit: cover;"
             onerror="this.src='https://via.placeholder.com/300x200?text=No+Image'">
        <div class="card-body d-flex flex-column">
          <div class="d-flex justify-content-between align-items-start mb-2">
            <h5 class="card-title">${item.name}</h5>
            <span class="badge bg-secondary text-capitalize">${item.category}</span>
          </div>
          <p class="card-text flex-grow-1">${item.description}</p>
          <div class="mb-2">
            <span class="badge ${getConditionBadgeClass(item.condition)} text-capitalize">${item.condition}</span>
            <small class="text-muted ms-2"><i class="fas fa-user"></i> ${item.sellerName}</small>
          </div>
          
          <!-- Contact Details -->
          <div class="contact-details">
            <div class="contact-label">Contact:</div>
            <div>${item.sellerContact || 'Not provided'}</div>
            ${!isOwner && !isSold && item.sellerContact ? `
              <div class="mt-2">
                <button class="btn btn-sm btn-success whatsapp-btn" 
                        data-contact="${item.sellerContact}" 
                        data-item="${item.name}"
                        data-seller="${item.sellerName}">
                  <i class="fab fa-whatsapp me-1"></i> Contact via WhatsApp
                </button>
              </div>
            ` : ''}
          </div>
          
          ${isSold && item.buyerContact ? `
          <div class="contact-details mt-2">
            <div class="contact-label">Buyer Contact:</div>
            <div>${item.buyerContact}</div>
            ${isOwner ? `
              <div class="mt-2">
                <button class="btn btn-sm btn-success whatsapp-btn" 
                        data-contact="${item.buyerContact}" 
                        data-item="${item.name}"
                        data-buyer="${item.buyerName}">
                  <i class="fab fa-whatsapp me-1"></i> Contact Buyer
                </button>
              </div>
            ` : ''}
          </div>
          ` : ''}
          
          <div class="mt-auto">
            <div class="d-flex justify-content-between align-items-center">
              <span class="h5 text-primary mb-0">RM${item.price}</span>
              <div>
                ${isOwner ? `
                  ${!isSold ? `
                    <button class="btn btn-sm btn-success mark-sold-btn" data-id="${item.id}">
                      <i class="fas fa-check"></i> Mark Sold
                    </button>
                  ` : ''}
                  <button class="btn btn-sm btn-outline-danger delete-item-btn" data-id="${item.id}">
                    <i class="fas fa-trash"></i>
                  </button>
                ` : `
                  ${!isSold ? `
                    <button class="btn btn-sm btn-primary buy-item-btn" data-id="${item.id}">
                      <i class="fas fa-shopping-cart"></i> Buy
                    </button>
                  ` : `
                    <span class="badge bg-danger">Sold</span>
                  `}
                `}
              </div>
            </div>
            ${item.createdAt ? `
              <small class="text-muted">
                Listed ${formatTimeAgo(item.createdAt.toDate())}
              </small>
            ` : ''}
          </div>
        </div>
      </div>
    `;

        marketplaceItems.appendChild(col);
      });

      // Add event listeners to WhatsApp buttons
      addWhatsAppEventListeners();
    }
    // Add event listeners to marketplace buttons
    function addMarketplaceEventListeners() {
      // Buy item buttons
      document.querySelectorAll('.buy-item-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const itemId = this.getAttribute('data-id');
          buyItem(itemId);
        });
      });

      // Mark as sold buttons
      document.querySelectorAll('.mark-sold-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const itemId = this.getAttribute('data-id');
          markItemAsSold(itemId);
        });
      });

      // Delete item buttons
      document.querySelectorAll('.delete-item-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const itemId = this.getAttribute('data-id');
          deleteItem(itemId);
        });
      });
    }

    // Helper function for condition badge classes
    function getConditionBadgeClass(condition) {
      const conditionClasses = {
        'new': 'bg-success',
        'excellent': 'bg-info',
        'good': 'bg-primary',
        'fair': 'bg-warning'
      };
      return conditionClasses[condition] || 'bg-secondary';
    }

    // Format time ago
    function formatTimeAgo(date) {
      const now = new Date();
      const diffInSeconds = Math.floor((now - date) / 1000);

      if (diffInSeconds < 60) return 'just now';
      if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)} minutes ago`;
      if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)} hours ago`;
      if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)} days ago`;

      return date.toLocaleDateString();
    }

    // List a new item in marketplace
    async function listNewItem() {
      try {
        const itemName = document.getElementById('itemName').value.trim();
        const itemPrice = parseFloat(document.getElementById('itemPrice').value);
        const itemCondition = document.getElementById('itemCondition').value;
        const itemCategory = document.getElementById('itemCategory').value;
        const itemImageUrl = document.getElementById('itemImageUrl').value.trim();
        const itemDescription = document.getElementById('itemDescription').value.trim();
        const contactNumber = document.getElementById('contactNumber').value.trim();

        // Validation
        if (!itemName) {
          showToast('Please enter item name', 'warning');
          return;
        }

        if (!itemPrice || itemPrice <= 0) {
          showToast('Please enter a valid price greater than 0', 'warning');
          return;
        }

        if (!itemDescription) {
          showToast('Please enter item description', 'warning');
          return;
        }

        if (!contactNumber) {
          showToast('Please enter your contact number', 'warning');
          return;
        }

        const itemData = {
          name: itemName,
          price: itemPrice,
          condition: itemCondition,
          category: itemCategory,
          imageUrl: itemImageUrl || 'https://via.placeholder.com/300x200?text=No+Image',
          description: itemDescription,
          sellerId: currentUser.uid,
          sellerName: currentUser.displayName || 'User',
          sellerContact: contactNumber,
          status: 'available',
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('marketplace').add(itemData);

        showToast('Item listed successfully!', 'success');

        // Clear form
        document.getElementById('itemName').value = '';
        document.getElementById('itemPrice').value = '';
        document.getElementById('itemImageUrl').value = '';
        document.getElementById('itemDescription').value = '';
        document.getElementById('contactNumber').value = '';

        await loadMarketplaceItems();

      } catch (error) {
        console.error('Error listing item:', error);
        showToast('Error listing item: ' + error.message, 'danger');
      }
    }

    // Update the buyItem function
    async function buyItem(itemId) {
      try {
        const itemDoc = await db.collection('marketplace').doc(itemId).get();
        if (!itemDoc.exists) {
          showToast('Item not found', 'danger');
          return;
        }

        const item = itemDoc.data();

        if (item.sellerId === currentUser.uid) {
          showToast('You cannot buy your own item', 'warning');
          return;
        }

        if (item.status === 'sold') {
          showToast('This item has already been sold', 'warning');
          return;
        }

        // Get buyer contact number
        const buyerContact = prompt('Please enter your contact number for the seller:');
        if (!buyerContact) {
          showToast('Contact number is required to complete purchase', 'warning');
          return;
        }

        const confirmBuy = confirm(`Are you sure you want to buy "${item.name}" for RM${item.price}?`);
        if (!confirmBuy) return;

        // Update item status
        await db.collection('marketplace').doc(itemId).update({
          status: 'sold',
          buyerId: currentUser.uid,
          buyerName: currentUser.displayName || 'User',
          buyerContact: buyerContact,
          soldAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Create transaction record
        await db.collection('transactions').add({
          itemId: itemId,
          itemName: item.name,
          sellerId: item.sellerId,
          sellerName: item.sellerName,
          buyerId: currentUser.uid,
          buyerName: currentUser.displayName || 'User',
          price: item.price,
          status: 'completed',
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('Purchase successful! Contact the seller to arrange pickup/delivery.', 'success');

        // Auto-open WhatsApp to contact seller
        if (item.sellerContact) {
          const confirmWhatsApp = confirm('Would you like to contact the seller via WhatsApp to arrange pickup/delivery?');
          if (confirmWhatsApp) {
            const message = `Hi ${item.sellerName}! I just purchased your "${item.name}" on Sportova Marketplace. My contact number is ${buyerContact}. Let's arrange for pickup/delivery.`;
            openWhatsAppWithMessage(item.sellerContact, message);
          }
        }

        // Reload items
        await loadMarketplaceItems();

      } catch (error) {
        console.error('Error buying item:', error);
        showToast('Error processing purchase', 'danger');
      }
    }
    // Add this function to handle WhatsApp button clicks
    function addWhatsAppEventListeners() {
      document.querySelectorAll('.whatsapp-btn').forEach(btn => {
        btn.addEventListener('click', function () {
          const contact = this.getAttribute('data-contact');
          const itemName = this.getAttribute('data-item');
          const sellerName = this.getAttribute('data-seller');
          const buyerName = this.getAttribute('data-buyer');

          const contactName = sellerName || buyerName;
          openWhatsApp(contact, itemName, contactName);
        });
      });
    }

    // Function to open WhatsApp with pre-filled message
    function openWhatsApp(contactNumber, itemName, contactName) {
      // Clean the contact number (remove spaces, dashes, etc.)
      const cleanNumber = contactNumber.replace(/[\s\-\(\)\+]/g, '');

      // Create the message
      const message = `Hi${contactName ? ' ' + contactName : ''}! I'm interested in your item "${itemName}" on Sportova Marketplace. Could you provide more details?`;

      // Encode the message for URL
      const encodedMessage = encodeURIComponent(message);

      // Create WhatsApp URL
      const whatsappUrl = `https://wa.me/${cleanNumber}?text=${encodedMessage}`;

      // Open in new tab
      window.open(whatsappUrl, '_blank');
    }

    // Helper function for WhatsApp with custom message
    function openWhatsAppWithMessage(contactNumber, message) {
      const cleanNumber = contactNumber.replace(/[\s\-\(\)\+]/g, '');
      const encodedMessage = encodeURIComponent(message);
      const whatsappUrl = `https://wa.me/${cleanNumber}?text=${encodedMessage}`;
      window.open(whatsappUrl, '_blank');
    }

    // Mark item as sold (for sellers)
    async function markItemAsSold(itemId) {
      try {
        const itemDoc = await db.collection('marketplace').doc(itemId).get();
        if (!itemDoc.exists) {
          showToast('Item not found', 'danger');
          return;
        }

        const item = itemDoc.data();

        if (item.sellerId !== currentUser.uid) {
          showToast('You can only mark your own items as sold', 'warning');
          return;
        }

        const confirmSold = confirm('Mark this item as sold?');
        if (!confirmSold) return;

        await db.collection('marketplace').doc(itemId).update({
          status: 'sold',
          soldAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showToast('Item marked as sold', 'success');
        await loadMarketplaceItems();

      } catch (error) {
        console.error('Error marking item as sold:', error);
        showToast('Error updating item', 'danger');
      }
    }

    // Delete item (for sellers)
    async function deleteItem(itemId) {
      try {
        const itemDoc = await db.collection('marketplace').doc(itemId).get();
        if (!itemDoc.exists) {
          showToast('Item not found', 'danger');
          return;
        }

        const item = itemDoc.data();

        if (item.sellerId !== currentUser.uid) {
          showToast('You can only delete your own items', 'warning');
          return;
        }

        const confirmDelete = confirm('Are you sure you want to delete this item?');
        if (!confirmDelete) return;

        await db.collection('marketplace').doc(itemId).delete();
        showToast('Item deleted successfully', 'success');
        await loadMarketplaceItems();

      } catch (error) {
        console.error('Error deleting item:', error);
        showToast('Error deleting item', 'danger');
      }
    }

    // Filter items
    async function filterItems() {
      const filters = {
        category: document.getElementById('filterCategory').value,
        condition: document.getElementById('filterCondition').value,
        price: document.getElementById('filterPrice').value,
        status: document.getElementById('filterStatus').value
      };

      await loadMarketplaceItems(filters);
    }

    // Initialize Community Page
    async function initializeCommunityPage() {
      try {
        await loadCommunityPosts();
        await loadCommunityStats();
        await loadTopPlayers();

        // Set up event listeners
        document.getElementById('createPostBtn').addEventListener('click', createPost);

      } catch (error) {
        console.error('Error initializing community page:', error);
        showToast('Error loading community posts', 'danger');
      }
    }

    // Load community posts
    async function loadCommunityPosts() {
      try {
        const postsSnapshot = await db.collection('posts')
          .orderBy('createdAt', 'desc')
          .get();

        const communityPosts = document.getElementById('communityPosts');
        communityPosts.innerHTML = '';

        if (postsSnapshot.empty) {
          communityPosts.innerHTML = `
        <div class="col-12 text-center">
          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            No posts yet. Be the first to share something!
          </div>
        </div>
      `;
          return;
        }

        const postsData = [];

        postsSnapshot.forEach(doc => {
          const post = doc.data();
          postsData.push({
            id: doc.id,
            ...post
          });
        });

        // Render posts
        postsData.forEach(post => {
          const postElement = createPostElement(post);
          communityPosts.appendChild(postElement);
        });

      } catch (error) {
        console.error('Error loading posts:', error);
        showToast('Error loading posts', 'danger');
      }
    }


    // Create post element with emoji reactions
    function createPostElement(post) {
      const postDiv = document.createElement('div');
      postDiv.className = 'post-card';
      postDiv.id = `post-${post.id}`;

      const mediaHtml = post.photoUrl ? `
    <img src="${post.photoUrl}" class="media mb-3" alt="Post image" onerror="this.style.display='none'">
  ` : post.videoUrl ? `
    <video src="${post.videoUrl}" class="media mb-3" controls onerror="this.style.display='none'"></video>
  ` : '';

      // Get user's current reaction if any
      const userReaction = post.reactions ?
        Object.keys(post.reactions).find(emoji => post.reactions[emoji].includes(currentUser.uid)) : null;

      postDiv.innerHTML = `
    <div class="d-flex align-items-center mb-3">
      <img src="${post.userPhotoUrl || generateDefaultAvatar(post.userName || 'User')}" 
           class="rounded-circle me-3" width="50" height="50" style="object-fit: cover;"
           onerror="this.src='https://via.placeholder.com/50'">
      <div>
        <h6 class="mb-0">${post.userName || 'User'}</h6>
        <small class="text-muted">${formatTimeAgo(post.createdAt?.toDate())}</small>
      </div>
    </div>
    
    <div class="post-content">
      <p class="mb-3">${post.content}</p>
      ${mediaHtml}
    </div>
    
    <!-- Reactions Section -->
    <div class="reactions-section mb-3">
      <div class="d-flex justify-content-between align-items-center">
        <div class="reactions-display">
          ${post.reactions ? Object.entries(post.reactions).map(([emoji, users]) =>
        users.length > 0 ? `<span class="reaction-badge">${emoji} ${users.length}</span>` : ''
      ).join('') : ''}
        </div>
        <button class="btn btn-sm btn-outline-secondary reaction-btn" data-post-id="${post.id}">
          <i class="fas fa-smile me-1"></i> React
        </button>
      </div>
      
      <!-- Emoji Picker (Hidden by default) -->
      <div class="emoji-picker mt-2" id="emoji-picker-${post.id}" style="display: none;">
        <div class="emoji-option" data-emoji="üëç">üëç</div>
        <div class="emoji-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
        <div class="emoji-option" data-emoji="üòÇ">üòÇ</div>
        <div class="emoji-option" data-emoji="üòÆ">üòÆ</div>
        <div class="emoji-option" data-emoji="üò¢">üò¢</div>
        <div class="emoji-option" data-emoji="üéâ">üéâ</div>
        <div class="emoji-option" data-emoji="üî•">üî•</div>
        <div class="emoji-option" data-emoji="‚≠ê">‚≠ê</div>
      </div>
    </div>
    
    <div class="post-actions">
      <button class="post-action-btn like-btn ${post.likes && post.likes.includes(currentUser.uid) ? 'active' : ''}" 
              data-post-id="${post.id}">
        <i class="fas fa-heart me-1"></i>
        <span class="like-count">${post.likes ? post.likes.length : 0}</span>
      </button>
      <button class="post-action-btn comment-btn" data-post-id="${post.id}">
        <i class="fas fa-comment me-1"></i>
        <span class="comment-count">${post.comments ? post.comments.length : 0}</span>
      </button>
    </div>
    
    <div class="comments-section" id="comments-${post.id}" style="display: none;">
      <div class="comment-form mb-3">
        <div class="input-group">
          <input type="text" class="form-control comment-input" placeholder="Write a comment..." 
                 data-post-id="${post.id}">
          <button class="btn btn-primary add-comment-btn" data-post-id="${post.id}">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
      <div class="comments-list" id="comments-list-${post.id}">
        ${post.comments ? post.comments.map(comment => `
          <div class="comment mb-3 p-2 border rounded">
            <div class="d-flex align-items-center mb-1">
              <img src="${comment.userPhotoUrl || generateDefaultAvatar(comment.userName || 'User')}" 
                   class="rounded-circle me-2" width="30" height="30" style="object-fit: cover;"
                   onerror="this.src='https://via.placeholder.com/30'">
              <div class="flex-grow-1">
                <span class="comment-user fw-bold">${comment.userName}:</span>
                <span class="comment-text">${comment.text}</span>
              </div>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-1">
              <small class="text-muted">${comment.timestamp ? formatTimeAgo(comment.timestamp.toDate()) : 'Recently'}</small>
              <button class="btn btn-sm btn-outline-secondary comment-reaction-btn" 
                      data-post-id="${post.id}" data-comment-id="${comment.id}">
                <i class="fas fa-smile"></i>
              </button>
            </div>
            
            <!-- Comment Reactions -->
            <div class="comment-reactions mt-1">
              ${comment.reactions ? Object.entries(comment.reactions).map(([emoji, users]) =>
        users.length > 0 ? `<span class="reaction-badge small">${emoji} ${users.length}</span>` : ''
      ).join('') : ''}
            </div>
          </div>
        `).join('') : ''}
      </div>
    </div>
  `;

      // Add event listeners
      const likeBtn = postDiv.querySelector('.like-btn');
      const commentBtn = postDiv.querySelector('.comment-btn');
      const addCommentBtn = postDiv.querySelector('.add-comment-btn');
      const commentInput = postDiv.querySelector('.comment-input');
      const reactionBtn = postDiv.querySelector('.reaction-btn');
      const emojiPicker = postDiv.querySelector(`#emoji-picker-${post.id}`);
      const commentReactionBtns = postDiv.querySelectorAll('.comment-reaction-btn');

      likeBtn.addEventListener('click', () => toggleLike(post.id));
      commentBtn.addEventListener('click', () => toggleComments(post.id));
      addCommentBtn.addEventListener('click', () => addComment(post.id));
      commentInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          addComment(post.id);
        }
      });

      // Reaction button event listener
      reactionBtn.addEventListener('click', () => {
        emojiPicker.style.display = emojiPicker.style.display === 'none' ? 'block' : 'none';
      });

      // Emoji picker event listeners
      emojiPicker.querySelectorAll('.emoji-option').forEach(emoji => {
        emoji.addEventListener('click', function () {
          const emojiChar = this.getAttribute('data-emoji');
          addReaction(post.id, emojiChar);
          emojiPicker.style.display = 'none';
        });
      });

      // Comment reaction buttons
      commentReactionBtns.forEach(btn => {
        btn.addEventListener('click', function () {
          const postId = this.getAttribute('data-post-id');
          const commentId = this.getAttribute('data-comment-id');
          showCommentEmojiPicker(postId, commentId, this);
        });
      });

      return postDiv;
    }

    // Add reaction to a post
    async function addReaction(postId, emoji) {
      try {
        const postDoc = await db.collection('posts').doc(postId).get();
        if (!postDoc.exists) return;

        const post = postDoc.data();
        const reactions = post.reactions || {};

        // Remove user from any existing reaction
        Object.keys(reactions).forEach(existingEmoji => {
          if (reactions[existingEmoji].includes(currentUser.uid)) {
            reactions[existingEmoji] = reactions[existingEmoji].filter(id => id !== currentUser.uid);
          }
        });

        // Add user to the new reaction
        if (!reactions[emoji]) {
          reactions[emoji] = [];
        }

        // Toggle reaction - if user already has this reaction, remove it
        if (reactions[emoji].includes(currentUser.uid)) {
          reactions[emoji] = reactions[emoji].filter(id => id !== currentUser.uid);
        } else {
          reactions[emoji].push(currentUser.uid);
        }

        // Remove empty reaction arrays
        Object.keys(reactions).forEach(emojiKey => {
          if (reactions[emojiKey].length === 0) {
            delete reactions[emojiKey];
          }
        });

        await db.collection('posts').doc(postId).update({
          reactions: reactions,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update UI
        await loadCommunityPosts();

      } catch (error) {
        console.error('Error adding reaction:', error);
        showToast('Error adding reaction', 'danger');
      }
    }

    // Show emoji picker for comment reactions
    function showCommentEmojiPicker(postId, commentId, buttonElement) {
      // Create or show emoji picker for comments
      let emojiPicker = document.getElementById(`comment-emoji-picker-${commentId}`);

      if (!emojiPicker) {
        emojiPicker = document.createElement('div');
        emojiPicker.id = `comment-emoji-picker-${commentId}`;
        emojiPicker.className = 'emoji-picker';
        emojiPicker.innerHTML = `
      <div class="emoji-option" data-emoji="üëç">üëç</div>
      <div class="emoji-option" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</div>
      <div class="emoji-option" data-emoji="üòÇ">üòÇ</div>
      <div class="emoji-option" data-emoji="üòÆ">üòÆ</div>
    `;

        // Position near the button
        const rect = buttonElement.getBoundingClientRect();
        emojiPicker.style.position = 'absolute';
        emojiPicker.style.top = `${rect.bottom + window.scrollY}px`;
        emojiPicker.style.left = `${rect.left + window.scrollX}px`;
        emojiPicker.style.zIndex = '1000';

        document.body.appendChild(emojiPicker);

        // Add event listeners to emoji options
        emojiPicker.querySelectorAll('.emoji-option').forEach(emoji => {
          emoji.addEventListener('click', function () {
            const emojiChar = this.getAttribute('data-emoji');
            addCommentReaction(postId, commentId, emojiChar);
            emojiPicker.remove();
          });
        });

        // Close emoji picker when clicking outside
        setTimeout(() => {
          const closePicker = (e) => {
            if (!emojiPicker.contains(e.target) && e.target !== buttonElement) {
              emojiPicker.remove();
              document.removeEventListener('click', closePicker);
            }
          };
          document.addEventListener('click', closePicker);
        }, 100);
      } else {
        emojiPicker.remove();
      }
    }

    // Add reaction to a comment
    async function addCommentReaction(postId, commentId, emoji) {
      try {
        const postDoc = await db.collection('posts').doc(postId).get();
        if (!postDoc.exists) return;

        const post = postDoc.data();
        const comments = post.comments || [];

        // Find the comment and update its reactions
        const updatedComments = comments.map(comment => {
          if (comment.id === commentId) {
            const reactions = comment.reactions || {};

            // Initialize array for this emoji if it doesn't exist
            if (!reactions[emoji]) {
              reactions[emoji] = [];
            }

            // Toggle user reaction
            if (reactions[emoji].includes(currentUser.uid)) {
              reactions[emoji] = reactions[emoji].filter(id => id !== currentUser.uid);
            } else {
              reactions[emoji].push(currentUser.uid);
            }

            // Remove empty reaction arrays
            Object.keys(reactions).forEach(emojiKey => {
              if (reactions[emojiKey].length === 0) {
                delete reactions[emojiKey];
              }
            });

            return {
              ...comment,
              reactions: reactions
            };
          }
          return comment;
        });

        await db.collection('posts').doc(postId).update({
          comments: updatedComments,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        // Update UI
        await loadCommunityPosts();

      } catch (error) {
        console.error('Error adding comment reaction:', error);
        showToast('Error adding reaction', 'danger');
      }
    }

    // Load community stats
    async function loadCommunityStats() {
      try {
        // Get total users count
        const usersSnapshot = await db.collection('users').get();
        const activeMembers = usersSnapshot.size;

        // Get posts from this week
        const oneWeekAgo = new Date();
        oneWeekAgo.setDate(oneWeekAgo.getDate() - 7);

        const postsSnapshot = await db.collection('posts')
          .where('createdAt', '>=', oneWeekAgo)
          .get();
        const postsThisWeek = postsSnapshot.size;

        // Get events count
        const eventsSnapshot = await db.collection('events').get();
        const eventsCreated = eventsSnapshot.size;

        // Update UI
        document.getElementById('activeMembers').textContent = activeMembers;
        document.getElementById('postsThisWeek').textContent = postsThisWeek;
        document.getElementById('eventsCreated').textContent = eventsCreated;

      } catch (error) {
        console.error('Error loading community stats:', error);
      }
    }

    // Load top players
    async function loadTopPlayers() {
      try {
        const usersSnapshot = await db.collection('users').get();
        const topPlayersEl = document.getElementById('topPlayers');
        topPlayersEl.innerHTML = '';

        if (usersSnapshot.empty) {
          topPlayersEl.innerHTML = '<div class="text-center p-3">No players found</div>';
          return;
        }

        const users = [];

        usersSnapshot.forEach(doc => {
          const userData = doc.data();
          // Skip admins
          if (userData.role !== 'admin') {
            users.push({
              id: doc.id,
              ...userData,
              // Calculate a score based on various factors
              score: calculatePlayerScore(userData)
            });
          }
        });

        // Sort by score and take top 5
        const topPlayers = users
          .sort((a, b) => b.score - a.score)
          .slice(0, 5);

        // Render top players
        topPlayers.forEach((player, index) => {
          const playerItem = document.createElement('a');
          playerItem.href = '#';
          playerItem.className = 'list-group-item list-group-item-action';

          playerItem.innerHTML = `
        <div class="d-flex align-items-center">
          <span class="badge bg-primary me-2">${index + 1}</span>
          <img src="${player.photoURL || generateDefaultAvatar(player.name || 'User')}" 
               class="rounded-circle me-3" width="40" height="40" style="object-fit: cover;"
               onerror="this.src='https://via.placeholder.com/40'">
          <div class="flex-grow-1">
            <h6 class="mb-0">${player.name || 'User'}</h6>
            <small class="text-muted">${player.primarySport || 'Sports'} ‚Ä¢ ${player.skillLevel || 'Beginner'}</small>
          </div>
          <span class="badge bg-success">${player.score} pts</span>
        </div>
      `;

          topPlayersEl.appendChild(playerItem);
        });

      } catch (error) {
        console.error('Error loading top players:', error);
      }
    }

    // Calculate player score based on various factors
    function calculatePlayerScore(userData) {
      let score = 0;

      // Base points for being active
      score += 10;

      // Points for skill level
      const skillPoints = {
        'beginner': 10,
        'intermediate': 20,
        'advanced': 30,
        'expert': 40
      };
      score += skillPoints[userData.skillLevel] || 0;

      // Points for loyalty points
      score += (userData.loyaltyPoints || 0) * 0.1;

      // Additional points for profile completeness
      if (userData.bio) score += 5;
      if (userData.location) score += 5;
      if (userData.primarySport) score += 5;

      return Math.round(score);
    }

    // Create a new post - FIXED VERSION
    async function createPost() {
      try {
        const content = document.getElementById('postContent').value.trim();
        const photoUrl = document.getElementById('photoUrl').value.trim();
        const videoUrl = document.getElementById('videoUrl').value.trim();

        if (!content) {
          showToast('Please enter post content', 'warning');
          return;
        }

        // Get user data properly
        const userData = window.userProfileData || {};
        const userPhotoUrl = userData.photoUrl || currentUser.photoURL || '';

        const postData = {
          content: content,
          photoUrl: photoUrl || null,
          videoUrl: videoUrl || null,
          userId: currentUser.uid,
          userName: currentUser.displayName || 'User',
          userPhotoUrl: userPhotoUrl,
          likes: [],
          comments: [],
          reactions: {},
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('posts').add(postData);

        showToast('Post created successfully!', 'success');

        // Clear form
        document.getElementById('postContent').value = '';
        document.getElementById('photoUrl').value = '';
        document.getElementById('videoUrl').value = '';

        // Reload posts and stats
        await loadCommunityPosts();
        await loadCommunityStats();

      } catch (error) {
        console.error('Error creating post:', error);
        showToast('Error creating post', 'danger');
      }
    }

    // Toggle like on a post
    async function toggleLike(postId) {
      try {
        const postDoc = await db.collection('posts').doc(postId).get();
        if (!postDoc.exists) return;

        const post = postDoc.data();
        const likes = post.likes || [];
        const hasLiked = likes.includes(currentUser.uid);

        if (hasLiked) {
          // Unlike
          await db.collection('posts').doc(postId).update({
            likes: firebase.firestore.FieldValue.arrayRemove(currentUser.uid),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } else {
          // Like
          await db.collection('posts').doc(postId).update({
            likes: firebase.firestore.FieldValue.arrayUnion(currentUser.uid),
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        }

        // Update UI
        await loadCommunityPosts();

      } catch (error) {
        console.error('Error toggling like:', error);
        showToast('Error updating like', 'danger');
      }
    }

    // Toggle comments section
    function toggleComments(postId) {
      const commentsSection = document.getElementById(`comments-${postId}`);
      commentsSection.style.display = commentsSection.style.display === 'none' ? 'block' : 'none';
    }

    // Add comment to a post - FIXED VERSION
    async function addComment(postId) {
      try {
        const commentInput = document.querySelector(`#comments-${postId} .comment-input`);
        const commentText = commentInput.value.trim();

        if (!commentText) {
          showToast('Please enter a comment', 'warning');
          return;
        }

        // Get user data properly
        const userData = window.userProfileData || {};
        const userPhotoUrl = userData.photoUrl || currentUser.photoURL || '';

        const comment = {
          id: generateId(), // Generate a unique ID for the comment
          text: commentText,
          userId: currentUser.uid,
          userName: currentUser.displayName || 'User',
          userPhotoUrl: userPhotoUrl,
          timestamp: new Date(), // Use regular Date object instead of FieldValue
          reactions: {}
        };

        // Get the current post
        const postDoc = await db.collection('posts').doc(postId).get();
        if (!postDoc.exists) {
          showToast('Post not found', 'danger');
          return;
        }

        const post = postDoc.data();
        const comments = post.comments || [];

        // Add the new comment
        comments.push(comment);

        // Update the post with the new comments array
        await db.collection('posts').doc(postId).update({
          comments: comments,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp() // This is fine here, outside the array
        });

        // Clear input
        commentInput.value = '';

        showToast('Comment added successfully!', 'success');

        // Update UI
        await loadCommunityPosts();

        // Keep comments section open
        const commentsSection = document.getElementById(`comments-${postId}`);
        if (commentsSection) {
          commentsSection.style.display = 'block';
        }

      } catch (error) {
        console.error('Error adding comment:', error);
        console.error('Error details:', error.message);
        showToast('Error adding comment: ' + error.message, 'danger');
      }
    }

    // Helper function to generate unique ID
    function generateId() {
      return Date.now().toString(36) + Math.random().toString(36).substr(2);
    }

    // Add CSS for reactions
    const reactionStyles = `
  .reactions-section {
    border-top: 1px solid #e9ecef;
    border-bottom: 1px solid #e9ecef;
    padding: 10px 0;
  }
  
  .reaction-badge {
    background-color: #f8f9fa;
    border: 1px solid #dee2e6;
    border-radius: 15px;
    padding: 2px 8px;
    margin-right: 5px;
    font-size: 0.85rem;
  }
  
  .reaction-badge.small {
    font-size: 0.75rem;
    padding: 1px 6px;
  }
  
  .comment-reactions {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
  }
  
  .comment-reaction-btn {
    padding: 2px 6px;
    font-size: 0.75rem;
  }
  
  .comment {
    background-color: #f8f9fa;
    border-radius: 8px;
  }
`;

    // Add the styles to the document
    const styleSheet = document.createElement('style');
    styleSheet.textContent = reactionStyles;
    document.head.appendChild(styleSheet);

    // Other page initializations (simplified for this example)
    function initializeEventsPage() {
      // Event page initialization code would go here
    }

    // Add session management
    function setupSessionManagement() {
      // Check for existing auth state
      auth.onAuthStateChanged((user) => {
        if (user) {
          console.log('User is signed in:', user.email);
        } else {
          console.log('User is signed out');
          // Optional: Redirect to login after a delay if no user found
          setTimeout(() => {
            if (!auth.currentUser) {
              window.location.href = 'login.html';
            }
          }, 2000);
        }
      });

      // Handle browser/tab close
      window.addEventListener('beforeunload', () => {
        // You can add cleanup here, but Firebase handles session persistence
      });
    }
    // Notification system functions
    async function createNotification(userId, type, title, message, data = {}) {
      try {
        const notificationData = {
          userId: userId,
          type: type,
          title: title,
          message: message,
          data: data,
          read: false,
          createdAt: firebase.firestore.FieldValue.serverTimestamp(),
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        await db.collection('notifications').add(notificationData);
        console.log('Notification created:', type);
      } catch (error) {
        console.error('Error creating notification:', error);
      }
    }

    // Get user's unread notifications count
    async function getUnreadNotificationsCount(userId) {
      try {
        const notificationsSnapshot = await db.collection('notifications')
          .where('userId', '==', userId)
          .where('read', '==', false)
          .get();

        return notificationsSnapshot.size;
      } catch (error) {
        console.error('Error getting notifications count:', error);
        return 0;
      }
    }

    // Mark notification as read
    async function markNotificationAsRead(notificationId) {
      try {
        await db.collection('notifications').doc(notificationId).update({
          read: true,
          updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        });
      } catch (error) {
        console.error('Error marking notification as read:', error);
      }
    }

    // Mark all notifications as read
    async function markAllNotificationsAsRead(userId) {
      try {
        const notificationsSnapshot = await db.collection('notifications')
          .where('userId', '==', userId)
          .where('read', '==', false)
          .get();

        const batch = db.batch();
        notificationsSnapshot.forEach(doc => {
          const notificationRef = db.collection('notifications').doc(doc.id);
          batch.update(notificationRef, {
            read: true,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        });

        await batch.commit();
        showToast('All notifications marked as read', 'success');
      } catch (error) {
        console.error('Error marking all notifications as read:', error);
      }
    }
    // Submit booking - UPDATED VERSION with notification
    async function submitBooking() {
      try {
        // ... existing booking calculation code ...

        // Create booking object
        const bookingData = {
          // ... existing booking data ...
        };

        // Add booking to Firestore
        const bookingRef = await db.collection('bookings').add(bookingData);

        // Create notification for user
        await createNotification(
          currentUser.uid,
          'booking_created',
          'Booking Submitted',
          `Your booking for ${selectedFacility.name} on ${selectedDate.toLocaleDateString()} at ${selectedTimeSlot} has been submitted and is pending approval.`,
          {
            bookingId: bookingRef.id,
            facilityName: selectedFacility.name,
            date: selectedDate,
            time: selectedTimeSlot
          }
        );

        // Create notification for admins (all users with admin role)
        const adminsSnapshot = await db.collection('users')
          .where('role', '==', 'admin')
          .get();

        adminsSnapshot.forEach(async (adminDoc) => {
          await createNotification(
            adminDoc.id,
            'new_booking_request',
            'New Booking Request',
            `New booking request from ${currentUser.displayName} for ${selectedFacility.name}`,
            {
              bookingId: bookingRef.id,
              userId: currentUser.uid,
              userName: currentUser.displayName,
              facilityName: selectedFacility.name,
              date: selectedDate,
              time: selectedTimeSlot
            }
          );
        });

        // ... rest of existing code (loyalty points, success message, etc.) ...

      } catch (error) {
        console.error('Error submitting booking:', error);
        showToast('Error submitting booking', 'danger');
      }
    }
    // Function to be called when admin approves a booking
    async function onBookingApproved(bookingId, bookingData) {
      try {
        await createNotification(
          bookingData.userId,
          'booking_approved',
          'Booking Approved!',
          `Your booking for ${bookingData.facilityName} on ${bookingData.date.toDate().toLocaleDateString()} at ${bookingData.time} has been approved.`,
          {
            bookingId: bookingId,
            facilityName: bookingData.facilityName,
            date: bookingData.date,
            time: bookingData.time
          }
        );
      } catch (error) {
        console.error('Error creating approval notification:', error);
      }
    }

    // Function to be called when admin rejects a booking
    async function onBookingRejected(bookingId, bookingData) {
      try {
        await createNotification(
          bookingData.userId,
          'booking_rejected',
          'Booking Rejected',
          `Your booking for ${bookingData.facilityName} on ${bookingData.date.toDate().toLocaleDateString()} at ${bookingData.time} has been rejected.`,
          {
            bookingId: bookingId,
            facilityName: bookingData.facilityName,
            date: bookingData.date,
            time: bookingData.time
          }
        );
      } catch (error) {
        console.error('Error creating rejection notification:', error);
      }
    }
    // Load notifications for dropdown
    async function loadNotifications() {
      try {
        const notificationsSnapshot = await db.collection('notifications')
          .where('userId', '==', currentUser.uid)
          .orderBy('createdAt', 'desc')
          .limit(5)
          .get();

        const notificationsDropdown = document.querySelector('.dropdown-menu');
        if (!notificationsDropdown) return;

        // Clear existing notifications (except header and view all link)
        const existingNotifications = notificationsDropdown.querySelectorAll('.notification-item');
        existingNotifications.forEach(item => item.remove());

        if (notificationsSnapshot.empty) {
          const noNotificationsItem = document.createElement('li');
          noNotificationsItem.innerHTML = '<a class="dropdown-item text-muted" href="#">No notifications</a>';
          notificationsDropdown.insertBefore(noNotificationsItem, notificationsDropdown.querySelector('.dropdown-divider'));
          return;
        }

        // Add notifications to dropdown
        notificationsSnapshot.forEach(doc => {
          const notification = doc.data();
          const notificationItem = document.createElement('li');
          notificationItem.className = 'notification-item';

          const notificationClass = notification.read ? '' : 'fw-bold';
          const timeAgo = formatTimeAgo(notification.createdAt?.toDate());

          notificationItem.innerHTML = `
                <a class="dropdown-item ${notificationClass}" href="#" data-notification-id="${doc.id}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${notification.title}</h6>
                        <small>${timeAgo}</small>
                    </div>
                    <p class="mb-1">${notification.message}</p>
                </a>
            `;

          notificationsDropdown.insertBefore(notificationItem, notificationsDropdown.querySelector('.dropdown-divider'));

          // Add click event to mark as read
          notificationItem.querySelector('a').addEventListener('click', async (e) => {
            e.preventDefault();
            if (!notification.read) {
              await markNotificationAsRead(doc.id);
            }
            // Handle notification click based on type
            handleNotificationClick(notification);
          });
        });

        // Update notification badge count
        const unreadCount = await getUnreadNotificationsCount(currentUser.uid);
        const notificationBadge = document.querySelector('.header-actions .badge');
        if (notificationBadge) {
          notificationBadge.textContent = unreadCount;
          notificationBadge.style.display = unreadCount > 0 ? 'inline' : 'none';
        }

      } catch (error) {
        console.error('Error loading notifications:', error);
      }
    }

    // Handle notification clicks based on type
    function handleNotificationClick(notification) {
      switch (notification.type) {
        case 'booking_created':
        case 'booking_approved':
        case 'booking_rejected':
          // Navigate to bookings page
          currentPage = 'my-bookings';
          localStorage.setItem('currentPage', 'my-bookings');
          updatePageTitle('my-bookings');
          loadPageContent('my-bookings');
          initializeMyBookingsPage();
          break;

        case 'new_message':
          // Navigate to find friends page and open chat
          currentPage = 'find-friends';
          localStorage.setItem('currentPage', 'find-friends');
          updatePageTitle('find-friends');
          loadPageContent('find-friends');
          initializeFindFriendsPage();
          // You could automatically open the chat here
          break;

        default:
          // Default behavior
          break;
      }

      // Close dropdown
      const dropdown = bootstrap.Dropdown.getInstance(document.querySelector('.dropdown-toggle'));
      if (dropdown) {
        dropdown.hide();
      }
    }
    // Real-time notification listener
    function setupNotificationListener() {
      if (!currentUser) return;

      db.collection('notifications')
        .where('userId', '==', currentUser.uid)
        .where('read', '==', false)
        .orderBy('createdAt', 'desc')
        .onSnapshot((snapshot) => {
          // Update notification count
          const unreadCount = snapshot.size;
          const notificationBadge = document.querySelector('.header-actions .badge');
          if (notificationBadge) {
            notificationBadge.textContent = unreadCount;
            notificationBadge.style.display = unreadCount > 0 ? 'inline' : 'none';
          }

          // Show toast for new notifications
          snapshot.docChanges().forEach((change) => {
            if (change.type === 'added') {
              const notification = change.doc.data();
              showToast(`${notification.title}: ${notification.message}`, 'info');
            }
          });
        });
    }
    // Call this when the app loads
    setupSessionManagement();
  </script>
</body>

</html>